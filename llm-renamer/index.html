<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    
      Rename files using llm.datasette.io — infoBAG
    
  </title>
  <meta name="title" content="Rename files using llm.datasette.io" />
  <meta name="description" content="can't steer unless already moving" />  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Rename files using llm.datasette.io — infoBAG" />
  <meta property="og:description" content="can't steer unless already moving" />
  <meta property="og:url" content="https://ib.bsb.br/llm-renamer/" />
  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="infoBAG" />
    
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Rename files using llm.datasette.io — infoBAG">
  <meta name="twitter:description" content="can't steer unless already moving">
    
   <link rel="canonical" href="https://ib.bsb.br/llm-renamer/">
  <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">  
  
    <meta name="keywords" content="linux,scripts">
    
      <meta property="article:tag" content="linux">
    
      <meta property="article:tag" content="scripts">
    
    
  <!-- Favicons and Icons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
  <link href="/style.css" rel="stylesheet">
</head>
<body class="post-content-body">
  <header class="header-container">
    <nav aria-label="Main navigation" class="header-content">
      <a href="/" aria-label="Home">
        <img src="/favicon.ico" alt="Home" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>
      <a href="/tags" aria-label="Tags">
        <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>
      <a href="/events" aria-label="Events">
        <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>
      <a href="/archive" aria-label="Archive">
        <img src="/assets/Loose_Stone_Pile.gif" alt="Archive" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>      
    </nav>
    <h1 class="post-title">Rename files using llm.datasette.io</h1>
        <div class="post-meta">
          <time datetime="2024-06-02T03:00:00+00:00" class="post-date">
            02 Jun 2024</time>
          
            <span class="post-updated"> &rightarrowtail; <time datetime="2024-09-20T02:37:06+00:00">20 Sep 2024</time></span>
          
          
          <div class="post-tags">
            <p>
              
              Slug: <a href="https://ib.bsb.br/llm-renamer" class="tag">llm-renamer</a>
              
              Tags:
              
              <a href="https://ib.bsb.br/tags/#linux" class="tag">linux</a>
              
              
              <a href="https://ib.bsb.br/tags/#scripts" class="tag">scripts</a>
              
              
            </p>
          </div>
          
          <div class="post-actions">
            <p>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2024-06-02-llm-renamer.md" method="POST" target="_blank" rel="noopener noreferrer">
              <button type="submit" class="btn btn-danger">Improve this page? aberto.</button>
            </form>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2024-06-02-llm-renamer.md" method="POST" target="_blank" rel="noopener noreferrer">
              <button type="submit" class="btn btn-danger">View revision history</button>
            </form>
          </p>
            <a class="btn-primary">
              55458&hArr;2996
            </a>
          </div>
        </div>
  </header>
  <main class="content">
    <article class="post-wrapper">      
      <div class="post-content">
        

        <p>Fork of https://github.com/heversonbr/scientific-paper-pdf-rename</p>

<div class="language-python highlighter-rouge"><div class="highlight"><section><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">fitz</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">platform</span>
<span class="kn">import</span> <span class="n">pkg_resources</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="n">string</span>
<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">shutil</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">llm</span>
<span class="kn">from</span> <span class="n">src.helper</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Define logger / logger config
</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">INFO</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">[%(asctime)s] - [%(levelname)s]- %(message)s</span><span class="sh">'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">()</span>
<span class="nf">set_helper_logger</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

<span class="c1"># Set your OpenAI API key
</span><span class="n">model</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">get_model</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-3.5-turbo</span><span class="sh">"</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;!-- INSERT OPENAI KEY --&gt;</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">keyboardInterruptHandler</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">You pressed Ctrl+C! Leaving...</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">validate_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Wrong number of arguments!</span><span class="sh">'</span><span class="p">)</span>
        <span class="nf">print_usage</span><span class="p">()</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Missing arguments!</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print_usage</span><span class="p">()</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">'</span><span class="s">.pdf</span><span class="sh">'</span><span class="p">):</span>
                    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Argument is not a pdf file</span><span class="sh">'</span><span class="p">)</span>
                    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Directory or file [</span><span class="sh">"</span><span class="o">+</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">] path does not exist!</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span>

<span class="k">def</span> <span class="nf">hash_file</span><span class="p">(</span><span class="n">target_file</span><span class="p">):</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">65536</span>
    <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="sh">'</span><span class="s">sha256</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">target_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">hasher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hasher</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="n">target_file</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> is not a file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">parse_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">max_length</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="mi">125</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">[^a-zA-Z0-9]+</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="nf">capwords</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s">.pdf</span><span class="sh">'</span>
    <span class="k">return</span> <span class="n">title</span>

<span class="k">def</span> <span class="nf">get_page_text</span><span class="p">(</span><span class="n">current_page</span><span class="p">):</span>
    <span class="n">python_version</span> <span class="o">=</span> <span class="n">platform</span><span class="p">.</span><span class="nf">python_version</span><span class="p">()</span>
    <span class="n">library_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">PyMuPDF</span><span class="sh">"</span>
    <span class="n">library_version</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="p">.</span><span class="nf">get_distribution</span><span class="p">(</span><span class="n">library_name</span><span class="p">).</span><span class="n">version</span>

    <span class="n">acceptable_python_versions</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">3.11</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">3.7</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">3.8</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">acceptable_pymupdf_versions</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">1.22</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1.18</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">python_version</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">acceptable_python_versions</span><span class="p">)</span> <span class="ow">and</span> \
       <span class="nf">any</span><span class="p">(</span><span class="n">library_version</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">acceptable_pymupdf_versions</span><span class="p">):</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">current_page</span><span class="p">.</span><span class="nf">get_text</span><span class="p">(</span><span class="sh">'</span><span class="s">dict</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">blocks</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">'</span><span class="s">Python version is: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">python_version</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">'</span><span class="s">PyMuPDF version is: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">library_version</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">Python version is: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">python_version</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">PyMuPDF version is: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">library_version</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Your Python version or PyMuPDF is not at the required level!</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Please ensure that both meet the specified version requirements for this script to function properly.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">blocks</span>

<span class="k">def</span> <span class="nf">get_best_title_from_llm</span><span class="p">(</span><span class="n">text_content</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">prompt</span><span class="p">(</span>
        <span class="n">text_content</span><span class="p">,</span>
        <span class="n">system</span><span class="o">=</span><span class="sh">'</span><span class="s">Given the extracted text from a PDF document, craft the most fitting title. The title should be accurate, clear, concise, and relevant to researchers, adhering, if possible, to the standard of ABNT NBR 6023 (e.g., </span><span class="sh">"</span><span class="s">MARX, Karl; ENGELS, Friedrich. The communist manifesto. In: Ideals and ideologies. Routledge, 2019. p. 243-255.</span><span class="sh">"</span><span class="s">). However, ensure the title adheres to filename restrictions: avoid characters like `/ \ ? * : &lt; &gt; |` and control characters (ASCII 0-31). Prioritize alphanumeric characters, hyphens, underscores, and periods. Your response MUST contain ONLY the crafted title, NO MORE, NO LESS.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">title</span>

<span class="k">def</span> <span class="nf">scan_title</span><span class="p">(</span><span class="n">full_file_name</span><span class="p">,</span> <span class="n">page_num</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">page_num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">page_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">full_file_name</span><span class="p">)</span>
    <span class="n">meta_title</span> <span class="o">=</span> <span class="n">doc</span><span class="p">.</span><span class="n">metadata</span><span class="p">[</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">meta_title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">meta_title</span> <span class="o">=</span> <span class="nf">parse_title</span><span class="p">(</span><span class="n">meta_title</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">.</span><span class="nf">load_page</span><span class="p">(</span><span class="n">page_num</span><span class="p">)</span>
    <span class="n">size_text_tup_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sh">''</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="nf">get_page_text</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">blk</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">blk</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">blk</span><span class="p">[</span><span class="sh">'</span><span class="s">lines</span><span class="sh">'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="sh">'</span><span class="s">dir</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="sh">'</span><span class="s">wmode</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="sh">'</span><span class="s">spans</span><span class="sh">'</span><span class="p">]:</span>
                        <span class="n">size_text_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">],</span> <span class="n">span</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">],</span> <span class="n">span</span><span class="p">[</span><span class="sh">'</span><span class="s">origin</span><span class="sh">'</span><span class="p">])</span>
                        <span class="n">size_text_tup_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">size_text_tup</span><span class="p">)</span>
                        <span class="n">text_content</span> <span class="o">+=</span> <span class="n">span</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span>
    <span class="n">sorted_size_text_list</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">size_text_tup_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">text_size</span><span class="p">:</span> <span class="n">text_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">larger_font</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">title_max_lines</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_size_text_list</span><span class="p">:</span>
        <span class="n">t_font_size</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_text</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t_text_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">t_text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_text_len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t_font_size</span> <span class="o">&gt;</span> <span class="n">larger_font</span><span class="p">:</span>
                <span class="n">larger_font</span> <span class="o">=</span> <span class="n">t_font_size</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">t_text</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span>
                <span class="n">title_max_lines</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">t_font_size</span> <span class="o">==</span> <span class="n">larger_font</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="n">t_text</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span>
                <span class="n">title_max_lines</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">title_max_lines</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="n">doc</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="n">parsed_found_title</span> <span class="o">=</span> <span class="nf">parse_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">best_title</span> <span class="o">=</span> <span class="nf">get_best_title_from_llm</span><span class="p">(</span><span class="n">text_content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">meta_title</span><span class="p">,</span> <span class="n">parsed_found_title</span><span class="p">,</span> <span class="n">best_title</span>

<span class="k">def</span> <span class="nf">do_rename</span><span class="p">(</span><span class="n">fullpath_current_filename</span><span class="p">,</span> <span class="n">fullpath_new_filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fullpath_current_filename</span> <span class="o">==</span> <span class="n">fullpath_new_filename</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">Current filename and found title are already the same. Skipping...</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">fullpath_current_filename</span><span class="p">,</span> <span class="n">fullpath_new_filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">An exception occurred. File not renamed!</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">confirm_to_continue</span><span class="p">():</span>
    <span class="n">valid_choices</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">s</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">'</span><span class="s">Choose [c] to continue, [s] to skip, or [a] to abort : </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">while</span><span class="p">(</span><span class="n">choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_choices</span><span class="p">):</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">'</span><span class="s">Choose [c] to continue or [a] to abort : </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sh">'</span><span class="s">s</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">aborting...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">select_loop_type</span><span class="p">():</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Choose [1] : for renaming all pdf files in the directory</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Choose [2] : for one-by-one pdf file confirmation</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">valid_choices</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">'</span><span class="s">Choose [1], [2] or q [quit] : </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">while</span><span class="p">(</span><span class="n">choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_choices</span><span class="p">):</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">'</span><span class="s">Choose [1], [2] or q [quit] : </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">aborting...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">move_file</span><span class="p">(</span><span class="n">fullpath_src_file</span><span class="p">,</span> <span class="n">destination_dir</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">):</span>
    <span class="nf">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">)):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">move</span><span class="p">(</span><span class="n">fullpath_src_file</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">strerror</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">File </span><span class="sh">'</span> <span class="o">+</span> <span class="n">fullpath_src_file</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> was not moved to </span><span class="sh">'</span> <span class="o">+</span> <span class="n">destination_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/auto_renamed_pdf</span><span class="sh">'</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">search_candidate_title</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">current_file</span><span class="p">):</span>
    <span class="n">meta_title</span><span class="p">,</span> <span class="n">font_based_title</span><span class="p">,</span> <span class="n">best_title</span> <span class="o">=</span> <span class="nf">scan_title</span><span class="p">(</span><span class="n">src_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">best_title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best_title</span>
    <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">font_based_title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">font_based_title</span>
    <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">meta_title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">meta_title</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">No potential Title was found for : </span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">rename_files_in_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">):</span>
    <span class="n">renamed_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">file_fingerprints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">full_path_base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">full_path_base_dir</span><span class="p">):</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[</span><span class="nb">file</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">full_path_base_dir</span><span class="p">)</span> <span class="k">if</span> <span class="nb">file</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">'</span><span class="s">.pdf</span><span class="sh">'</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">no pdf files found in the target directory</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">renamed_counter</span><span class="p">,</span> <span class="n">total_counter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">))</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> files found in the target directory!</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">loop_type</span> <span class="o">=</span> <span class="nf">select_loop_type</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">current_file</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
            <span class="n">total_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fingerprint</span> <span class="o">=</span> <span class="nf">hash_file</span><span class="p">(</span><span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">[Current file name] : </span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">'</span><span class="s">[Current file hash] : </span><span class="sh">'</span> <span class="o">+</span> <span class="n">fingerprint</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">'</span><span class="s">[loop_type] : </span><span class="sh">'</span> <span class="o">+</span> <span class="n">loop_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loop_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="nf">confirm_to_continue</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">answer</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fingerprint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_fingerprints</span><span class="p">:</span>
                <span class="n">file_fingerprints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">)</span>
                <span class="n">found_title</span> <span class="o">=</span> <span class="nf">search_candidate_title</span><span class="p">(</span><span class="n">full_path_base_dir</span><span class="p">,</span> <span class="n">current_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">found_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">renamed</span> <span class="o">=</span> <span class="nf">do_rename</span><span class="p">(</span><span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">,</span> <span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">found_title</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">renamed</span><span class="p">:</span>
                        <span class="nf">move_file</span><span class="p">(</span><span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">found_title</span><span class="p">,</span> <span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/auto_renamed_pdf</span><span class="sh">'</span><span class="p">,</span> <span class="n">found_title</span><span class="p">)</span>
                        <span class="n">renamed_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">Another file with the same content (hash) was found in the source directory!</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Skipping file: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> adding prefix `duplicated_`to it</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">,</span> <span class="n">full_path_base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/duplicated_</span><span class="sh">'</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Directory does not exist!</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">renamed_counter</span><span class="p">,</span> <span class="n">total_counter</span>

<span class="k">def</span> <span class="nf">rename_target_file</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">fullpath_filename</span> <span class="o">=</span> <span class="n">src_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">fullpath_filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">fullpath_filename</span><span class="p">).</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">'</span><span class="s">.pdf</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">found_title</span> <span class="o">=</span> <span class="nf">search_candidate_title</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">found_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">renamed</span> <span class="o">=</span> <span class="nf">do_rename</span><span class="p">(</span><span class="n">fullpath_filename</span><span class="p">,</span> <span class="n">src_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">found_title</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">renamed</span><span class="p">:</span>
                    <span class="nf">move_file</span><span class="p">(</span><span class="n">src_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">found_title</span><span class="p">,</span> <span class="n">src_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/auto_renamed_pdf</span><span class="sh">'</span><span class="p">,</span> <span class="n">found_title</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">File is not a pdf!</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">File does not exist!</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nf">print_header</span><span class="p">()</span>
    <span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="nf">validate_arguments</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">keyboardInterruptHandler</span><span class="p">)</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">filename</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">[Target Path]: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">target_path</span><span class="p">)</span>
    <span class="n">rename_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
        <span class="n">rename_counter</span><span class="p">,</span> <span class="n">total_counter</span> <span class="o">=</span> <span class="nf">rename_files_in_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Finished =&gt; Total files: </span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">total_counter</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> Renamed files: </span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">rename_counter</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">renamed</span> <span class="o">=</span> <span class="nf">rename_target_file</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">renamed</span><span class="p">:</span>
            <span class="n">rename_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Finished =&gt; Renamed files : </span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">rename_counter</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></section></div></div>

      </div>
      URL: https://ib.bsb.br/llm-renamer
    </article>
    
    
    
    
    
    
    <nav class="post-navigation" aria-label="Post navigation">
      
      <div class="nav-arrow prev">
        <a href="/bibtex-check/" title="Python script to check LaTeX citations" rel="prev">
          <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ/lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
        </a>
      </div>
      
      
      <div class="nav-arrow next">
        <a href="/pdf-utf8/" title="Convert `.pdf` to `UTF-8`" rel="next">
          <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next article" width="45" height="45" loading="lazy">
        </a>
      </div>
      
    </nav>
    <pre>
      Fork of https://github.com/heversonbr/scientific-paper-pdf-rename

#!/usr/bin/env python3
import fitz
import os
import sys
import platform
import pkg_resources
import signal
import string
import hashlib
import shutil
import re
import logging
import llm
from src.helper import *

# Define logger / logger config
log_level = logging.INFO
logging.basicConfig(format='[%(asctime)s] - [%(levelname)s]- %(message)s', level=log_level)
logger = logging.getLogger()
set_helper_logger(log_level)

# Set your OpenAI API key
model = llm.get_model("gpt-3.5-turbo")
model.key = "&lt;!-- INSERT OPENAI KEY --&gt;"

def keyboardInterruptHandler(signal, frame):
    logger.info('You pressed Ctrl+C! Leaving...'.format(signal))
    sys.exit(0)

def validate_arguments(arguments):
    if len(arguments) &gt; 2:
        logger.error('Wrong number of arguments!')
        print_usage()
        sys.exit()
    if len(sys.argv) == 1:
        logger.error("Missing arguments!")
        print_usage()
        sys.exit()
    if len(arguments) == 2:
        target = os.path.abspath(arguments[1])
        base_dir = ''
        filename = ''
        if os.path.exists(target):
            if os.path.isdir(target):
                base_dir = os.path.abspath(target)
            else:
                if target.endswith('.pdf'):
                    base_dir = os.path.dirname(target)
                    filename = os.path.basename(target)
                else:
                    logger.error('Argument is not a pdf file')
                    sys.exit()
        else:
            logger.error("Directory or file ["+ arguments[1] + "] path does not exist!")
            sys.exit()
        return base_dir, filename

def hash_file(target_file):
    blocksize = 65536
    hasher = hashlib.new('sha256')
    target_file = os.path.abspath(target_file)
    if os.path.isfile(target_file):
        with open(target_file, 'rb') as f:
            while True:
                data = f.read(blocksize)
                if not data:
                    break
                hasher.update(data)
        return hasher.hexdigest()
    else:
        logger.error(target_file + ' is not a file')
        sys.exit()

def parse_title(title, max_length=None):
    if max_length == None:
        max_length = 125
    if len(title) &gt; max_length:
        title = title[:max_length]
    title = re.sub(r'[^a-zA-Z0-9]+', ' ', title)
    title = title.strip()
    title = re.sub(r'\s', '_', title)
    title = string.capwords(title) + '.pdf'
    return title

def get_page_text(current_page):
    python_version = platform.python_version()
    library_name = "PyMuPDF"
    library_version = pkg_resources.get_distribution(library_name).version

    acceptable_python_versions = ["3.11", "3.7", "3.8"]
    acceptable_pymupdf_versions = ["1.22", "1.18"]

    if any(python_version.startswith(ver) for ver in acceptable_python_versions) and \
       any(library_version.startswith(ver) for ver in acceptable_pymupdf_versions):
        blocks = current_page.get_text('dict')['blocks']
        logger.debug('Python version is: ' + python_version)
        logger.debug('PyMuPDF version is: ' + library_version)
    else:
        logger.warning('Python version is: ' + python_version)
        logger.warning('PyMuPDF version is: ' + library_version)
        logger.error('Your Python version or PyMuPDF is not at the required level!')
        logger.error('Please ensure that both meet the specified version requirements for this script to function properly.')
        sys.exit()

    return blocks

def get_best_title_from_llm(text_content):
    response = model.prompt(
        text_content,
        system='Given the extracted text from a PDF document, craft the most fitting title. The title should be accurate, clear, concise, and relevant to researchers, adhering, if possible, to the standard of ABNT NBR 6023 (e.g., "MARX, Karl; ENGELS, Friedrich. The communist manifesto. In: Ideals and ideologies. Routledge, 2019. p. 243-255."). However, ensure the title adheres to filename restrictions: avoid characters like `/ \ ? * : &lt; &gt; |` and control characters (ASCII 0-31). Prioritize alphanumeric characters, hyphens, underscores, and periods. Your response MUST contain ONLY the crafted title, NO MORE, NO LESS.')
    title = response.text().strip()
    return title

def scan_title(full_file_name, page_num=None):
    if page_num is None:
        page_num = 0
    doc = fitz.open(full_file_name)
    meta_title = doc.metadata['title'].strip()
    if len(meta_title) &gt; 5:
        meta_title = parse_title(meta_title)
    page = doc.load_page(page_num)
    size_text_tup_list = []
    title = ''
    blocks = get_page_text(page)
    text_content = ""
    for blk in blocks:
        if blk['type'] == 0:
            for line in blk['lines']:
                if line['dir'] == (1.0, 0.0) and line['wmode'] == 0:
                    for span in line['spans']:
                        size_text_tup = (span['size'], span['text'], span['origin'])
                        size_text_tup_list.append(size_text_tup)
                        text_content += span['text'] + " "
    sorted_size_text_list = sorted(size_text_tup_list, key=lambda text_size: text_size[0], reverse=True)
    larger_font = 0
    title_max_lines = 5
    for item in sorted_size_text_list:
        t_font_size = item[0]
        t_text = item[1]
        t_text_len = len(t_text)
        if t_text_len &gt; 2:
            if t_font_size &gt; larger_font:
                larger_font = t_font_size
                title = t_text.strip() + ' '
                title_max_lines -= 1
            elif t_font_size == larger_font:
                title = title + t_text.strip() + ' '
                title_max_lines -= 1
            if title_max_lines &lt; 1:
                break
    doc.close()
    parsed_found_title = parse_title(title)
    best_title = get_best_title_from_llm(text_content)
    return meta_title, parsed_found_title, best_title

def do_rename(fullpath_current_filename, fullpath_new_filename):
    if fullpath_current_filename == fullpath_new_filename:
        logger.warning('Current filename and found title are already the same. Skipping...')
        return False
    try:
        os.rename(fullpath_current_filename, fullpath_new_filename)
    except:
        logger.error("An exception occurred. File not renamed!")
        return False
    return True

def confirm_to_continue():
    valid_choices = ['c', 's', 'a']
    choice = input('Choose [c] to continue, [s] to skip, or [a] to abort : \n')
    while(choice not in valid_choices):
        choice = input('Choose [c] to continue or [a] to abort : \n')
    if choice == 'c':
        return True
    if choice == 's':
        return False
    if choice == 'a':
        logger.info("aborting...")
        sys.exit()

def select_loop_type():
    logger.info('Choose [1] : for renaming all pdf files in the directory')
    logger.info('Choose [2] : for one-by-one pdf file confirmation')
    valid_choices = ['1', '2', 'q']
    choice = input('Choose [1], [2] or q [quit] : \n')
    while(choice not in valid_choices):
        choice = input('Choose [1], [2] or q [quit] : \n')
    if choice == '1':
        return '1'
    if choice == '2':
        return '2'
    if choice == 'q':
        logger.info("aborting...")
        sys.exit()

def move_file(fullpath_src_file, destination_dir, dest_file):
    if(not os.path.isdir(destination_dir)):
        os.mkdir(os.path.join(destination_dir))
    try:
        shutil.move(fullpath_src_file, os.path.join(destination_dir, dest_file))
    except OSError as e:
        logger.exception(e.strerror)
        logger.warning('File ' + fullpath_src_file + ' was not moved to ' + destination_dir + '/auto_renamed_pdf' )

def search_candidate_title(src_dir, current_file):
    meta_title, font_based_title, best_title = scan_title(src_dir + '/' + current_file)
    if len(best_title) &gt; 0:
        return best_title
    elif len(font_based_title) &gt; 0:
        return font_based_title
    elif len(meta_title) &gt; 0:
        return meta_title
    else:
        logger.info('No potential Title was found for : ' + current_file)
        return None

def rename_files_in_dir(base_dir):
    renamed_counter = 0
    total_counter = 0
    file_fingerprints = []
    full_path_base_dir = os.path.abspath(base_dir)
    if os.path.isdir(full_path_base_dir):
        list_of_files = [file for file in os.listdir(full_path_base_dir) if file.endswith('.pdf')]
        if len(list_of_files) &lt; 1:
            logger.info('no pdf files found in the target directory')
            return renamed_counter, total_counter
        else:
            logger.info(str(len(list_of_files)) + ' files found in the target directory!')
        loop_type = select_loop_type()
        for current_file in list_of_files:
            total_counter += 1
            fingerprint = hash_file(full_path_base_dir + '/' + current_file)
            logger.info('*' * 80)
            logger.info('[Current file name] : ' + current_file)
            logger.debug('[Current file hash] : ' + fingerprint)
            logger.debug('[loop_type] : ' + loop_type)
            if loop_type == '2':
                answer = confirm_to_continue()
                if answer is False:
                    continue
            if fingerprint not in file_fingerprints:
                file_fingerprints.append(fingerprint)
                found_title = search_candidate_title(full_path_base_dir, current_file)
                if found_title is not None:
                    renamed = do_rename(full_path_base_dir + '/' + current_file, full_path_base_dir + '/' + found_title)
                    if renamed:
                        move_file(full_path_base_dir + '/' + found_title, full_path_base_dir + '/auto_renamed_pdf', found_title)
                        renamed_counter += 1
            else:
                logger.warning('Another file with the same content (hash) was found in the source directory!')
                logger.info('Skipping file: ' + current_file + ' adding prefix `duplicated_`to it')
                os.rename(full_path_base_dir + '/' + current_file, full_path_base_dir + '/duplicated_' + current_file)
    else:
        logger.error('Directory does not exist!')
    return renamed_counter, total_counter

def rename_target_file(src_dir, filename):
    fullpath_filename = src_dir + '/' + filename
    if os.path.isfile(fullpath_filename):
        if os.path.abspath(fullpath_filename).endswith('.pdf'):
            found_title = search_candidate_title(src_dir, filename)
            if found_title is not None:
                renamed = do_rename(fullpath_filename, src_dir + '/' + found_title)
                if renamed:
                    move_file(src_dir + '/' + found_title, src_dir + '/auto_renamed_pdf', found_title)
                return True
        else:
            logger.debug("File is not a pdf!")
            return False
    else:
        logger.error("File does not exist!")
        return False

def main():
    print_header()
    base_dir, filename = validate_arguments(sys.argv)
    signal.signal(signal.SIGINT, keyboardInterruptHandler)
    target_path = base_dir + '/' + filename
    logger.info('[Target Path]: ' + target_path)
    rename_counter = 0
    if os.path.isdir(target_path):
        rename_counter, total_counter = rename_files_in_dir(base_dir)
        logger.info('*' * 80)
        logger.info('Finished =&gt; Total files: ' + str(total_counter) + ' Renamed files: ' + str(rename_counter))
    else:
        renamed = rename_target_file(base_dir, filename)
        if renamed:
            rename_counter += 1
        logger.info('*' * 80)
        logger.info('Finished =&gt; Renamed files : ' + str(rename_counter))

if __name__ == "__main__":
    main()


    </pre>    
    
    <div class="comment-box">
      Reference:
      <a href="https://github.com/heversonbr/scientific-paper-pdf-rename" title="https://github.com/heversonbr/scientific-paper-pdf-rename">https://github.com/heversonbr/scientific-paper-pdf-rename</a>
    </div>
    
  </main>
  <footer class="site-footer">
    <p><a href="#" aria-label="Back to top"><img src="/assets/Rope_(Old).gif" alt="Back to top" width="32" height="32" loading="lazy"></a>2024-12-17 20:45:31<a href="/" aria-label="Homepage">&#8505; infoBAG</a></p>
  </footer>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://ib.bsb.br/llm-renamer/"
    },
    "headline": "Rename files using llm.datasette.io",
    "description": "",
    "datePublished": "2024-06-02T03:00:00+00:00",
    "dateModified": "2024-09-20T02:37:06+00:00",
    "author": {
      "@type": "Person",
      "name": "Author"
    },
    "publisher": {
      "@type": "Organization",
      "name": "infoBAG",
      
    }
    
  }
  </script>  
  <script src="/assets/js/prism.js" defer></script>
</body>
</html>
