<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      
        postmarketOS-powered Kubernetes cluster - infoBAG
      
    </title>
    <meta name="title" content="postmarketOS-powered Kubernetes cluster - infoBAG" />
    <meta name="description" content="">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ib.bsb.br/postmarketos-powered-kubernetes-cluster/">
    <meta property="og:title" content="postmarketOS-powered Kubernetes cluster - infoBAG">
    <meta property="og:description" content="">
    <meta property="og:image" content="/favicon.ico">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ib.bsb.br/postmarketos-powered-kubernetes-cluster/">
    <meta name="twitter:title" content="postmarketOS-powered Kubernetes cluster - infoBAG">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/favicon.ico">
    <link rel="canonical" href="https://ib.bsb.br/postmarketos-powered-kubernetes-cluster/">
    <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">
    
      <meta name="keywords" content="scratchpad">
      
        <meta property="article:tag" content="scratchpad">
      
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/style.css">
  </head>
  <body class="post-content-body">
    <header class="header-container">
      <nav aria-label="Main navigation" class="header-content">
        <a href="/" aria-label="Home">
          <img src="/favicon.ico" alt="Home" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/tags" aria-label="Tags">
          <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/send" aria-label="send">
          <img src="/assets/rot.gif" alt="send" class="favicon search-link" width="32" height="32" loading="lazy">
        </a> 
        <a href="/created" aria-label="archive created">
          <img src="/assets/Loose_Stone_Pile.gif" alt="archive created" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/events" aria-label="Events">
          <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/modified" aria-label="archive modified">
          <img src="/assets/Hole_(Rock).gif" alt="archive modified" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
    </nav>
      <h5 class="post-title">
        <a href="#bottom-of-page" aria-label="Go to bottom">
          postmarketOS-powered Kubernetes cluster
        </a>
      </h5>
      <div class="post-meta">
        <time datetime="2025-03-16T00:00:00+00:00" class="post-date">
          16 Mar 2025
        </time>
        
          <span class="post-updated">
            ↣
            <time datetime="2025-03-16T13:57:04+00:00">
              16 Mar 2025
            </time>
          </span>
        
        
          <p class="post-slug">
            Slug: <a href="https://ib.bsb.br/postmarketos-powered-kubernetes-cluster" class="tag">postmarketos-powered-kubernetes-cluster</a>
          </p>
        
        
          <p class="post-tags">
            Tags:
            
              <a href="https://ib.bsb.br/tags/#scratchpad" class="tag">scratchpad</a>
            
          </p>
        
      </div>
      <div class="post-actions">
        <div class="page-stats mt-3" role="status" aria-label="Page statistics">
      
      <span class="badge bg-primary">
        25890 characters
      </span>
        <span class="separator mx-2" aria-hidden="true">•</span>
        <span class="badge bg-primary">
        3973 words
      </span>
      </div>
        <div class="action-buttons d-flex flex-wrap gap-2">
          
            
              <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2025-03-16-postmarketos-powered-kubernetes-cluster.md"
                    method="GET"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="d-inline-block">
                <button type="submit" class="btn btn-danger" aria-label="Edit page content">
                  <span class="button-text">Improve this page?</span>
                  <span class="info-text">aberto.</span>
                </button>
              </form>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2025-03-16-postmarketos-powered-kubernetes-cluster.md"
                  method="GET"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="d-inline-block">
              <button type="submit" class="btn btn-danger" aria-label="View page revision history">
                View revision history
              </button>
            </form>
          
        </div>
      </div>
    </header>
    <main class="content">
      <article class="post-wrapper">
        <div class="post-content-body">
          
<ul><li><a href="#introduction">Introduction</a></li><li><a href="#what-are-raspberry-pis-good-for">What are Raspberry Pis good for?</a></li><li><a href="#whats-so-compelling-about-old-smartphones">What’s so compelling about old smartphones?</a><ul><li><a href="#comparison">Comparison</a></li></ul></li><li><a href="#whats-bad-about-linux-on-smartphones">What’s bad about Linux on smartphones?</a><ul><li><a href="#no-support-for-mainline-linux">No support for mainline Linux</a></li><li><a href="#unlocking-the-bootloader-can-be-tricky">Unlocking the bootloader can be… tricky</a></li><li><a href="#gpl-is-not-always-respected">GPL is not always respected</a></li><li><a href="#your-device-is-not-supported">Your device is not supported</a></li></ul></li><li><a href="#what-is-postmarketos">What is postmarketOS?</a></li><li><a href="#state-of-linux-on-arm">State of Linux on ARM</a></li><li><a href="#setting-up-a-node">Setting up a node</a><ul><li><a href="#lessons-learned">Lessons learned</a></li><li><a href="#oneplus-5t-dumpling">OnePlus 5T (dumpling)</a><ul><li><a href="#connecting-the-device-to-the-wi-fi">Connecting the device to the Wi-Fi</a></li><li><a href="#using-the-device-as-a-kubernetes-node">Using the device as a Kubernetes node</a><ul><li><a href="#installing-k3s">Installing <code class="language-plaintext highlighter-rouge">k3s</code></a></li><li><a href="#configuring-k3s-agent">Configuring <code class="language-plaintext highlighter-rouge">k3s</code> agent</a></li><li><a href="#starting-k3s">Starting <code class="language-plaintext highlighter-rouge">k3s</code></a></li><li><a href="#missing-kernel-features">Missing kernel features</a></li><li><a href="#recompiling-the-kernel">Recompiling the kernel</a></li><li><a href="#trying-again">Trying again</a></li><li><a href="#network-issues">Network issues</a></li><li><a href="#the-solution">The solution</a></li><li><a href="#final-steps">Final steps</a></li></ul></li></ul></li><li><a href="#oneplus-8-pro-instantnoodlep">OnePlus 8 Pro (instantnoodlep)</a><ul><li><a href="#a-missing-wi-fi-chip">A missing Wi-Fi chip</a></li><li><a href="#using-the-newly-built-dtb">Using the newly built DTB</a></li><li><a href="#trying-one-small-change-at-the-time">Trying one small change at the time</a></li><li><a href="#backlight">Backlight</a></li></ul></li></ul></li><li><a href="#conclusion">Conclusion</a><ul><li><a href="#pre-built-images">Pre-built images</a></li></ul></li></ul>
          <p>Having a few Raspberry Pi 4s at my disposal, I found myself somewhat dissatisfied with their processing capabilities and power management features.
This led me to explore alternative solutions, particularly given the collection of old smartphones gathering dust in my drawer. 
These devices, while outdated for daily use, still pack considerable computing power.
In this article, I’ll walk through how I transformed these old smartphones into a functional Kubernetes cluster using postmarketOS, giving them a second life as computing nodes.</p>

<!--more-->

<!-- toc -->
  <h2 id="introduction">
    
    
     <a href="#introduction">#</a><a href="#" aria-label="Back to top">Introduction</a>
        
    
  </h2>
      

<p>Applications nowadays are getting more resource-intensive. Depending on your use case, some of your homelab services might need a lot of processing power and memory.</p>

<p>Some of my (current and future) workloads include:</p>
<ul>
  <li>CI/CD pipelines</li>
  <li>Photo library software such as <a href="https://immich.app/">Immich</a>
    <ul>
      <li>Resizing / converting images</li>
      <li>Running face recognition</li>
    </ul>
  </li>
  <li><a href="https://forgejo.org/">Forgejo</a> (Git)</li>
  <li><a href="https://woodpecker-ci.org/">Woodpecker CI</a></li>
  <li><a href="https://github.com/dani-garcia/vaultwarden">Vaultwarden</a></li>
  <li><a href="https://plex.tv">Plex</a> / <a href="https://jellyfin.org/">Jellyfin</a></li>
  <li><a href="https://github.com/docmost/docmost/">Docmost</a></li>
  <li><a href="https://github.com/teslamate-org/teslamate">Teslamate</a></li>
  <li><a href="https://prometheus.io/">Prometheus</a></li>
  <li><a href="https://grafana.com/">Grafana</a></li>
  <li><a href="https://github.com/lobehub/lobe-chat">LobeChat</a></li>
  <li><a href="https://vikunja.io/">Vikunja</a> (To-Do list)</li>
  <li><a href="https://github.com/gitpod-io/openvscode-server">openvscode-server</a></li>
  <li>…</li>
</ul>

<p>Although it’s rare that single services are so demanding, certain pipelines or workflows can be quite resource-intensive. 
The solution is usually to scale horizontally - but this can be expensive (in terms of money, amount of devices, power consumption, physical space).
Buying new devices is not the most sustainable solution, especially when you’re surrounded by old devices that have a computing power that is comparable or even better than that of your next purchase.</p>
  <h2 id="what-are-raspberry-pis-good-for">
    
    
     <a href="#what-are-raspberry-pis-good-for">#</a><a href="#" aria-label="Back to top">What are Raspberry Pis good for?</a>
        
    
  </h2>
      

<p>Raspberry Pis excel at running small services and functioning as <a href="https://gokrazy.org/">appliances</a>. Their GPIO capabilities make them perfect for physical computing projects, but as Kubernetes nodes, they have some limitations.</p>

<p>Here are the main challenges I’ve encountered:</p>
<ul>
  <li>Physical size: With a case, they’re relatively bulky for a computing node</li>
  <li>Power management: One power supply per device is often needed</li>
  <li>Power stability: Multi-port power supplies can be unreliable, causing simultaneous outages across nodes</li>
  <li>Performance: Limited computing power compared to modern mobile processors</li>
  <li>Price: <a href="https://www.digitec.ch/en/s1/product/raspberry-pi-new-raspberry-pi-5-8gb-development-boards-kits-38955607">A Raspberry Pi 5 with 8 GB of RAM</a> costs around <a href="https://www.xe.com/currencyconverter/convert/?Amount=85&amp;From=CHF&amp;To=USD">85 CHF</a>: there are cheaper and more sustainable solutions</li>
</ul>

<p>While I have used several Raspberry Pis for other projects (like my wedding photobooth, which I’ll detail in another post), their I/O capabilities are often underutilized when serving purely as compute nodes.</p>
  <h2 id="whats-so-compelling-about-old-smartphones">
    
    
     <a href="#whats-so-compelling-about-old-smartphones">#</a><a href="#" aria-label="Back to top">What’s so compelling about old smartphones?</a>
        
    
  </h2>
      

<p>On one hand, a Raspberry Pi 4 is a great device for running small services and provides
a very good interface between hardware and software. On the other hand, old smartphones are often discarded due to their outdated software, but they still have a lot of computing power and memory.</p>

<p>Old devices are filling marketplaces and drawers. For a very low price, usually 0 if the device sits in your drawer, you can get a device with an octa-core CPU, 6/8 GB of RAM and 128+ GB of storage.
If you compare this with a Raspberry Pi 4, using an old smarthphone as a computing node could be a good idea.</p>
  <h3 id="comparison">
    
    
     <a href="#comparison">#</a><a href="#" aria-label="Back to top">Comparison</a>
        
    
  </h3>
      

<p>Here is a small comparison of some of the devices I have at my disposal:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Device</th>
      <th style="text-align: right">Year</th>
      <th style="text-align: right">Cores</th>
      <th style="text-align: right">Frequencies</th>
      <th style="text-align: right">RAM</th>
      <th style="text-align: right">Storage</th>
      <th>Storage Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><a href="https://www.gsmarena.com/xiaomi_redmi_note_11_pro_5g-11333.php">Xiaomi Redmi Note 11 Pro</a></td>
      <td style="text-align: right">2022</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">2x2.2 GHz, 6x1.7 GHz</td>
      <td style="text-align: right">4/6/8GB</td>
      <td style="text-align: right">64/128GB</td>
      <td>UFS 2.2</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://www.gsmarena.com/oneplus_nord-10289.php">Oneplus Nord</a></td>
      <td style="text-align: right">2020</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">1x2.4 GHz, 1x2.2 GHz, 6x1.8 GHz</td>
      <td style="text-align: right">6/8/12 GB</td>
      <td style="text-align: right">64-256 GB</td>
      <td>UFS 2.1</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://wiki.postmarketos.org/wiki/OnePlus_8_Pro_(oneplus-instantnoodlep)">OnePlus 8 Pro</a></td>
      <td style="text-align: right">2020</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">1x2.84 GHz, 3x2.42GHz, 4x1.8 GHz</td>
      <td style="text-align: right">8/12 GB</td>
      <td style="text-align: right">128/256 GB</td>
      <td>UFS 3.0</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://en.wikipedia.org/wiki/Raspberry_Pi_4">Raspberry Pi 4</a></td>
      <td style="text-align: right">2019</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">1.5 GHz</td>
      <td style="text-align: right">2-8 GB</td>
      <td style="text-align: right">External</td>
      <td>microSD</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://wiki.postmarketos.org/wiki/OnePlus_5T_(oneplus-dumpling)">OnePlus 5T</a></td>
      <td style="text-align: right">2017</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">4x 2.45 GHz, 4x1.9 GHz</td>
      <td style="text-align: right">6/8 GB</td>
      <td style="text-align: right">64/128 GB</td>
      <td>UFS 2.1</td>
    </tr>
  </tbody>
</table>

<p>There’s also inherent value in using smartphones: they come with built-in batteries that function as UPS (Uninterruptible Power Supply) units, and their integrated displays can serve as dashboard monitors. These features provide additional utility without requiring extra hardware components. You can of course turn off the backlight of the display to save power if you don’t need it.</p>
  <h2 id="whats-bad-about-linux-on-smartphones">
    
    
     <a href="#whats-bad-about-linux-on-smartphones">#</a><a href="#" aria-label="Back to top">What’s bad about Linux on smartphones?</a>
        
    
  </h2>
      
  <h3 id="no-support-for-mainline-linux">
    
    
     <a href="#no-support-for-mainline-linux">#</a><a href="#" aria-label="Back to top">No support for mainline Linux</a>
        
    
  </h3>
      

<p>Most of the Android smartphones out there have poor support for <em>mainline</em> Linux. The kernel running on the average Android device is generally a heavy customized
version of the Linux kernel. This makes things complicated, and reduces security and performance.</p>

<p>While this is not a problem of the smartphones per se, it’s going to be a problem if you intend to use them as Kubernetes nodes, or use them for anything else that’s not Android.</p>
  <h3 id="unlocking-the-bootloader-can-be-tricky">
    
    
     <a href="#unlocking-the-bootloader-can-be-tricky">#</a><a href="#" aria-label="Back to top">Unlocking the bootloader can be… tricky</a>
        
    
  </h3>
      

<blockquote>
  <p>[!WARNING]<br />
Unlocking the bootloader will delete all your data. Do not run the following commands if you haven’t backed up your data.</p>
</blockquote>

<p>Not all the devices can be unlocked easily. While some manufacturers allow you to <code class="language-plaintext highlighter-rouge">fastboot oem unlock</code> your device directly, others require you to perform long processes to unlock the bootloader, and sometimes you can’t unlock it at all.</p>

<p>If you’re about to buy an used device for this purpose, make sure the brand is known for allowing bootloader unlocking.</p>

<p>To save you some time, try to generally avoid:</p>
<ul>
  <li>Xiaomi
    <ul>
      <li>Unlocking the bootloader takes from 7 to 30 days to unlock</li>
      <li>During this time, you need to keep the same Xiaomi account connected to the device,</li>
      <li>You’ll have to use a Xiaomi-provided application… but <a href="https://github.com/topminipie/awesome-xiaomi-bootloader-unlock">there are alternatives</a></li>
    </ul>
  </li>
  <li>Huawei / Honor
    <ul>
      <li>You can’t unlock the bootloader anymore</li>
    </ul>
  </li>
</ul>

<p>… and prefer:</p>

<ul>
  <li>Google</li>
  <li>OnePlus</li>
  <li>FairPhone</li>
</ul>

<p>See a complete list on <a href="https://github.com/melontini/bootloader-unlock-wall-of-shame">Bootloader Unlock Wall Of Shame</a>.</p>
  <h3 id="gpl-is-not-always-respected">
    
    
     <a href="#gpl-is-not-always-respected">#</a><a href="#" aria-label="Back to top">GPL is not always respected</a>
        
    
  </h3>
      

<p>The Linux kernel is licensed under the GPL, which means that if you modify it, you have to share your modifications.<br />
Despite this, many manufacturers are slow to release the kernel sources, or don’t release them at all.</p>

<p>One example of this is <a href="https://github.com/MiCode/Xiaomi_Kernel_OpenSource/issues">Xiaomi</a> (<a href="https://news.ycombinator.com/item?id=35184859">HN discussion</a>), 
which has been criticized for not releasing the kernel sources for some of their devices.</p>
  <h3 id="your-device-is-not-supported">
    
    
     <a href="#your-device-is-not-supported">#</a><a href="#" aria-label="Back to top">Your device is not supported</a>
        
    
  </h3>
      

<p>This is not really a problem caused by anyone really, there will always be a device that is not supported by the community - and sometimes <em>you</em> will be the one
that has to put in the legwork to make it work.</p>

<p>I’m by no means a kernel expert, but I’ve tried this road <a href="https://github.com/pixelc-linux/documentation">a couple</a> <a href="https://github.com/linux-surface/surface-pro-x/issues?q=author%3Adenysvitali">of times</a> - and, while it might be challenging, it’s a very rewarding process and you get to learn a lot about how these devices work. 
In the next sections you’ll see what I mean by this.</p>

<p>Despite this, you can still play it safe and buy an used device that is already (partially) <a href="https://wiki.postmarketos.org/wiki/Devices">supported by the community</a>.</p>

<p>Before you complain about the lack of support for your device: make sure to also check the “Testing” section of the <a href="https://wiki.postmarketos.org/wiki/Devices">postmarketOS Devices</a> page:
it’s easy to miss that part and might sound scary, but a “testing” device is generally just a device that doesn’t have full support for all the features and that doesn’t have a ready to use firmware image. With <a href="https://docs.postmarketos.org/pmbootstrap/usage.html"><code class="language-plaintext highlighter-rouge">pmbootstrap</code></a> setting up an already upstreamed testing device is really a breeze!</p>
  <h2 id="what-is-postmarketos">
    
    
     <a href="#what-is-postmarketos">#</a><a href="#" aria-label="Back to top">What is postmarketOS?</a>
        
    
  </h2>
      

<p>Okay, we mentioned it a couple of times already, but I didn’t explain what the heck <a href="https://postmarketos.org/">postmarketOS</a> is: the shortest way to describe it is by saying that it’s a rolling Linux distribution for smartphones based on <a href="https://alpinelinux.org/">Alpine Linux</a>.</p>

<p>The interesting part of this distribution is that <em>it’s meant to be run with the mainline Linux kernel</em>. This effectively means that postmarketOS is not just another Android ROM: it is the key to the long-term support of the devices.</p>

<p>Whilst I haven’t seen anyone (yet) really using pmOS as a daily driver, and I myself am not doing that either (I’m using <a href="https://grapheneos.org/">GrapheneOS</a>).</p>

<p>Being a Linux distribution based on Alpine, you can really use your smartphone as if it’s a computer (or in my case, a server): this means that you can install for example <a href="https://swaywm.org/">sway</a>, <a href="https://kde.org/">KDE</a> or literally <a href="https://wiki.postmarketos.org/wiki/Category:Interface">any other desktop environment / user interfaces</a> you want and run your favorite applications.</p>
  <h2 id="state-of-linux-on-arm">
    
    
     <a href="#state-of-linux-on-arm">#</a><a href="#" aria-label="Back to top">State of Linux on ARM</a>
        
    
  </h2>
      

<p>With the <a href="https://en.wikipedia.org/wiki/Apple_M1">“recent” Apple Silicon push</a> and the amazing work of <a href="https://github.com/aarch64-laptops">aarch64-laptops</a> / <a href="https://www.linaro.org/">Linaro</a> (<a href="https://old.linaro.org/blog/porting-linux-to-aarch64-laptops/">thanks</a> Bjorn &amp; team!), Linux on ARM is growing fast and it’s supported by many distros / forks (such as <a href="https://archlinuxarm.org/">Arch Linux ARM</a>, <a href="https://wiki.alpinelinux.org/wiki/Alpine_on_ARM">Alpine Linux</a>, <a href="https://wiki.debian.org/Arm64Port#Official_Debian_port">Debian</a>, …) - so using a smartphone as a server / computer is not that crazy anymore as mobile devices aren’t that different from (new) laptops anymore.</p>

<p>There are still a few assumptions made by some software distributors (especially Docker Images) where they assume that you’re running on <code class="language-plaintext highlighter-rouge">x86_64</code>, but this is getting better and better, especially given the “recent” additions of <a href="https://docs.docker.com/build/building/multi-platform/">multi-platform builds</a> on Docker.</p>

<p>If that’s your thing, you can also connect a mouse, keyboard (and monitor) to your device and use it as a desktop computer.</p>
  <h2 id="setting-up-a-node">
    
    
     <a href="#setting-up-a-node">#</a><a href="#" aria-label="Back to top">Setting up a node</a>
        
    
  </h2>
      
  <h3 id="lessons-learned">
    
    
     <a href="#lessons-learned">#</a><a href="#" aria-label="Back to top">Lessons learned</a>
        
    
  </h3>
      

<p>Before I start with the details, I want to immediately share some lessons learned - so that you can avoid some of the mistakes I made:</p>

<ul>
  <li>
    <p><strong>Don’t spend half a day debugging <code class="language-plaintext highlighter-rouge">iptables</code></strong>: postmarketOS comes with <code class="language-plaintext highlighter-rouge">nftables</code> and the default rules in <code class="language-plaintext highlighter-rouge">/etc/nftables.nft</code> are the reason why your Kubernetes network might get messed up</p>
  </li>
  <li>
    <p>Docker, Kubernetes and K3s require some kernel modules / configs to be enabled:</p>
    <ul>
      <li>
        <p>Try to run a Docker container first, and eventually use <a href="https://github.com/moby/moby/blob/master/contrib/check-config.sh">moby’s <code class="language-plaintext highlighter-rouge">check-config.sh</code></a></p>
      </li>
      <li>
        <p>Use <a href="https://github.com/k3s-io/k3s/blob/master/contrib/util/check-config.sh">k3s’s <code class="language-plaintext highlighter-rouge">check-config.sh</code></a> to check if your kernel is ready. In my case (<a href="https://wiki.postmarketos.org/wiki/OnePlus_5T_(oneplus-dumpling)"><code class="language-plaintext highlighter-rouge">dumpling</code></a> was missing some kernel configs, but <a href="https://wiki.postmarketos.org/wiki/OnePlus_8_Pro_(oneplus-instantnoodlep)"><code class="language-plaintext highlighter-rouge">instantnoodlep</code></a> was fine)</p>
      </li>
      <li>
        <p>Kubernetes doesn’t come with a <code class="language-plaintext highlighter-rouge">check-config.sh</code> file - but your Container Network Interface (CNI) might require some kernel features that Docker / K3s don’t need. In the case of Flannel, make sure you have most / all the <code class="language-plaintext highlighter-rouge">CONFIG_NETFILTER_XTABLES</code> options enabled in your kernel, as well as <code class="language-plaintext highlighter-rouge">CONFIG_VXLAN</code>.</p>
      </li>
    </ul>
  </li>
</ul>
  <h3 id="oneplus-5t-dumpling">
    
    
     <a href="#oneplus-5t-dumpling">#</a><a href="#" aria-label="Back to top">OnePlus 5T (dumpling)</a>
        
    
  </h3>
      

<p>According to the <a href="https://wiki.postmarketos.org/wiki/OnePlus_5T_(oneplus-dumpling)">postmarketOS wiki</a>, the OnePlus 5T is a “testing” device, which means that it’s not fully supported yet. Despite this, I was able to run postmarketOS on it without any issue.</p>

<p>The most important features for me (Wi-Fi) and USB ethernet worked out of the box.</p>

<p>If, like me, this is your first time running postmarketOS - one nice feature is that they support USB ethernet out of the box. Initially, I thought this meant supporting an USB to Ethernet adapter, but it actually means that you can connect your smartphone to your computer, and this will be recognized as an USB ethernet device.</p>

<pre><code class="language-plain">% ip addr show enp0s20f0u1
149: enp0s20f0u1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether ca:fe:ba:be:00:42 brd ff:ff:ff:ff:ff:ff
    inet 172.16.42.2/24 brd 172.16.42.255 scope global dynamic noprefixroute enp0s20f0u1
       valid_lft 3628776sec preferred_lft 3628776sec
    inet6 fe80::504a:1ee0:5015:da8d/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
</code></section>

<p>With this, you can simply SSH into your device and start working on it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">$ </span>ssh root@172.16.42.1
Welcome to postmarketOS! o/

This distribution is based on Alpine Linux.
First <span class="nb">time </span>using postmarketOS? Make sure to <span class="nb">read </span>the cheatsheet <span class="k">in </span>the wiki:

-&gt; https://postmarketos.org/cheatsheet

You may change this message by editing /etc/motd.
dumpling:~#
</code></section></div></div>

<blockquote>
  <p>[!TIP]<br />
For whatever reason, after many tries, I started using the wrong IP (<code class="language-plaintext highlighter-rouge">172.16.42.2</code>) to SSH into the device and got confused on why it wasn’t accepting my device password anymore. Don’t be as dumb as me and double check the IP you’re <code class="language-plaintext highlighter-rouge">ssh</code>ing into, which should be <code class="language-plaintext highlighter-rouge">172.16.42.1</code>.</p>
</blockquote>
  <h4 id="connecting-the-device-to-the-wi-fi">
    
    
     <a href="#connecting-the-device-to-the-wi-fi">#</a><a href="#" aria-label="Back to top">Connecting the device to the Wi-Fi</a>
        
    
  </h4>
      

<p>Now that you’re able to connect to the device, you should be able to see <code class="language-plaintext highlighter-rouge">wlan0</code> as an interface:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">$ </span>ip addr show wlan0
4: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP qlen 1000
    <span class="nb">link</span>/ether 02:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
</code></section></div></div>

<p>this means that you’re ready to connect to your Wi-Fi network!</p>

<p>You can check the list of Wi-Fi networks with <a href="https://wiki.archlinux.org/title/NetworkManager">NetworkManager</a>’s CLI:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">$ </span>nmcli d wifi
IN-USE  BSSID              SSID                   MODE   CHAN  RATE        SIGNAL  BARS  SECURITY
        00:00:00:00:00:00  MyNetwork              Infra  1     54 Mbit/s  100     ▂▄▆█  WPA2
</code></section></div></div>

<p>If you want to connect to a network, you can use the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code>nmcli d wifi connect MyNetwork <span class="nt">--ask</span>
</code></section></div></div>

<p>this assumes that the network is visible, and it will ask you for the password.</p>

<p>If you want to connect to a hidden network, you can use the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">HIDDEN_SSID</span><span class="o">=</span><span class="s2">"your_ssid"</span>
nmcli d wifi connect <span class="nt">--ask</span> <span class="s2">"</span><span class="nv">$HIDDEN_SSID</span><span class="s2">"</span> name <span class="s2">"</span><span class="nv">$HIDDEN_SSID</span><span class="s2">"</span> hidden <span class="nb">yes</span>
</code></section></div></div>

<p>If everything went well, NetworkManager will tell you that you’re connected to the network:</p>

<pre><code class="language-plain">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/1)
</code></section>
  <h4 id="using-the-device-as-a-kubernetes-node">
    
    
     <a href="#using-the-device-as-a-kubernetes-node">#</a><a href="#" aria-label="Back to top">Using the device as a Kubernetes node</a>
        
    
  </h4>
      

<blockquote>
  <p>[!IMPORTANT]
This part shows how the process of setting up Kubernetes on <code class="language-plaintext highlighter-rouge">dumpling</code> should look like - unfortunately this isn’t exactly how it should be done as of today. Do not follow all these steps blindly - read the full section first :)</p>
</blockquote>

<p>Since our goal is to use this device as a Kubernetes node, we’ll have to configure the device accordingly. In my setup, I’ll be using <a href="https://k3s.io/">k3s</a>, a lightweight Kubernetes distribution that is perfect for low-resource devices.</p>

<p>This part assumes that you’ve already setup the master node(s) somewhere else, but if you want this to be the master node, you can adapt my steps and follow the <a href="https://docs.k3s.io/installation/configuration">documentation</a>.</p>

<p>Assuming:</p>
<ul>
  <li>A master node with the IP <code class="language-plaintext highlighter-rouge">192.168.10.11</code></li>
  <li>A token to join the cluster <code class="language-plaintext highlighter-rouge">000000::server::f0000</code></li>
</ul>
  <h5 id="installing-k3s">
    
    
     <a href="#installing-k3s">#</a><a href="#" aria-label="Back to top">Installing <code class="language-plaintext highlighter-rouge">k3s</code></a>
        
    
  </h5>
      

<p>If you haven’t done so during the pmOS wizard, you can <code class="language-plaintext highlighter-rouge">apk add k3s</code> to install k3s on your device.</p>
  <h5 id="configuring-k3s-agent">
    
    
     <a href="#configuring-k3s-agent">#</a><a href="#" aria-label="Back to top">Configuring <code class="language-plaintext highlighter-rouge">k3s</code> agent</a>
        
    
  </h5>
      

<p>Create an <code class="language-plaintext highlighter-rouge">/etc/rancher/k3s/config.yaml</code> file as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><section><code><span class="na">token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">000000::server::f0000"</span>
<span class="na">server</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://192.168.10.11:6443"</span>
<span class="na">prefer-bundled-bin</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">flannel-iface</span><span class="pi">:</span> <span class="s">wlan0</span>
<span class="na">with-node-id</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">node-label</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">com.example.mylabel/type=foo</span>
    <span class="pi">-</span> <span class="s">com.example.mylabel/net=wireless</span>
</code></section></div></div>

<p>This configuration file will tell <code class="language-plaintext highlighter-rouge">k3s</code> to connect to the master node, and to use the <code class="language-plaintext highlighter-rouge">wlan0</code> interface for the <a href="https://www.sysspace.net/post/kubernetes-networking-explained-flannel-network-model_">Flannel</a> network.</p>

<p>Make sure the <code class="language-plaintext highlighter-rouge">/etc/conf.d/k3s</code> file has the following content:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/usr/libexec/cni/:</span><span class="nv">$PATH</span><span class="s2">"</span>
<span class="nv">K3S_EXEC</span><span class="o">=</span><span class="s2">"agent"</span>
<span class="nv">K3S_OPTS</span><span class="o">=</span><span class="s2">""</span>
</code></section></div></div>

<p>This will make sure that we start <code class="language-plaintext highlighter-rouge">k3s</code> in agent mode, and that we can use the <code class="language-plaintext highlighter-rouge">cni</code> binaries (for flannel).</p>
  <h5 id="starting-k3s">
    
    
     <a href="#starting-k3s">#</a><a href="#" aria-label="Back to top">Starting <code class="language-plaintext highlighter-rouge">k3s</code></a>
        
    
  </h5>
      

<p>You can now start <code class="language-plaintext highlighter-rouge">k3s</code> (once) and enable it at boot:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code>service k3s start
rc-update add k3s
</code></section></div></div>

<p>You can now check the logs with <code class="language-plaintext highlighter-rouge">tail -f /var/log/k3s.log</code> and see if the node is joining the cluster…</p>

<p>… except that, it won’t work.</p>
  <h5 id="missing-kernel-features">
    
    
     <a href="#missing-kernel-features">#</a><a href="#" aria-label="Back to top">Missing kernel features</a>
        
    
  </h5>
      

<p>If you haven’t skipped over the “Lessons learned” section, you might have noticed that I mentioned that you should check if your kernel is ready for Docker / Kubernetes / K3s. We generally take for granted that the kernels shipped with our distributions are ready for using containers and orchestrators, but this is not always the case.</p>

<p>Specifically, in the case of the <code class="language-plaintext highlighter-rouge">dumpling</code> kernel (<code class="language-plaintext highlighter-rouge">msm8998</code>), it seems like the <a href="https://gitlab.postmarketos.org/postmarketOS/pmaports/-/blob/master/device/testing/linux-postmarketos-qcom-msm8998/config-postmarketos-qcom-msm8998.aarch64">kernel config</a> is missing some key features that are required to run <code class="language-plaintext highlighter-rouge">docker</code> and <code class="language-plaintext highlighter-rouge">k3s</code>.</p>

<p>You can get a list of all the missing configs by running k3s’s <a href="https://github.com/k3s-io/k3s/blob/master/contrib/util/check-config.sh"><code class="language-plaintext highlighter-rouge">check-config.sh</code></a> script.</p>
  <h5 id="recompiling-the-kernel">
    
    
     <a href="#recompiling-the-kernel">#</a><a href="#" aria-label="Back to top">Recompiling the kernel</a>
        
    
  </h5>
      

<p>Thankfully, changing the kernel configuration is pretty straightforward. You can follow the <a href="https://wiki.postmarketos.org/wiki/Kernel_configuration/Adjusting_one_kernel">postmarketOS Kernel configuration/Adjusting one kernel</a> to get started.</p>

<p>In my case, it was as easy as running:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><section><code>pmbootstrap kconfig edit linux-postmarketos-qcom-msm8998
</code></section></div></div>

<p>I then <code class="language-plaintext highlighter-rouge">/</code> searched for the needed config entries as reported by <code class="language-plaintext highlighter-rouge">check-config.sh</code> and enabled them. This was enough to run some Docker containers, but apparently not enough to have a fully working Kubernetes node as the flannel network was not working.</p>

<p>For this, you’ll most likely need to enable all the <code class="language-plaintext highlighter-rouge">NETFILTER_XTABLES_*</code> options. Although probably unnecessary, you can find my kernel config <a href="https://pastebin.com/pnNXrhb0">here</a>.</p>
  <h5 id="trying-again">
    
    
     <a href="#trying-again">#</a><a href="#" aria-label="Back to top">Trying again</a>
        
    
  </h5>
      

<p>After recompiling the kernel, copying and installing resulting <code class="language-plaintext highlighter-rouge">.apk</code> file (<code class="language-plaintext highlighter-rouge">scp linux-postmarketos-qcom-msm8998-6.0-r2.apk root@dumpling</code> and <code class="language-plaintext highlighter-rouge">apk add -u linux-postmarketos-qcom-msm8998-6.0-r2.apk</code>) and rebooting, I was able to start <code class="language-plaintext highlighter-rouge">k3s</code> and see the node joining the cluster.</p>

<p>Unfortunately, in that moment, my cluster started having some issues. After a quick diagnosis, I found out that DNS resolution was broken. This made me realize the newly joined node was able to pull images from the internet, but the containers themselves were not able to reach the internet.</p>
  <h5 id="network-issues">
    
    
     <a href="#network-issues">#</a><a href="#" aria-label="Back to top">Network issues</a>
        
    
  </h5>
      

<p>To debug the network issues, I’ve used <code class="language-plaintext highlighter-rouge">netshoot</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code>kubectl run tmp-shell <span class="nt">--rm</span> <span class="nt">-i</span> <span class="nt">--tty</span> <span class="nt">--image</span> nicolaka/netshoot
</code></section></div></div>

<p>This spawned a shell in a container that had all the network tools I needed to debug the issue. Of course I had to make sure that the container was running on the affected node (I actually used a <code class="language-plaintext highlighter-rouge">DaemonSet</code> to make sure it was running on all the nodes).</p>

<p>The problems were:</p>

<ul>
  <li>None of the containers were able to reach the internet
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ping 1.1.1.1</code> was not working</li>
    </ul>
  </li>
  <li>Containers on the same network (node) were not able to reach each other
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ping 10.42.3.11</code> was not working from <code class="language-plaintext highlighter-rouge">10.42.3.13</code></li>
    </ul>
  </li>
  <li>Containers on different networks (on another node) were not able to reach each other
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ping 10.42.1.10</code> was not working from <code class="language-plaintext highlighter-rouge">10.42.0.3</code></li>
      <li>Flannel was likely not working here</li>
    </ul>
  </li>
</ul>

<pre><code class="language-plain"># tcpdump -i any icmp
tcpdump: WARNING: any: That device doesn't support promiscuous mode
(Promiscuous mode not supported on the "any" device)
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
11:22:21.229307 veth50680d5c P   IP 10.42.3.13 &gt; 10.42.3.11: ICMP echo request, id 10, seq 1, length 64
11:22:22.264132 veth50680d5c P   IP 10.42.3.13 &gt; 10.42.3.11: ICMP echo request, id 10, seq 2, length 64
11:22:23.288137 veth50680d5c P   IP 10.42.3.13 &gt; 10.42.3.11: ICMP echo request, id 10, seq 3, length 64
11:22:24.312629 veth50680d5c P   IP 10.42.3.13 &gt; 10.42.3.11: ICMP echo request, id 10, seq 4, length 64
11:22:25.336390 veth50680d5c P   IP 10.42.3.13 &gt; 10.42.3.11: ICMP echo request, id 10, seq 5, length 64

</code></section>

<p>After investigating further, I discovered that there was a problem with the packet forwarding: none of the packets were being forwarded. The strangest part was that the <code class="language-plaintext highlighter-rouge">iptables -t nat</code> rules were correct, and nothing strange was happening in the <code class="language-plaintext highlighter-rouge">FORWARD</code> chain.</p>

<p>This kept me busy for a very long time as I was going crazy trying to understand why the packets were being dropped despite being allowed by <code class="language-plaintext highlighter-rouge">iptables</code>…</p>
  <h5 id="the-solution">
    
    
     <a href="#the-solution">#</a><a href="#" aria-label="Back to top">The solution</a>
        
    
  </h5>
      

<p>As spoilered in the “Lessons learned” section, the issue was with the <code class="language-plaintext highlighter-rouge">nftables</code> rules that were blocking the traffic. This took me an incredible amount of time to figure out, because I assumed that the issue was with either flannel using wthe wrong interface, with the kernel configuration or with… iptables.</p>

<p>If you’re not aware of the difference between <code class="language-plaintext highlighter-rouge">iptables</code> and <code class="language-plaintext highlighter-rouge">nftables</code>, <a href="https://wiki.archlinux.org/title/Nftables"><code class="language-plaintext highlighter-rouge">nftables</code></a> is pretty much the new default in the Linux kernel (previously, it was <code class="language-plaintext highlighter-rouge">iptables</code>), and nowadays <code class="language-plaintext highlighter-rouge">iptables</code> <em>should</em> just be a frontend for <code class="language-plaintext highlighter-rouge">nftables</code>.</p>

<p>Unfortunately for me, the <code class="language-plaintext highlighter-rouge">nftables</code> rules were not visible from <code class="language-plaintext highlighter-rouge">iptables</code> (the opposite is true) - which made me investigate the wrong part of the system for a long time.</p>

<p>After adapting the <code class="language-plaintext highlighter-rouge">/etc/nftables.nft</code> file (as follows), the containers on the node were finally able to reach the internet and the other containers in the cluster.</p>

<pre><code class="language-plain">#!/usr/sbin/nft -f
# vim: set ts=4 sw=4:
# You can find examples in /usr/share/nftables/.

# Clear all prior state
flush ruleset

# The state of stateful objects saved on the nftables service stop.
include "/var/lib/nftables/*.nft"

# Rules
</code></section>
  <h5 id="final-steps">
    
    
     <a href="#final-steps">#</a><a href="#" aria-label="Back to top">Final steps</a>
        
    
  </h5>
      

<p>After fixing the issues with the network, I was able to run some workloads on the node. Since this node is connected via Wi-Fi and I can only get around 200 Mbit/s of DL and UL - I’ve marked this node with a label (<code class="language-plaintext highlighter-rouge">com.example.mylabel/net=wireless</code>) so that I can schedule workloads that are not latency or network intensive.</p>

<p>To finish the setup, I’ve created an Ansible playbook with the steps above and added one finishing touch:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo </span>0 <span class="o">&gt;</span> /sys/class/backlight/c994000.dsi.0/brightness
</code></section></div></div>

<p>This command completely turns off the backlight of the display, saving lots of power.</p>
  <h3 id="oneplus-8-pro-instantnoodlep">
    
    
     <a href="#oneplus-8-pro-instantnoodlep">#</a><a href="#" aria-label="Back to top">OnePlus 8 Pro (instantnoodlep)</a>
        
    
  </h3>
      

<p>After the experience with the OnePlus 5T, I decided it was time to extend my cluster by adding another device.
With the learnings from the previous experience and the promising features list (Wi-Fi marked as working, mainline kernel, USB Networking working), I decided to go with the OnePlus 8 Pro.</p>

<p>I’ve followed the same steps as before, and then, as soon as I wrote <code class="language-plaintext highlighter-rouge">ip link show wlan0</code>, I realized there was something wrong…</p>

<pre><code class="language-plain">$ ip link show wlan0
ip: can't find device 'wlan0'
</code></section>

<p>… what?</p>
  <h4 id="a-missing-wi-fi-chip">
    
    
     <a href="#a-missing-wi-fi-chip">#</a><a href="#" aria-label="Back to top">A missing Wi-Fi chip</a>
        
    
  </h4>
      

<p>After reading the <code class="language-plaintext highlighter-rouge">dmesg</code> output and trying to find references to the Wi-Fi / BT chip (QCA6390), I realized that the <a href="https://wiki.postmarketos.org/wiki/Device_Tree_(dtb)">Device Tree (dtb)</a> was missing the Wi-Fi / Bluetooth chip.</p>

<p>I wasn’t quickly able to spot the issue there, so I decided to look on the internet for answers - and that’s where I found something that at the time looked promising: <a href="https://patches.linaro.org/project/linux-input/patch/20240624-oneplus8-v1-7-388eecf2dff7@postmarketos.org/">a patch to add support for the OnePlus 8T (kebab)</a> (which is pretty much the same as the OnePlus 8 Pro).</p>

<p>I therefore decided to try out the patch - I cloned the kernel repository, applied the patch, compiled the DTS (<code class="language-plaintext highlighter-rouge">make dtbs</code>) and obtained the new <code class="language-plaintext highlighter-rouge">dtb</code> file.</p>
  <h4 id="using-the-newly-built-dtb">
    
    
     <a href="#using-the-newly-built-dtb">#</a><a href="#" aria-label="Back to top">Using the newly built DTB</a>
        
    
  </h4>
      

<p>Since I didn’t want to follow the full <code class="language-plaintext highlighter-rouge">.img</code> creating process, I decided to unpack the original <code class="language-plaintext highlighter-rouge">boot.img</code> file and re-pack it with my own <code class="language-plaintext highlighter-rouge">dtb</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">$ </span>unpack_bootimg <span class="nt">--boot_img</span> <span class="nv">$PMOS_ROOT</span>/chroot_rootfs_oneplus-instantnoodlep/boot/boot.img <span class="nt">--format</span><span class="o">=</span>mkbootimg
<span class="nv">$ </span><span class="nb">cp</span> ~/git/linux/arch/arm64/boot/dts/qcom/sm8250-oneplus-instantnoodlep.dtb /tmp/firmware/out/dtb
<span class="nv">$ </span>mkbootimg <span class="nt">--header_version</span> 2 <span class="nt">--kernel</span> out/kernel <span class="nt">--ramdisk</span> out/ramdisk <span class="nt">--dtb</span> out/dtb <span class="nt">--pagesize</span> 0x00001000 <span class="nt">--base</span> 0x00000000 <span class="nt">--kernel_offset</span> 0x00008000 <span class="nt">--ramdisk_offset</span> 0x01000000 <span class="nt">--second_offset</span> 0x00000000 <span class="nt">--tags_offset</span> 0x00000100 <span class="nt">--dtb_offset</span> 0x0000000001f00000 <span class="nt">--board</span> <span class="s1">''</span> <span class="nt">--cmdline</span> <span class="s1">'clk_ignore_unused pd_ignore_unused  pmos_boot_uuid=d86a5f31-2802-4333-b5aa-ff8a59e4d66e pmos_root_uuid=efbc85d5-1ba9-45ff-af90-1eecd5235327 pmos_rootfsopts=defaults'</span> <span class="nt">-o</span> boot-repacked.img
</code></section></div></div>

<p>With the new image ready to be flashed, I connected the device to my computer and ran the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">$ </span>fastboot flash boot boot-repacked.img
<span class="nv">$ </span>fastboot reboot
</code></section></div></div>

<p>… and the device didn’t boot.</p>
  <h4 id="trying-one-small-change-at-the-time">
    
    
     <a href="#trying-one-small-change-at-the-time">#</a><a href="#" aria-label="Back to top">Trying one small change at the time</a>
        
    
  </h4>
      

<p>When a device doesn’t boot and you don’t have a serial console - you’re pretty much clueless on what’s going on.
The only thing you can really do is to go back to the last working state (in my case, the original <code class="language-plaintext highlighter-rouge">dtb</code>) and try to change one small thing at the time until you find the issue.</p>

<p>In this particular phase, I’ve tried to adapt the <code class="language-plaintext highlighter-rouge">dtb</code> by following other references: the <a href="https://gitlab.com/sm8250-mainline"><code class="language-plaintext highlighter-rouge">sm8250-mainline</code></a> kernel already includes lots of other devices using the same chip and with a similar configuration. For example, the <a href="https://wiki.postmarketos.org/wiki/Xiaomi_Mi_Pad_5_Pro_(xiaomi-elish)">Xiaomi Mi Pad 5 Pro (elish)</a> used the same chip and described it as being part of the PCI0 port as seen in its dts file: <a href="https://gitlab.com/sm8250-mainline/linux/-/blob/sm8250/v6.11/arch/arm64/boot/dts/qcom/sm8250-xiaomi-elish-common.dtsi?ref_type=heads#L824-839">
<code class="language-plaintext highlighter-rouge">sm8250-xiaomi-elish-common.dtsi</code></a>.</p>

<p>Additionally, the device tree also described <a href="https://gitlab.com/sm8250-mainline/linux/-/blob/sm8250/v6.11/arch/arm64/boot/dts/qcom/sm8250-xiaomi-elish-common.dtsi?ref_type=heads#L1008-1022">some GPIOs to enable the chip</a>, together with a <a href="https://gitlab.com/sm8250-mainline/linux/-/blob/sm8250/v6.11/arch/arm64/boot/dts/qcom/sm8250-xiaomi-elish-common.dtsi?ref_type=heads#L108-167">voltage regulator</a> to power the chip.</p>

<p>After many trial and errors in adapting and stiching together some configuration, I was finally able to see the chip getting recognized:</p>

<pre><code class="language-plain"># dmesg | grep ath11k
[   11.524348] ath11k_pci 0000:01:00.0: Adding to iommu group 13
[   11.524578] ath11k_pci 0000:01:00.0: BAR 0 [mem 0x60400000-0x604fffff 64bit]: assigned
[   11.524642] ath11k_pci 0000:01:00.0: enabling device (0000 -&gt; 0002)
[   11.524983] ath11k_pci 0000:01:00.0: MSI vectors: 32
[   11.525005] ath11k_pci 0000:01:00.0: qca6390 hw2.0
[   12.796173] ath11k_pci 0000:01:00.0: chip_id 0x0 chip_family 0xb board_id 0xff soc_id 0xffffffff
[   12.796205] ath11k_pci 0000:01:00.0: fw_version 0x10121492 fw_build_timestamp 2021-11-04 11:23 fw_build_id
</code></section>

<p>I then checked that the adapter was being recognized (<code class="language-plaintext highlighter-rouge">ip link show wlan0</code>) and tried to connect to my Wi-Fi network.
Everything worked perfectly: I was able to join this device to the cluster and run some workloads on it, as with the previous device.</p>

<p>Since I deeply care about reducing e-waste and getting others to use their old devices, I’ve submitted my patch to the <a href="https://gitlab.com/sm8250-mainline/linux/-/merge_requests/8">sm8250-mainline kernel repo</a> and added a note on the <a href="https://wiki.postmarketos.org/wiki/OnePlus_8_Pro_(oneplus-instantnoodlep)#Known_Issues">device page</a> until the patch is picked up by the postmarketOS kernel.</p>
  <h4 id="backlight">
    
    
     <a href="#backlight">#</a><a href="#" aria-label="Back to top">Backlight</a>
        
    
  </h4>
      

<p>Unfortunately this device doesn’t have the backlight described in the device tree, and it’s therefore not possible (at the moment) to turn it off. This is not a big issue for me, but it would be a good candidate for a future patch.</p>
  <h2 id="conclusion">
    
    
     <a href="#conclusion">#</a><a href="#" aria-label="Back to top">Conclusion</a>
        
    
  </h2>
      

<p>After joining the second node to the cluster, I have now a small cluster of 3 nodes that I can use to run my workloads, and I’m happy that I can reuse old devices that would have otherwise kept collecting dust in my drawer.</p>

<pre><code class="language-plain">$ kubectl get nodes
NAME                               STATUS   ROLES                  AGE    VERSION
k3s-node-dumpling-cf0b07d4         Ready    &lt;none&gt;                 15d    v1.31.2-k3s1
k3s-node-instantnoodlep-e577c75e   Ready    &lt;none&gt;                 2d8h   v1.31.2-k3s1
master-1                           Ready    control-plane,master   14d    v1.31.2-k3s1
</code></section>
  <h3 id="pre-built-images">
    
    
     <a href="#pre-built-images">#</a><a href="#" aria-label="Back to top">Pre-built images</a>
        
    
  </h3>
      

<p>Since I’ve spent quite some time re-packing the boot image for <code class="language-plaintext highlighter-rouge">instantnoodlep</code>, I’ve decided to share the <code class="language-plaintext highlighter-rouge">boot.img</code>.
Granted that you should never trust a random kernel image from the internet, this could save you a bit of time.</p>

<ul>
  <li><a href="https://drive.google.com/file/d/1pQ5A0yJDBMO92uh4-qROcdpHTemuzKGx/view?usp=sharing"><code class="language-plaintext highlighter-rouge">boot-repacked.img</code></a></li>
</ul>

        </div>
        
          URL: https://ib.bsb.br/postmarketos-powered-kubernetes-cluster
        
      </article>
      <nav class="post-navigation-combined" aria-label="Post navigation">
        <!-- Chronological Navigation (always visible at 40vh) -->
        
          <div class="nav-arrow chronological prev">
            <a href="/opnsense-unbound-docker-adguard-home-or-pi-hole-ansible-automation/" title="OPNsense + Unbound + Docker (AdGuard Home or Pi-hole) + Ansible Automation" rel="prev">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
        
          <div class="nav-arrow chronological next">
            <a href="/web-scraping-and-rss-aggregation-using-older-devices/" title="Web scraping and RSS aggregation using older devices" rel="next">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
            
            
              
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  
                  
              
              
              
              <!-- Navigation block for tag "scratchpad"; default display for the first tag -->
              <div class="nav-group tags" id="tag-nav-scratchpad" style="display: block;">
                <div class="nav-arrow tags prev">
                  
                    <a href="/web-scraping-and-rss-aggregation-using-older-devices/" title="Web scraping and RSS aggregation using older devices" rel="prev">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
                <div class="nav-arrow tags next">
                  
                    <a href="/opnsense-unbound-docker-adguard-home-or-pi-hole-ansible-automation/" title="OPNsense + Unbound + Docker (AdGuard Home or Pi-hole) + Ansible Automation" rel="next">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
              </div>
            
          
          <!-- JavaScript to Toggle the Tag-based Navigation -->
          <script>
            document.addEventListener("DOMContentLoaded", function(){
              var tagLinks = document.querySelectorAll('.tag-option');
              tagLinks.forEach(function(link){
                link.addEventListener('click', function(event){
                  event.preventDefault();
                  // Remove "active" class from all tag options.
                  tagLinks.forEach(function(el){ el.classList.remove('active'); });
                  // Add active class to the clicked tag option.
                  this.classList.add('active');
                  // Hide all tag navigation blocks.
                  document.querySelectorAll('.nav-group.tags').forEach(function(block){
                    block.style.display = 'none';
                  });
                  // Show the navigation block corresponding to the selected tag.
                  var tagSlug = this.getAttribute('data-tag');
                  var target = document.getElementById('tag-nav-' + tagSlug);
                  if(target) {
                    target.style.display = 'block';
                  }
                });
              });
            });
          </script>
      </nav>
      
    <div class="comment-box">
      Ref. 
      <a href="https://blog.denv.it/posts/pmos-k3s-cluster/" title="https://blog.denv.it/posts/pmos-k3s-cluster/">https://blog.denv.it/posts/pmos-k3s-cluster/</a>
    </div>
    
    </main>
    <footer id="bottom-of-page" class="site-footer">
      <div class="footer-content">
        <!-- Back to top link -->
        <a href="#" aria-label="Back to top" class="back2top-link">
          <span class="sronly">Back to top</span>
        </a>
    
        <!-- Liquid Time Calculation and Display -->
        
        
        
        <a href="https://ib.bsb.br/404" aria-label="404">
          2025-06-02 12:08:26
        </a>
        &#x23;
    
        <!-- Tag Selector -->
        <ul class="tag-selector">
          
            
            
              <li>
                <a href="#" class="tag-option active" data-tag="scratchpad">
                  scratchpad
                </a>
              </li>
            
          
        </ul>
        &hArr;
    
        <!-- GitHub Link -->
        <a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io" aria-label="GitHub">
          &#8505;
        </a>
    
        <!-- Homepage Link -->
        <a href="/" aria-label="Homepage">
          infoBAG
        </a>
    
        <!-- Copy All Code Button -->
        <button id="copyAllButton" aria-label="Copy all code">
          &copy;
        </button>
      </div>
    </footer>
    <style>
      .back2top-link {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: url("/assets/Rope_(Old).gif") center center no-repeat;
        background-size: contain;
        text-decoration: none;
        vertical-align: middle;
      }
      .sronly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://ib.bsb.br/postmarketos-powered-kubernetes-cluster/"
        },
        "headline": "postmarketOS-powered Kubernetes cluster",
        "description": "",
        "datePublished": "2025-03-16T00:00:00+00:00",
        "dateModified": "2025-03-16T13:57:04+00:00",
        "author": {
          "@type": "Person",
          "name": "Author"
        },
        "publisher": {
          "@type": "Organization",
          "name": "infoBAG"
          
        }
        
      }
    </script>
    <script src="/assets/js/prism.js" defer></script>
    <script src="/assets/js/copy-all-code.js"></script>
  </body>
</html>
