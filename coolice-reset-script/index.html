<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      
        coolice reset script - infoBAG
      
    </title>
    <meta name="title" content="coolice reset script - infoBAG" />
    <meta name="description" content="">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ib.bsb.br/coolice-reset-script/">
    <meta property="og:title" content="coolice reset script - infoBAG">
    <meta property="og:description" content="">
    <meta property="og:image" content="/favicon.ico">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ib.bsb.br/coolice-reset-script/">
    <meta name="twitter:title" content="coolice reset script - infoBAG">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/favicon.ico">
    <link rel="canonical" href="https://ib.bsb.br/coolice-reset-script/">
    <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">
    
      <meta name="keywords" content="scratchpad">
      
        <meta property="article:tag" content="scratchpad">
      
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/style.css">
  </head>
  <body class="post-content-body">
    <header class="header-container">
      <nav aria-label="Main navigation" class="header-content">
        <a href="/" aria-label="Home">
          <img src="/favicon.ico" alt="Home" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/tags" aria-label="Tags">
          <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/send" aria-label="send">
          <img src="/assets/rot.gif" alt="send" class="favicon search-link" width="32" height="32" loading="lazy">
        </a> 
        <a href="/created" aria-label="archive created">
          <img src="/assets/Loose_Stone_Pile.gif" alt="archive created" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/events" aria-label="Events">
          <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/modified" aria-label="archive modified">
          <img src="/assets/Hole_(Rock).gif" alt="archive modified" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
    </nav>
      <h5 class="post-title">
        <a href="#bottom-of-page" aria-label="Go to bottom">
          coolice reset script
        </a>
      </h5>
      <div class="post-meta">
        <time datetime="2025-09-15T00:00:00+00:00" class="post-date">
          15 Sep 2025
        </time>
        
          <span class="post-updated">
            ↣
            <time datetime="2025-09-15T09:34:14+00:00">
              15 Sep 2025
            </time>
          </span>
        
        
          <p class="post-slug">
            Slug: <a href="https://ib.bsb.br/coolice-reset-script" class="tag">coolice-reset-script</a>
          </p>
        
        
          <p class="post-tags">
            Tags:
            
              <a href="https://ib.bsb.br/tags/#scratchpad" class="tag">scratchpad</a>
            
          </p>
        
      </div>
      <div class="post-actions">
        <div class="page-stats mt-3" role="status" aria-label="Page statistics">
      
      <span class="badge bg-primary">
        20500 characters
      </span>
        <span class="separator mx-2" aria-hidden="true">•</span>
        <span class="badge bg-primary">
        2733 words
      </span>
      </div>
        <div class="action-buttons d-flex flex-wrap gap-2">
          
            
              <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2025-09-15-coolice-reset-script.md"
                    method="GET"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="d-inline-block">
                <button type="submit" class="btn btn-danger" aria-label="Edit page content">
                  <span class="button-text">Improve this page?</span>
                  <span class="info-text">aberto.</span>
                </button>
              </form>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2025-09-15-coolice-reset-script.md"
                  method="GET"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="d-inline-block">
              <button type="submit" class="btn btn-danger" aria-label="View page revision history">
                View revision history
              </button>
            </form>
          
        </div>
      </div>
    </header>
    <main class="content">
      <article class="post-wrapper">
        <div class="post-content-body">
          

          <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="c">#!/usr/bin/env bash</span>
<span class="c">#</span>
<span class="c"># Revised: stable logging and safe optional tracing.</span>
<span class="c"># - Key changes vs. previous iteration:</span>
<span class="c">#   * Use a stable log file in BASEDIR (not inside ephemeral WORKDIR) for all persistent logs.</span>
<span class="c">#   * Open a single persistent FD (3) for programmatic logging and (optionally) BASH_XTRACEFD.</span>
<span class="c">#   * Do NOT use DEBUG traps (they are fragile with process substitution); rely on BASH_XTRACEFD when available.</span>
<span class="c">#   * Avoid tee pipelines for log writes; use single FD writes to avoid FD lifecycle races.</span>
<span class="c">#</span>
<span class="nb">set</span> <span class="nt">-Eeuo</span> pipefail
<span class="nb">shopt</span> <span class="nt">-s</span> inherit_errexit 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
</span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n\t</span><span class="s1">'</span>

<span class="c"># -----------------------</span>
<span class="c"># Small helpers early (used by arg parsing/sanity checks)</span>
<span class="c"># -----------------------</span>
timestamp<span class="o">()</span> <span class="o">{</span> <span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="p">;</span> <span class="o">}</span>

abs<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">p</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">realpath</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    </span><span class="nb">realpath</span> <span class="nt">-m</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">elif </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">readlink</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    </span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">else</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s/%s\n'</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span> <span class="nt">-P</span><span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span><span class="o">)</span> <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">fi</span>
<span class="o">}</span>

is_special<span class="o">()</span> <span class="o">{</span> <span class="o">[</span> <span class="nt">-S</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Configuration defaults</span>
<span class="c"># -----------------------</span>
<span class="nv">DEFAULT_BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">:-</span><span class="p">/home/ibbsbbry</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="nv">$DEFAULT_BASEDIR</span><span class="s2">"</span>
<span class="nv">APPLY</span><span class="o">=</span>0
<span class="nv">USE_ZIP</span><span class="o">=</span>0
<span class="nv">DEBUG</span><span class="o">=</span>0
<span class="nv">TRACE</span><span class="o">=</span>0
<span class="nv">TIMESTAMP</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">date</span> +%Y%m%d_%H%M%S<span class="si">)</span><span class="s2">"</span>
<span class="nv">MIN_FREE_KB</span><span class="o">=</span>102400

<span class="c"># -----------------------</span>
<span class="c"># Tool detection (FIX for latent bug)</span>
<span class="c"># -----------------------</span>
<span class="nv">TAR_GNU</span><span class="o">=</span>0
<span class="k">if </span><span class="nb">tar</span> <span class="nt">--version</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s1">'GNU tar'</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">TAR_GNU</span><span class="o">=</span>1
<span class="k">fi
</span><span class="nv">HAS_ZIP</span><span class="o">=</span>0
<span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> zip <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
  </span><span class="nv">HAS_ZIP</span><span class="o">=</span>1
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Lightweight logging helpers (they write to FD 3 when available)</span>
<span class="c"># -----------------------</span>
_log_to_fd3<span class="o">()</span> <span class="o">{</span>
  <span class="c"># write a single line to FD3 if it's open; fall back to stdout/stderr</span>
  <span class="nb">local ln</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="k">if</span> <span class="o">{</span> <span class="nb">true</span> <span class="o">&gt;</span>&amp;3<span class="p">;</span> <span class="o">}</span> 2&gt;/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$ln</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;3 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span><span class="k">else
    </span><span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$ln</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span><span class="k">fi</span>
<span class="o">}</span>

log<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] INFO: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="o">}</span>
warn<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] WARN: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>
err<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] ERROR: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>
dbg<span class="o">()</span> <span class="o">{</span>
  <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DEBUG</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>0
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] DEBUG: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="o">}</span>
trace_log<span class="o">()</span> <span class="o">{</span>
  <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TRACE</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>0
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] TRACE: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># Capture minimal last/current command for error context</span>
<span class="nv">CURRENT_COMMAND</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">LAST_COMMAND</span><span class="o">=</span><span class="s2">""</span>

<span class="c"># -----------------------</span>
<span class="c"># Argument parsing</span>
<span class="c"># -----------------------</span>
usage<span class="o">()</span> <span class="o">{</span>
  <span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">USAGE</span><span class="sh">
Usage: trim_and_fixperms.sh [options]
Default: DRY-RUN (no destructive actions).

Options:
  -y, --apply        Execute archive + remove + permissions (destructive)
      --zip          Prefer ZIP archive (requires 'zip')
      --base DIR     Base directory (default: </span><span class="se">\$</span><span class="sh">HOME)
      --debug        Enable verbose debug logging (paths &amp; outcomes)
      --trace        Enable command tracing (command-level trace; requires bash &gt;= 4.1)
  -h, --help         Show this help
</span><span class="no">USAGE
</span><span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">do
  case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in</span>
    <span class="nt">-y</span><span class="p">|</span><span class="nt">--apply</span><span class="p">)</span> <span class="nv">APPLY</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">--zip</span><span class="p">)</span> <span class="nv">USE_ZIP</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">--base</span><span class="p">)</span>
      <span class="nb">shift
      </span><span class="nv">BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$BASEDIR</span><span class="k">}</span><span class="s2">"</span>
      <span class="nb">shift</span>
      <span class="p">;;</span>
    <span class="nt">--debug</span><span class="p">)</span> <span class="nv">DEBUG</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">--trace</span><span class="p">)</span> <span class="nv">TRACE</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">-h</span><span class="p">|</span><span class="nt">--help</span><span class="p">)</span> usage<span class="p">;</span> <span class="nb">exit </span>0 <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Unknown option: </span><span class="nv">$1</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> usage<span class="p">;</span> <span class="nb">exit </span>1 <span class="p">;;</span>
  <span class="k">esac</span>
<span class="k">done</span>

<span class="c"># -----------------------</span>
<span class="c"># Resolve BASEDIR and do early safety checks (we create persistent log in BASEDIR)</span>
<span class="c"># -----------------------</span>
<span class="nv">BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="k">in</span>
  <span class="s2">"/"</span><span class="p">|</span><span class="s2">"/root"</span><span class="p">|</span><span class="s2">"/home"</span><span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Refusing to operate on </span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="nb">exit </span>1 <span class="p">;;</span>
<span class="k">esac</span>
<span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"Base dir not found: </span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>

<span class="nv">FREE_KB</span><span class="o">=</span><span class="si">$(</span><span class="nb">df</span> <span class="nt">-k</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'NR==2{print $4}'</span> <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$FREE_KB</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$FREE_KB</span><span class="s2">"</span> <span class="nt">-lt</span> <span class="s2">"</span><span class="nv">$MIN_FREE_KB</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Low free space on filesystem containing </span><span class="nv">$BASEDIR</span><span class="s2"> (</span><span class="nv">$FREE_KB</span><span class="s2"> KB &lt; </span><span class="nv">$MIN_FREE_KB</span><span class="s2"> KB)"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Prepare stable log (outside WORKDIR) and open FD3</span>
<span class="c"># -----------------------</span>
<span class="nv">LOG_STABLE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log"</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
<span class="c"># Open FD3 for persistent programmatic logging; leave it open until on_exit</span>
<span class="nb">exec </span>3&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>

<span class="c"># If TRACE requested, enable Bash xtrace to FD3 (requires bash &gt;= 4.1)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TRACE</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
  if</span> <span class="o">((</span>BASH_VERSINFO[0] <span class="o">&gt;</span> 4 <span class="o">||</span> <span class="o">(</span>BASH_VERSINFO[0] <span class="o">==</span> 4 <span class="o">&amp;&amp;</span> BASH_VERSINFO[1] <span class="o">&gt;=</span> 1<span class="o">)))</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">export </span><span class="nv">BASH_XTRACEFD</span><span class="o">=</span>3
    <span class="nv">PS4</span><span class="o">=</span><span class="s1">'+[$(date "+%Y-%m-%d %H:%M:%S")] '</span>
    <span class="nb">set</span> <span class="nt">-x</span>
    trace_log <span class="s2">"Enabled per-command xtrace to </span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>
  <span class="k">else
    </span><span class="nv">TRACE</span><span class="o">=</span>0
    dbg <span class="s2">"TRACE disabled: bash too old to safely redirect xtrace (requires bash &gt;= 4.1)"</span>
  <span class="k">fi
fi

</span>log <span class="s2">"Script started: </span><span class="nv">$0</span><span class="s2"> (TIMESTAMP=</span><span class="nv">$TIMESTAMP</span><span class="s2">) LOG=</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>

<span class="c"># -----------------------</span>
<span class="c"># Prepare WORKDIR (ephemeral)</span>
<span class="c"># -----------------------</span>
<span class="nv">WORKDIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TMPDIR</span><span class="k">:-</span><span class="p">/tmp</span><span class="k">}</span><span class="s2">/trimwork.</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.XXXXXX"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span><span class="si">)</span><span class="s2">"</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-w</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">WORKDIR</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.trimwork_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="o">{</span> err <span class="s2">"Cannot create workdir: </span><span class="nv">$WORKDIR</span><span class="s2">"</span><span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>
  <span class="nb">chmod </span>700 <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
</span><span class="k">fi</span>

<span class="c"># local copies of path variables inside workdir if needed</span>
<span class="nv">DOMAINS_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/domains_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.lst"</span>
<span class="nv">CAND_ABS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/candidates_abs_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.nul"</span>
<span class="nv">CAND_REL</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/candidates_rel_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.nul"</span>

: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>

dbg <span class="s2">"WORKDIR=</span><span class="nv">$WORKDIR</span><span class="s2">"</span>

<span class="c"># -----------------------</span>
<span class="c"># Error handler uses stable log (LOG_STABLE). Keep WORKDIR until on_exit.</span>
<span class="c"># -----------------------</span>
on_error<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">rc</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$?</span><span class="k">}</span>
  <span class="nv">LAST_COMMAND</span><span class="o">=</span><span class="k">${</span><span class="nv">LAST_COMMAND</span><span class="k">:-</span><span class="s1">'&lt;none&gt;'</span><span class="k">}</span>
  <span class="nv">CURRENT_COMMAND</span><span class="o">=</span><span class="k">${</span><span class="nv">CURRENT_COMMAND</span><span class="k">:-</span><span class="s2">"</span><span class="nv">$BASH_COMMAND</span><span class="s2">"</span><span class="k">}</span>
  err <span class="s2">"Script failed (exit code </span><span class="k">${</span><span class="nv">rc</span><span class="k">}</span><span class="s2">)."</span>
  err <span class="s2">"Last command: </span><span class="k">${</span><span class="nv">LAST_COMMAND</span><span class="k">}</span><span class="s2">"</span>
  err <span class="s2">"Current command: </span><span class="k">${</span><span class="nv">CURRENT_COMMAND</span><span class="k">}</span><span class="s2">"</span>
  err <span class="s2">"Location: PWD=</span><span class="si">$(</span><span class="nb">pwd </span>2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s1">'&lt;pwd?&gt;'</span><span class="si">)</span><span class="s2"> USER=</span><span class="k">${</span><span class="nv">USER</span><span class="k">:-}</span><span class="s2">"</span>
  err <span class="s2">"Preserved WORKDIR for inspection: </span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-</span><span class="p">&lt;none&gt;</span><span class="k">}</span><span class="s2">"</span>
  <span class="nv">KEEP_WORKDIR_ON_EXIT</span><span class="o">=</span>1
  <span class="c"># Ensure stable log has been copied/available; it's already in BASEDIR so no-op most times.</span>
  <span class="nb">cp</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log.FAILED"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span>err <span class="s2">"Copied runtime log (best-effort) to </span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log.FAILED"</span>
  <span class="c"># Close FD3 only at the end via on_exit; exit now</span>
  <span class="nb">exit</span> <span class="s2">"</span><span class="nv">$rc</span><span class="s2">"</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s1">'on_error $?'</span> ERR

on_exit<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">rc</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$?</span><span class="k">}</span>
  <span class="c"># flush/close FD3 last (best-effort)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$rc</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">cp</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>dbg <span class="s2">"Final log left at </span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>
  <span class="k">fi
  if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">KEEP_WORKDIR_ON_EXIT</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Preserving WORKDIR for inspection: </span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-</span><span class="p">&lt;none&gt;</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">else
    if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
      </span>dbg <span class="s2">"Removed WORKDIR: </span><span class="nv">$WORKDIR</span><span class="s2">"</span>
    <span class="k">fi
  fi</span>
  <span class="c"># close FD3</span>
  <span class="nb">exec </span>3&gt;&amp;- 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s1">'on_exit $?'</span> EXIT

<span class="c"># -----------------------</span>
<span class="c"># Portable functions used below</span>
<span class="c"># -----------------------</span>
path_size<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">p</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s1">'0\n'</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="o">}</span>
  <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">stat</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    if </span><span class="nb">stat</span> <span class="nt">--version</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
      </span><span class="nb">stat</span> <span class="nt">-c</span>%s <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">du</span> <span class="nt">-sb</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="o">||</span> <span class="nb">echo </span>0
    <span class="k">else
      </span><span class="nb">stat</span> <span class="nt">-f</span>%z <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">du</span> <span class="nt">-sk</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1*1024}'</span> <span class="o">||</span> <span class="nb">echo </span>0
    <span class="k">fi
  else
    </span><span class="nb">du</span> <span class="nt">-sb</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="o">||</span> <span class="nb">du</span> <span class="nt">-sk</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1*1024}'</span> <span class="o">||</span> <span class="nb">echo </span>0
  <span class="k">fi</span>
<span class="o">}</span>

human<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">n</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">numfmt</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    </span><span class="nb">numfmt</span> <span class="nt">--to</span><span class="o">=</span>iec <span class="nt">--suffix</span><span class="o">=</span>B <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%sB'</span> <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span>
  <span class="k">else
    </span><span class="nb">awk</span> <span class="nt">-v</span> <span class="nv">b</span><span class="o">=</span><span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span> <span class="s1">'BEGIN{function hr(x){s="B K M G";i=1;while(x&gt;=1024&amp;&amp;i&lt;4){x/=1024;i++}printf 
"%.1f%s",x,substr(s,i*2-1,1)};hr(b)}'</span>
  <span class="k">fi</span>
<span class="o">}</span>

safe_move<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">src</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="nv">dst</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
  dbg <span class="s2">"safe_move: '</span><span class="nv">$src</span><span class="s2">' -&gt; '</span><span class="nv">$dst</span><span class="s2">'"</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">APPLY</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    if </span><span class="nb">mv</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
      </span>dbg <span class="s2">"mv succeeded: </span><span class="nv">$src</span><span class="s2"> -&gt; </span><span class="nv">$dst</span><span class="s2">"</span>
      <span class="k">return </span>0
    <span class="k">fi
    </span>dbg <span class="s2">"mv failed, attempting cp -a + rm -rf for </span><span class="nv">$src</span><span class="s2">"</span>
    <span class="k">if </span><span class="nb">cp</span> <span class="nt">-a</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span> err <span class="s2">"rm after cp failed for </span><span class="nv">$src</span><span class="s2">"</span><span class="p">;</span> <span class="k">return </span>1<span class="p">;</span> <span class="o">}</span>
      dbg <span class="s2">"cp+rm succeeded for </span><span class="nv">$src</span><span class="s2">"</span>
      <span class="k">return </span>0
    <span class="k">fi
    </span>err <span class="s2">"safe_move failed for </span><span class="nv">$src</span><span class="s2"> -&gt; </span><span class="nv">$dst</span><span class="s2">"</span>
    <span class="k">return </span>1
  <span class="k">else
    </span>dbg <span class="s2">"DRY-RUN safe_move: </span><span class="nv">$src</span><span class="s2"> -&gt; </span><span class="nv">$dst</span><span class="s2">"</span>
    <span class="k">return </span>0
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Discover domain roots</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Discovering domain roots..."</span>
<span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/public_html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/domains"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  for </span>d <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/domains"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do</span>
    <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">/public_html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
  <span class="k">done
fi
for </span>d <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do</span>
  <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">/public_html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">done
if</span> <span class="o">[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">LC_ALL</span><span class="o">=</span>C <span class="nb">sort</span> <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">fi
</span><span class="nv">DOM_COUNT</span><span class="o">=</span><span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> &lt; <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
log <span class="s2">"Detected </span><span class="nv">$DOM_COUNT</span><span class="s2"> domain roots"</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOM_COUNT</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">sed</span> <span class="s1">'s/^/  /'</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
</span><span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Candidate collection helpers</span>
<span class="c"># -----------------------</span>
<span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
<span class="nv">SCRIPT_IN_BASE</span><span class="o">=</span>0
<span class="k">case</span> <span class="s2">"</span><span class="nv">$SCRIPT_PATH</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span><span class="p">|</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">)</span> <span class="nv">SCRIPT_IN_BASE</span><span class="o">=</span>1 <span class="p">;;</span> <span class="k">esac</span>

append_abs<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">p</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-}</span><span class="s2">"</span>
  <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>0
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SCRIPT_IN_BASE</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$SCRIPT_PATH</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Skipping script itself: </span><span class="nv">$p</span><span class="s2">"</span>
    <span class="k">return </span>0
  <span class="k">fi
  case</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">)</span> dbg <span class="s2">"Skipping workdir path: </span><span class="nv">$p</span><span class="s2">"</span><span class="p">;</span> <span class="k">return </span>0 <span class="p">;;</span> <span class="k">esac</span>
  <span class="k">if </span>is_special <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Skipping special file: </span><span class="nv">$p</span><span class="s2">"</span>
    <span class="k">return </span>0
  <span class="k">fi
  </span><span class="nb">printf</span> <span class="s1">'%s\0'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>
  dbg <span class="s2">"Appended candidate: </span><span class="nv">$p</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Collect candidates</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Collecting candidate files..."</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOM_COUNT</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> D<span class="p">;</span> <span class="k">do
    </span><span class="nv">D</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
    dbg <span class="s2">"Processing domain root: </span><span class="nv">$D</span><span class="s2">"</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/cgi-bin"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats/.data"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp/incoming"</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true</span>

    <span class="c"># Find all items (files, links, directories) at the top level of the domain root.</span>
    find <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> item<span class="p">;</span> <span class="k">do
      </span><span class="nv">base_item</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
      <span class="c"># Exclude standard directories that are handled by later, specific loops.</span>
      <span class="k">case</span> <span class="s2">"</span><span class="nv">$base_item</span><span class="s2">"</span> <span class="k">in
        </span>public_html|cgi-bin|logs|stats|awstats|public_ftp|.htpasswd<span class="p">)</span>
          dbg <span class="s2">"Skipping standard path in main loop: </span><span class="nv">$item</span><span class="s2">"</span>
          <span class="k">continue</span>
          <span class="p">;;</span>
      <span class="k">esac</span>

      <span class="c"># If the item is a file or symlink at the domain root, add it as a candidate.</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-L</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>append_abs <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span>
      <span class="c"># If the item is a directory not in our exclusion list (e.g., 'data'),</span>
      <span class="c"># recursively find and add all files within it.</span>
      <span class="k">elif</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>dbg <span class="s2">"Scanning non-standard directory for files: </span><span class="nv">$item</span><span class="s2">"</span>
        find <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
          </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
        <span class="k">done
      fi
    done</span>

    <span class="c"># Now, process the standard directories with their specific rules.</span>
    <span class="nv">PH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$PH</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        </span><span class="nv">base</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$base</span><span class="s2">"</span> <span class="k">in </span>index.html|index.htm|index.php<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/.well-known"</span><span class="p">|</span><span class="s2">"</span><span class="k">${</span><span class="nv">PH</span><span class="k">}</span><span class="s2">/.well-known/"</span><span class="k">*</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
      <span class="k">done
    fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
    fi
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
    fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        </span><span class="nv">bn</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$bn</span><span class="s2">"</span> <span class="k">in</span> .data|awstats.pl<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$bn</span><span class="s2">"</span> <span class="k">in </span>awstats<span class="k">*</span>.conf<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
      <span class="k">done
    fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        case</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp/incoming"</span><span class="p">|</span><span class="s2">"</span><span class="k">${</span><span class="nv">D</span><span class="k">}</span><span class="s2">/public_ftp/incoming/"</span><span class="k">*</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
      <span class="k">done
    fi
  done</span> &lt; <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># Top-level under BASEDIR</span>
find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> top<span class="p">;</span> <span class="k">do</span>
  <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="k">continue
  case</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span><span class="p">|</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/public_html"</span><span class="p">|</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/domains"</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
  <span class="nv">skip</span><span class="o">=</span>0
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOM_COUNT</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> D<span class="p">;</span> <span class="k">do</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nv">skip</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="k">done</span> &lt; <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
  <span class="k">fi</span>
  <span class="o">[</span> <span class="s2">"</span><span class="nv">$skip</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue
  if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-L</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span>append_abs <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span>
  <span class="k">elif</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>find <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
  fi
done</span>

<span class="c"># If no candidates, exit gracefully</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>log <span class="s2">"No candidates found; nothing to do."</span>
  <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Build relative list and compute totals</span>
<span class="c"># -----------------------</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> abs<span class="p">;</span> <span class="k">do
  case</span> <span class="s2">"</span><span class="nv">$abs</span><span class="s2">"</span> <span class="k">in</span>
    <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span><span class="p">)</span> <span class="nv">rel</span><span class="o">=</span><span class="s1">'.'</span> <span class="p">;;</span>
    <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">)</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">abs</span><span class="p">#</span><span class="nv">$BASEDIR</span><span class="p">/</span><span class="k">}</span><span class="s2">"</span> <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"</span><span class="nv">$abs</span><span class="s2">"</span> <span class="p">;;</span>
  <span class="k">esac</span>
  <span class="nb">printf</span> <span class="s1">'%s\0'</span> <span class="s2">"</span><span class="nv">$rel</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>
<span class="k">done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>

<span class="nv">CAND_COUNT</span><span class="o">=</span><span class="si">$(</span><span class="nb">tr</span> <span class="nt">-cd</span> <span class="s1">'\0'</span> &lt;<span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span> | <span class="nb">wc</span> <span class="nt">-c</span> <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
<span class="nv">TOTAL_BYTES</span><span class="o">=</span>0
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> p<span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">bytes</span><span class="o">=</span><span class="si">$(</span>path_size <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
    <span class="k">case</span> <span class="s2">"</span><span class="nv">$bytes</span><span class="s2">"</span> <span class="k">in</span> <span class="s1">''</span><span class="p">|</span><span class="k">*</span><span class="o">[!</span>0-9]<span class="k">*</span><span class="p">)</span> <span class="nv">bytes</span><span class="o">=</span>0 <span class="p">;;</span> <span class="k">esac</span>
    <span class="nv">TOTAL_BYTES</span><span class="o">=</span><span class="k">$((</span>TOTAL_BYTES <span class="o">+</span> bytes<span class="k">))</span>
  <span class="k">fi
done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>
log <span class="s2">"Candidates: </span><span class="nv">$CAND_COUNT</span><span class="s2"> (~</span><span class="si">$(</span>human <span class="s2">"</span><span class="nv">$TOTAL_BYTES</span><span class="s2">"</span><span class="si">)</span><span class="s2">)"</span>
log <span class="s2">"Sample (first 20):"</span>
<span class="nv">i</span><span class="o">=</span>0
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> p <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$i</span> <span class="nt">-lt</span> 20 <span class="o">]</span><span class="p">;</span> <span class="k">do
  </span><span class="nb">printf</span> <span class="s1">'  %s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span><span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
<span class="k">done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>

<span class="c"># Dry-run: report and exit</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$APPLY</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>log <span class="s2">"DRY-RUN: no changes made. Re-run with --apply to execute."</span>
  <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># Confirm destructive action</span>
<span class="nb">printf</span> <span class="s1">'Type EXACTLY CONFIRM to proceed: '</span>
<span class="nb">read</span> <span class="nt">-r</span> CONFIRM
<span class="o">[</span> <span class="s2">"</span><span class="nv">$CONFIRM</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"CONFIRM"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> err <span class="s2">"Aborted by user"</span><span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Archiving (same behavior)</span>
<span class="c"># -----------------------</span>
<span class="nv">ARCHIVE_TGZ</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/min_trim_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.tar.gz"</span>
<span class="nv">ARCHIVE_ZIP</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/min_trim_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.zip"</span>
log <span class="s2">"Archiving to: </span><span class="nv">$ARCHIVE_TGZ</span><span class="s2"> (tar) or </span><span class="nv">$ARCHIVE_ZIP</span><span class="s2"> (zip)"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TAR_GNU</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>log <span class="s2">"Using GNU tar with --remove-files"</span>
  <span class="nb">set</span> +e
  <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">--null</span> <span class="nt">--ignore-failed-read</span> <span class="nt">-czf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="nt">--remove-files</span> <span class="nt">-T</span> <span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span><span class="o">)</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>
  <span class="nv">TAR_RC</span><span class="o">=</span><span class="nv">$?</span>
  <span class="nb">set</span> <span class="nt">-e</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$TAR_RC</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>warn <span class="s2">"tar returned </span><span class="nv">$TAR_RC</span><span class="s2">; some files may not have been archived/removed."</span>
  <span class="k">fi
  if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">tar</span> <span class="nt">-tzf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> warn <span class="s2">"Archive verification failed: </span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span>
  <span class="k">else
    </span>err <span class="s2">"Archive was not created: </span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span>
  <span class="k">fi
else
  </span><span class="nv">STAGE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/stage"</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span>
  log <span class="s2">"Staging files to </span><span class="nv">$STAGE</span><span class="s2">"</span>
  <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> rel<span class="p">;</span> <span class="k">do
    </span><span class="nv">src</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/</span><span class="nv">$rel</span><span class="s2">"</span>
    <span class="nv">dst</span><span class="o">=</span><span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">/</span><span class="nv">$rel</span><span class="s2">"</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      if</span> <span class="o">!</span> safe_move <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
        </span>err <span class="s2">"Failed to stage </span><span class="nv">$src</span><span class="s2">"</span>
      <span class="k">fi
    fi
  done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$USE_ZIP</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$HAS_ZIP</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> zip <span class="nt">-r</span> <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$ARCHIVE_ZIP</span><span class="s2">"</span> .<span class="o">)</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> warn <span class="s2">"zip failed"</span>
    <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$ARCHIVE_ZIP</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> unzip <span class="nt">-t</span> <span class="s2">"</span><span class="nv">$ARCHIVE_ZIP</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> warn <span class="s2">"ZIP verification failed"</span>
  <span class="k">else</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-czf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> .<span class="o">)</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> warn <span class="s2">"tar failed"</span>
    <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-tzf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> warn <span class="s2">"tar.gz verification failed"</span>
  <span class="k">fi
  </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># Residual cleanup</span>
log <span class="s2">"Residual cleanup..."</span>
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> p<span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Removing residual: </span><span class="nv">$p</span><span class="s2">"</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> warn <span class="s2">"Failed to remove residual: </span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">fi
done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>

find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-depth</span> <span class="nt">-type</span> d <span class="nt">-empty</span> <span class="nt">-delete</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true</span>

<span class="c"># -----------------------</span>
<span class="c"># Recreate skeletons</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Recreating skeletons..."</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> D<span class="p">;</span> <span class="k">do
    </span><span class="nv">D</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
    dbg <span class="s2">"Recreating for domain: </span><span class="nv">$D</span><span class="s2">"</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/cgi-bin"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats/.data"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp/incoming"</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="nv">PH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.php"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">cat</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.html"</span> <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">HTML</span><span class="sh">'
&lt;!doctype html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;Placeholder&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;&lt;h1&gt;Placeholder&lt;/h1&gt;&lt;p&gt;Minimal skeleton active. Upload your site to public_html.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
</span><span class="no">HTML
</span>      <span class="nb">chmod </span>644 <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.html"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">fi
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">fi
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        </span><span class="nv">bn</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$bn</span><span class="s2">"</span> <span class="k">in</span> .data|awstats.pl|awstats<span class="k">*</span>.conf<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
      </span><span class="k">done
    fi
  done</span> &lt;<span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Apply permissions</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Applying permissions..."</span>
find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0755 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0644 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-name</span> <span class="s2">"cgi-bin"</span> <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> d<span class="p">;</span> <span class="k">do
  </span>find <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0755 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span><span class="k">done
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s2">"awstats.pl"</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0755 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-path</span> <span class="s2">"*/public_ftp"</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0711 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-path</span> <span class="s2">"*/public_ftp/incoming"</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0733 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> 
<span class="nb">true
</span><span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">chmod </span>700 <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
  </span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0600 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span><span class="k">fi
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="se">\(</span> <span class="nt">-name</span> <span class="s2">".htaccess"</span> <span class="nt">-o</span> <span class="nt">-name</span> <span class="s2">".htpasswd"</span> <span class="se">\)</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0644 <span class="nt">--</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="se">\(</span> <span class="nt">-iname</span> <span class="s2">"wp-config.php"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">"config.php"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">".env"</span> <span class="se">\)</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> 
<span class="nt">-r</span> <span class="nb">chmod </span>0640 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="se">\(</span> <span class="nt">-iname</span> <span class="s2">"*token*"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">"*secret*"</span> <span class="nt">-o</span> <span class="nt">-name</span> <span class="s2">"id_*"</span> <span class="se">\)</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod 
</span>0600 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true</span>

<span class="c"># -----------------------</span>
<span class="c"># Finalization</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Completed successfully."</span>
<span class="nb">exit </span>0
</code></section></div></div>

        </div>
        
          URL: https://ib.bsb.br/coolice-reset-script
        
      </article>
      <nav class="post-navigation-combined" aria-label="Post navigation">
        <!-- Chronological Navigation (always visible at 40vh) -->
        
          <div class="nav-arrow chronological prev">
            <a href="/coolicehost/" title="CooliceHost's Shared Hosting Service" rel="prev">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
        
          <div class="nav-arrow chronological next">
            <a href="/bnmp/" title="bnmp" rel="next">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
            
            
              
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  
                  
              
              
              
              <!-- Navigation block for tag "scratchpad"; default display for the first tag -->
              <div class="nav-group tags" id="tag-nav-scratchpad" style="display: block;">
                <div class="nav-arrow tags prev">
                  
                    <a href="/coolice-writable-tree/" title="coolice writable tree" rel="prev">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
                <div class="nav-arrow tags next">
                  
                    <a href="/bnmp/" title="bnmp" rel="next">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
              </div>
            
          
          <!-- JavaScript to Toggle the Tag-based Navigation -->
          <script>
            document.addEventListener("DOMContentLoaded", function(){
              var tagLinks = document.querySelectorAll('.tag-option');
              tagLinks.forEach(function(link){
                link.addEventListener('click', function(event){
                  event.preventDefault();
                  // Remove "active" class from all tag options.
                  tagLinks.forEach(function(el){ el.classList.remove('active'); });
                  // Add active class to the clicked tag option.
                  this.classList.add('active');
                  // Hide all tag navigation blocks.
                  document.querySelectorAll('.nav-group.tags').forEach(function(block){
                    block.style.display = 'none';
                  });
                  // Show the navigation block corresponding to the selected tag.
                  var tagSlug = this.getAttribute('data-tag');
                  var target = document.getElementById('tag-nav-' + tagSlug);
                  if(target) {
                    target.style.display = 'block';
                  }
                });
              });
            });
          </script>
      </nav>
      
    </main>
    <footer id="bottom-of-page" class="site-footer">
      <div class="footer-content">
        <!-- Back to top link -->
        <a href="#" aria-label="Back to top" class="back2top-link">
          <span class="sronly">Back to top</span>
        </a>
    
        <!-- Liquid Time Calculation and Display -->
        
        
        
        <a href="https://ib.bsb.br/404" aria-label="404">
          2026-01-21 19:24:30
        </a>
        &#x23;
    
        <!-- Tag Selector -->
        <ul class="tag-selector">
          
            
            
              <li>
                <a href="#" class="tag-option active" data-tag="scratchpad">
                  scratchpad
                </a>
              </li>
            
          
        </ul>
        &hArr;
    
        <!-- GitHub Link -->
        <a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io" aria-label="GitHub">
          &#8505;
        </a>
    
        <!-- Homepage Link -->
        <a href="/" aria-label="Homepage">
          infoBAG
        </a>
    
        <!-- Copy All Code Button -->
        <button id="copyAllButton" aria-label="Copy all code">
          &copy;
        </button>
      </div>
    </footer>
    <style>
      .back2top-link {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: url("/assets/Rope_(Old).gif") center center no-repeat;
        background-size: contain;
        text-decoration: none;
        vertical-align: middle;
      }
      .sronly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://ib.bsb.br/coolice-reset-script/"
        },
        "headline": "coolice reset script",
        "description": "",
        "datePublished": "2025-09-15T00:00:00+00:00",
        "dateModified": "2025-09-15T09:34:14+00:00",
        "author": {
          "@type": "Person",
          "name": "Author"
        },
        "publisher": {
          "@type": "Organization",
          "name": "infoBAG"
          
        }
        
      }
    </script>
    <script src="/assets/js/prism.js" defer></script>
    <script src="/assets/js/copy-all-code.js"></script>
  </body>
</html>
