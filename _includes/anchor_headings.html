{% assign min_level = include.h_min | default: 1 %}
{% assign max_level = include.h_max | default: 6 %}
{% assign before_heading = include.beforeHeading | default: false %}
{% assign anchor_class = include.anchorClass | default: "" %}
{% assign anchor_title = include.anchorTitle | default: "" %}
{% assign anchor_attrs = include.anchorAttrs | default: "" %}
{% assign anchor_body = include.anchorBody | default: "#" %}
{% assign header_extra = include.headerAttrs | default: "" %}
{% assign html_input = include.html %}
{% capture output_html %}{% endcapture %}
{% assign parts = html_input | split: "<h" %}
{% for part in parts %}
  {% if forloop.first %}
    {% assign output_html = part %}
  {% else %}
    {% assign first_chunk = part | split: ">" | first %}
    {% assign header_level = first_chunk | slice: 0,1 | plus: 0 %}
    {% if header_level < min_level or header_level > max_level %}
      {% assign output_html = output_html | append: "<h" | append: part %}
      {% continue %}
    {% endif %}
    {% if first_chunk contains 'id="' %}
      {% assign id_piece = first_chunk | split: 'id="' | last | split: '"' | first %}
      {% assign header_id = id_piece %}
    {% else %}
      {% assign header_text_temp = part | split: "</h" | first | remove_first: ">" %}
      {% assign header_id = header_text_temp | strip_html | strip | slugify %}
    {% endif %}
    {% capture anchor_link %}
      <a href="#{{ header_id }}" {% if anchor_class != "" %}class="{{ anchor_class }}"{% endif %} {% if anchor_title != "" %}title="{{ anchor_title | replace: "%heading%", header_text_temp | strip_html | strip }}"{% endif %} {{ anchor_attrs }}>{{ anchor_body | replace: "%heading%", header_text_temp | strip_html | strip }}</a>
    {% endcapture %}
    {% capture rebuilt_header %}
      <h{{ header_level }} {{ header_extra }} id="{{ header_id }}">
      {% if before_heading %}
        {{ anchor_link }}{{ part | split: ">" | slice: 1 | join: ">" }}
      {% else %}
        {{ part | split: ">" | slice: 1 | join: ">" }} {{ anchor_link }}
      {% endif %}
      </h{{ header_level }}>
    {% endcapture %}
    {% assign output_html = output_html | append: rebuilt_header %}
  {% endif %}
{% endfor %}
{{ output_html | strip }}