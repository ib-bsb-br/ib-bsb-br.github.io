<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      
        Portable linux via Sbnb distro with persistence - infoBAG
      
    </title>
    <meta name="title" content="Portable linux via Sbnb distro with persistence - infoBAG" />
    <meta name="description" content="">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ib.bsb.br/sbnb/">
    <meta property="og:title" content="Portable linux via Sbnb distro with persistence - infoBAG">
    <meta property="og:description" content="">
    <meta property="og:image" content="/favicon.ico">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ib.bsb.br/sbnb/">
    <meta name="twitter:title" content="Portable linux via Sbnb distro with persistence - infoBAG">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/favicon.ico">
    <link rel="canonical" href="https://ib.bsb.br/sbnb/">
    <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">
    
      <meta name="keywords" content="linux&gt;software&gt;dotfile">
      
        <meta property="article:tag" content="linux&gt;software&gt;dotfile">
      
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/style.css">
  </head>
  <body class="post-content-body">
    <header class="header-container">
      <nav aria-label="Main navigation" class="header-content">
        <a href="/" aria-label="Home">
          <img src="/favicon.ico" alt="Home" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/tags" aria-label="Tags">
          <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/send" aria-label="send">
          <img src="/assets/rot.gif" alt="send" class="favicon search-link" width="32" height="32" loading="lazy">
        </a> 
        <a href="/created" aria-label="archive created">
          <img src="/assets/Loose_Stone_Pile.gif" alt="archive created" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/events" aria-label="Events">
          <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/modified" aria-label="archive modified">
          <img src="/assets/Hole_(Rock).gif" alt="archive modified" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
    </nav>
      <h5 class="post-title">
        <a href="#bottom-of-page" aria-label="Go to bottom">
          Portable linux via Sbnb distro with persistence
        </a>
      </h5>
      <div class="post-meta">
        <time datetime="2025-04-07T00:00:00+00:00" class="post-date">
          07 Apr 2025
        </time>
        
          <span class="post-updated">
            ↣
            <time datetime="2025-05-02T00:52:29+00:00">
              02 May 2025
            </time>
          </span>
        
        
          <p class="post-slug">
            Slug: <a href="https://ib.bsb.br/sbnb" class="tag">sbnb</a>
          </p>
        
        
          <p class="post-tags">
            Tags:
            
              <a href="https://ib.bsb.br/tags/#linux-software-dotfile" class="tag">linux>software>dotfile</a>
            
          </p>
        
      </div>
      <div class="post-actions">
        <div class="page-stats mt-3" role="status" aria-label="Page statistics">
      
      <span class="badge bg-primary">
        85989 characters
      </span>
        <span class="separator mx-2" aria-hidden="true">•</span>
        <span class="badge bg-primary">
        10159 words
      </span>
      </div>
        <div class="action-buttons d-flex flex-wrap gap-2">
          
            
              <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2025-04-07-sbnb.md"
                    method="GET"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="d-inline-block">
                <button type="submit" class="btn btn-danger" aria-label="Edit page content">
                  <span class="button-text">Improve this page?</span>
                  <span class="info-text">aberto.</span>
                </button>
              </form>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2025-04-07-sbnb.md"
                  method="GET"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="d-inline-block">
              <button type="submit" class="btn btn-danger" aria-label="View page revision history">
                View revision history
              </button>
            </form>
          
        </div>
      </div>
    </header>
    <main class="content">
      <article class="post-wrapper">
        <div class="post-content-body">
          
<ul><li><a href="#-extreme-caution-irreversible-data-destruction-imminent-"><strong>***** EXTREME CAUTION: IRREVERSIBLE DATA DESTRUCTION IMMINENT! *****</strong></a></li></ul>
          <p>This guide provides comprehensive, step-by-step instructions for configuring a single USB flash drive (or potentially an external USB hard drive) to perform two distinct functions simultaneously:</p>

<ol>
  <li><strong>Booting the Sbnb Linux Operating System:</strong> The drive will be prepared with a standard UEFI-compatible structure, specifically an EFI System Partition (ESP) containing the Sbnb EFI bootloader (<code class="language-plaintext highlighter-rouge">sbnb.efi</code>) and necessary configuration files. This allows the server’s firmware to locate and start the Sbnb boot process. The <code class="language-plaintext highlighter-rouge">sbnb.efi</code> file itself is typically a Unified Kernel Image (UKI), bundling the Linux kernel, initramfs, and kernel command line into a single executable file.</li>
  <li><strong>Providing Simple Persistent Storage:</strong> Utilizing a separate partition on the same physical USB drive, formatted with a standard Linux filesystem (<code class="language-plaintext highlighter-rouge">ext4</code> is used in this guide). This partition is intended to be automatically mounted at the <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> directory path within the running Sbnb Linux system via a custom boot script (<code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code>). This provides a space where data (like container volumes, application data, logs, user files) can persist across reboots of the otherwise ephemeral, RAM-based Sbnb OS.</li>
</ol>

<p><strong>Why <code class="language-plaintext highlighter-rouge">ext4</code> instead of LVM:</strong> Initial analysis suggested LVM might be suitable, but further review of the default Sbnb Linux build configuration indicates the necessary <code class="language-plaintext highlighter-rouge">lvm2</code> user-space tools are likely missing from the base runtime environment. Without these tools, managing LVM volumes during boot via standard scripts is infeasible unless you create a custom Sbnb build that includes the <code class="language-plaintext highlighter-rouge">lvm2</code> package. This revised guide therefore uses a standard <code class="language-plaintext highlighter-rouge">ext4</code> filesystem partition, relying only on basic tools expected to be present in Sbnb.</p>

<p><strong>Contrasting with Standard Sbnb Workflow:</strong> It’s crucial to understand that this guide describes a highly non-standard setup. The intended Sbnb workflow prioritizes resilience, performance, and statelessness:</p>

<ul>
  <li>Boot the minimal Sbnb OS from simple USB/network.</li>
  <li>Use automation (Ansible) or manual scripts (<code class="language-plaintext highlighter-rouge">sbnb-configure-storage.sh</code>) post-boot to configure LVM on internal server drives.</li>
  <li>Run workloads utilizing this fast, reliable internal storage. This guide’s method compromises these benefits for single-drive convenience under specific constraints.</li>
</ul><hr />

<blockquote>
  <h5 id="-extreme-caution-irreversible-data-destruction-imminent-">
    
    
     <a href="#-extreme-caution-irreversible-data-destruction-imminent-">#</a><a href="#" aria-label="Back to top"><strong>***** EXTREME CAUTION: IRREVERSIBLE DATA DESTRUCTION IMMINENT! *****</strong></a>
        
    
  </h5>
      

  <p>This procedure involves low-level disk operations (partitioning, formatting) that will completely and <strong>PERMANENTLY ERASE ALL DATA</strong> currently residing on the USB drive you select. There is <strong>NO UNDO</strong> function. Data recovery after accidental formatting is often impossible.</p>

  <p>The most critical risk is selecting the <strong>wrong target device</strong>. Mistakenly choosing your computer’s internal hard drive (e.g., <code class="language-plaintext highlighter-rouge">/dev/sda</code>, <code class="language-plaintext highlighter-rouge">/dev/nvme0n1</code>) instead of the intended USB drive (e.g., <code class="language-plaintext highlighter-rouge">/dev/sdb</code>, <code class="language-plaintext highlighter-rouge">/dev/sdc</code>) <strong>WILL RESULT IN CATASTROPHIC AND LIKELY IRRECOVERABLE LOSS OF YOUR OPERATING SYSTEM, APPLICATIONS, AND PERSONAL FILES.</strong></p>

  <p>You <strong>MUST</strong> verify the target device name multiple times using different commands (like <code class="language-plaintext highlighter-rouge">lsblk</code>, <code class="language-plaintext highlighter-rouge">fdisk</code>, <code class="language-plaintext highlighter-rouge">parted</code>) and cross-reference with expected drive sizes and models before executing any partitioning or formatting commands. Proceed with extreme vigilance, double-checking each step, entirely at your own sole risk!</p>
</blockquote><hr />
  <h2 id="primary-drawbacks--warnings-reiterated--expanded">
    
    
     <a href="#primary-drawbacks--warnings-reiterated--expanded">#</a><a href="#" aria-label="Back to top">Primary Drawbacks &amp; Warnings (Reiterated &amp; Expanded):</a>
        
    
  </h2>
      

<ul>
  <li><strong>Highly Non-Standard &amp; Complex:</strong> Deviates significantly from Sbnb’s design. Setup is intricate, runtime behavior depends on precise script execution and timing. Future Sbnb updates might break this.</li>
  <li><strong>Severe Performance Penalty:</strong> USB storage is inherently slow (latency, throughput, IOPS) compared to internal NVMe/SATA drives. Disk I/O to <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> will be a major bottleneck.</li>
  <li><strong>Drastically Reduced Lifespan &amp; Reliability:</strong> USB flash drives will wear out quickly under persistent write load due to limited write cycles, write amplification, and lack of TRIM support. Unsuitable for write-intensive workloads or high reliability needs. Expect eventual failure and data loss without robust backups.</li>
  <li><strong>Potential Instability &amp; Boot Issues:</strong> Relies on correct partition detection, udev node creation, filesystem integrity, and <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> execution timing. Failures can leave persistent storage unavailable.</li>
</ul>
  <h3 id="when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">
    
    
     <a href="#when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">#</a><a href="#" aria-label="Back to top">When Might This Be Considered? (Limited Scenarios with Full Risk Acceptance)</a>
        
    
  </h3>
      

<ul>
  <li><strong>Temporary Testing/Experimentation ONLY:</strong> Brief evaluations on hardware lacking internal drives.</li>
  <li><strong>Specific, Very Low-Intensity, Read-Mostly Use Cases:</strong> Infrequent writes, performance irrelevant (e.g., static config kiosk).</li>
  <li><strong>Absolute Hardware Constraints:</strong> Sealed systems where internal drives are impossible, and risks are fully accepted.</li>
</ul>

<p><em>Even in these limited scenarios, regular, automated, and verified backups are non-negotiable.</em></p>
  <h2 id="prerequisites">
    
    
     <a href="#prerequisites">#</a><a href="#" aria-label="Back to top">Prerequisites</a>
        
    
  </h2>
      

<ul>
  <li><strong>A Suitable USB Flash Drive:</strong>
    <ul>
      <li><strong>Capacity:</strong> Min ~1GB ESP + desired data size (32GB+ recommended).</li>
      <li><strong>Quality &amp; Speed:</strong> Reputable brand, USB 3.0+ advised for marginal speed benefit. Endurance matters more than peak speed.</li>
    </ul>
  </li>
  <li><strong>A Working Linux System (Preparation Environment):</strong>
    <ul>
      <li><strong>Necessity:</strong> Required for partitioning/formatting the target USB safely. openSUSE Tumbleweed assumed.</li>
      <li><strong>Live Environment Benefit:</strong> Using a Live USB/CD (e.g., openSUSE Tumbleweed Live) is highly recommended as it provides a non-destructive environment.</li>
    </ul>
  </li>
  <li><strong>Sbnb Linux Boot File (<code class="language-plaintext highlighter-rouge">sbnb.efi</code>):</strong>
    <ul>
      <li><strong>Method 1 (Easier):</strong> Run official Sbnb install script on a temporary USB, then copy <code class="language-plaintext highlighter-rouge">/EFI/BOOT/BOOTX64.EFI</code> from its ESP.</li>
      <li><strong>Method 2 (Advanced):</strong> Build Sbnb from source, find <code class="language-plaintext highlighter-rouge">sbnb.efi</code> in <code class="language-plaintext highlighter-rouge">output/images/</code>.</li>
    </ul>
  </li>
  <li><strong>Root/Sudo Privileges:</strong> Needed on the openSUSE prep system for disk commands.</li>
  <li><strong>Internet Connection:</strong> May be needed for <code class="language-plaintext highlighter-rouge">zypper</code>.</li>
</ul>
  <h2 id="step-by-step-instructions">
    
    
     <a href="#step-by-step-instructions">#</a><a href="#" aria-label="Back to top">Step-by-Step Instructions</a>
        
    
  </h2>
      

<p><em>(Reminder: TRIPLE-CHECK your target device name, e.g., <code class="language-plaintext highlighter-rouge">/dev/sdX</code>, before every destructive command!)</em></p>
  <h3 id="phase-1-prepare-the-linux-environment-opensuse-tumbleweed">
    
    
     <a href="#phase-1-prepare-the-linux-environment-opensuse-tumbleweed">#</a><a href="#" aria-label="Back to top">Phase 1: Prepare the Linux Environment (openSUSE Tumbleweed)</a>
        
    
  </h3>
      

<ol>
  <li><strong>Boot into openSUSE:</strong> Start your preparation environment.</li>
  <li><strong>Install Necessary Tools:</strong> Open a terminal. <code class="language-plaintext highlighter-rouge">zypper refresh</code> updates package lists. <code class="language-plaintext highlighter-rouge">zypper install</code> installs tools.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">sudo </span>zypper refresh
<span class="nb">sudo </span>zypper <span class="nb">install</span> <span class="nt">-y</span> parted lvm2 dosfstools e2fsprogs
</code></section></div>    </div>
  </li>
  <li><strong>Identify Target USB Drive:</strong> <strong>CRITICAL SAFETY STEP!</strong> Unplug other USB storage.
    <ul>
      <li>Insert the target USB drive.</li>
      <li>Use multiple commands. Compare SIZE and MODEL. Check <code class="language-plaintext highlighter-rouge">dmesg | tail</code> after plugging in for kernel messages like <code class="language-plaintext highlighter-rouge">sd 2:0:0:0: [sdc] Attached SCSI removable disk</code>.
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>lsblk <span class="nt">-d</span> <span class="nt">-o</span> NAME,SIZE,MODEL,VENDOR,TYPE | <span class="nb">grep</span> <span class="s1">'disk'</span>
<span class="nb">sudo </span>fdisk <span class="nt">-l</span> | <span class="nb">grep</span> <span class="s1">'^Disk /dev/'</span>
<span class="nb">sudo </span>parted <span class="nt">-l</span> | <span class="nb">grep</span> <span class="s1">'^Disk /dev/'</span>
<span class="c"># Example: If consistently identified as /dev/sdc, use /dev/sdc below.</span>
</code></section></div>        </div>
      </li>
      <li>Visually confirm with YaST Partitioner (<code class="language-plaintext highlighter-rouge">sudo yast2 partitioner</code>) or GParted (<code class="language-plaintext highlighter-rouge">sudo zypper install -y gparted &amp;&amp; sudo gparted</code>) if preferred. Look for the drive matching the expected size and vendor/model.</li>
      <li>Assume <code class="language-plaintext highlighter-rouge">/dev/sdX</code> is your verified target drive. <strong>Replace it carefully!</strong></li>
    </ul>
  </li>
</ol>
  <h3 id="phase-2-partition-the-usb-drive">
    
    
     <a href="#phase-2-partition-the-usb-drive">#</a><a href="#" aria-label="Back to top">Phase 2: Partition the USB Drive</a>
        
    
  </h3>
      

<p><strong>(Warning: The following <code class="language-plaintext highlighter-rouge">parted</code> commands are DESTRUCTIVE to <code class="language-plaintext highlighter-rouge">/dev/sdX</code>. Double-check the device name!)</strong></p>

<p>This script automates the partitioning and formatting process. Save it as <code class="language-plaintext highlighter-rouge">prepare_usb.sh</code>, make it executable (<code class="language-plaintext highlighter-rouge">chmod +x prepare_usb.sh</code>), and run it with <code class="language-plaintext highlighter-rouge">sudo ./prepare_usb.sh /dev/sdX</code> (replacing <code class="language-plaintext highlighter-rouge">/dev/sdX</code> with your verified target device).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="c">#!/bin/bash</span>

<span class="c"># --- Configuration ---</span>
<span class="c"># Exit immediately if a command exits with a non-zero status.</span>
<span class="c"># Treat unset variables as an error when substituting.</span>
<span class="c"># Pipelines return the exit status of the last command to exit non-zero.</span>
<span class="nb">set</span> <span class="nt">-euo</span> pipefail

<span class="c"># --- Variables ---</span>
<span class="c"># EFI System Partition (ESP) Label (CRITICAL - must match bootloader config)</span>
<span class="nv">ESP_LABEL</span><span class="o">=</span><span class="s2">"sbnb"</span>
<span class="c"># Data Partition Label (Recommended for identification)</span>
<span class="nv">DATA_LABEL</span><span class="o">=</span><span class="s2">"SBNB_DATA"</span>
<span class="c"># ESP Size (Adjust if needed, ~1GB is usually sufficient)</span>
<span class="nv">ESP_SIZE</span><span class="o">=</span><span class="s2">"1025MiB"</span>
<span class="c"># List of required commands for the script to function</span>
<span class="nv">REQUIRED_CMDS</span><span class="o">=(</span>
  <span class="s2">"parted"</span> <span class="s2">"mkfs.vfat"</span> <span class="s2">"mkfs.ext4"</span> <span class="s2">"wipefs"</span> <span class="s2">"findmnt"</span> <span class="s2">"lsblk"</span>
  <span class="s2">"blkid"</span> <span class="s2">"fsck.vfat"</span> <span class="s2">"e2fsck"</span> <span class="s2">"sync"</span> <span class="s2">"id"</span> <span class="s2">"grep"</span> <span class="s2">"read"</span>
  <span class="s2">"sleep"</span> <span class="s2">"xargs"</span> <span class="s2">"umount"</span> <span class="s2">"partprobe"</span> <span class="s2">"realpath"</span>
<span class="o">)</span>

<span class="c"># --- Functions ---</span>
<span class="c"># Function to check for required commands</span>
check_dependencies<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"--- Checking for required commands ---"</span>
  <span class="nb">local </span><span class="nv">missing_cmds</span><span class="o">=()</span>
  <span class="k">for </span>cmd <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">REQUIRED_CMDS</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> <span class="s2">"</span><span class="nv">$cmd</span><span class="s2">"</span> &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
      </span>missing_cmds+<span class="o">=(</span><span class="s2">"</span><span class="nv">$cmd</span><span class="s2">"</span><span class="o">)</span>
    <span class="k">fi
  done

  if</span> <span class="o">[</span> <span class="k">${#</span><span class="nv">missing_cmds</span><span class="p">[@]</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ERROR: The following required commands are not found:"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">printf</span> <span class="s2">" - %s</span><span class="se">\n</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">missing_cmds</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"Please install them and try again."</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">exit </span>1
  <span class="k">fi
  </span><span class="nb">echo</span> <span class="s2">"All required commands found."</span>
<span class="o">}</span>

<span class="c"># Function to get the base block device for a given path (handles partitions, links, etc.)</span>
get_base_device<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">path</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>resolved_path
  <span class="nv">resolved_path</span><span class="o">=</span><span class="si">$(</span><span class="nb">realpath</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span><span class="si">)</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"ERROR: Cannot resolve path '</span><span class="nv">$path</span><span class="s2">'"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="k">return </span>1<span class="p">;</span> <span class="o">}</span>
  <span class="c"># lsblk -no pkname gets the parent kernel name (base device)</span>
  lsblk <span class="nt">-no</span> pkname <span class="s2">"</span><span class="nv">$resolved_path</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"ERROR: Cannot find base device for '</span><span class="nv">$resolved_path</span><span class="s2">' using lsblk."</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="k">return </span>1<span class="p">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="c"># --- Script Start ---</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"--- USB Drive Partitioning and Formatting Script ---"</span>
<span class="nb">echo</span> <span class="s2">"---  (Version 2 - Enhanced Safety)      ---"</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"WARNING: This script is DESTRUCTIVE and will ERASE"</span>
<span class="nb">echo</span> <span class="s2">" ALL DATA on the target device."</span>
<span class="nb">echo</span> <span class="s2">""</span>

<span class="c"># --- Check for Root Privileges ---</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: This script must be run as root (e.g., using sudo)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># --- Check Dependencies ---</span>
check_dependencies

<span class="c"># --- Check for Device Argument ---</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> /dev/sdX"</span>
  <span class="nb">echo</span> <span class="s2">"ERROR: Please provide the target block device (e.g., /dev/sda, /dev/sdb)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"Available block devices (excluding ROM, loop, and RAM devices):"</span>
  lsblk <span class="nt">-d</span> <span class="nt">-o</span> NAME,SIZE,TYPE,MODEL | <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s1">'rom|loop|ram'</span>
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">DEVICE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>

<span class="c"># --- Validate Device ---</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: '</span><span class="nv">$DEVICE</span><span class="s2">' is not a valid block device."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># --- CRITICAL SAFETY CHECK: Prevent targeting the root filesystem device ---</span>
<span class="nb">echo</span> <span class="s2">"--- Performing safety checks ---"</span>
<span class="nv">ROOT_DEV_PATH</span><span class="o">=</span><span class="si">$(</span>findmnt <span class="nt">-n</span> <span class="nt">-o</span> SOURCE /<span class="si">)</span>
<span class="nv">ROOT_BASE_DEV_NAME</span><span class="o">=</span><span class="si">$(</span>get_base_device <span class="s2">"</span><span class="nv">$ROOT_DEV_PATH</span><span class="s2">"</span><span class="si">)</span> <span class="o">||</span> <span class="nb">exit </span>1 <span class="c"># Exit if function fails</span>
<span class="nv">TARGET_BASE_DEV_NAME</span><span class="o">=</span><span class="si">$(</span>get_base_device <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span><span class="si">)</span> <span class="o">||</span> <span class="nb">exit </span>1

<span class="c"># Construct full device paths for comparison</span>
<span class="nv">ROOT_BASE_DEV</span><span class="o">=</span><span class="s2">"/dev/</span><span class="k">${</span><span class="nv">ROOT_BASE_DEV_NAME</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">TARGET_BASE_DEV</span><span class="o">=</span><span class="s2">"/dev/</span><span class="k">${</span><span class="nv">TARGET_BASE_DEV_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="c"># Assumes the input $DEVICE is the base device</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TARGET_BASE_DEV</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$ROOT_BASE_DEV</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">"FATAL ERROR: Target device '</span><span class="nv">$DEVICE</span><span class="s2">' appears to be the same"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">" device ('</span><span class="nv">$ROOT_BASE_DEV</span><span class="s2">') as the running root"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">" filesystem ('</span><span class="nv">$ROOT_DEV_PATH</span><span class="s2">')."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">" Aborting to prevent data loss."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"Safety check passed: Target device '</span><span class="nv">$DEVICE</span><span class="s2">' is not the root filesystem device ('</span><span class="nv">$ROOT_BASE_DEV</span><span class="s2">')."</span>

<span class="c"># Check if the device looks like an SD card reader often used for the OS drive</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">==</span> /dev/mmcblk<span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"WARNING: '</span><span class="nv">$DEVICE</span><span class="s2">' looks like an SD card (e.g., /dev/mmcblk0)."</span>
  <span class="nb">echo</span> <span class="s2">" Double-check this is not your primary OS drive!"</span>
<span class="k">fi</span>


<span class="c"># --- Confirmation ---</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"Target Device: </span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Partitions to be created:"</span>
<span class="nb">echo</span> <span class="s2">"  1: EFI System Partition (ESP), FAT32, Label: '</span><span class="nv">$ESP_LABEL</span><span class="s2">', Size: </span><span class="nv">$ESP_SIZE</span><span class="s2">, Flags: boot, esp"</span>
<span class="nb">echo</span> <span class="s2">"  2: Linux Data Partition, ext4, Label: '</span><span class="nv">$DATA_LABEL</span><span class="s2">', Size: Remaining space"</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"ARE YOU ABSOLUTELY SURE you want to erase '</span><span class="nv">$DEVICE</span><span class="s2">' and proceed? (yes/NO): "</span> CONFIRMATION
<span class="nv">CONFIRMATION</span><span class="o">=</span><span class="k">${</span><span class="nv">CONFIRMATION</span><span class="k">:-</span><span class="nv">NO</span><span class="k">}</span> <span class="c"># Default to NO if user just presses Enter</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$CONFIRMATION</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"yes"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Operation cancelled by user."</span>
  <span class="nb">exit </span>0
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Proceeding with operations on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>

<span class="c"># --- Phase 2: Partition the USB Drive ---</span>

<span class="c"># 1. Unmount Existing Partitions</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Unmounting any existing partitions on </span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}</span><span class="s2">* ---"</span>
<span class="c"># Use findmnt to get mount points and umount them safely</span>
<span class="c"># Also try to unmount the base device itself in case it's loop-mounted etc.</span>
findmnt <span class="nt">-n</span> <span class="nt">-o</span> TARGET <span class="nt">--source</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}</span><span class="s2">*"</span> | xargs <span class="nt">--no-run-if-empty</span> umount <span class="nt">-v</span> <span class="nt">-l</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"Info: No partitions were mounted or umount failed (might be okay)."</span>
umount <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> &amp;&gt;/dev/null <span class="o">||</span> <span class="nb">true</span> <span class="c"># Attempt to unmount base device, ignore errors</span>
<span class="nb">sleep </span>1 <span class="c"># Give time for umount to settle</span>
lsblk <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>

<span class="c"># 2. Wipe Existing Signatures (Recommended)</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Wiping filesystem/partition signatures from </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
wipefs <span class="nt">--all</span> <span class="nt">--force</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk to ensure changes are physically written</span>

<span class="c"># 3. Create New GPT Partition Table</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Creating new GPT partition table on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> mklabel gpt
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># 4. Create EFI System Partition (ESP)</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Creating ESP partition (1) on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> mkpart <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">"</span> fat32 1MiB <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_SIZE</span><span class="k">}</span><span class="s2">"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> <span class="nb">set </span>1 boot on
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> <span class="nb">set </span>1 esp on
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># 5. Create Linux Data Partition</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Creating Linux data partition (2) on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
<span class="c"># Use the end of the ESP as the start for the data partition</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> mkpart <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">"</span> ext4 <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_SIZE</span><span class="k">}</span><span class="s2">"</span> 100%
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>
<span class="nb">echo</span> <span class="s2">"Waiting briefly for kernel to recognize new partitions..."</span>
<span class="nb">sleep </span>2

<span class="c"># Define partition variables (assuming standard naming, e.g., /dev/sda1, /dev/sda2)</span>
<span class="c"># Adding 'p' for NVMe devices (e.g., /dev/nvme0n1p1) - check if base device name contains 'nvme'</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">==</span> <span class="k">*</span>nvme<span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">PART_PREFIX</span><span class="o">=</span><span class="s2">"p"</span>
<span class="k">else
  </span><span class="nv">PART_PREFIX</span><span class="o">=</span><span class="s2">""</span>
<span class="k">fi
</span><span class="nv">ESP_PARTITION</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}${</span><span class="nv">PART_PREFIX</span><span class="k">}</span><span class="s2">1"</span>
<span class="nv">DATA_PARTITION</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}${</span><span class="nv">PART_PREFIX</span><span class="k">}</span><span class="s2">2"</span>

<span class="c"># Check if partition devices exist, retry with partprobe if needed</span>
<span class="nb">echo</span> <span class="s2">"--- Checking for partition device nodes (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">, </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">) ---"</span>
<span class="nv">PARTITIONS_FOUND</span><span class="o">=</span><span class="nb">false
</span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..5<span class="o">}</span><span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$ESP_PARTITION</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$DATA_PARTITION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Partition nodes found."</span>
    <span class="nv">PARTITIONS_FOUND</span><span class="o">=</span><span class="nb">true
    break
  </span><span class="k">fi
  </span><span class="nb">echo</span> <span class="s2">"Partition nodes not yet found. Retrying probe (Attempt </span><span class="nv">$i</span><span class="s2">/5)..."</span>
  partprobe <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"Warning: partprobe command failed, continuing check..."</span>
  <span class="nb">sleep </span>1
<span class="k">done

if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$PARTITIONS_FOUND</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: Partition devices (</span><span class="nv">$ESP_PARTITION</span><span class="s2">, </span><span class="nv">$DATA_PARTITION</span><span class="s2">) not found after partitioning and retries."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">"    Please check manually ('lsblk </span><span class="nv">$DEVICE</span><span class="s2">', 'parted </span><span class="nv">$DEVICE</span><span class="s2"> print')."</span> <span class="o">&gt;</span>&amp;2
  lsblk <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># 6. Verify Partitioning</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying partitions on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> print
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Block device view: ---"</span>
lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,PARTLABEL,MOUNTPOINT,PARTFLAGS <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"----------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Expected: </span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2"> (~</span><span class="k">${</span><span class="nv">ESP_SIZE</span><span class="k">}</span><span class="s2">), Type EFI System, Flags: boot, esp"</span>
<span class="nb">echo</span> <span class="s2">"Expected: </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2"> (Remaining size), Type Linux filesystem"</span>
<span class="nb">echo</span> <span class="s2">"----------------------------"</span>
<span class="nb">sleep </span>2 <span class="c"># Pause for user to review</span>


<span class="c"># --- Phase 3: Format Filesystems ---</span>

<span class="c"># 1. Format EFI Partition</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Formatting ESP partition (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">) as FAT32 with label '</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">' ---"</span>
mkfs.vfat <span class="nt">-F</span> 32 <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># Check filesystem integrity</span>
<span class="nb">echo</span> <span class="s2">"--- Checking ESP filesystem (fsck.vfat) ---"</span>
<span class="nv">FSCK_VFAT_EXIT_CODE</span><span class="o">=</span>0
fsck.vfat <span class="nt">-a</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="nv">FSCK_VFAT_EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span> <span class="c"># Run fsck, capture exit code on failure</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$FSCK_VFAT_EXIT_CODE</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ESP filesystem check passed (or no check performed)."</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$FSCK_VFAT_EXIT_CODE</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Exit code 1 usually means errors were found AND corrected.</span>
  <span class="nb">echo</span> <span class="s2">"WARNING: fsck.vfat found and corrected errors on ESP partition (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">). Check output above."</span>
<span class="k">else</span>
  <span class="c"># Exit codes &gt; 1 typically indicate uncorrected errors.</span>
  <span class="nb">echo</span> <span class="s2">"ERROR: fsck.vfat reported uncorrectable errors (Exit Code: </span><span class="nv">$FSCK_VFAT_EXIT_CODE</span><span class="s2">) on ESP partition (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">"    Cannot proceed safely. Please investigate manually."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Verify label using blkid</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying ESP label ---"</span>
<span class="k">if </span>blkid <span class="nt">-s</span> LABEL <span class="nt">-o</span> value <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"^</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">$"</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ESP Label '</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">' verified successfully on </span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">."</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"ERROR: Failed to verify ESP Label '</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">' on </span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">."</span> <span class="o">&gt;</span>&amp;2
  blkid <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="c"># Show full blkid output for debugging</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># 2. Format Data Partition</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Formatting Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">) as ext4 with label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' ---"</span>
mkfs.ext4 <span class="nt">-m</span> 0 <span class="nt">-L</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># Check the new ext4 filesystem integrity</span>
<span class="nb">echo</span> <span class="s2">"--- Checking Data partition filesystem (e2fsck) ---"</span>
<span class="c"># -f forces check even if clean, -y assumes yes to all prompts (use with caution)</span>
<span class="nv">E2FSCK_EXIT_CODE</span><span class="o">=</span>0
e2fsck <span class="nt">-f</span> <span class="nt">-y</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="nv">E2FSCK_EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span> <span class="c"># Capture exit code on failure</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$E2FSCK_EXIT_CODE</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Data partition filesystem check passed."</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$E2FSCK_EXIT_CODE</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Exit code 1 means errors were corrected.</span>
  <span class="nb">echo</span> <span class="s2">"WARNING: e2fsck found and corrected errors on Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">). Check output above."</span>
<span class="k">else</span>
  <span class="c"># Exit codes &gt; 1 indicate uncorrected errors.</span>
  <span class="nb">echo</span> <span class="s2">"ERROR: e2fsck reported uncorrectable errors (Exit Code: </span><span class="nv">$E2FSCK_EXIT_CODE</span><span class="s2">) on Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">"    Cannot proceed safely. Please investigate manually."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Verify the label using blkid</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying Data partition label ---"</span>
<span class="k">if </span>blkid <span class="nt">-s</span> LABEL <span class="nt">-o</span> value <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"^</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">$"</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Data Label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' verified successfully on </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">."</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"ERROR: Failed to verify Data Label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' on </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">."</span> <span class="o">&gt;</span>&amp;2
  blkid <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="c"># Show full blkid output for debugging</span>
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"--- Script finished successfully! ---"</span>
<span class="nb">echo</span> <span class="s2">"Device: </span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Partitions created and formatted:"</span>
lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,LABEL,PARTLABEL,MOUNTPOINT <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>

<span class="nb">exit </span>0
</code></section></div></div>
  <h3 id="phase-3-install-sbnb-boot-files-and-configuration">
    
    
     <a href="#phase-3-install-sbnb-boot-files-and-configuration">#</a><a href="#" aria-label="Back to top">Phase 3: Install Sbnb Boot Files and Configuration</a>
        
    
  </h3>
      

<ol>
  <li><strong>Mount EFI Partition:</strong> Access the ESP filesystem. Replace <code class="language-plaintext highlighter-rouge">/dev/sdX1</code> with the actual ESP partition device name identified earlier.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Mounting ESP partition ---"</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /mnt/sbnb-mount
<span class="nb">sudo </span>mount /dev/sdX1 /mnt/sbnb-mount
</code></section></div>    </div>
  </li>
  <li><strong>Create EFI Boot Directory:</strong> Standard UEFI fallback path.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating EFI boot directories ---"</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /mnt/sbnb-mount/EFI/BOOT
</code></section></div>    </div>
  </li>
  <li><strong>Copy Sbnb EFI Boot File:</strong> Place the bootloader (<code class="language-plaintext highlighter-rouge">sbnb.efi</code> as <code class="language-plaintext highlighter-rouge">BOOTX64.EFI</code>). Replace <code class="language-plaintext highlighter-rouge">/path/to/your/sbnb.efi</code> with the actual path to the file you obtained.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Copying Sbnb EFI boot file ---"</span>
<span class="nb">sudo cp</span> /path/to/your/sbnb.efi /mnt/sbnb-mount/EFI/BOOT/BOOTX64.EFI
</code></section></div>    </div>
  </li>
  <li><strong>Run Sbnb Configuration python script:</strong> Mount <code class="language-plaintext highlighter-rouge">/dev/sdX1</code> to <code class="language-plaintext highlighter-rouge">/mnt/sbnb</code> and <code class="language-plaintext highlighter-rouge">/dev/sdX2</code> to <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code>. Replace <code class="language-plaintext highlighter-rouge">tskey-auth-...</code> with your actual Tailscale auth key on this python script:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><section><code><span class="c1">#!/usr/bin/env python3
</span><span class="sh">"""</span><span class="s">
Unified SBNB Configuration Deployment Script (Version 2.1 - BusyBox cp focus).

Generates configuration files and scripts to:
- Mount a persistent data partition.
- Configure Docker to use a persistent data-root on that partition.
- Optionally migrate existing Docker data from /var/lib/docker robustly using busybox cp.
- Set up backup/purge routines for the persistent Docker data.
- Set up health and volume monitoring for Docker (with safer defaults).
- Deploy a Tailscale authentication key.
- Deploy an optional development environment script.

Core components generated:
- /mnt/sbnb/sbnb-cmds.sh: Main boot script executed by the system.
- /mnt/sbnb/sbnb-tskey.txt: Tailscale authentication key.
- /mnt/sbnb-data/scripts/*: Helper scripts for backup, purge, health checks.
- /mnt/sbnb-data/systemd/*: Systemd units to automate helper scripts.

Prerequisites:
- Run as root.
- ESP partition mounted at /mnt/sbnb (writable).
- Data partition mounted at /mnt/sbnb-data (writable).
- Required: Standard Linux utilities (coreutils including </span><span class="sh">'</span><span class="s">cp</span><span class="sh">'</span><span class="s">, systemd, grep, sed, etc.).
- Recommended: `jq` installed on the target system for robust JSON handling.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">stat</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">pathlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># --- Configuration: File Paths ---
# Base mount points - Script will check if these exist and are writable
</span><span class="n">ESP_MOUNT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/mnt/sbnb</span><span class="sh">"</span>
<span class="n">DATA_MOUNT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/mnt/sbnb-data</span><span class="sh">"</span>

<span class="c1"># Docker configuration
</span><span class="n">PERSISTENT_DOCKER_ROOT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/docker-root</span><span class="sh">"</span>
<span class="n">DOCKER_CONFIG_DIR</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/etc/docker</span><span class="sh">"</span>
<span class="n">DOCKER_CONFIG_FILE</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DOCKER_CONFIG_DIR</span><span class="si">}</span><span class="s">/daemon.json</span><span class="sh">"</span>
<span class="n">DOCKER_CONFIG_BACKUP_SUFFIX</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.sbnb-orig-backup</span><span class="sh">"</span> <span class="c1"># Suffix for one-time backup
</span><span class="n">DOCKER_DATA_EPHEMERAL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/var/lib/docker</span><span class="sh">"</span> <span class="c1"># Default path for migration check
# Permissions for Docker root dir (rwx--x--x). Owner/Group should be root:root.
# Use standard integer representation for octal in Python
</span><span class="n">DOCKER_ROOT_PERMISSIONS</span> <span class="o">=</span> <span class="mo">0o711</span>
<span class="c1"># Permissions for daemon.json (rw-r--r--)
</span><span class="n">DOCKER_CONFIG_PERMISSIONS</span> <span class="o">=</span> <span class="mo">0o644</span>

<span class="c1"># Backup configuration
</span><span class="n">BACKUP_BASE_DIR</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/backups/docker</span><span class="sh">"</span>
<span class="n">BACKUP_KEEP_COUNT</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># Number of backups to retain
</span><span class="n">STOP_DOCKER_FOR_BACKUP</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 1 = Stop Docker during backup (safer), 0 = Attempt live backup
# Permissions for backup base directory (rwxr-x---)
</span><span class="n">BACKUP_DIR_PERMISSIONS</span> <span class="o">=</span> <span class="mo">0o750</span>

<span class="c1"># Health Check configuration
</span><span class="n">VOLUME_CHECK_THRESHOLD_PERCENT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Warn if free space drops below this %
# Pruning level in volume check: 0=None, 1=Containers/Dangling Images, 2=All Unused Images+Containers (--volumes still excluded)
</span><span class="n">VOLUME_CHECK_PRUNE_LEVEL</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># --- Content Definitions ---
</span>
<span class="c1"># --- sbnb-cmds.sh Content ---
# REFACTOR: Removed rsync checks and usage, standardized on cp -a -u for migration.
# REFACTOR: Use correct octal format specifier (:o) for mkdir -m and chmod.
</span><span class="n">SBNB_CMDS_SH_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">#!/bin/sh
# Sbnb Custom Commands Script (Unified Persistent Docker Root + Features - v2.1 - BusyBox cp)
# Mounts persistent data, configures Docker data-root, migrates data (if needed using cp),
# updates optional scripts, enables systemd units for backup &amp; monitoring.

# Strict error handling
set -e -o pipefail -u

# --- Logging Function ---
log() {{
    # Log to kernel message buffer
    echo </span><span class="sh">"</span><span class="s">[sbnb-cmds.sh] $1</span><span class="sh">"</span><span class="s"> &gt; /dev/kmsg
}}

log </span><span class="sh">"</span><span class="s">Starting custom boot commands (Unified Persistent Docker Root v2.1 - BusyBox cp)...</span><span class="sh">"</span><span class="s">

# --- Check Core Commands ---
# Ensure essential commands for this script are present
check_cmds() {{
    local missing_cmd=0
    log </span><span class="sh">"</span><span class="s">Checking required commands...</span><span class="sh">"</span><span class="s">
    for cmd in </span><span class="sh">"</span><span class="s">$@</span><span class="sh">"</span><span class="s">; do
        if ! command -v </span><span class="sh">"</span><span class="s">$cmd</span><span class="sh">"</span><span class="s"> &gt;/dev/null 2&gt;&amp;1; then
            log </span><span class="sh">"</span><span class="s">ERROR: Required command </span><span class="sh">'</span><span class="s">$cmd</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="s">
            missing_cmd=1
        fi
    done
    if [ $missing_cmd -eq 1 ]; then
        log </span><span class="sh">"</span><span class="s">ERROR: Missing one or more required commands. Cannot proceed.</span><span class="sh">"</span><span class="s">
        exit 1
    fi
    log </span><span class="sh">"</span><span class="s">Required commands found.</span><span class="sh">"</span><span class="s">
    # Check optional but recommended commands
    if ! command -v jq &gt;/dev/null 2&gt;&amp;1; then
        log </span><span class="sh">"</span><span class="s">WARNING: </span><span class="sh">'</span><span class="s">jq</span><span class="sh">'</span><span class="s"> command not found. JSON handling for daemon.json will be less robust and may fail on complex existing files.</span><span class="sh">"</span><span class="s">
    else
        log </span><span class="sh">"</span><span class="s">OK: </span><span class="sh">'</span><span class="s">jq</span><span class="sh">'</span><span class="s"> command found (recommended).</span><span class="sh">"</span><span class="s">
    fi
    # Note: rsync check removed as cp -a -u is now the standard method
}}
# Define all commands potentially used in this script
# Removed </span><span class="sh">'</span><span class="s">rsync</span><span class="sh">'</span><span class="s"> from the list.
check_cmds mountpoint readlink mkdir mount echo sleep rm find ln systemctl mktemp cp mv chmod chown dirname basename jq grep cat cmp date sed ls

# --- Mount Persistent Data Partition ---
DATA_LABEL=</span><span class="sh">"</span><span class="s">SBNB_DATA</span><span class="sh">"</span><span class="s">
DATA_DEVICE_SYMLINK=</span><span class="sh">"</span><span class="s">/dev/disk/by-label/${{DATA_LABEL}}</span><span class="sh">"</span><span class="s">
DATA_MOUNT_POINT=</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="sh">"</span><span class="s">
MAX_WAIT_SECONDS=15
WAIT_INTERVAL=1
elapsed_time=0

log </span><span class="sh">"</span><span class="s">Waiting up to ${{MAX_WAIT_SECONDS}}s for data device (Label: ${{DATA_LABEL}})...</span><span class="sh">"</span><span class="s">
while [ ! -e </span><span class="sh">"</span><span class="s">${{DATA_DEVICE_SYMLINK}}</span><span class="sh">"</span><span class="s"> ]; do
    if [ ${{elapsed_time}} -ge ${{MAX_WAIT_SECONDS}} ]; then
        log </span><span class="sh">"</span><span class="s">ERROR: Timeout waiting for device ${{DATA_DEVICE_SYMLINK}}. Persistent data cannot be mounted.</span><span class="sh">"</span><span class="s">
        exit 1
    fi
    sleep ${{WAIT_INTERVAL}}
    elapsed_time=$((elapsed_time + WAIT_INTERVAL))
done
DATA_DEVICE=$(readlink -f </span><span class="sh">"</span><span class="s">${{DATA_DEVICE_SYMLINK}}</span><span class="sh">"</span><span class="s">)
log </span><span class="sh">"</span><span class="s">Data partition device resolved to ${{DATA_DEVICE}} after ${{elapsed_time}}s.</span><span class="sh">"</span><span class="s">

# Ensure mount point directory exists
mkdir -p </span><span class="sh">"</span><span class="s">${{DATA_MOUNT_POINT}}</span><span class="sh">"</span><span class="s">

log </span><span class="sh">"</span><span class="s">Attempting to mount ${{DATA_DEVICE}} at ${{DATA_MOUNT_POINT}}...</span><span class="sh">"</span><span class="s">
if ! mountpoint -q </span><span class="sh">"</span><span class="s">${{DATA_MOUNT_POINT}}</span><span class="sh">"</span><span class="s">; then
    # Attempt to mount read-write, noatime, nodiratime
    if mount -o rw,noatime,nodiratime </span><span class="sh">"</span><span class="s">${{DATA_DEVICE}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DATA_MOUNT_POINT}}</span><span class="sh">"</span><span class="s">; then
        log </span><span class="sh">"</span><span class="s">Successfully mounted persistent partition at ${{DATA_MOUNT_POINT}}.</span><span class="sh">"</span><span class="s">
    else
        log </span><span class="sh">"</span><span class="s">ERROR: Failed to mount ${{DATA_DEVICE}} at ${{DATA_MOUNT_POINT}}! Check filesystem and device.</span><span class="sh">"</span><span class="s">
        exit 1
    fi
else
    log </span><span class="sh">"</span><span class="s">Persistent partition already mounted at ${{DATA_MOUNT_POINT}}. Ensuring read-write...</span><span class="sh">"</span><span class="s">
    # Ensure partition is mounted read-write
    mount -o remount,rw </span><span class="sh">"</span><span class="s">${{DATA_MOUNT_POINT}}</span><span class="sh">"</span><span class="s"> || {{
        log </span><span class="sh">"</span><span class="s">ERROR: Failed to remount ${{DATA_MOUNT_POINT}} as read-write! Docker requires write access.</span><span class="sh">"</span><span class="s">
        exit 1
    }}
fi

# --- Configure Docker to use Persistent Data Directory ---
log </span><span class="sh">"</span><span class="s">Setting up Docker to use persistent data-root...</span><span class="sh">"</span><span class="s">

PERSISTENT_DOCKER_ROOT=</span><span class="sh">"</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="s">
DOCKER_CONFIG_DIR=</span><span class="sh">"</span><span class="si">{</span><span class="n">DOCKER_CONFIG_DIR</span><span class="si">}</span><span class="sh">"</span><span class="s">
DOCKER_CONFIG_FILE=</span><span class="sh">"</span><span class="si">{</span><span class="n">DOCKER_CONFIG_FILE</span><span class="si">}</span><span class="sh">"</span><span class="s">
DOCKER_CONFIG_BACKUP=</span><span class="sh">"</span><span class="si">{</span><span class="n">DOCKER_CONFIG_FILE</span><span class="si">}{</span><span class="n">DOCKER_CONFIG_BACKUP_SUFFIX</span><span class="si">}</span><span class="sh">"</span><span class="s">
DOCKER_DATA_EPHEMERAL=</span><span class="sh">"</span><span class="si">{</span><span class="n">DOCKER_DATA_EPHEMERAL</span><span class="si">}</span><span class="sh">"</span><span class="s"> # For migration check
CONFIG_CHANGED=0 # Flag to track if we need to restart docker

# 1. Ensure the persistent Docker data-root directory exists with correct owner/permissions
log </span><span class="sh">"</span><span class="s">Ensuring persistent Docker data directory exists: ${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s">
# Create with specific permissions (rwx--x--x) using correct octal format for command line
mkdir -p -m </span><span class="si">{</span><span class="n">DOCKER_ROOT_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s">
if [ ! -d </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">ERROR: Failed to create persistent Docker data directory ${{PERSISTENT_DOCKER_ROOT}}!</span><span class="sh">"</span><span class="s">
    exit 1
fi
# Ensure ownership is root:root (critical for Docker)
log </span><span class="sh">"</span><span class="s">Ensuring ownership of ${{PERSISTENT_DOCKER_ROOT}} is root:root...</span><span class="sh">"</span><span class="s">
chown root:root </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> || log </span><span class="sh">"</span><span class="s">WARNING: Failed to set ownership on ${{PERSISTENT_DOCKER_ROOT}}. Docker might have issues.</span><span class="sh">"</span><span class="s">
# Ensure permissions are correct (mkdir -p doesn</span><span class="sh">'</span><span class="s">t always set mode on existing dirs) using correct octal format for command line
log </span><span class="sh">"</span><span class="s">Ensuring permissions of ${{PERSISTENT_DOCKER_ROOT}} are </span><span class="si">{</span><span class="n">DOCKER_ROOT_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="s">
chmod </span><span class="si">{</span><span class="n">DOCKER_ROOT_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> || log </span><span class="sh">"</span><span class="s">WARNING: Failed to set permissions on ${{PERSISTENT_DOCKER_ROOT}}.</span><span class="sh">"</span><span class="s">

log </span><span class="sh">"</span><span class="s">Persistent Docker data directory ensured.</span><span class="sh">"</span><span class="s">

# 2. Create/Update Docker daemon configuration (/etc/docker/daemon.json)
log </span><span class="sh">"</span><span class="s">Configuring Docker daemon (${{DOCKER_CONFIG_FILE}}) to use data-root: ${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s">
mkdir -p </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_DIR}}</span><span class="sh">"</span><span class="s"> # Ensure config directory exists

# Backup original config ONCE if it exists and backup doesn</span><span class="sh">'</span><span class="s">t
if [ -f </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ ! -f </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_BACKUP}}</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">Backing up original Docker config to ${{DOCKER_CONFIG_BACKUP}}...</span><span class="sh">"</span><span class="s">
    cp -a </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_BACKUP}}</span><span class="sh">"</span><span class="s"> || </span><span class="se">\\</span><span class="s">
        log </span><span class="sh">"</span><span class="s">WARNING: Failed to create backup of ${{DOCKER_CONFIG_FILE}}.</span><span class="sh">"</span><span class="s">
fi

# --- Safely update daemon.json ---
NEEDS_UPDATE=0
# Use jq if available (preferred method)
if command -v jq &gt;/dev/null 2&gt;&amp;1; then
    log </span><span class="sh">"</span><span class="s">Using jq to manage daemon.json.</span><span class="sh">"</span><span class="s">
    # Ensure file exists with at least {{}} for jq processing
    [ -f </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> ] || echo </span><span class="sh">"</span><span class="s">{{}}</span><span class="sh">"</span><span class="s"> &gt; </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">

    # Read current value safely, defaulting to empty string if null or missing
    current_data_root=$(jq -r </span><span class="sh">'</span><span class="s">.[</span><span class="sh">"</span><span class="s">data-root</span><span class="sh">"</span><span class="s">] // </span><span class="sh">""'</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">)

    if [ </span><span class="sh">"</span><span class="s">$current_data_root</span><span class="sh">"</span><span class="s"> != </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> ]; then
        log </span><span class="sh">"</span><span class="s">Data-root needs update (jq check). Preparing changes...</span><span class="sh">"</span><span class="s">
        NEEDS_UPDATE=1
    else
        log </span><span class="sh">"</span><span class="s">Docker data-root already correctly set in daemon.json (jq check).</span><span class="sh">"</span><span class="s">
    fi

    if [ $NEEDS_UPDATE -eq 1 ]; then
        TMP_JSON=$(mktemp </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_DIR}}/daemon.json.tmp.XXXXXX</span><span class="sh">"</span><span class="s">)
        log </span><span class="sh">"</span><span class="s">Attempting to merge data-root setting using jq...</span><span class="sh">"</span><span class="s">
        # Merge the new data-root value, preserving other keys
        if jq --arg path </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">'</span><span class="s">. + {{</span><span class="sh">"</span><span class="s">data-root</span><span class="sh">"</span><span class="s">: $path}}</span><span class="sh">'</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> &gt; </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s">; then
            # Check if jq produced valid JSON
            if jq -e . </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s"> &gt; /dev/null; then
                # Check if content actually changed before moving
                if ! cmp -s </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">; then
                    mv </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">
                    chmod </span><span class="si">{</span><span class="n">DOCKER_CONFIG_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> # Use correct format here too for consistency, though 644 doesn</span><span class="sh">'</span><span class="s">t need </span><span class="sh">'</span><span class="s">0o</span><span class="sh">'</span><span class="s"> prefix
                    log </span><span class="sh">"</span><span class="s">Successfully updated daemon.json using jq.</span><span class="sh">"</span><span class="s">
                    CONFIG_CHANGED=1
                else
                    log </span><span class="sh">"</span><span class="s">daemon.json content unchanged after jq merge, removing temp file.</span><span class="sh">"</span><span class="s">
                    rm -f </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s">
                fi
            else
                log </span><span class="sh">"</span><span class="s">ERROR: jq produced invalid JSON output. Config not updated.</span><span class="sh">"</span><span class="s">
                rm -f </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s"> # Clean up temp file
            fi
        else
            jq_exit_code=$?
            log </span><span class="sh">"</span><span class="s">ERROR: jq command failed (exit code $jq_exit_code) while updating config. Config not updated.</span><span class="sh">"</span><span class="s">
            # Optionally capture and log jq stderr here if needed
            rm -f </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s"> # Clean up temp file
        fi
    fi
# Fallback logic if jq is NOT available
else
    log </span><span class="sh">"</span><span class="s">WARNING: jq not found. Using less robust fallback for daemon.json.</span><span class="sh">"</span><span class="s">
    # Define the minimal target content
    TARGET_JSON_CONTENT=$(printf </span><span class="sh">'</span><span class="s">{{%s</span><span class="se">\\</span><span class="s">n  </span><span class="sh">"</span><span class="s">data-root</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">%s</span><span class="sh">"</span><span class="s">%s</span><span class="se">\\</span><span class="s">n}}%s</span><span class="se">\\</span><span class="s">n</span><span class="sh">'</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s">)

    if [ ! -f </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> ]; then
        log </span><span class="sh">"</span><span class="s">daemon.json does not exist. Creating new file with data-root.</span><span class="sh">"</span><span class="s">
        NEEDS_UPDATE=1
    else
        # Check if data-root key exists at all
        if ! grep -q </span><span class="sh">'"</span><span class="s">data-root</span><span class="sh">"</span><span class="se">\\</span><span class="s">s*:</span><span class="sh">'</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">; then
             log </span><span class="sh">"</span><span class="s">Existing daemon.json lacks </span><span class="sh">'</span><span class="s">data-root</span><span class="sh">'</span><span class="s"> key.</span><span class="sh">"</span><span class="s">
            # Check if the file is simple (e.g., just {{}} or empty/whitespace)
            if ! grep -q </span><span class="sh">'</span><span class="s">[a-zA-Z0-9]</span><span class="sh">'</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> || grep -q </span><span class="sh">'</span><span class="s">^</span><span class="se">\\</span><span class="s">s*{{</span><span class="se">\\</span><span class="s">s*}}</span><span class="se">\\</span><span class="s">s*$</span><span class="sh">'</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">; then
                log </span><span class="sh">"</span><span class="s">Existing file is simple, overwriting with data-root.</span><span class="sh">"</span><span class="s">
                NEEDS_UPDATE=1
            else
                log </span><span class="sh">"</span><span class="s">ERROR: Existing daemon.json is complex and lacks </span><span class="sh">'</span><span class="s">data-root</span><span class="sh">'</span><span class="s">. Cannot safely update without jq. Install jq or manually edit.</span><span class="sh">"</span><span class="s">
                # Do not proceed with overwrite
                NEEDS_UPDATE=0 # Explicitly prevent update
            fi
        # Key exists, check if the value is correct (basic check)
        elif ! grep -q </span><span class="sh">'"</span><span class="s">data-root</span><span class="sh">"</span><span class="se">\\</span><span class="s">s*:</span><span class="se">\\</span><span class="s">s*</span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"'</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">; then
            log </span><span class="sh">"</span><span class="s">ERROR: Existing daemon.json has </span><span class="sh">'</span><span class="s">data-root</span><span class="sh">'</span><span class="s"> but points elsewhere. Cannot safely update without jq. Install jq or manually edit.</span><span class="sh">"</span><span class="s">
            # Do not proceed with overwrite
            NEEDS_UPDATE=0 # Explicitly prevent update
        else
            log </span><span class="sh">"</span><span class="s">daemon.json exists and data-root seems correct (grep check).</span><span class="sh">"</span><span class="s">
            NEEDS_UPDATE=0
        fi
    fi

    # Perform write only if deemed safe and necessary by the logic above
    if [ $NEEDS_UPDATE -eq 1 ]; then
        log </span><span class="sh">"</span><span class="s">Writing daemon.json (simple method)...</span><span class="sh">"</span><span class="s">
        TMP_JSON=$(mktemp </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_DIR}}/daemon.json.tmp.XXXXXX</span><span class="sh">"</span><span class="s">)
        echo </span><span class="sh">"</span><span class="s">$TARGET_JSON_CONTENT</span><span class="sh">"</span><span class="s"> &gt; </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s">
        if [ $? -eq 0 ]; then
            mv </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s">
            chmod </span><span class="si">{</span><span class="n">DOCKER_CONFIG_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="s">${{DOCKER_CONFIG_FILE}}</span><span class="sh">"</span><span class="s"> # Use correct format here too
            log </span><span class="sh">"</span><span class="s">Successfully wrote simple daemon.json.</span><span class="sh">"</span><span class="s">
            CONFIG_CHANGED=1
        else
            log </span><span class="sh">"</span><span class="s">ERROR: Failed to write temporary simple daemon.json! Config not updated.</span><span class="sh">"</span><span class="s">
            rm -f </span><span class="sh">"</span><span class="s">${{TMP_JSON}}</span><span class="sh">"</span><span class="s">
        fi
    fi
fi
log </span><span class="sh">"</span><span class="s">Docker daemon configuration check finished.</span><span class="sh">"</span><span class="s">


# 3. Data Migration (Optional): Migrate data from ephemeral location if needed
log </span><span class="sh">"</span><span class="s">Checking for existing Docker data in ephemeral location (${{DOCKER_DATA_EPHEMERAL}})...</span><span class="sh">"</span><span class="s">
# Check if the directory exists and contains anything other than </span><span class="sh">'</span><span class="s">lost+found</span><span class="sh">'</span><span class="s"> or potential marker files
if [ -d </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -n </span><span class="sh">"</span><span class="s">$(ls -A </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s"> | grep -v -e </span><span class="sh">'</span><span class="s">^lost+found$</span><span class="sh">'</span><span class="s"> -e </span><span class="sh">'</span><span class="s">^</span><span class="se">\\</span><span class="s">.sbnb_persistent_redirect$</span><span class="sh">'</span><span class="s"> -e </span><span class="sh">'</span><span class="s">^README_DO_NOT_USE</span><span class="se">\\</span><span class="s">.txt$</span><span class="sh">'</span><span class="s"> 2&gt;/dev/null)</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">Found potentially significant data in ${{DOCKER_DATA_EPHEMERAL}}.</span><span class="sh">"</span><span class="s">
    # Check if persistent location is effectively empty (allowing only lost+found)
    persistent_is_empty=0
    if [ ! </span><span class="sh">"</span><span class="s">$(ls -A </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}</span><span class="sh">"</span><span class="s"> | grep -v </span><span class="sh">'</span><span class="s">^lost+found$</span><span class="sh">'</span><span class="s"> 2&gt;/dev/null)</span><span class="sh">"</span><span class="s"> ]; then
        persistent_is_empty=1
    fi

    if [ $persistent_is_empty -eq 1 ]; then
        log </span><span class="sh">"</span><span class="s">Persistent location ${{PERSISTENT_DOCKER_ROOT}} is empty. Migrating data...</span><span class="sh">"</span><span class="s">

        # Ensure Docker is stopped before migration
        if systemctl is-active --quiet docker; then
            log </span><span class="sh">"</span><span class="s">Stopping Docker service for migration...</span><span class="sh">"</span><span class="s">
            systemctl stop docker || log </span><span class="sh">"</span><span class="s">WARNING: Failed to stop Docker. Migration proceeding, but data might be inconsistent!</span><span class="sh">"</span><span class="s">
            sleep 3 # Give it time to release files
        fi

        log </span><span class="sh">"</span><span class="s">Starting migration using cp -a -u...</span><span class="sh">"</span><span class="s">
        MIGRATION_SUCCESS=0
        # Use cp -a -u: archive mode (preserve attrs), update mode (copy only if newer/missing).
        # Source ends with /. to copy contents including hidden files.
        # This is the recommended busybox alternative to rsync for local mirroring.
        if cp -a -u </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}/.</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{PERSISTENT_DOCKER_ROOT}}/</span><span class="sh">"</span><span class="s">; then
             MIGRATION_SUCCESS=1
        else
             log </span><span class="sh">"</span><span class="s">ERROR: cp -a -u migration failed with exit code $? !</span><span class="sh">"</span><span class="s">
        fi

        # Handle migration outcome
        if [ $MIGRATION_SUCCESS -eq 1 ]; then
            log </span><span class="sh">"</span><span class="s">Migration completed successfully.</span><span class="sh">"</span><span class="s">
            # Rename old data directory as backup
            OLD_DATA_BACKUP=</span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}.migrated.$(date +%Y%m%d_%H%M%S).bak</span><span class="sh">"</span><span class="s">
            log </span><span class="sh">"</span><span class="s">Attempting to rename old data directory to ${{OLD_DATA_BACKUP}}...</span><span class="sh">"</span><span class="s">
            # Use mv -T to handle if ephemeral is somehow a symlink
            if mv -T </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{OLD_DATA_BACKUP}}</span><span class="sh">"</span><span class="s">; then
                log </span><span class="sh">"</span><span class="s">Successfully renamed old data directory.</span><span class="sh">"</span><span class="s">
            else
                log </span><span class="sh">"</span><span class="s">WARNING: Could not rename old data directory ${{DOCKER_DATA_EPHEMERAL}}. It may still contain data.</span><span class="sh">"</span><span class="s">
                # Consider rm -rf here ONLY if migration verification was very thorough, otherwise leave it.
            fi
            # Mark that Docker needs restart due to migration
            CONFIG_CHANGED=1
        else
            log </span><span class="sh">"</span><span class="s">ERROR: Data migration failed! Docker data may be incomplete or inconsistent in ${{PERSISTENT_DOCKER_ROOT}}.</span><span class="sh">"</span><span class="s">
            # Exiting is likely the safest option here to force manual review.
            exit 1
        fi
    else
        log </span><span class="sh">"</span><span class="s">Persistent location ${{PERSISTENT_DOCKER_ROOT}} already contains data. Skipping migration.</span><span class="sh">"</span><span class="s">
        # Optionally rename the ephemeral data if it still exists and is unwanted
        OLD_DATA_BACKUP=</span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}.ignored.$(date +%Y%m%d_%H%M%S).bak</span><span class="sh">"</span><span class="s">
        log </span><span class="sh">"</span><span class="s">Attempting to rename unused ephemeral data directory to ${{OLD_DATA_BACKUP}}...</span><span class="sh">"</span><span class="s">
        mv -T </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{OLD_DATA_BACKUP}}</span><span class="sh">"</span><span class="s"> || </span><span class="se">\\</span><span class="s">
            log </span><span class="sh">"</span><span class="s">WARNING: Could not rename ephemeral data directory ${{DOCKER_DATA_EPHEMERAL}}.</span><span class="sh">"</span><span class="s">
    fi
else
    log </span><span class="sh">"</span><span class="s">No significant data found in ephemeral location ${{DOCKER_DATA_EPHEMERAL}}. No migration needed.</span><span class="sh">"</span><span class="s">
fi
# Ensure the original ephemeral directory path exists but is empty, with a marker
log </span><span class="sh">"</span><span class="s">Ensuring ephemeral path ${{DOCKER_DATA_EPHEMERAL}} exists and is marked as unused.</span><span class="sh">"</span><span class="s">
# Remove original path if it still exists (e.g., if rename failed but we continued)
if [ -d </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s"> ]; then
    rm -rf </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s"> || log </span><span class="sh">"</span><span class="s">WARNING: Failed to remove original ephemeral directory after processing.</span><span class="sh">"</span><span class="s">
fi
mkdir -p </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}</span><span class="sh">"</span><span class="s">
touch </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}/.sbnb_persistent_redirect</span><span class="sh">"</span><span class="s">
echo </span><span class="sh">"</span><span class="s">Docker data is managed at ${{PERSISTENT_DOCKER_ROOT}}. This directory should remain empty.</span><span class="sh">"</span><span class="s"> &gt; </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}/README_DO_NOT_USE.txt</span><span class="sh">"</span><span class="s">
chmod 644 </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}/README_DO_NOT_USE.txt</span><span class="sh">"</span><span class="s"> # 644 doesn</span><span class="sh">'</span><span class="s">t need :o format
chmod 600 </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_EPHEMERAL}}/.sbnb_persistent_redirect</span><span class="sh">"</span><span class="s"> # 600 doesn</span><span class="sh">'</span><span class="s">t need :o format
log </span><span class="sh">"</span><span class="s">Data migration check finished.</span><span class="sh">"</span><span class="s">


# 4. Restart Docker Service *if* configuration was changed OR migration occurred
if [ $CONFIG_CHANGED -eq 1 ]; then
    log </span><span class="sh">"</span><span class="s">Configuration or data migration requires Docker restart. Reloading daemon and restarting service...</span><span class="sh">"</span><span class="s">
    if ! systemctl daemon-reload; then
        log </span><span class="sh">"</span><span class="s">ERROR: Failed to reload systemd daemon! Docker restart might fail or use old config.</span><span class="sh">"</span><span class="s">
        exit 1 # Critical failure if daemon cannot reload
    fi
    log </span><span class="sh">"</span><span class="s">Attempting to restart docker.service...</span><span class="sh">"</span><span class="s">
    if systemctl restart docker.service; then
        log </span><span class="sh">"</span><span class="s">Docker service restarted successfully.</span><span class="sh">"</span><span class="s">
    else
        log </span><span class="sh">"</span><span class="s">ERROR: Failed to restart Docker service! Check </span><span class="sh">'</span><span class="s">journalctl -u docker.service</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="s">
        exit 1 # Critical failure if Docker doesn</span><span class="sh">'</span><span class="s">t restart after config change/migration
    fi
else
    log </span><span class="sh">"</span><span class="s">No configuration changes or migration. Docker restart not required by this script.</span><span class="sh">"</span><span class="s">
    # Optional: Ensure Docker is running even if no changes occurred
    # log </span><span class="sh">"</span><span class="s">Ensuring Docker service is active...</span><span class="sh">"</span><span class="s">
    # if ! systemctl is-active --quiet docker.service; then
    #     log </span><span class="sh">"</span><span class="s">Docker service is not active. Attempting to start...</span><span class="sh">"</span><span class="s">
    #     systemctl start docker.service || log </span><span class="sh">"</span><span class="s">WARNING: Failed to start inactive Docker service.</span><span class="sh">"</span><span class="s">
    # fi
fi
log </span><span class="sh">"</span><span class="s">Docker setup finished.</span><span class="sh">"</span><span class="s">


# --- Update Optional Development Environment Script ---
# (Using the robust atomic update logic)
TARGET_DEV_ENV_SCRIPT=</span><span class="sh">"</span><span class="s">/usr/sbin/sbnb-dev-env.sh</span><span class="sh">"</span><span class="s">
SOURCE_DEV_ENV_SCRIPT=</span><span class="sh">"</span><span class="s">${{DATA_MOUNT_POINT}}/scripts/sbnb-dev-env.sh</span><span class="sh">"</span><span class="s"> # Assuming it</span><span class="sh">'</span><span class="s">s stored persistently

log </span><span class="sh">"</span><span class="s">Checking for optional development script update: ${{SOURCE_DEV_ENV_SCRIPT}}</span><span class="sh">"</span><span class="s">
if [ -f </span><span class="sh">"</span><span class="s">${{SOURCE_DEV_ENV_SCRIPT}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -r </span><span class="sh">"</span><span class="s">${{SOURCE_DEV_ENV_SCRIPT}}</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">Source script found. Attempting atomic update of ${{TARGET_DEV_ENV_SCRIPT}}...</span><span class="sh">"</span><span class="s">
    TARGET_DIR=$(dirname </span><span class="sh">"</span><span class="s">${{TARGET_DEV_ENV_SCRIPT}}</span><span class="sh">"</span><span class="s">)
    TMP_SCRIPT=</span><span class="sh">""</span><span class="s">

    # Setup trap for cleanup
    trap </span><span class="sh">'</span><span class="s">sbnb_dev_cleanup</span><span class="sh">'</span><span class="s"> EXIT HUP INT QUIT TERM
    sbnb_dev_cleanup() {{
        if [ -n </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT:-}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -f </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s"> ]; then
            rm -f </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s">
            log </span><span class="sh">"</span><span class="s">Cleaned up temporary file ${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s">
        fi
        trap - EXIT HUP INT QUIT TERM # Reset trap
    }}

    if [ ! -d </span><span class="sh">"</span><span class="s">${{TARGET_DIR}}</span><span class="sh">"</span><span class="s"> ] || [ ! -w </span><span class="sh">"</span><span class="s">${{TARGET_DIR}}</span><span class="sh">"</span><span class="s"> ]; then
        log </span><span class="sh">"</span><span class="s">WARNING: Target directory ${{TARGET_DIR}} does not exist or is not writable. Cannot update script.</span><span class="sh">"</span><span class="s">
    # Check required commands exist (already done by check_cmds, but good practice here too)
    elif ! command -v mktemp &gt;/dev/null 2&gt;&amp;1 || ! command -v cp &gt;/dev/null 2&gt;&amp;1 || ! command -v chmod &gt;/dev/null 2&gt;&amp;1 || ! command -v mv &gt;/dev/null 2&gt;&amp;1; then
        log </span><span class="sh">"</span><span class="s">WARNING: Required command (mktemp/cp/chmod/mv) not found. Skipping update.</span><span class="sh">"</span><span class="s">
    else
        TMP_SCRIPT=$(mktemp </span><span class="sh">"</span><span class="s">${{TARGET_DIR}}/sbnb-dev-env.sh.XXXXXX</span><span class="sh">"</span><span class="s">)
        if [ -z </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s"> ] || [ ! -f </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s"> ]; then
            log </span><span class="sh">"</span><span class="s">WARNING: Failed to create temporary file in ${{TARGET_DIR}}. Skipping update.</span><span class="sh">"</span><span class="s">
            TMP_SCRIPT=</span><span class="sh">""</span><span class="s"> # Prevent trap from trying to remove nothing
        else
            # Proceed with copy, chmod, move
            if cp </span><span class="sh">"</span><span class="s">${{SOURCE_DEV_ENV_SCRIPT}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s">; then
                if chmod +x </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s">; then
                    # Use mv -T to handle target being a symlink correctly
                    if mv -T </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{TARGET_DEV_ENV_SCRIPT}}</span><span class="sh">"</span><span class="s">; then
                        log </span><span class="sh">"</span><span class="s">Successfully updated ${{TARGET_DEV_ENV_SCRIPT}}.</span><span class="sh">"</span><span class="s">
                        TMP_SCRIPT=</span><span class="sh">""</span><span class="s"> # Clear var so trap doesn</span><span class="sh">'</span><span class="s">t remove the final script
                    else log </span><span class="sh">"</span><span class="s">WARNING: Failed to move temporary file ${{TMP_SCRIPT}} to ${{TARGET_DEV_ENV_SCRIPT}}. Update failed.</span><span class="sh">"</span><span class="s">; fi
                else log </span><span class="sh">"</span><span class="s">WARNING: Failed to set execute permissions on temporary file ${{TMP_SCRIPT}}. Update failed.</span><span class="sh">"</span><span class="s">; fi
            else log </span><span class="sh">"</span><span class="s">WARNING: Failed to copy content from ${{SOURCE_DEV_ENV_SCRIPT}} to ${{TMP_SCRIPT}}. Update failed.</span><span class="sh">"</span><span class="s">; fi
        fi
        # Clean up temp file if it still exists (e.g., on mv failure) and TMP_SCRIPT is set
        if [ -n </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT:-}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -f </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s"> ]; then rm -f </span><span class="sh">"</span><span class="s">${{TMP_SCRIPT}}</span><span class="sh">"</span><span class="s">; fi
        TMP_SCRIPT=</span><span class="sh">""</span><span class="s"> # Ensure trap doesn</span><span class="sh">'</span><span class="s">t run again for this
    fi
    trap - EXIT HUP INT QUIT TERM # Clear trap explicitly
else
    log </span><span class="sh">"</span><span class="s">NOTE: Source script ${{SOURCE_DEV_ENV_SCRIPT}} not found or not readable. Skipping update.</span><span class="sh">"</span><span class="s">
fi
log </span><span class="sh">"</span><span class="s">Update of optional script finished.</span><span class="sh">"</span><span class="s">


# --- Enable Systemd Units (Backup/Purge + Health/Volume Checks) ---
SYSTEMD_SOURCE_DIR=</span><span class="sh">"</span><span class="s">${{DATA_MOUNT_POINT}}/systemd</span><span class="sh">"</span><span class="s">
SYSTEMD_TARGET_DIR=</span><span class="sh">"</span><span class="s">/etc/systemd/system</span><span class="sh">"</span><span class="s">
TIMERS_WANTS_DIR=</span><span class="sh">"</span><span class="s">${{SYSTEMD_TARGET_DIR}}/timers.target.wants</span><span class="sh">"</span><span class="s">

log </span><span class="sh">"</span><span class="s">Enabling custom systemd units (Source: ${{SYSTEMD_SOURCE_DIR}})...</span><span class="sh">"</span><span class="s">
if [ -d </span><span class="sh">"</span><span class="s">${{SYSTEMD_SOURCE_DIR}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -r </span><span class="sh">"</span><span class="s">${{SYSTEMD_SOURCE_DIR}}</span><span class="sh">"</span><span class="s"> ]; then
    mkdir -p </span><span class="sh">"</span><span class="s">${{SYSTEMD_TARGET_DIR}}</span><span class="sh">"</span><span class="s">
    mkdir -p </span><span class="sh">"</span><span class="s">${{TIMERS_WANTS_DIR}}</span><span class="sh">"</span><span class="s">
    # Check ln and systemctl exist (already done in check_cmds)

    linked_any=0
    log </span><span class="sh">"</span><span class="s">Linking systemd unit files...</span><span class="sh">"</span><span class="s">
    # Use find with -print0 and read -d </span><span class="sh">''</span><span class="s"> for safe filename handling
    find </span><span class="sh">"</span><span class="s">${{SYSTEMD_SOURCE_DIR}}</span><span class="sh">"</span><span class="s"> -maxdepth 1 -type f </span><span class="se">\\</span><span class="s">( -name </span><span class="sh">'</span><span class="s">*.service</span><span class="sh">'</span><span class="s"> -o -name </span><span class="sh">'</span><span class="s">*.timer</span><span class="sh">'</span><span class="s"> </span><span class="se">\\</span><span class="s">) -print0 | while IFS= read -r -d </span><span class="sh">''</span><span class="s"> source_unit; do
        unit_name=$(basename </span><span class="sh">"</span><span class="s">${{source_unit}}</span><span class="sh">"</span><span class="s">)
        target_link=</span><span class="sh">"</span><span class="s">${{SYSTEMD_TARGET_DIR}}/${{unit_name}}</span><span class="sh">"</span><span class="s">
        log </span><span class="sh">"</span><span class="s">  Linking ${{unit_name}}...</span><span class="sh">"</span><span class="s">
        # Use ln -sf: symbolic, force overwrite if link exists
        if ln -sf </span><span class="sh">"</span><span class="s">${{source_unit}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{target_link}}</span><span class="sh">"</span><span class="s">; then
            linked_any=1
        else
            log </span><span class="sh">"</span><span class="s">  WARNING: Failed to link ${{unit_name}}.</span><span class="sh">"</span><span class="s">
        fi
    done

    if [ $linked_any -eq 0 ]; then
        log </span><span class="sh">"</span><span class="s">No unit files found in ${{SYSTEMD_SOURCE_DIR}} to link.</span><span class="sh">"</span><span class="s">
    else
        log </span><span class="sh">"</span><span class="s">Reloading systemd daemon after linking units...</span><span class="sh">"</span><span class="s">
        # Reload daemon again (might be redundant if Docker restart already did it, but safe)
        systemctl daemon-reload || log </span><span class="sh">"</span><span class="s">WARNING: systemctl daemon-reload failed after linking units.</span><span class="sh">"</span><span class="s">

        log </span><span class="sh">"</span><span class="s">Enabling systemd timers/services...</span><span class="sh">"</span><span class="s">
        enabled_any=0
        # Define ALL units expected to be enabled by this script
        UNITS_TO_ENABLE=</span><span class="sh">"</span><span class="s">docker-backup.timer docker-purge.timer docker-shutdown-backup.service docker-health-check.timer docker-volume-check.timer</span><span class="sh">"</span><span class="s">
        final_enabled_list=</span><span class="sh">""</span><span class="s">
        # Use </span><span class="sh">'</span><span class="s">for unit in $UNITS_TO_ENABLE</span><span class="sh">'</span><span class="s"> which relies on word splitting
        # shellcheck disable=SC2086
        for unit in $UNITS_TO_ENABLE; do
            # Check if the link exists and points to a file before enabling
            if [ -L </span><span class="sh">"</span><span class="s">${{SYSTEMD_TARGET_DIR}}/${{unit}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -f </span><span class="sh">"</span><span class="s">${{SYSTEMD_TARGET_DIR}}/${{unit}}</span><span class="sh">"</span><span class="s"> ]; then
                log </span><span class="sh">"</span><span class="s">  Enabling ${{unit}}...</span><span class="sh">"</span><span class="s">
                # Use --now to also start timers immediately if desired, otherwise just enable
                if systemctl enable </span><span class="sh">"</span><span class="s">${{unit}}</span><span class="sh">"</span><span class="s">; then
                    enabled_any=1
                    final_enabled_list=</span><span class="sh">"</span><span class="s">${{final_enabled_list}} ${{unit}}</span><span class="sh">"</span><span class="s">
                else
                    log </span><span class="sh">"</span><span class="s">  WARNING: Failed to enable ${{unit}}.</span><span class="sh">"</span><span class="s">
                fi
            else
                log </span><span class="sh">"</span><span class="s">  Skipping enable for ${{unit}} (link missing or broken).</span><span class="sh">"</span><span class="s">
            fi
        done

        if [ $enabled_any -eq 1 ]; then
            final_enabled_list=$(echo </span><span class="sh">"</span><span class="s">${{final_enabled_list}}</span><span class="sh">"</span><span class="s"> | sed </span><span class="sh">'</span><span class="s">s/^ *//</span><span class="sh">'</span><span class="s">) # Remove leading space
            log </span><span class="sh">"</span><span class="s">Systemd units enabled successfully: ${{final_enabled_list}}</span><span class="sh">"</span><span class="s">
        else
            log </span><span class="sh">"</span><span class="s">No relevant systemd units were successfully enabled.</span><span class="sh">"</span><span class="s">
        fi
    fi # end if linked_any
else
    log </span><span class="sh">"</span><span class="s">WARNING: Systemd source directory ${{SYSTEMD_SOURCE_DIR}} not found or not readable. Cannot enable units.</span><span class="sh">"</span><span class="s">
fi
log </span><span class="sh">"</span><span class="s">Systemd unit setup finished.</span><span class="sh">"</span><span class="s">

# --- Script Finish Logging ---
log </span><span class="sh">"</span><span class="s">Finished custom boot commands successfully.</span><span class="sh">"</span><span class="s">

# Clear trap explicitly
trap - EXIT HUP INT QUIT TERM
exit 0
</span><span class="sh">"""</span>

<span class="c1"># --- Tailscale Key ---
# !!! REPLACE THIS WITH YOUR ACTUAL KEY !!!
</span><span class="n">SBNB_TSKEY_TXT_CONTENT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">tskey-auth-...</span><span class="sh">"</span> <span class="c1"># Placeholder
</span>
<span class="c1"># --- Backup Script ---
</span><span class="n">BACKUP_DOCKER_SH_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">#!/bin/sh
# File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/backup-docker.sh
# Backs up the persistent Docker data-root directory.

set -e -u

# --- Configuration ---
DOCKER_DATA_DIR=</span><span class="sh">"</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="s"> # Source is PERSISTENT root
BACKUP_DIR=</span><span class="sh">"</span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="sh">"</span><span class="s">
TIMESTAMP=$(date +</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="s">)
BACKUP_FILE=</span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}/docker_backup_${{TIMESTAMP}}.tar.gz</span><span class="sh">"</span><span class="s">
LATEST_LINK=</span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}/docker_latest.tar.gz</span><span class="sh">"</span><span class="s">
STOP_DOCKER=</span><span class="si">{</span><span class="n">STOP_DOCKER_FOR_BACKUP</span><span class="si">}</span><span class="s"> # 1=Stop Docker (safer), 0=Live backup

log() {{ echo </span><span class="sh">"</span><span class="s">[backup-docker.sh] $1</span><span class="sh">"</span><span class="s"> &gt; /dev/kmsg; }}

# --- Check Commands ---
log </span><span class="sh">"</span><span class="s">Checking required commands...</span><span class="sh">"</span><span class="s">
check_cmds() {{
    local missing_cmd=0
    for cmd in </span><span class="sh">"</span><span class="s">$@</span><span class="sh">"</span><span class="s">; do
        if ! command -v </span><span class="sh">"</span><span class="s">$cmd</span><span class="sh">"</span><span class="s"> &gt;/dev/null 2&gt;&amp;1; then log </span><span class="sh">"</span><span class="s">ERROR: Command </span><span class="sh">'</span><span class="s">$cmd</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="s">; missing_cmd=1; fi
    done
    # Exit if any command is missing
    [ $missing_cmd -eq 1 ] &amp;&amp; exit 1
}}
# Core commands needed
check_cmds date mkdir tar gzip ln mv sleep dirname basename
# Check systemctl only if stopping docker is enabled
[ $STOP_DOCKER -eq 1 ] &amp;&amp; check_cmds systemctl

# Check for optional </span><span class="sh">'</span><span class="s">nice</span><span class="sh">'</span><span class="s"> command
NICE_CMD=</span><span class="sh">""</span><span class="s">
if command -v nice &gt;/dev/null 2&gt;&amp;1; then NICE_CMD=</span><span class="sh">"</span><span class="s">nice -n 19</span><span class="sh">"</span><span class="s">; log </span><span class="sh">"</span><span class="s">Using nice for lower tar priority.</span><span class="sh">"</span><span class="s">; fi

# --- Main Logic ---
log </span><span class="sh">"</span><span class="s">Starting Docker backup process...</span><span class="sh">"</span><span class="s">
log </span><span class="sh">"</span><span class="s">Source:         ${{DOCKER_DATA_DIR}}</span><span class="sh">"</span><span class="s">
log </span><span class="sh">"</span><span class="s">Destination:    ${{BACKUP_FILE}}</span><span class="sh">"</span><span class="s">

# Ensure backup directory exists and is writable
log </span><span class="sh">"</span><span class="s">Ensuring backup directory exists: ${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s">
mkdir -p </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s">
# Check write permissions specifically
if [ ! -w </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s"> ]; then log </span><span class="sh">"</span><span class="s">ERROR: Backup directory not writable: ${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s">; exit 1; fi

# Stop Docker if configured
DOCKER_WAS_RUNNING=0
if [ $STOP_DOCKER -eq 1 ]; then
    log </span><span class="sh">"</span><span class="s">Attempting to stop Docker service...</span><span class="sh">"</span><span class="s">
    if systemctl is-active --quiet docker.service; then
        DOCKER_WAS_RUNNING=1
        log </span><span class="sh">"</span><span class="s">Docker service is active, stopping...</span><span class="sh">"</span><span class="s">
        if systemctl stop docker.service; then
            log </span><span class="sh">"</span><span class="s">Docker service stopped. Waiting 5s for files to release...</span><span class="sh">"</span><span class="s">; sleep 5
        else
            # If stop fails, warn but maybe proceed? Or exit? Exiting might be safer.
            log </span><span class="sh">"</span><span class="s">ERROR: Failed to stop Docker service gracefully! Backup might be inconsistent or fail. Aborting.</span><span class="sh">"</span><span class="s">
            exit 1 # Exit if stop fails, as backup consistency is compromised
        fi
    else
        log </span><span class="sh">"</span><span class="s">Docker service already stopped.</span><span class="sh">"</span><span class="s">
    fi
fi

# Create backup
log </span><span class="sh">"</span><span class="s">Creating backup archive...</span><span class="sh">"</span><span class="s">
if [ -d </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_DIR}}</span><span class="sh">"</span><span class="s"> ] &amp;&amp; [ -r </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_DIR}}</span><span class="sh">"</span><span class="s"> ]; then
    PARENT_DIR=$(dirname </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_DIR}}</span><span class="sh">"</span><span class="s">)
    SOURCE_BASENAME=$(basename </span><span class="sh">"</span><span class="s">${{DOCKER_DATA_DIR}}</span><span class="sh">"</span><span class="s">)
    log </span><span class="sh">"</span><span class="s">Archiving </span><span class="sh">'</span><span class="s">${{SOURCE_BASENAME}}</span><span class="sh">'</span><span class="s"> from parent </span><span class="sh">'</span><span class="s">${{PARENT_DIR}}</span><span class="sh">'</span><span class="s">...</span><span class="sh">"</span><span class="s">
    # Use -C to change directory, archive relative path </span><span class="sh">'</span><span class="s">docker-root/...</span><span class="sh">'</span><span class="s">
    # Add --warning=no-file-changed to suppress warnings about files changing during read
    # shellcheck disable=SC2086 # Allow word splitting for $NICE_CMD
    if ${{NICE_CMD}} tar --warning=no-file-changed -czf </span><span class="sh">"</span><span class="s">${{BACKUP_FILE}}</span><span class="sh">"</span><span class="s"> -C </span><span class="sh">"</span><span class="s">${{PARENT_DIR}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{SOURCE_BASENAME}}</span><span class="sh">"</span><span class="s">; then
        log </span><span class="sh">"</span><span class="s">Backup archive created successfully.</span><span class="sh">"</span><span class="s">
        # Verify backup file exists and is not empty
        if [ -s </span><span class="sh">"</span><span class="s">${{BACKUP_FILE}}</span><span class="sh">"</span><span class="s"> ]; then
            log </span><span class="sh">"</span><span class="s">Updating latest backup link...</span><span class="sh">"</span><span class="s">
            # Atomic symlink update: create temp link, then rename over old one
            ln -sfT </span><span class="sh">"</span><span class="s">${{BACKUP_FILE}}</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{LATEST_LINK}}.tmp</span><span class="sh">"</span><span class="s"> &amp;&amp; mv -Tf </span><span class="sh">"</span><span class="s">${{LATEST_LINK}}.tmp</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">${{LATEST_LINK}}</span><span class="sh">"</span><span class="s">
            if [ $? -eq 0 ]; then
                log </span><span class="sh">"</span><span class="s">Updated latest link to point to ${{BACKUP_FILE}}.</span><span class="sh">"</span><span class="s">
            else
                log </span><span class="sh">"</span><span class="s">WARNING: Failed to update latest backup link.</span><span class="sh">"</span><span class="s">
                rm -f </span><span class="sh">"</span><span class="s">${{LATEST_LINK}}.tmp</span><span class="sh">"</span><span class="s"> # Clean up temp link if mv failed
            fi
        else
            log </span><span class="sh">"</span><span class="s">WARNING: Backup file seems invalid (empty/missing): ${{BACKUP_FILE}}. Removing.</span><span class="sh">"</span><span class="s">
            rm -f </span><span class="sh">"</span><span class="s">${{BACKUP_FILE}}</span><span class="sh">"</span><span class="s">
        fi
    else
        tar_exit_code=$?
        log </span><span class="sh">"</span><span class="s">ERROR: tar command failed with exit code ${{tar_exit_code}}! Backup failed.</span><span class="sh">"</span><span class="s">
        rm -f </span><span class="sh">"</span><span class="s">${{BACKUP_FILE}}</span><span class="sh">"</span><span class="s"> # Clean up partial archive if tar failed
    fi
else
    log </span><span class="sh">"</span><span class="s">WARNING: Docker data directory not found or not readable: ${{DOCKER_DATA_DIR}}. Skipping backup.</span><span class="sh">"</span><span class="s">
fi

# Restart Docker if it was running and we stopped it successfully
if [ $DOCKER_WAS_RUNNING -eq 1 ]; then
    log </span><span class="sh">"</span><span class="s">Restarting Docker service...</span><span class="sh">"</span><span class="s">
    if ! systemctl start docker.service; then
        log </span><span class="sh">"</span><span class="s">WARNING: Failed to restart Docker service after backup.</span><span class="sh">"</span><span class="s">
    else
        log </span><span class="sh">"</span><span class="s">Docker service restarted.</span><span class="sh">"</span><span class="s">
    fi
fi

log </span><span class="sh">"</span><span class="s">Docker backup process finished.</span><span class="sh">"</span><span class="s">
exit 0
</span><span class="sh">"""</span>

<span class="c1"># --- Purge Script ---
</span><span class="n">PURGE_DOCKER_BACKUPS_SH_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">#!/bin/sh
# File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/purge-docker-backups.sh
# Removes old Docker backups, keeping the last N.

set -e -u

BACKUP_DIR=</span><span class="sh">"</span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="sh">"</span><span class="s">
KEEP_COUNT=</span><span class="si">{</span><span class="n">BACKUP_KEEP_COUNT</span><span class="si">}</span><span class="s">

log() {{ echo </span><span class="sh">"</span><span class="s">[purge-docker-backups.sh] $1</span><span class="sh">"</span><span class="s"> &gt; /dev/kmsg; }}

# Check commands
check_cmds() {{
    local missing_cmd=0
    for cmd in </span><span class="sh">"</span><span class="s">$@</span><span class="sh">"</span><span class="s">; do if ! command -v </span><span class="sh">"</span><span class="s">$cmd</span><span class="sh">"</span><span class="s"> &gt;/dev/null 2&gt;&amp;1; then log </span><span class="sh">"</span><span class="s">ERROR: Command </span><span class="sh">'</span><span class="s">$cmd</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="s">; missing_cmd=1; fi; done
    [ $missing_cmd -eq 1 ] &amp;&amp; exit 1
}}
check_cmds find wc sort head cut xargs rm mkdir date

log </span><span class="sh">"</span><span class="s">Purging old Docker backups in ${{BACKUP_DIR}}, keeping ${{KEEP_COUNT}}...</span><span class="sh">"</span><span class="s">

# Validate KEEP_COUNT
if ! [ </span><span class="sh">"</span><span class="s">$KEEP_COUNT</span><span class="sh">"</span><span class="s"> -ge 0 ] 2&gt;/dev/null; then log </span><span class="sh">"</span><span class="s">ERROR: KEEP_COUNT (${{KEEP_COUNT}}) is invalid.</span><span class="sh">"</span><span class="s">; exit 1; fi

# Ensure backup directory exists and is accessible
if ! mkdir -p </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s">; then log </span><span class="sh">"</span><span class="s">ERROR: Failed to create backup directory ${{BACKUP_DIR}}!</span><span class="sh">"</span><span class="s">; exit 1; fi
if [ ! -d </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s"> ] || [ ! -r </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s"> ] || [ ! -w </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s"> ]; then log </span><span class="sh">"</span><span class="s">ERROR: Cannot access backup directory ${{BACKUP_DIR}}!</span><span class="sh">"</span><span class="s">; exit 1; fi

# Count existing backups safely
log </span><span class="sh">"</span><span class="s">Counting existing backup files...</span><span class="sh">"</span><span class="s">
backup_count=$(find </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s"> -maxdepth 1 -name </span><span class="sh">'</span><span class="s">docker_backup_*.tar.gz</span><span class="sh">'</span><span class="s"> -type f -print 2&gt;/dev/null | wc -l)
find_exit_code=$?

if [ $find_exit_code -ne 0 ]; then log </span><span class="sh">"</span><span class="s">WARNING: find command failed (${{find_exit_code}}) while counting backups. Skipping purge.</span><span class="sh">"</span><span class="s">; exit 0; fi
log </span><span class="sh">"</span><span class="s">Found ${{backup_count}} backup files.</span><span class="sh">"</span><span class="s">

if [ </span><span class="sh">"</span><span class="s">$backup_count</span><span class="sh">"</span><span class="s"> -gt </span><span class="sh">"</span><span class="s">$KEEP_COUNT</span><span class="sh">"</span><span class="s"> ]; then
    to_delete_count=$(( backup_count - KEEP_COUNT ))
    log </span><span class="sh">"</span><span class="s">Need to delete ${{to_delete_count}} oldest backup(s).</span><span class="sh">"</span><span class="s">

    # Use find -printf with null terminators for safe filename handling
    log </span><span class="sh">"</span><span class="s">Identifying oldest backups to delete...</span><span class="sh">"</span><span class="s">
    delete_output=$(find </span><span class="sh">"</span><span class="s">${{BACKUP_DIR}}</span><span class="sh">"</span><span class="s"> -maxdepth 1 -name </span><span class="sh">'</span><span class="s">docker_backup_*.tar.gz</span><span class="sh">'</span><span class="s"> -type f -printf </span><span class="sh">'</span><span class="s">%T@ %p</span><span class="se">\\</span><span class="s">0</span><span class="sh">'</span><span class="s"> 2&gt;/dev/null | </span><span class="se">\\</span><span class="s">
        sort -zn | </span><span class="se">\\</span><span class="s">
        head -zn </span><span class="sh">"</span><span class="s">${{to_delete_count}}</span><span class="sh">"</span><span class="s"> | </span><span class="se">\\</span><span class="s">
        cut -z -d</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="s"> -f2- | </span><span class="se">\\</span><span class="s">
        xargs -0 -r rm -v -- 2&gt;&amp;1) # Capture rm output (stdout+stderr)
    rm_exit_code=$?

    if [ $rm_exit_code -eq 0 ]; then
        log </span><span class="sh">"</span><span class="s">Purge completed successfully.</span><span class="sh">"</span><span class="s">
        if [ -n </span><span class="sh">"</span><span class="s">$delete_output</span><span class="sh">"</span><span class="s"> ]; then
            log </span><span class="sh">"</span><span class="s">Deleted files:</span><span class="sh">"</span><span class="s">
            # Log multi-line output safely
            echo </span><span class="sh">"</span><span class="s">$delete_output</span><span class="sh">"</span><span class="s"> | while IFS= read -r line || [ -n </span><span class="sh">"</span><span class="s">$line</span><span class="sh">"</span><span class="s"> ]; do log </span><span class="sh">"</span><span class="s">  $line</span><span class="sh">"</span><span class="s">; done
        fi
    else
        log </span><span class="sh">"</span><span class="s">WARNING: Purge command (rm) failed (exit code ${{rm_exit_code}}). Check output below.</span><span class="sh">"</span><span class="s">
        log </span><span class="sh">"</span><span class="s">rm output:</span><span class="sh">"</span><span class="s">
        echo </span><span class="sh">"</span><span class="s">$delete_output</span><span class="sh">"</span><span class="s"> | while IFS= read -r line || [ -n </span><span class="sh">"</span><span class="s">$line</span><span class="sh">"</span><span class="s"> ]; do log </span><span class="sh">"</span><span class="s">  $line</span><span class="sh">"</span><span class="s">; done
    fi
else
    log </span><span class="sh">"</span><span class="s">${{backup_count}} backups found &lt;= ${{KEEP_COUNT}}. No backups purged.</span><span class="sh">"</span><span class="s">
fi

log </span><span class="sh">"</span><span class="s">Backup purge process finished.</span><span class="sh">"</span><span class="s">
exit 0
</span><span class="sh">"""</span>

<span class="c1"># --- Health Check Script ---
</span><span class="n">DOCKER_HEALTH_CHECK_SH_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">#!/bin/sh
# File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-health-check.sh
# Checks Docker daemon health, responsiveness, and data-root configuration.

set -e -u

PERSISTENT_ROOT=</span><span class="sh">"</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="s">
DOCKER_CONFIG_FILE=</span><span class="sh">"</span><span class="si">{</span><span class="n">DOCKER_CONFIG_FILE</span><span class="si">}</span><span class="sh">"</span><span class="s">

log() {{ echo </span><span class="sh">"</span><span class="s">[docker-health-check] $1</span><span class="sh">"</span><span class="s"> | tee /dev/kmsg; }} # Log to kmsg and stdout/stderr

log </span><span class="sh">"</span><span class="s">Starting Docker health check...</span><span class="sh">"</span><span class="s">

# Check required commands
check_cmds() {{ for cmd in </span><span class="sh">"</span><span class="s">$@</span><span class="sh">"</span><span class="s">; do if ! command -v </span><span class="sh">"</span><span class="s">$cmd</span><span class="sh">"</span><span class="s"> &gt;/dev/null 2&gt;&amp;1; then log </span><span class="sh">"</span><span class="s">ERROR: Command </span><span class="sh">'</span><span class="s">$cmd</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="s">; exit 1; fi; done }}
check_cmds systemctl docker

# Check if Docker daemon service is running
log </span><span class="sh">"</span><span class="s">Checking if docker.service is active...</span><span class="sh">"</span><span class="s">
if ! systemctl is-active --quiet docker.service; then
    log </span><span class="sh">"</span><span class="s">WARNING: Docker service is not running. Attempting restart...</span><span class="sh">"</span><span class="s">
    if systemctl restart docker.service; then
        log </span><span class="sh">"</span><span class="s">Docker service restarted successfully.</span><span class="sh">"</span><span class="s">
        sleep 5 # Give it time to fully start
    else
        log </span><span class="sh">"</span><span class="s">ERROR: Failed to restart inactive Docker service!</span><span class="sh">"</span><span class="s">
        exit 1 # Critical failure if it should be running but can</span><span class="sh">'</span><span class="s">t be started
    fi
fi

# Verify Docker daemon is responding to commands
log </span><span class="sh">"</span><span class="s">Checking Docker daemon responsiveness via </span><span class="sh">'</span><span class="s">docker info</span><span class="sh">'</span><span class="s">...</span><span class="sh">"</span><span class="s">
if ! docker info &gt; /dev/null 2&gt;&amp;1; then
    log </span><span class="sh">"</span><span class="s">WARNING: Docker service is running but </span><span class="sh">'</span><span class="s">docker info</span><span class="sh">'</span><span class="s"> command failed. Attempting restart...</span><span class="sh">"</span><span class="s">
    if systemctl restart docker.service; then
        log </span><span class="sh">"</span><span class="s">Docker service restarted successfully.</span><span class="sh">"</span><span class="s">
        sleep 5 # Give it time
        # Re-check responsiveness after restart
        if ! docker info &gt; /dev/null 2&gt;&amp;1; then
            log </span><span class="sh">"</span><span class="s">ERROR: Docker daemon still not responding after restart! Requires manual investigation.</span><span class="sh">"</span><span class="s">
            exit 1 # Critical failure
        else
            log </span><span class="sh">"</span><span class="s">Docker daemon is now responsive after restart.</span><span class="sh">"</span><span class="s">
        fi
    else
        log </span><span class="sh">"</span><span class="s">ERROR: Failed to restart unresponsive Docker service!</span><span class="sh">"</span><span class="s">
        exit 1 # Critical failure
    fi
else
    log </span><span class="sh">"</span><span class="s">Docker daemon is responsive.</span><span class="sh">"</span><span class="s">
fi

# Check if Docker is using the correct data-root directory
log </span><span class="sh">"</span><span class="s">Checking configured Docker data-root directory...</span><span class="sh">"</span><span class="s">
# Use docker info with Go template for precise extraction
CURRENT_ROOT=$(docker info --format </span><span class="sh">'</span><span class="s">{{{{.DockerRootDir}}}}</span><span class="sh">'</span><span class="s"> 2&gt;/dev/null || echo </span><span class="sh">"</span><span class="s">ERROR_GETTING_INFO</span><span class="sh">"</span><span class="s">)

if [ </span><span class="sh">"</span><span class="s">$CURRENT_ROOT</span><span class="sh">"</span><span class="s"> = </span><span class="sh">"</span><span class="s">ERROR_GETTING_INFO</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">ERROR: Could not determine Docker</span><span class="sh">'</span><span class="s">s current data-root using </span><span class="sh">'</span><span class="s">docker info</span><span class="sh">'</span><span class="s">. Health check incomplete.</span><span class="sh">"</span><span class="s">
    exit 1 # Exit as this is a significant issue
elif [ </span><span class="sh">"</span><span class="s">$CURRENT_ROOT</span><span class="sh">"</span><span class="s"> != </span><span class="sh">"</span><span class="s">$PERSISTENT_ROOT</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">CRITICAL ERROR: Docker is using incorrect data-root!</span><span class="sh">"</span><span class="s">
    log </span><span class="sh">"</span><span class="s">  Expected: $PERSISTENT_ROOT</span><span class="sh">"</span><span class="s">
    log </span><span class="sh">"</span><span class="s">  Actual:   $CURRENT_ROOT</span><span class="sh">"</span><span class="s">
    log </span><span class="sh">"</span><span class="s">This indicates a configuration problem in $DOCKER_CONFIG_FILE or Docker failed to apply it. Manual intervention required.</span><span class="sh">"</span><span class="s">
    exit 1 # Critical configuration error
else
    log </span><span class="sh">"</span><span class="s">Docker is correctly using the persistent data-root: $PERSISTENT_ROOT</span><span class="sh">"</span><span class="s">
fi

log </span><span class="sh">"</span><span class="s">Docker health check completed successfully.</span><span class="sh">"</span><span class="s">
exit 0
</span><span class="sh">"""</span>

<span class="c1"># --- Volume Check Script ---
# Define prune command based on configuration
</span><span class="k">if</span> <span class="n">VOLUME_CHECK_PRUNE_LEVEL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">PRUNE_COMMAND</span> <span class="o">=</span> <span class="sh">"</span><span class="s">echo </span><span class="sh">'</span><span class="s">Automatic pruning disabled.</span><span class="sh">'"</span> <span class="c1"># No-op
</span><span class="k">elif</span> <span class="n">VOLUME_CHECK_PRUNE_LEVEL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="c1"># Prune stopped containers and dangling images only
</span>    <span class="n">PRUNE_COMMAND</span> <span class="o">=</span> <span class="sh">"</span><span class="s">docker container prune -f &amp;&amp; docker image prune -f</span><span class="sh">"</span>
<span class="k">elif</span> <span class="n">VOLUME_CHECK_PRUNE_LEVEL</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="c1"># Prune stopped containers and *all* unused images (more aggressive)
</span>    <span class="n">PRUNE_COMMAND</span> <span class="o">=</span> <span class="sh">"</span><span class="s">docker container prune -f &amp;&amp; docker image prune -a -f</span><span class="sh">"</span>
<span class="k">else</span><span class="p">:</span> <span class="c1"># Default to level 1 if invalid config
</span>    <span class="n">PRUNE_COMMAND</span> <span class="o">=</span> <span class="sh">"</span><span class="s">docker container prune -f &amp;&amp; docker image prune -f</span><span class="sh">"</span>

<span class="n">DOCKER_VOLUME_CHECK_SH_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">#!/bin/sh
# File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-volume-check.sh
# Checks free space on the Docker persistent volume and optionally prunes resources.

set -e -u

DOCKER_ROOT=</span><span class="sh">"</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="s">
MIN_FREE_PERCENT=</span><span class="si">{</span><span class="n">VOLUME_CHECK_THRESHOLD_PERCENT</span><span class="si">}</span><span class="s">
# Prune command determined by Python script configuration (Level: </span><span class="si">{</span><span class="n">VOLUME_CHECK_PRUNE_LEVEL</span><span class="si">}</span><span class="s">)
PRUNE_CMD=</span><span class="sh">"</span><span class="si">{</span><span class="n">PRUNE_COMMAND</span><span class="si">}</span><span class="sh">"</span><span class="s">

log() {{ echo </span><span class="sh">"</span><span class="s">[docker-volume-check] $1</span><span class="sh">"</span><span class="s"> | tee /dev/kmsg; }}

log </span><span class="sh">"</span><span class="s">Checking Docker volume free space: ${{DOCKER_ROOT}}</span><span class="sh">"</span><span class="s">

# Check required commands
check_cmds() {{ for cmd in </span><span class="sh">"</span><span class="s">$@</span><span class="sh">"</span><span class="s">; do if ! command -v </span><span class="sh">"</span><span class="s">$cmd</span><span class="sh">"</span><span class="s"> &gt;/dev/null 2&gt;&amp;1; then log </span><span class="sh">"</span><span class="s">ERROR: Command </span><span class="sh">'</span><span class="s">$cmd</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="s">; exit 1; fi; done }}
check_cmds df awk sed docker # Need docker if pruning is enabled

# Check if the Docker root directory exists
if [ ! -d </span><span class="sh">"</span><span class="s">$DOCKER_ROOT</span><span class="sh">"</span><span class="s"> ]; then log </span><span class="sh">"</span><span class="s">ERROR: Docker root directory not found: $DOCKER_ROOT</span><span class="sh">"</span><span class="s">; exit 1; fi

# Get free space percentage using df -P for POSIX compatibility
log </span><span class="sh">"</span><span class="s">Calculating free space...</span><span class="sh">"</span><span class="s">
# Get Available and Total blocks (in 1K blocks usually)
df_output=$(df -P </span><span class="sh">"</span><span class="s">$DOCKER_ROOT</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">NR==2 {{print $4, $2}}</span><span class="sh">'</span><span class="s"> 2&gt;/dev/null)
if [ -z </span><span class="sh">"</span><span class="s">$df_output</span><span class="sh">"</span><span class="s"> ]; then log </span><span class="sh">"</span><span class="s">ERROR: Failed to get disk usage using df for $DOCKER_ROOT</span><span class="sh">"</span><span class="s">; exit 1; fi

avail_kb=$(echo </span><span class="sh">"</span><span class="s">$df_output</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">{{print $1}}</span><span class="sh">'</span><span class="s">)
total_kb=$(echo </span><span class="sh">"</span><span class="s">$df_output</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">{{print $2}}</span><span class="sh">'</span><span class="s">)

# Handle edge case where total size is 0 or df failed weirdly
if [ -z </span><span class="sh">"</span><span class="s">$total_kb</span><span class="sh">"</span><span class="s"> ] || [ </span><span class="sh">"</span><span class="s">$total_kb</span><span class="sh">"</span><span class="s"> -le 0 ]; then
    log </span><span class="sh">"</span><span class="s">WARNING: Total disk size reported as zero or invalid for $DOCKER_ROOT. Cannot calculate percentage.</span><span class="sh">"</span><span class="s">
    exit 0
fi

# Calculate free percentage using integer arithmetic
free_percent=$(( (avail_kb * 100) / total_kb ))

# Get human-readable sizes for logging
total_size_hr=$(df -h </span><span class="sh">"</span><span class="s">$DOCKER_ROOT</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">NR==2 {{print $2}}</span><span class="sh">'</span><span class="s">)
avail_size_hr=$(df -h </span><span class="sh">"</span><span class="s">$DOCKER_ROOT</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">NR==2 {{print $4}}</span><span class="sh">'</span><span class="s">)

log </span><span class="sh">"</span><span class="s">Volume Stats: Total=${{total_size_hr}}, Available=${{avail_size_hr}}, Free=${{free_percent}}%</span><span class="sh">"</span><span class="s">

# Check against threshold
if [ </span><span class="sh">"</span><span class="s">$free_percent</span><span class="sh">"</span><span class="s"> -lt </span><span class="sh">"</span><span class="s">$MIN_FREE_PERCENT</span><span class="sh">"</span><span class="s"> ]; then
    log </span><span class="sh">"</span><span class="s">WARNING: Low disk space! Free: ${{free_percent}}% (Threshold: ${{MIN_FREE_PERCENT}}%)</span><span class="sh">"</span><span class="s">

    # Attempt to prune based on configured level
    if [ </span><span class="si">{</span><span class="n">VOLUME_CHECK_PRUNE_LEVEL</span><span class="si">}</span><span class="s"> -gt 0 ]; then
        log </span><span class="sh">"</span><span class="s">Attempting automatic prune (Level: </span><span class="si">{</span><span class="n">VOLUME_CHECK_PRUNE_LEVEL</span><span class="si">}</span><span class="s">)...</span><span class="sh">"</span><span class="s">
        prune_output=$(</span><span class="si">{</span><span class="n">PRUNE_COMMAND</span><span class="si">}</span><span class="s"> 2&gt;&amp;1) || prune_exit_code=$?
        # Check exit code, prune can return non-zero even if it works partially
        if [ </span><span class="sh">"</span><span class="s">${{prune_exit_code:-0}}</span><span class="sh">"</span><span class="s"> -eq 0 ]; then
            log </span><span class="sh">"</span><span class="s">Docker prune command executed successfully.</span><span class="sh">"</span><span class="s">
        else
            log </span><span class="sh">"</span><span class="s">WARNING: Docker prune command finished with exit code ${{prune_exit_code}}.</span><span class="sh">"</span><span class="s">
        fi
        log </span><span class="sh">"</span><span class="s">Prune output:</span><span class="sh">"</span><span class="s">
        echo </span><span class="sh">"</span><span class="s">$prune_output</span><span class="sh">"</span><span class="s"> | while IFS= read -r line || [ -n </span><span class="sh">"</span><span class="s">$line</span><span class="sh">"</span><span class="s"> ]; do log </span><span class="sh">"</span><span class="s">  $line</span><span class="sh">"</span><span class="s">; done

        # Recalculate free space after pruning
        log </span><span class="sh">"</span><span class="s">Recalculating space after cleanup...</span><span class="sh">"</span><span class="s">
        df_output=$(df -P </span><span class="sh">"</span><span class="s">$DOCKER_ROOT</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">NR==2 {{print $4, $2}}</span><span class="sh">'</span><span class="s"> 2&gt;/dev/null)
        avail_kb=$(echo </span><span class="sh">"</span><span class="s">$df_output</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">{{print $1}}</span><span class="sh">'</span><span class="s">)
        total_kb=$(echo </span><span class="sh">"</span><span class="s">$df_output</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">{{print $2}}</span><span class="sh">'</span><span class="s">)
        if [ </span><span class="sh">"</span><span class="s">$total_kb</span><span class="sh">"</span><span class="s"> -gt 0 ]; then free_percent=$(( (avail_kb * 100) / total_kb )); else free_percent=0; fi
        avail_size_hr=$(df -h </span><span class="sh">"</span><span class="s">$DOCKER_ROOT</span><span class="sh">"</span><span class="s"> | awk </span><span class="sh">'</span><span class="s">NR==2 {{print $4}}</span><span class="sh">'</span><span class="s">)

        log </span><span class="sh">"</span><span class="s">Space after cleanup: Available=${{avail_size_hr}}, Free=${{free_percent}}%</span><span class="sh">"</span><span class="s">
        if [ </span><span class="sh">"</span><span class="s">$free_percent</span><span class="sh">"</span><span class="s"> -lt </span><span class="sh">"</span><span class="s">$MIN_FREE_PERCENT</span><span class="sh">"</span><span class="s"> ]; then
            log </span><span class="sh">"</span><span class="s">ERROR: Space still critically low after cleanup! Manual intervention likely required.</span><span class="sh">"</span><span class="s">
        else
            log </span><span class="sh">"</span><span class="s">Space is now above threshold after cleanup.</span><span class="sh">"</span><span class="s">
        fi
    else
         log </span><span class="sh">"</span><span class="s">Automatic pruning is disabled (Level 0). Manual cleanup needed.</span><span class="sh">"</span><span class="s">
    fi
else
    log </span><span class="sh">"</span><span class="s">Sufficient free space available (${{free_percent}}%).</span><span class="sh">"</span><span class="s">
fi

log </span><span class="sh">"</span><span class="s">Docker volume check completed.</span><span class="sh">"</span><span class="s">
exit 0
</span><span class="sh">"""</span>

<span class="c1"># --- Systemd Units (Content definitions remain the same as previous version) ---
# Backup Service
</span><span class="n">DOCKER_BACKUP_SERVICE_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-backup.service
[Unit]
Description=Backup Docker Data (</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="s">)
Documentation=file://</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/backup-docker.sh
Requires=mnt-sbnb-data.mount
After=mnt-sbnb-data.mount docker.service # Ensure mount and docker are up

[Service]
Type=oneshot
ExecStart=/bin/sh </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/backup-docker.sh
</span><span class="sh">"""</span>
<span class="c1"># Backup Timer
</span><span class="n">DOCKER_BACKUP_TIMER_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-backup.timer
[Unit]
Description=Daily Docker Backup Timer (</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="s">)
Requires=docker-backup.service

[Timer]
OnCalendar=*-*-* 05:00:00
AccuracySec=1h
Persistent=true
RandomizedDelaySec=600 # 10 minutes
Unit=docker-backup.service

[Install]
WantedBy=timers.target
</span><span class="sh">"""</span>
<span class="c1"># Purge Service
</span><span class="n">DOCKER_PURGE_SERVICE_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-purge.service
[Unit]
Description=Purge Old Docker Backups (</span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="s">)
Documentation=file://</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/purge-docker-backups.sh
Requires=mnt-sbnb-data.mount
After=mnt-sbnb-data.mount

[Service]
Type=oneshot
ExecStart=/bin/sh </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/purge-docker-backups.sh
</span><span class="sh">"""</span>
<span class="c1"># Purge Timer
</span><span class="n">DOCKER_PURGE_TIMER_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-purge.timer
[Unit]
Description=Daily Docker Backup Purge Timer
Requires=docker-purge.service

[Timer]
OnCalendar=*-*-* 06:00:00
AccuracySec=1h
Persistent=true
RandomizedDelaySec=300 # 5 minutes
Unit=docker-purge.service

[Install]
WantedBy=timers.target
</span><span class="sh">"""</span>
<span class="c1"># Shutdown Backup Service
</span><span class="n">DOCKER_SHUTDOWN_BACKUP_SERVICE_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-shutdown-backup.service
[Unit]
Description=Backup Docker Data (</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="s">) on Shutdown (Best Effort)
Documentation=file://</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/backup-docker.sh
DefaultDependencies=no # Crucial for shutdown units
Requires=mnt-sbnb-data.mount docker.service
After=mnt-sbnb-data.mount docker.service network.target
Before=shutdown.target reboot.target halt.target kexec.target umount.target final.target

[Service]
Type=oneshot
RemainAfterExit=true # Important for ExecStop= during shutdown
TimeoutStopSec=180 # Give backup reasonable time (3 minutes)
ExecStop=/bin/sh </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/backup-docker.sh # Run backup on stop

[Install]
WantedBy=shutdown.target reboot.target halt.target kexec.target
</span><span class="sh">"""</span>
<span class="c1"># Health Check Service
</span><span class="n">DOCKER_HEALTH_SERVICE_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-health-check.service
[Unit]
Description=Docker Health Check Service
Documentation=file://</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-health-check.sh
Requires=mnt-sbnb-data.mount docker.service
After=mnt-sbnb-data.mount docker.service

[Service]
Type=oneshot
ExecStart=/bin/sh </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-health-check.sh
# Optional resource limits
# CPUQuota=10%
# MemoryMax=128M
</span><span class="sh">"""</span>
<span class="c1"># Health Check Timer
</span><span class="n">DOCKER_HEALTH_TIMER_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-health-check.timer
[Unit]
Description=Regular Docker Health Check Timer
Requires=docker-health-check.service

[Timer]
# Run 5 mins after boot, then every 15 mins
OnBootSec=5min
OnUnitActiveSec=15min
AccuracySec=1min
Unit=docker-health-check.service

[Install]
WantedBy=timers.target
</span><span class="sh">"""</span>
<span class="c1"># Volume Check Service
</span><span class="n">DOCKER_VOLUME_SERVICE_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-volume-check.service
[Unit]
Description=Docker Volume Space Check Service (</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="s">)
Documentation=file://</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-volume-check.sh
Requires=mnt-sbnb-data.mount docker.service
After=mnt-sbnb-data.mount docker.service

[Service]
Type=oneshot
ExecStart=/bin/sh </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-volume-check.sh
# Optional resource limits
# CPUQuota=10%
# MemoryMax=64M
</span><span class="sh">"""</span>
<span class="c1"># Volume Check Timer
</span><span class="n">DOCKER_VOLUME_TIMER_CONTENT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"># File: </span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-volume-check.timer
[Unit]
Description=Regular Docker Volume Check Timer
Requires=docker-volume-check.service

[Timer]
# Run 10 mins after boot, then every hour
OnBootSec=10min
OnUnitActiveSec=1h
AccuracySec=5min
Unit=docker-volume-check.service

[Install]
WantedBy=timers.target
</span><span class="sh">"""</span>


<span class="c1"># --- Dictionary of Files to Create ---
# Defines all files to be generated by this script
</span><span class="n">FILES_TO_CREATE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># --- ESP Files ---
</span>    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">ESP_MOUNT</span><span class="si">}</span><span class="s">/sbnb-cmds.sh</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">SBNB_CMDS_SH_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o755</span> <span class="c1"># rwxr-xr-x
</span>    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">ESP_MOUNT</span><span class="si">}</span><span class="s">/sbnb-tskey.txt</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">SBNB_TSKEY_TXT_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o600</span> <span class="c1"># rw------- (Restrict access to key)
</span>    <span class="p">},</span>

    <span class="c1"># --- Data Partition Files ---
</span>    <span class="c1"># Helper Scripts
</span>    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/backup-docker.sh</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">BACKUP_DOCKER_SH_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o750</span> <span class="c1"># rwxr-x--- (Owner exec, group read/exec)
</span>    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/purge-docker-backups.sh</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">PURGE_DOCKER_BACKUPS_SH_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o750</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-health-check.sh</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_HEALTH_CHECK_SH_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o750</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/scripts/docker-volume-check.sh</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_VOLUME_CHECK_SH_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o750</span>
    <span class="p">},</span>
    <span class="c1"># Systemd Units
</span>    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-backup.service</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_BACKUP_SERVICE_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span> <span class="c1"># rw-r--r-- (Standard systemd unit permissions)
</span>    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-backup.timer</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_BACKUP_TIMER_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-purge.service</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_PURGE_SERVICE_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-purge.timer</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_PURGE_TIMER_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-shutdown-backup.service</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_SHUTDOWN_BACKUP_SERVICE_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-health-check.service</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_HEALTH_SERVICE_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-health-check.timer</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_HEALTH_TIMER_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-volume-check.service</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_VOLUME_SERVICE_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DATA_MOUNT</span><span class="si">}</span><span class="s">/systemd/docker-volume-check.timer</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">DOCKER_VOLUME_TIMER_CONTENT</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">:</span> <span class="mo">0o644</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># --- Global counters for create_files status ---
</span><span class="n">warning_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># --- Main Script Logic ---
</span>
<span class="k">def</span> <span class="nf">check_prerequisites</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Verify script prerequisites before attempting file creation.</span><span class="sh">"""</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">--- Checking Prerequisites ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># 1. Check root privileges
</span>    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="nf">geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Script must be run as root (UID 0).</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK: Running as root.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 2. Check base mount points exist and are writable
</span>    <span class="n">base_dirs</span> <span class="o">=</span> <span class="p">{</span><span class="n">ESP_MOUNT</span><span class="p">:</span> <span class="sh">"</span><span class="s">ESP</span><span class="sh">"</span><span class="p">,</span> <span class="n">DATA_MOUNT</span><span class="p">:</span> <span class="sh">"</span><span class="s">Data</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">bdir</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">base_dirs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">bdir_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="nc">Path</span><span class="p">(</span><span class="n">bdir</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Checking </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> mount point: </span><span class="si">{</span><span class="n">bdir</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bdir_path</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: Base </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> directory </span><span class="sh">'</span><span class="si">{</span><span class="n">bdir</span><span class="si">}</span><span class="sh">'</span><span class="s"> does not exist or is not a directory.</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">       Please ensure the corresponding partition is mounted correctly before running.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="nf">access</span><span class="p">(</span><span class="n">bdir_path</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">W_OK</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: Base </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> directory </span><span class="sh">'</span><span class="si">{</span><span class="n">bdir</span><span class="si">}</span><span class="sh">'</span><span class="s"> is not writable by the current user (root). Check mount options or permissions.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">OK: Base </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> directory </span><span class="sh">'</span><span class="si">{</span><span class="n">bdir</span><span class="si">}</span><span class="sh">'</span><span class="s"> exists and is writable.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3. Check for optional but recommended commands needed by generated scripts
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Checking for optional command (jq)...</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shutil</span><span class="p">.</span><span class="nf">which</span><span class="p">(</span><span class="sh">"</span><span class="s">jq</span><span class="sh">"</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK: </span><span class="sh">'</span><span class="s">jq</span><span class="sh">'</span><span class="s"> command found (recommended for robust daemon.json handling).</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">WARNING: </span><span class="sh">'</span><span class="s">jq</span><span class="sh">'</span><span class="s"> command not found. Generated sbnb-cmds.sh will use less robust methods for daemon.json, which might fail or overwrite existing settings.</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Removed rsync check as it's no longer used/preferred by the generated script
</span>    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">WARNING: Python </span><span class="sh">'</span><span class="s">shutil</span><span class="sh">'</span><span class="s"> module not found, cannot check for optional command (jq).</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">WARNING: Error checking for optional commands: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">passed</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">----------------------------</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Prerequisites not met. Aborting script.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">--- Prerequisites OK ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">create_files</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Creates directories and files as defined in FILES_TO_CREATE.</span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">warning_count</span><span class="p">,</span> <span class="n">fail_count</span> <span class="c1"># Declare intent to modify globals
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- Starting File Creation Process ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">warning_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset global counter
</span>    <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># Reset global counter
</span>
    <span class="c1"># Ensure the base backup directory exists first with correct permissions
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Ensuring base backup directory exists: </span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Create directory with specific permissions (rwxr-x---)
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">BACKUP_BASE_DIR</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">BACKUP_DIR_PERMISSIONS</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Explicitly set permissions in case it already existed with different ones
</span>        <span class="n">current_perm</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="nc">S_IMODE</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">BACKUP_BASE_DIR</span><span class="p">).</span><span class="n">st_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_perm</span> <span class="o">!=</span> <span class="n">BACKUP_DIR_PERMISSIONS</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Adjusting permissions on </span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">BACKUP_DIR_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use :o format
</span>            <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">BACKUP_BASE_DIR</span><span class="p">,</span> <span class="n">BACKUP_DIR_PERMISSIONS</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">OK: Backup directory ensured: </span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="s"> with permissions </span><span class="si">{</span><span class="n">BACKUP_DIR_PERMISSIONS</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use :o format
</span>    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: Failed to create or set permissions on </span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: Could not ensure backup directory </span><span class="sh">'</span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="sh">'</span><span class="s">. Exiting.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: An unexpected error occurred ensuring backup directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: Could not ensure backup directory </span><span class="sh">'</span><span class="si">{</span><span class="n">BACKUP_BASE_DIR</span><span class="si">}</span><span class="sh">'</span><span class="s">. Exiting.</span><span class="sh">"</span><span class="p">)</span>


    <span class="c1"># Process the files dictionary
</span>    <span class="k">for</span> <span class="n">file_path_str</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">FILES_TO_CREATE</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="nc">Path</span><span class="p">(</span><span class="n">file_path_str</span><span class="p">)</span>
        <span class="n">write_succeeded</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># Flag to track if write was successful
</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">details</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use get() as content might be None for dirs
</span>            <span class="n">permissions</span> <span class="o">=</span> <span class="n">details</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">permissions</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use .get() for optional permissions
</span>            <span class="c1"># Assign default permissions if not specified
</span>            <span class="k">if</span> <span class="n">permissions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># It's meant to be a directory
</span>                    <span class="n">permissions</span> <span class="o">=</span> <span class="mo">0o755</span> <span class="c1"># Default rwxr-xr-x for directories
</span>                <span class="k">else</span><span class="p">:</span> <span class="c1"># It's a file
</span>                    <span class="n">permissions</span> <span class="o">=</span> <span class="mo">0o644</span> <span class="c1"># Default rw-r--r-- for files
</span>                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">INFO: No specific permission set for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">, using default </span><span class="si">{</span><span class="n">permissions</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use :o format
</span>
        <span class="k">except</span> <span class="nb">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">ERROR: Configuration error - Missing </span><span class="sh">'</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">'</span><span class="s"> key for entry </span><span class="si">{</span><span class="n">file_path_str</span><span class="si">}</span><span class="s">. Skipping.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">ERROR: Configuration error for </span><span class="si">{</span><span class="n">file_path_str</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">. Skipping.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Processing: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 1. Create parent directories robustly
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">.</span><span class="n">parent</span>
            <span class="c1"># Check if parent needs creation (avoid os.makedirs on existing dirs if possible)
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_dir</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Creating parent directory: </span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="c1"># mode=0o755 sets default permissions for newly created dirs (rwxr-xr-x)
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c1"># Explicitly set permissions on parent in case it was just created or exist_ok=True skipped it
</span>                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Setting parent directory permissions to 755...</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># 755 doesn't need 0o prefix
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Parent exists, ensure it's writable and has correct permissions
</span>                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Parent directory exists: </span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="nf">access</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">W_OK</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  WARNING: Parent directory </span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="s"> is not writable! File write may fail.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">warning_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Ensure existing parent has standard 755 permissions
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_parent_perm</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="nc">S_IMODE</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">).</span><span class="n">st_mode</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_parent_perm</span> <span class="o">!=</span> <span class="mo">0o755</span><span class="p">:</span>
                        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Ensuring parent directory permissions are 755 (currently </span><span class="si">{</span><span class="n">current_parent_perm</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s">)...</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use :o format
</span>                        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  WARNING: Could not check/set permissions on existing parent </span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">warning_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  ERROR: Failed to create or set permissions on parent directory </span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Skipping item: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span> <span class="c1"># Skip to the next file
</span>        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  ERROR: An unexpected error occurred creating parent directory for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Skipping item: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># 2. Write the file content (or create directory if content is None)
</span>        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># It's a file
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Writing content...</span><span class="sh">"</span><span class="p">)</span>
                <span class="c1"># Use write_text for atomic write where possible and UTF-8 encoding
</span>                <span class="n">file_path</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Successfully wrote: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">write_succeeded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="nb">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  ERROR: Failed to write file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span> <span class="c1"># Skip permissions if write failed
</span>            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  ERROR: An unexpected error occurred writing </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># It's a directory (content is None)
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Ensuring directory exists: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c1"># Explicitly set permissions in case it already existed
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Successfully ensured directory: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">write_succeeded</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># Treat dir success like file write success
</span>            <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  ERROR: Failed to create/set permissions on directory </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  ERROR: An unexpected error occurred ensuring directory </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>


        <span class="c1"># 3. Set permissions (only if write/dir creation succeeded)
</span>        <span class="k">if</span> <span class="n">write_succeeded</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if current permissions match target permissions before attempting chmod
</span>                <span class="n">current_perm</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="nc">S_IMODE</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">file_path</span><span class="p">).</span><span class="n">st_mode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_perm</span> <span class="o">!=</span> <span class="n">permissions</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Setting permissions to </span><span class="si">{</span><span class="n">permissions</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s"> (currently </span><span class="si">{</span><span class="n">current_perm</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s">)...</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use :o format
</span>                    <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Successfully set permissions for: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Permissions already set correctly (</span><span class="si">{</span><span class="n">permissions</span><span class="si">:</span><span class="n">o</span><span class="si">}</span><span class="s">) for: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use :o format
</span>                <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Count full success (write/dir + chmod)
</span>            <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  WARNING: Failed to set permissions on </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">warning_count</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Item created/written, but permissions failed/check failed
</span>            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  WARNING: An unexpected error occurred setting permissions for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">warning_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># --- Summary ---
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- File Creation Summary ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Successfully processed (created/permissioned): </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s"> items</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Items processed but with warnings:             </span><span class="si">{</span><span class="n">warning_count</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed operations (write/dir/parent):          </span><span class="si">{</span><span class="n">fail_count</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-------------------------------</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">total_issues</span> <span class="o">=</span> <span class="n">fail_count</span> <span class="o">+</span> <span class="n">warning_count</span>
    <span class="k">if</span> <span class="n">total_issues</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">NOTE: Some errors or warnings occurred during file creation.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fail_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Fatal errors occurred. Deployment incomplete.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c1"># Fatal errors occurred
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Deployment completed, but with warnings. Please review the output above.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span> <span class="c1"># Only non-fatal warnings
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SBNB configuration file deployment completed successfully.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="c1"># --- Script Execution ---
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=====================================================================</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> SBNB Unified Configuration Deployment Script (v2.1 - BusyBox cp) </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=====================================================================</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Timestamp: </span><span class="si">{</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="sh">'</span><span class="s">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Configuring Docker persistent root: </span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Includes Backup/Purge and Health/Volume monitoring.</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Data migration uses </span><span class="sh">'</span><span class="s">cp -a -u</span><span class="sh">'</span><span class="s"> (BusyBox friendly).</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=====================================================================</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Store counts for final status reporting
</span>    <span class="n">final_warning_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">final_fail_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nf">check_prerequisites</span><span class="p">():</span>
        <span class="c1"># Capture status from create_files
</span>        <span class="n">create_files_success</span> <span class="o">=</span> <span class="nf">create_files</span><span class="p">()</span>
        <span class="c1"># Access the global counters updated by create_files
</span>        <span class="n">final_warning_count</span> <span class="o">=</span> <span class="n">warning_count</span>
        <span class="n">final_fail_count</span> <span class="o">=</span> <span class="n">fail_count</span>

        <span class="k">if</span> <span class="n">create_files_success</span> <span class="ow">or</span> <span class="p">(</span><span class="n">final_fail_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">final_warning_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1"># Success or only warnings - print final instructions
</span>            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">!!! CRITICAL: You MUST replace the placeholder in                         !!!</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">!!!           </span><span class="sh">'</span><span class="si">{</span><span class="n">ESP_MOUNT</span><span class="si">}</span><span class="s">/sbnb-tskey.txt</span><span class="sh">'</span><span class="s"> with your actual Tailscale auth key! !!!</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- Next Steps ---</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">1. Review any WARNINGS in the output above.</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">2. Reboot the system for sbnb-cmds.sh to take effect.</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">3. After reboot, verify Docker configuration and status:</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   - Check data root: `docker info | grep </span><span class="sh">'</span><span class="s">Docker Root Dir</span><span class="sh">'</span><span class="s">` (should show </span><span class="sh">'</span><span class="si">{</span><span class="n">PERSISTENT_DOCKER_ROOT</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   - Check status: `systemctl status docker.service`</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   - Check boot script logs: `journalctl -t sbnb-cmds.sh --no-pager` or check `/dev/kmsg` output during boot</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   - Check timers: `systemctl list-timers --all | grep docker`</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   - Check helper script logs periodically: `journalctl -t backup-docker.sh -t purge-docker-backups.sh -t docker-health-check -t docker-volume-check --no-pager`</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">final_warning_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Deployment finished with WARNINGS.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Exit code 2 for success with warnings
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Deployment finished successfully.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Exit successfully
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fatal errors occurred during file creation
</span>            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- Deployment Failed ---</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Fatal errors occurred during file creation. System configuration may be incomplete or inconsistent.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Exit with error code
</span></code></section></div></div>

<ol>
  <li><strong>Unmount the EFI Partition:</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Unmounting ESP partition ---"</span>
<span class="c"># Ensure buffers are flushed before unmounting</span>
<span class="nb">sync
sudo </span>umount /mnt/sbnb-mount
</code></section></div>    </div>
  </li>
</ol>
  <h3 id="phase-4-backing-up-data-critical">
    
    
     <a href="#phase-4-backing-up-data-critical">#</a><a href="#" aria-label="Back to top">Phase 4: Backing Up Data (CRITICAL!)</a>
        
    
  </h3>
      

<ul>
  <li><strong>Why Essential:</strong> High risk of USB drive failure. Backups are mandatory.</li>
  <li><strong>Strategy:</strong> Automate regular backups of <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code>.</li>
  <li><strong>File Data Backup (<code class="language-plaintext highlighter-rouge">rsync</code>):</strong> Ensure the backup destination (NAS, cloud, another server) has sufficient free space.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  <span class="c"># Example: From Sbnb to backup-server (requires ssh key auth)</span>
  rsync <span class="nt">-avz</span> <span class="nt">--delete</span> <span class="nt">--progress</span> <span class="nt">--human-readable</span> /mnt/sbnb-data/ user@backup-server:/path/to/backups/sbnb-usb-data/
</code></section></div>    </div>
  </li>
  <li><strong>Frequency:</strong> Daily recommended for active data.</li>
  <li><strong>Automation:</strong> Use cron/systemd timers or remote triggers.</li>
  <li><strong>Testing Restores:</strong> Vital! Don’t assume backups work.</li>
  <li><strong>Conceptual Restore:</strong> Boot Linux Live env -&gt; Mount backup source -&gt; Mount target USB data partition (new/reformatted) to <code class="language-plaintext highlighter-rouge">/mnt/restore</code> -&gt; <code class="language-plaintext highlighter-rouge">sudo rsync -av --progress /path/to/backup/sbnb-usb-data/ /mnt/restore/</code> -&gt; Verify restored files (count, size, checksums, spot checks).</li>
  <li><strong>Verification:</strong> Use tools like <code class="language-plaintext highlighter-rouge">diff -r</code>, <code class="language-plaintext highlighter-rouge">md5sum</code>, or <code class="language-plaintext highlighter-rouge">sha256sum</code> to compare restored files against originals or known good copies.</li>
  <li><em>Untested backups provide a false sense of security.</em></li>
</ul>
  <h3 id="phase-5-boot-and-verify">
    
    
     <a href="#phase-5-boot-and-verify">#</a><a href="#" aria-label="Back to top">Phase 5: Boot and Verify</a>
        
    
  </h3>
      

<ol>
  <li><strong>Safely Eject:</strong> Eject USB from prep system.</li>
  <li><strong>Configure Server BIOS/UEFI:</strong> Enter setup (DEL, F2, F10, F12, etc.). Ensure UEFI Mode ON, CSM/Legacy OFF, Secure Boot OFF. Set “UEFI: USB…” as first boot device. Save &amp; Exit.</li>
  <li><strong>Boot Sbnb Linux.</strong></li>
  <li><strong>Verify Operation:</strong>
    <ul>
      <li>Monitor Boot: Watch console for <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> logs, errors.</li>
      <li>SSH into Sbnb.</li>
      <li>Check Mounts:
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,LABEL,MOUNTPOINT <span class="c"># Look for mount at /mnt/sbnb-data</span>
<span class="nb">df</span> <span class="nt">-hT</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'Filesystem|/mnt/sbnb-data'</span> <span class="c"># Check usage/type</span>
mount | <span class="nb">grep</span> /mnt/sbnb-data  <span class="c"># Check mount options (rw, noatime)</span>
findmnt /mnt/sbnb-data     <span class="c"># Another way to check mount info</span>
</code></section></div>        </div>
      </li>
      <li>Test Persistence:
```bash
  <h1 id="after-sshing-in">
    
    
     <a href="#after-sshing-in">#</a><a href="#" aria-label="Back to top">After SSHing in:</a>
        
    
  </h1>
      
        <p>TIMESTAMP=$(date)
echo “Sbnb USB Persistence test - $TIMESTAMP” | sudo tee /mnt/sbnb-data/persistence_test.txt &gt; /dev/null
sync &amp;&amp; echo “Synced data to disk.”
echo “File created. Content:” &amp;&amp; sudo cat /mnt/sbnb-data/persistence_test.txt
echo “Rebooting server now…” &amp;&amp; sudo reboot</p>
      </li>
    </ul>
  <h1 id="-wait-for-reboot-and-reconnect-via-ssh-">
    
    
     <a href="#-wait-for-reboot-and-reconnect-via-ssh-">#</a><a href="#" aria-label="Back to top">— Wait for reboot and reconnect via SSH —</a>
        
    
  </h1>
      
    <p>echo “Checking for file after reboot…”
if [ -f /mnt/sbnb-data/persistence_test.txt ]; then
  echo “SUCCESS: File found. Content:” &amp;&amp; sudo cat /mnt/sbnb-data/persistence_test.txt
  sudo rm /mnt/sbnb-data/persistence_test.txt # Clean up
else
  echo “FAILURE: File NOT FOUND after reboot! Persistence failed.”
fi
```</p>
  </li>
</ol>
  <h2 id="troubleshooting">
    
    
     <a href="#troubleshooting">#</a><a href="#" aria-label="Back to top">Troubleshooting</a>
        
    
  </h2>
      

<ul>
  <li><strong>Doesn’t Boot / No Bootable Device:</strong>
    <ul>
      <li>Re-verify BIOS settings (UEFI, Secure Boot OFF, Boot Order).</li>
      <li>Re-verify USB Prep: Partitions (<code class="language-plaintext highlighter-rouge">parted print</code>), ESP flags (<code class="language-plaintext highlighter-rouge">boot</code>,<code class="language-plaintext highlighter-rouge">esp</code>), ESP filesystem label (<code class="language-plaintext highlighter-rouge">blkid /dev/sdX1</code> -&gt; <code class="language-plaintext highlighter-rouge">LABEL="sbnb"</code>), EFI file path (<code class="language-plaintext highlighter-rouge">/EFI/BOOT/BOOTX64.EFI</code>).</li>
      <li>Try different USB ports (check if port provides sufficient power). Test drive health on prep machine (<code class="language-plaintext highlighter-rouge">fsck</code>, <code class="language-plaintext highlighter-rouge">badblocks -nvs /dev/sdX</code>). Recreate drive meticulously.</li>
    </ul>
  </li>
  <li><strong>Data Partition Not Mounted / <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> Empty:</strong>
    <ul>
      <li>Check boot logs (<code class="language-plaintext highlighter-rouge">journalctl -b</code>, console) for <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> errors (“Device… not found”, “Failed to mount”). Check <code class="language-plaintext highlighter-rouge">dmesg</code> for USB errors (<code class="language-plaintext highlighter-rouge">dmesg | grep -iE 'usb|sdX'</code>) or filesystem errors (<code class="language-plaintext highlighter-rouge">dmesg | grep -i ext4</code>).</li>
      <li>SSH in:
        <ul>
          <li>Verify partition &amp; label: <code class="language-plaintext highlighter-rouge">sudo blkid</code>, <code class="language-plaintext highlighter-rouge">ls -l /dev/disk/by-label/</code>. Is <code class="language-plaintext highlighter-rouge">SBNB_DATA</code> present? Does it point to the correct device?</li>
          <li>If label wrong/missing: Re-label from prep env (<code class="language-plaintext highlighter-rouge">sudo e2label /dev/sdX2 SBNB_DATA</code>).</li>
          <li>If device/label exists, try manual mount: <code class="language-plaintext highlighter-rouge">sudo mkdir -p /mnt/sbnb-data &amp;&amp; sudo mount /dev/disk/by-label/SBNB_DATA /mnt/sbnb-data</code>. Check <code class="language-plaintext highlighter-rouge">dmesg</code> for errors (e.g., <code class="language-plaintext highlighter-rouge">mount: wrong fs type, bad option, bad superblock</code>). If manual mount works, debug <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> (add <code class="language-plaintext highlighter-rouge">set -x</code>, check paths, loop duration, check script permissions <code class="language-plaintext highlighter-rouge">ls -l /mnt/sbnb/sbnb-cmds.sh</code>).</li>
          <li>Run filesystem check (unmounted): <code class="language-plaintext highlighter-rouge">sudo e2fsck -f /dev/disk/by-label/SBNB_DATA</code>.</li>
          <li>Check kernel modules: <code class="language-plaintext highlighter-rouge">lsmod | grep ext4</code>. Is the module loaded? Check <code class="language-plaintext highlighter-rouge">dmesg</code> for errors loading filesystem modules.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Poor Performance / Drive Failure:</strong>
    <ul>
      <li><strong>Performance:</strong> Inherent limitation.</li>
      <li><strong>Lifespan/Failure:</strong> Monitor <code class="language-plaintext highlighter-rouge">dmesg</code> for I/O errors. Restore from verified backups upon failure. This setup will wear out consumer flash drives with persistent writes.</li>
    </ul>
  </li>
</ul>

        </div>
        
          URL: https://ib.bsb.br/sbnb
        
      </article>
      <nav class="post-navigation-combined" aria-label="Post navigation">
        <!-- Chronological Navigation (always visible at 40vh) -->
        
          <div class="nav-arrow chronological prev">
            <a href="/to-enable-video-acceleration-on-rpi4/" title="to enable video acceleration on RPI4" rel="prev">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
        
          <div class="nav-arrow chronological next">
            <a href="/images-to-searchable-pdf/" title="Images to Searchable PDF" rel="next">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
            
            
              
              
                
                  
                  
              
              
              
              <!-- Navigation block for tag "linux>software>dotfile"; default display for the first tag -->
              <div class="nav-group tags" id="tag-nav-linux-software-dotfile" style="display: block;">
                <div class="nav-arrow tags prev">
                  
                    <a href="/sbnb/" title="Portable linux via Sbnb distro with persistence" rel="prev">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
                <div class="nav-arrow tags next">
                  
                    <a href="javascript:void(0)" class="disabled" aria-disabled="true" title="No next in tag">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="No next in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
              </div>
            
          
          <!-- JavaScript to Toggle the Tag-based Navigation -->
          <script>
            document.addEventListener("DOMContentLoaded", function(){
              var tagLinks = document.querySelectorAll('.tag-option');
              tagLinks.forEach(function(link){
                link.addEventListener('click', function(event){
                  event.preventDefault();
                  // Remove "active" class from all tag options.
                  tagLinks.forEach(function(el){ el.classList.remove('active'); });
                  // Add active class to the clicked tag option.
                  this.classList.add('active');
                  // Hide all tag navigation blocks.
                  document.querySelectorAll('.nav-group.tags').forEach(function(block){
                    block.style.display = 'none';
                  });
                  // Show the navigation block corresponding to the selected tag.
                  var tagSlug = this.getAttribute('data-tag');
                  var target = document.getElementById('tag-nav-' + tagSlug);
                  if(target) {
                    target.style.display = 'block';
                  }
                });
              });
            });
          </script>
      </nav>
      
    <div class="comment-box">
      Ref. 
      <a href="https://github.com/sbnb-io/sbnb" title="https://github.com/sbnb-io/sbnb">https://github.com/sbnb-io/sbnb</a>
    </div>
    
    </main>
    <footer id="bottom-of-page" class="site-footer">
      <div class="footer-content">
        <!-- Back to top link -->
        <a href="#" aria-label="Back to top" class="back2top-link">
          <span class="sronly">Back to top</span>
        </a>
    
        <!-- Liquid Time Calculation and Display -->
        
        
        
        <a href="https://ib.bsb.br/404" aria-label="404">
          2025-05-07 19:52:06
        </a>
        &#x23;
    
        <!-- Tag Selector -->
        <ul class="tag-selector">
          
            
            
              <li>
                <a href="#" class="tag-option active" data-tag="linux-software-dotfile">
                  linux>software>dotfile
                </a>
              </li>
            
          
        </ul>
        &hArr;
    
        <!-- GitHub Link -->
        <a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io" aria-label="GitHub">
          &#8505;
        </a>
    
        <!-- Homepage Link -->
        <a href="/" aria-label="Homepage">
          infoBAG
        </a>
    
        <!-- Copy All Code Button -->
        <button id="copyAllButton" aria-label="Copy all code">
          &copy;
        </button>
      </div>
    </footer>
    <style>
      .back2top-link {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: url("/assets/Rope_(Old).gif") center center no-repeat;
        background-size: contain;
        text-decoration: none;
        vertical-align: middle;
      }
      .sronly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://ib.bsb.br/sbnb/"
        },
        "headline": "Portable linux via Sbnb distro with persistence",
        "description": "",
        "datePublished": "2025-04-07T00:00:00+00:00",
        "dateModified": "2025-05-02T00:52:29+00:00",
        "author": {
          "@type": "Person",
          "name": "Author"
        },
        "publisher": {
          "@type": "Organization",
          "name": "infoBAG"
          
        }
        
      }
    </script>
    <script src="/assets/js/prism.js" defer></script>
    <script src="/assets/js/copy-all-code.js"></script>
  </body>
</html>
