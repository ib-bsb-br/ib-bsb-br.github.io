<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      
        Single USB for Sbnb Boot and Persistent Storage - infoBAG
      
    </title>
    <meta name="title" content="Single USB for Sbnb Boot and Persistent Storage - infoBAG" />
    <meta name="description" content="">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/">
    <meta property="og:title" content="Single USB for Sbnb Boot and Persistent Storage - infoBAG">
    <meta property="og:description" content="">
    <meta property="og:image" content="/favicon.ico">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/">
    <meta name="twitter:title" content="Single USB for Sbnb Boot and Persistent Storage - infoBAG">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/favicon.ico">
    <link rel="canonical" href="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/">
    <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">
    
      <meta name="keywords" content="scratchpad">
      
        <meta property="article:tag" content="scratchpad">
      
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/style.css">
  </head>
  <body class="post-content-body">
    <header class="header-container">
      <nav aria-label="Main navigation" class="header-content">
        <a href="/" aria-label="Home">
          <img src="/favicon.ico" alt="Home" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/tags" aria-label="Tags">
          <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/send" aria-label="send">
          <img src="/assets/rot.gif" alt="send" class="favicon search-link" width="32" height="32" loading="lazy">
        </a> 
        <a href="/created" aria-label="archive created">
          <img src="/assets/Loose_Stone_Pile.gif" alt="archive created" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/events" aria-label="Events">
          <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/modified" aria-label="archive modified">
          <img src="/assets/Hole_(Rock).gif" alt="archive modified" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
    </nav>
      <h5 class="post-title">
        <a href="#bottom-of-page" aria-label="Go to bottom">
          Single USB for Sbnb Boot and Persistent Storage
        </a>
      </h5>
      <div class="post-meta">
        <time datetime="2025-04-07T00:00:00+00:00" class="post-date">
          07 Apr 2025
        </time>
        
          <span class="post-updated">
            ↣
            <time datetime="2025-04-12T20:33:58+00:00">
              12 Apr 2025
            </time>
          </span>
        
        
          <p class="post-slug">
            Slug: <a href="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage" class="tag">single-usb-for-sbnb-boot-and-persistent-storage</a>
          </p>
        
        
          <p class="post-tags">
            Tags:
            
              <a href="https://ib.bsb.br/tags/#scratchpad" class="tag">scratchpad</a>
            
          </p>
        
      </div>
      <div class="post-actions">
        <div class="page-stats mt-3" role="status" aria-label="Page statistics">
      
      <span class="badge bg-primary">
        30086 characters
      </span>
        <span class="separator mx-2" aria-hidden="true">•</span>
        <span class="badge bg-primary">
        3968 words
      </span>
      </div>
        <div class="action-buttons d-flex flex-wrap gap-2">
          
            
              <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2025-04-07-single-usb-for-sbnb-boot-and-persistent-storage.md"
                    method="GET"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="d-inline-block">
                <button type="submit" class="btn btn-danger" aria-label="Edit page content">
                  <span class="button-text">Improve this page?</span>
                  <span class="info-text">aberto.</span>
                </button>
              </form>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2025-04-07-single-usb-for-sbnb-boot-and-persistent-storage.md"
                  method="GET"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="d-inline-block">
              <button type="submit" class="btn btn-danger" aria-label="View page revision history">
                View revision history
              </button>
            </form>
          
        </div>
      </div>
    </header>
    <main class="content">
      <article class="post-wrapper">
        <div class="post-content-body">
          
<ul><li><a href="#primary-drawbacks--warnings-reiterated--expanded">Primary Drawbacks &amp; Warnings (Reiterated &amp; Expanded):</a><ul><li><a href="#when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">When Might This Be Considered? (Limited Scenarios with Full Risk Acceptance)</a></li></ul></li><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#step-by-step-instructions">Step-by-Step Instructions</a><ul><li><a href="#phase-1-prepare-the-linux-environment-opensuse-tumbleweed">Phase 1: Prepare the Linux Environment (openSUSE Tumbleweed)</a></li><li><a href="#phase-2-partition-the-usb-drive">Phase 2: Partition the USB Drive</a></li><li><a href="#phase-4-install-sbnb-boot-files-and-configuration">Phase 4: Install Sbnb Boot Files and Configuration</a></li><li><a href="#phase-45-backing-up-data-critical">Phase 4.5: Backing Up Data (CRITICAL!)</a></li><li><a href="#phase-5-boot-and-verify">Phase 5: Boot and Verify</a></li></ul></li><li><a href="#troubleshooting">Troubleshooting</a></li><li><a href="#final-recommendation">Final Recommendation</a></li></ul>
          <p>This guide provides comprehensive, step-by-step instructions for configuring a single USB flash drive (or potentially an external USB hard drive) to perform two distinct functions simultaneously:</p>

<ol>
  <li><strong>Booting the Sbnb Linux Operating System:</strong> The drive will be prepared with a standard UEFI-compatible structure, specifically an EFI System Partition (ESP) containing the Sbnb EFI bootloader (<code class="language-plaintext highlighter-rouge">sbnb.efi</code>) and necessary configuration files. This allows the server’s firmware to locate and start the Sbnb boot process. The <code class="language-plaintext highlighter-rouge">sbnb.efi</code> file itself is typically a Unified Kernel Image (UKI), bundling the Linux kernel, initramfs, and kernel command line into a single executable file.</li>
  <li><strong>Providing Simple Persistent Storage:</strong> Utilizing a separate partition on the same physical USB drive, formatted with a standard Linux filesystem (<code class="language-plaintext highlighter-rouge">ext4</code> is used in this guide). This partition is intended to be automatically mounted at the <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> directory path within the running Sbnb Linux system via a custom boot script (<code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code>). This provides a space where data (like container volumes, application data, logs, user files) can persist across reboots of the otherwise ephemeral, RAM-based Sbnb OS.</li>
</ol>

<p><strong>Why <code class="language-plaintext highlighter-rouge">ext4</code> instead of LVM:</strong> Initial analysis suggested LVM might be suitable, but further review of the default Sbnb Linux build configuration indicates the necessary <code class="language-plaintext highlighter-rouge">lvm2</code> user-space tools are likely missing from the base runtime environment. Without these tools, managing LVM volumes during boot via standard scripts is infeasible unless you create a custom Sbnb build that includes the <code class="language-plaintext highlighter-rouge">lvm2</code> package. This revised guide therefore uses a standard <code class="language-plaintext highlighter-rouge">ext4</code> filesystem partition, relying only on basic tools expected to be present in Sbnb.</p>

<p><strong>Contrasting with Standard Sbnb Workflow:</strong> It’s crucial to understand that this guide describes a highly non-standard setup. The intended Sbnb workflow prioritizes resilience, performance, and statelessness:</p>

<ul>
  <li>Boot the minimal Sbnb OS from simple USB/network.</li>
  <li>Use automation (Ansible) or manual scripts (<code class="language-plaintext highlighter-rouge">sbnb-configure-storage.sh</code>) post-boot to configure LVM on internal server drives.</li>
  <li>Run workloads utilizing this fast, reliable internal storage. This guide’s method compromises these benefits for single-drive convenience under specific constraints.</li>
</ul><hr />

<blockquote>
  <p><strong>*** EXTREME CAUTION: IRREVERSIBLE DATA DESTRUCTION IMMINENT! **</strong>*</p>

  <p>This procedure involves low-level disk operations (partitioning, formatting) that will completely and <strong>PERMANENTLY ERASE ALL DATA</strong> currently residing on the USB drive you select. There is <strong>NO UNDO</strong> function. Data recovery after accidental formatting is often impossible.</p>

  <p>The most critical risk is selecting the <strong>wrong target device</strong>. Mistakenly choosing your computer’s internal hard drive (e.g., <code class="language-plaintext highlighter-rouge">/dev/sda</code>, <code class="language-plaintext highlighter-rouge">/dev/nvme0n1</code>) instead of the intended USB drive (e.g., <code class="language-plaintext highlighter-rouge">/dev/sdb</code>, <code class="language-plaintext highlighter-rouge">/dev/sdc</code>) <strong>WILL RESULT IN CATASTROPHIC AND LIKELY IRRECOVERABLE LOSS OF YOUR OPERATING SYSTEM, APPLICATIONS, AND PERSONAL FILES.</strong></p>

  <p>You <strong>MUST</strong> verify the target device name multiple times using different commands (like <code class="language-plaintext highlighter-rouge">lsblk</code>, <code class="language-plaintext highlighter-rouge">fdisk</code>, <code class="language-plaintext highlighter-rouge">parted</code>) and cross-reference with expected drive sizes and models before executing any partitioning or formatting commands. Proceed with extreme vigilance, double-checking each step, entirely at your own sole risk!</p>
</blockquote><hr />
  <h2 id="primary-drawbacks--warnings-reiterated--expanded">
    
    
     <a href="#primary-drawbacks--warnings-reiterated--expanded">#</a><a href="#" aria-label="Back to top">Primary Drawbacks &amp; Warnings (Reiterated &amp; Expanded):</a>
        
    
  </h2>
      

<ul>
  <li><strong>Highly Non-Standard &amp; Complex:</strong> Deviates significantly from Sbnb’s design. Setup is intricate, runtime behavior depends on precise script execution and timing. Future Sbnb updates might break this.</li>
  <li><strong>Severe Performance Penalty:</strong> USB storage is inherently slow (latency, throughput, IOPS) compared to internal NVMe/SATA drives. Disk I/O to <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> will be a major bottleneck.</li>
  <li><strong>Drastically Reduced Lifespan &amp; Reliability:</strong> USB flash drives will wear out quickly under persistent write load due to limited write cycles, write amplification, and lack of TRIM support. Unsuitable for write-intensive workloads or high reliability needs. Expect eventual failure and data loss without robust backups.</li>
  <li><strong>Potential Instability &amp; Boot Issues:</strong> Relies on correct partition detection, udev node creation, filesystem integrity, and <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> execution timing. Failures can leave persistent storage unavailable.</li>
</ul>
  <h3 id="when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">
    
    
     <a href="#when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">#</a><a href="#" aria-label="Back to top">When Might This Be Considered? (Limited Scenarios with Full Risk Acceptance)</a>
        
    
  </h3>
      

<ul>
  <li><strong>Temporary Testing/Experimentation ONLY:</strong> Brief evaluations on hardware lacking internal drives.</li>
  <li><strong>Specific, Very Low-Intensity, Read-Mostly Use Cases:</strong> Infrequent writes, performance irrelevant (e.g., static config kiosk).</li>
  <li><strong>Absolute Hardware Constraints:</strong> Sealed systems where internal drives are impossible, and risks are fully accepted.</li>
</ul>

<p><em>Even in these limited scenarios, regular, automated, and verified backups are non-negotiable.</em></p>
  <h2 id="prerequisites">
    
    
     <a href="#prerequisites">#</a><a href="#" aria-label="Back to top">Prerequisites</a>
        
    
  </h2>
      

<ul>
  <li><strong>A Suitable USB Flash Drive:</strong>
    <ul>
      <li><strong>Capacity:</strong> Min ~1GB ESP + desired data size (32GB+ recommended).</li>
      <li><strong>Quality &amp; Speed:</strong> Reputable brand, USB 3.0+ advised for marginal speed benefit. Endurance matters more than peak speed.</li>
    </ul>
  </li>
  <li><strong>A Working Linux System (Preparation Environment):</strong>
    <ul>
      <li><strong>Necessity:</strong> Required for partitioning/formatting the target USB safely. openSUSE Tumbleweed assumed.</li>
      <li><strong>Live Environment Benefit:</strong> Using a Live USB/CD (e.g., openSUSE Tumbleweed Live) is highly recommended as it provides a non-destructive environment.</li>
    </ul>
  </li>
  <li><strong>Sbnb Linux Boot File (<code class="language-plaintext highlighter-rouge">sbnb.efi</code>):</strong>
    <ul>
      <li><strong>Method 1 (Easier):</strong> Run official Sbnb install script on a temporary USB, then copy <code class="language-plaintext highlighter-rouge">/EFI/BOOT/BOOTX64.EFI</code> from its ESP.</li>
      <li><strong>Method 2 (Advanced):</strong> Build Sbnb from source, find <code class="language-plaintext highlighter-rouge">sbnb.efi</code> in <code class="language-plaintext highlighter-rouge">output/images/</code>.</li>
    </ul>
  </li>
  <li><strong>Root/Sudo Privileges:</strong> Needed on the openSUSE prep system for disk commands.</li>
  <li><strong>Internet Connection:</strong> May be needed for <code class="language-plaintext highlighter-rouge">zypper</code>.</li>
</ul>
  <h2 id="step-by-step-instructions">
    
    
     <a href="#step-by-step-instructions">#</a><a href="#" aria-label="Back to top">Step-by-Step Instructions</a>
        
    
  </h2>
      

<p><em>(Reminder: TRIPLE-CHECK your target device name, e.g., <code class="language-plaintext highlighter-rouge">/dev/sdX</code>, before every destructive command!)</em></p>
  <h3 id="phase-1-prepare-the-linux-environment-opensuse-tumbleweed">
    
    
     <a href="#phase-1-prepare-the-linux-environment-opensuse-tumbleweed">#</a><a href="#" aria-label="Back to top">Phase 1: Prepare the Linux Environment (openSUSE Tumbleweed)</a>
        
    
  </h3>
      

<ol>
  <li><strong>Boot into openSUSE:</strong> Start your preparation environment.</li>
  <li><strong>Install Necessary Tools:</strong> Open a terminal. <code class="language-plaintext highlighter-rouge">zypper refresh</code> updates package lists. <code class="language-plaintext highlighter-rouge">zypper install</code> installs tools.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">sudo </span>zypper refresh
<span class="nb">sudo </span>zypper <span class="nb">install</span> <span class="nt">-y</span> parted lvm2 dosfstools e2fsprogs
</code></section></div>    </div>
  </li>
  <li><strong>Identify Target USB Drive:</strong> <strong>CRITICAL SAFETY STEP!</strong> Unplug other USB storage.
    <ul>
      <li>Insert the target USB drive.</li>
      <li>Use multiple commands. Compare SIZE and MODEL. Check <code class="language-plaintext highlighter-rouge">dmesg | tail</code> after plugging in for kernel messages like <code class="language-plaintext highlighter-rouge">sd 2:0:0:0: [sdc] Attached SCSI removable disk</code>.
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>lsblk <span class="nt">-d</span> <span class="nt">-o</span> NAME,SIZE,MODEL,VENDOR,TYPE | <span class="nb">grep</span> <span class="s1">'disk'</span>
<span class="nb">sudo </span>fdisk <span class="nt">-l</span> | <span class="nb">grep</span> <span class="s1">'^Disk /dev/'</span>
<span class="nb">sudo </span>parted <span class="nt">-l</span> | <span class="nb">grep</span> <span class="s1">'^Disk /dev/'</span>
<span class="c"># Example: If consistently identified as /dev/sdc, use /dev/sdc below.</span>
</code></section></div>        </div>
      </li>
      <li>Visually confirm with YaST Partitioner (<code class="language-plaintext highlighter-rouge">sudo yast2 partitioner</code>) or GParted (<code class="language-plaintext highlighter-rouge">sudo zypper install -y gparted &amp;&amp; sudo gparted</code>) if preferred. Look for the drive matching the expected size and vendor/model.</li>
      <li>Assume <code class="language-plaintext highlighter-rouge">/dev/sdX</code> is your verified target drive. <strong>Replace it carefully!</strong></li>
    </ul>
  </li>
</ol>
  <h3 id="phase-2-partition-the-usb-drive">
    
    
     <a href="#phase-2-partition-the-usb-drive">#</a><a href="#" aria-label="Back to top">Phase 2: Partition the USB Drive</a>
        
    
  </h3>
      

<p><strong>(Warning: The following <code class="language-plaintext highlighter-rouge">parted</code> commands are DESTRUCTIVE to <code class="language-plaintext highlighter-rouge">/dev/sdX</code>. Double-check the device name!)</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="c">#!/bin/bash</span>

<span class="c"># --- Configuration ---</span>
<span class="c"># Exit immediately if a command exits with a non-zero status.</span>
<span class="c"># Treat unset variables as an error when substituting.</span>
<span class="c"># Pipelines return the exit status of the last command to exit non-zero.</span>
<span class="nb">set</span> <span class="nt">-euo</span> pipefail

<span class="c"># --- Variables ---</span>
<span class="c"># EFI System Partition (ESP) Label (CRITICAL - must match bootloader config)</span>
<span class="nv">ESP_LABEL</span><span class="o">=</span><span class="s2">"sbnb"</span>
<span class="c"># Data Partition Label (Recommended for identification)</span>
<span class="nv">DATA_LABEL</span><span class="o">=</span><span class="s2">"SBNB_DATA"</span>
<span class="c"># ESP Size (Adjust if needed, ~1GB is usually sufficient)</span>
<span class="nv">ESP_SIZE</span><span class="o">=</span><span class="s2">"1025MiB"</span>
<span class="c"># List of required commands for the script to function</span>
<span class="nv">REQUIRED_CMDS</span><span class="o">=(</span>
    <span class="s2">"parted"</span> <span class="s2">"mkfs.vfat"</span> <span class="s2">"mkfs.ext4"</span> <span class="s2">"wipefs"</span> <span class="s2">"findmnt"</span> <span class="s2">"lsblk"</span>
    <span class="s2">"blkid"</span> <span class="s2">"fsck.vfat"</span> <span class="s2">"e2fsck"</span> <span class="s2">"sync"</span> <span class="s2">"id"</span> <span class="s2">"grep"</span> <span class="s2">"read"</span>
    <span class="s2">"sleep"</span> <span class="s2">"xargs"</span> <span class="s2">"umount"</span> <span class="s2">"partprobe"</span> <span class="s2">"realpath"</span>
<span class="o">)</span>

<span class="c"># --- Functions ---</span>
<span class="c"># Function to check for required commands</span>
check_dependencies<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"--- Checking for required commands ---"</span>
    <span class="nb">local </span><span class="nv">missing_cmds</span><span class="o">=()</span>
    <span class="k">for </span>cmd <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">REQUIRED_CMDS</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
        if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> <span class="s2">"</span><span class="nv">$cmd</span><span class="s2">"</span> &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
            </span>missing_cmds+<span class="o">=(</span><span class="s2">"</span><span class="nv">$cmd</span><span class="s2">"</span><span class="o">)</span>
        <span class="k">fi
    done

    if</span> <span class="o">[</span> <span class="k">${#</span><span class="nv">missing_cmds</span><span class="p">[@]</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"ERROR: The following required commands are not found:"</span> <span class="o">&gt;</span>&amp;2
        <span class="nb">printf</span> <span class="s2">" - %s</span><span class="se">\n</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">missing_cmds</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
        <span class="nb">echo</span> <span class="s2">"Please install them and try again."</span> <span class="o">&gt;</span>&amp;2
        <span class="nb">exit </span>1
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="s2">"All required commands found."</span>
<span class="o">}</span>

<span class="c"># Function to get the base block device for a given path (handles partitions, links, etc.)</span>
get_base_device<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">path</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
    <span class="nb">local </span>resolved_path
    <span class="nv">resolved_path</span><span class="o">=</span><span class="si">$(</span><span class="nb">realpath</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span><span class="si">)</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"ERROR: Cannot resolve path '</span><span class="nv">$path</span><span class="s2">'"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="k">return </span>1<span class="p">;</span> <span class="o">}</span>
    <span class="c"># lsblk -no pkname gets the parent kernel name (base device)</span>
    lsblk <span class="nt">-no</span> pkname <span class="s2">"</span><span class="nv">$resolved_path</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"ERROR: Cannot find base device for '</span><span class="nv">$resolved_path</span><span class="s2">' using lsblk."</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="k">return </span>1<span class="p">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="c"># --- Script Start ---</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"--- USB Drive Partitioning and Formatting Script ---"</span>
<span class="nb">echo</span> <span class="s2">"---          (Version 2 - Enhanced Safety)       ---"</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"WARNING: This script is DESTRUCTIVE and will ERASE"</span>
<span class="nb">echo</span> <span class="s2">"         ALL DATA on the target device."</span>
<span class="nb">echo</span> <span class="s2">""</span>

<span class="c"># --- Check for Root Privileges ---</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: This script must be run as root (e.g., using sudo)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># --- Check Dependencies ---</span>
check_dependencies

<span class="c"># --- Check for Device Argument ---</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> /dev/sdX"</span>
  <span class="nb">echo</span> <span class="s2">"ERROR: Please provide the target block device (e.g., /dev/sda, /dev/sdb)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"Available block devices (excluding ROM, loop, and RAM devices):"</span>
  lsblk <span class="nt">-d</span> <span class="nt">-o</span> NAME,SIZE,TYPE,MODEL | <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s1">'rom|loop|ram'</span>
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">DEVICE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>

<span class="c"># --- Validate Device ---</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: '</span><span class="nv">$DEVICE</span><span class="s2">' is not a valid block device."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># --- CRITICAL SAFETY CHECK: Prevent targeting the root filesystem device ---</span>
<span class="nb">echo</span> <span class="s2">"--- Performing safety checks ---"</span>
<span class="nv">ROOT_DEV_PATH</span><span class="o">=</span><span class="si">$(</span>findmnt <span class="nt">-n</span> <span class="nt">-o</span> SOURCE /<span class="si">)</span>
<span class="nv">ROOT_BASE_DEV_NAME</span><span class="o">=</span><span class="si">$(</span>get_base_device <span class="s2">"</span><span class="nv">$ROOT_DEV_PATH</span><span class="s2">"</span><span class="si">)</span> <span class="o">||</span> <span class="nb">exit </span>1 <span class="c"># Exit if function fails</span>
<span class="nv">TARGET_BASE_DEV_NAME</span><span class="o">=</span><span class="si">$(</span>get_base_device <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span><span class="si">)</span> <span class="o">||</span> <span class="nb">exit </span>1

<span class="c"># Construct full device paths for comparison</span>
<span class="nv">ROOT_BASE_DEV</span><span class="o">=</span><span class="s2">"/dev/</span><span class="k">${</span><span class="nv">ROOT_BASE_DEV_NAME</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">TARGET_BASE_DEV</span><span class="o">=</span><span class="s2">"/dev/</span><span class="k">${</span><span class="nv">TARGET_BASE_DEV_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="c"># Assumes the input $DEVICE is the base device</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TARGET_BASE_DEV</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$ROOT_BASE_DEV</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"FATAL ERROR: Target device '</span><span class="nv">$DEVICE</span><span class="s2">' appears to be the same"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"             device ('</span><span class="nv">$ROOT_BASE_DEV</span><span class="s2">') as the running root"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"             filesystem ('</span><span class="nv">$ROOT_DEV_PATH</span><span class="s2">')."</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"             Aborting to prevent data loss."</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"Safety check passed: Target device '</span><span class="nv">$DEVICE</span><span class="s2">' is not the root filesystem device ('</span><span class="nv">$ROOT_BASE_DEV</span><span class="s2">')."</span>

<span class="c"># Check if the device looks like an SD card reader often used for the OS drive</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">==</span> /dev/mmcblk<span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"WARNING: '</span><span class="nv">$DEVICE</span><span class="s2">' looks like an SD card (e.g., /dev/mmcblk0)."</span>
    <span class="nb">echo</span> <span class="s2">"         Double-check this is not your primary OS drive!"</span>
<span class="k">fi</span>


<span class="c"># --- Confirmation ---</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"Target Device: </span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Partitions to be created:"</span>
<span class="nb">echo</span> <span class="s2">"  1: EFI System Partition (ESP), FAT32, Label: '</span><span class="nv">$ESP_LABEL</span><span class="s2">', Size: </span><span class="nv">$ESP_SIZE</span><span class="s2">, Flags: boot, esp"</span>
<span class="nb">echo</span> <span class="s2">"  2: Linux Data Partition, ext4, Label: '</span><span class="nv">$DATA_LABEL</span><span class="s2">', Size: Remaining space"</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"ARE YOU ABSOLUTELY SURE you want to erase '</span><span class="nv">$DEVICE</span><span class="s2">' and proceed? (yes/NO): "</span> CONFIRMATION
<span class="nv">CONFIRMATION</span><span class="o">=</span><span class="k">${</span><span class="nv">CONFIRMATION</span><span class="k">:-</span><span class="nv">NO</span><span class="k">}</span> <span class="c"># Default to NO if user just presses Enter</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$CONFIRMATION</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"yes"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Operation cancelled by user."</span>
  <span class="nb">exit </span>0
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Proceeding with operations on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>

<span class="c"># --- Phase 2: Partition the USB Drive ---</span>

<span class="c"># 1. Unmount Existing Partitions</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Unmounting any existing partitions on </span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}</span><span class="s2">* ---"</span>
<span class="c"># Use findmnt to get mount points and umount them safely</span>
<span class="c"># Also try to unmount the base device itself in case it's loop-mounted etc.</span>
findmnt <span class="nt">-n</span> <span class="nt">-o</span> TARGET <span class="nt">--source</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}</span><span class="s2">*"</span> | xargs <span class="nt">--no-run-if-empty</span> umount <span class="nt">-v</span> <span class="nt">-l</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"Info: No partitions were mounted or umount failed (might be okay)."</span>
umount <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> &amp;&gt;/dev/null <span class="o">||</span> <span class="nb">true</span> <span class="c"># Attempt to unmount base device, ignore errors</span>
<span class="nb">sleep </span>1 <span class="c"># Give time for umount to settle</span>
lsblk <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>

<span class="c"># 2. Wipe Existing Signatures (Recommended)</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Wiping filesystem/partition signatures from </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
wipefs <span class="nt">--all</span> <span class="nt">--force</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk to ensure changes are physically written</span>

<span class="c"># 3. Create New GPT Partition Table</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Creating new GPT partition table on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> mklabel gpt
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># 4. Create EFI System Partition (ESP)</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Creating ESP partition (1) on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> mkpart <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">"</span> fat32 1MiB <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_SIZE</span><span class="k">}</span><span class="s2">"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> <span class="nb">set </span>1 boot on
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> <span class="nb">set </span>1 esp on
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># 5. Create Linux Data Partition</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Creating Linux data partition (2) on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
<span class="c"># Use the end of the ESP as the start for the data partition</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> mkpart <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">"</span> ext4 <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_SIZE</span><span class="k">}</span><span class="s2">"</span> 100%
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>
<span class="nb">echo</span> <span class="s2">"Waiting briefly for kernel to recognize new partitions..."</span>
<span class="nb">sleep </span>2

<span class="c"># Define partition variables (assuming standard naming, e.g., /dev/sda1, /dev/sda2)</span>
<span class="c"># Adding 'p' for NVMe devices (e.g., /dev/nvme0n1p1) - check if base device name contains 'nvme'</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">==</span> <span class="k">*</span>nvme<span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">PART_PREFIX</span><span class="o">=</span><span class="s2">"p"</span>
<span class="k">else
    </span><span class="nv">PART_PREFIX</span><span class="o">=</span><span class="s2">""</span>
<span class="k">fi
</span><span class="nv">ESP_PARTITION</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}${</span><span class="nv">PART_PREFIX</span><span class="k">}</span><span class="s2">1"</span>
<span class="nv">DATA_PARTITION</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">DEVICE</span><span class="k">}${</span><span class="nv">PART_PREFIX</span><span class="k">}</span><span class="s2">2"</span>

<span class="c"># Check if partition devices exist, retry with partprobe if needed</span>
<span class="nb">echo</span> <span class="s2">"--- Checking for partition device nodes (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">, </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">) ---"</span>
<span class="nv">PARTITIONS_FOUND</span><span class="o">=</span><span class="nb">false
</span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..5<span class="o">}</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$ESP_PARTITION</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$DATA_PARTITION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Partition nodes found."</span>
        <span class="nv">PARTITIONS_FOUND</span><span class="o">=</span><span class="nb">true
        break
    </span><span class="k">fi
    </span><span class="nb">echo</span> <span class="s2">"Partition nodes not yet found. Retrying probe (Attempt </span><span class="nv">$i</span><span class="s2">/5)..."</span>
    partprobe <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"Warning: partprobe command failed, continuing check..."</span>
    <span class="nb">sleep </span>1
<span class="k">done

if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$PARTITIONS_FOUND</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Partition devices (</span><span class="nv">$ESP_PARTITION</span><span class="s2">, </span><span class="nv">$DATA_PARTITION</span><span class="s2">) not found after partitioning and retries."</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"       Please check manually ('lsblk </span><span class="nv">$DEVICE</span><span class="s2">', 'parted </span><span class="nv">$DEVICE</span><span class="s2"> print')."</span> <span class="o">&gt;</span>&amp;2
    lsblk <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># 6. Verify Partitioning</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying partitions on </span><span class="nv">$DEVICE</span><span class="s2"> ---"</span>
parted <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span> <span class="nt">--script</span> <span class="nt">--</span> print
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Block device view: ---"</span>
lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,PARTLABEL,MOUNTPOINT,PARTFLAGS <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"----------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Expected: </span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2"> (~</span><span class="k">${</span><span class="nv">ESP_SIZE</span><span class="k">}</span><span class="s2">), Type EFI System, Flags: boot, esp"</span>
<span class="nb">echo</span> <span class="s2">"Expected: </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2"> (Remaining size), Type Linux filesystem"</span>
<span class="nb">echo</span> <span class="s2">"----------------------------"</span>
<span class="nb">sleep </span>2 <span class="c"># Pause for user to review</span>


<span class="c"># --- Phase 3: Format Filesystems ---</span>

<span class="c"># 1. Format EFI Partition</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Formatting ESP partition (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">) as FAT32 with label '</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">' ---"</span>
mkfs.vfat <span class="nt">-F</span> 32 <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># Check filesystem integrity</span>
<span class="nb">echo</span> <span class="s2">"--- Checking ESP filesystem (fsck.vfat) ---"</span>
<span class="nv">FSCK_VFAT_EXIT_CODE</span><span class="o">=</span>0
fsck.vfat <span class="nt">-a</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="nv">FSCK_VFAT_EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span> <span class="c"># Run fsck, capture exit code on failure</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$FSCK_VFAT_EXIT_CODE</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ESP filesystem check passed (or no check performed)."</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$FSCK_VFAT_EXIT_CODE</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Exit code 1 usually means errors were found AND corrected.</span>
  <span class="nb">echo</span> <span class="s2">"WARNING: fsck.vfat found and corrected errors on ESP partition (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">). Check output above."</span>
<span class="k">else</span>
  <span class="c"># Exit codes &gt; 1 typically indicate uncorrected errors.</span>
  <span class="nb">echo</span> <span class="s2">"ERROR: fsck.vfat reported uncorrectable errors (Exit Code: </span><span class="nv">$FSCK_VFAT_EXIT_CODE</span><span class="s2">) on ESP partition (</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">)."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">echo</span> <span class="s2">"       Cannot proceed safely. Please investigate manually."</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Verify label using blkid</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying ESP label ---"</span>
<span class="k">if </span>blkid <span class="nt">-s</span> LABEL <span class="nt">-o</span> value <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"^</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">$"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ESP Label '</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">' verified successfully on </span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">."</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Failed to verify ESP Label '</span><span class="k">${</span><span class="nv">ESP_LABEL</span><span class="k">}</span><span class="s2">' on </span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">."</span> <span class="o">&gt;</span>&amp;2
    blkid <span class="s2">"</span><span class="k">${</span><span class="nv">ESP_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="c"># Show full blkid output for debugging</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># 2. Format Data Partition</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"--- Formatting Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">) as ext4 with label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' ---"</span>
mkfs.ext4 <span class="nt">-m</span> 0 <span class="nt">-L</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">sync</span> <span class="c"># Flush kernel buffers to disk</span>

<span class="c"># Check the new ext4 filesystem integrity</span>
<span class="nb">echo</span> <span class="s2">"--- Checking Data partition filesystem (e2fsck) ---"</span>
<span class="c"># -f forces check even if clean, -y assumes yes to all prompts (use with caution)</span>
<span class="nv">E2FSCK_EXIT_CODE</span><span class="o">=</span>0
e2fsck <span class="nt">-f</span> <span class="nt">-y</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="nv">E2FSCK_EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span> <span class="c"># Capture exit code on failure</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$E2FSCK_EXIT_CODE</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Data partition filesystem check passed."</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$E2FSCK_EXIT_CODE</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c"># Exit code 1 means errors were corrected.</span>
    <span class="nb">echo</span> <span class="s2">"WARNING: e2fsck found and corrected errors on Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">). Check output above."</span>
<span class="k">else</span>
    <span class="c"># Exit codes &gt; 1 indicate uncorrected errors.</span>
    <span class="nb">echo</span> <span class="s2">"ERROR: e2fsck reported uncorrectable errors (Exit Code: </span><span class="nv">$E2FSCK_EXIT_CODE</span><span class="s2">) on Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">)."</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"       Cannot proceed safely. Please investigate manually."</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Verify the label using blkid</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying Data partition label ---"</span>
<span class="k">if </span>blkid <span class="nt">-s</span> LABEL <span class="nt">-o</span> value <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"^</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">$"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Data Label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' verified successfully on </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">."</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Failed to verify Data Label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' on </span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">."</span> <span class="o">&gt;</span>&amp;2
    blkid <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">"</span> <span class="c"># Show full blkid output for debugging</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"--- Script finished successfully! ---"</span>
<span class="nb">echo</span> <span class="s2">"Device: </span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Partitions created and formatted:"</span>
lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,LABEL,PARTLABEL,MOUNTPOINT <span class="s2">"</span><span class="nv">$DEVICE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"-----------------------------------------------------"</span>

<span class="nb">exit </span>0
</code></section></div></div>
  <h3 id="phase-4-install-sbnb-boot-files-and-configuration">
    
    
     <a href="#phase-4-install-sbnb-boot-files-and-configuration">#</a><a href="#" aria-label="Back to top">Phase 4: Install Sbnb Boot Files and Configuration</a>
        
    
  </h3>
      

<ol>
  <li><strong>Mount EFI Partition:</strong> Access the ESP filesystem.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Mounting ESP partition ---"</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /mnt/sbnb-mount
<span class="nb">sudo </span>mount /dev/sdX1 /mnt/sbnb-mount
</code></section></div>    </div>
  </li>
  <li><strong>Create EFI Boot Directory:</strong> Standard UEFI fallback path.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating EFI boot directories ---"</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /mnt/sbnb-mount/EFI/BOOT
</code></section></div>    </div>
  </li>
  <li><strong>Copy Sbnb EFI Boot File:</strong> Place the bootloader (<code class="language-plaintext highlighter-rouge">sbnb.efi</code> as <code class="language-plaintext highlighter-rouge">BOOTX64.EFI</code>).
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Copying Sbnb EFI boot file ---"</span>
<span class="nb">sudo cp </span>sbnb.efi /mnt/sbnb-mount/EFI/BOOT/BOOTX64.EFI
</code></section></div>    </div>
  </li>
  <li><strong>(Recommended) Create Sbnb Configuration File:</strong> Place <code class="language-plaintext highlighter-rouge">sbnb-tskey.txt</code> in ESP root (<code class="language-plaintext highlighter-rouge">/mnt/sbnb-mount/</code>). The <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code> script reads this to configure Tailscale.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating Sbnb configuration file (sbnb-tskey.txt) ---"</span>
<span class="nb">echo</span> <span class="s2">"tskey-auth-..."</span> | <span class="nb">sudo tee</span> /mnt/sbnb-mount/sbnb-tskey.txt <span class="o">&gt;</span> /dev/null
</code></section></div>    </div>
  </li>
  <li><strong>(Crucial) Handle Data Partition Mounting via <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code>:</strong>
    <ul>
      <li><strong>Context &amp; Goal:</strong> Sbnb boots -&gt; systemd -&gt; <code class="language-plaintext highlighter-rouge">sbnb.service</code> -&gt; <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code> -&gt; mounts ESP to <code class="language-plaintext highlighter-rouge">/mnt/sbnb</code> -&gt; executes <code class="language-plaintext highlighter-rouge">/mnt/sbnb/sbnb-cmds.sh</code>. This script mounts the data partition (labeled <code class="language-plaintext highlighter-rouge">SBNB_DATA</code>) to <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code>.</li>
      <li><strong>Device Detection Timing:</strong> There’s a potential race: the kernel/udev might not have created the <code class="language-plaintext highlighter-rouge">/dev/disk/by-label/SBNB_DATA</code> symlink or the <code class="language-plaintext highlighter-rouge">/dev/sdX2</code> node exactly when the script runs. The wait loop mitigates this.</li>
      <li><strong>Default Script Conflict Uncertainty:</strong> The <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code> excerpt doesn’t show conflicting actions at its execution point. However, other early boot mechanisms could exist in Sbnb. If <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> behaves unexpectedly, investigate potential early boot scripts/services related to storage in your Sbnb version (advanced).</li>
      <li><strong><code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> Script (Wait Loop &amp; Logging):</strong> Create this in the ESP root (<code class="language-plaintext highlighter-rouge">/mnt/sbnb-mount/</code> during prep).
```bash
#!/bin/sh
  <h1 id="custom-sbnb-cmdssh-for-usb-persistent-partition-setup-no-lvm">
    
    
     <a href="#custom-sbnb-cmdssh-for-usb-persistent-partition-setup-no-lvm">#</a><a href="#" aria-label="Back to top">Custom sbnb-cmds.sh for USB Persistent Partition setup (No LVM)</a>
        
    
  </h1>
      
  <h1 id="mounts-partition-labeled-data_label-to-mount_point-after-waiting-for-device">
    
    
     <a href="#mounts-partition-labeled-data_label-to-mount_point-after-waiting-for-device">#</a><a href="#" aria-label="Back to top">Mounts partition labeled DATA_LABEL to MOUNT_POINT after waiting for device.</a>
        
    
  </h1>
      
  <h1 id="for-debugging-uncomment-set--x-to-trace-command-execution">
    
    
     <a href="#for-debugging-uncomment-set--x-to-trace-command-execution">#</a><a href="#" aria-label="Back to top">For debugging, uncomment ‘set -x’ to trace command execution.</a>
        
    
  </h1>
      
  <h1 id="set--x">
    
    
     <a href="#set--x">#</a><a href="#" aria-label="Back to top">set -x</a>
        
    
  </h1>
      
      </li>
    </ul>
  </li>
</ol>
  <h1 id="function-to-log-messages-consistently-to-kernel-buffer-dmesg-and-console-tty">
    
    
     <a href="#function-to-log-messages-consistently-to-kernel-buffer-dmesg-and-console-tty">#</a><a href="#" aria-label="Back to top">Function to log messages consistently to kernel buffer (dmesg) and console (tty)</a>
        
    
  </h1>
      
<p>log_msg() {
  echo “sbnb-cmds.sh: $1” | tee /dev/kmsg
}</p>

<p>log_msg “— Running Custom USB Partition Mount Script —”</p>
  <h1 id="-configuration-">
    
    
     <a href="#-configuration-">#</a><a href="#" aria-label="Back to top">— Configuration —</a>
        
    
  </h1>
      
<p>MOUNT_POINT=”/mnt/sbnb-data”  # Target directory for persistent data
DATA_LABEL=”SBNB_DATA”        # Filesystem label of the data partition (MUST match mkfs.ext4 -L)</p>
  <h1 id="alternative-use-uuid-for-potentially-more-stable-identification-if-labels-changeconflict">
    
    
     <a href="#alternative-use-uuid-for-potentially-more-stable-identification-if-labels-changeconflict">#</a><a href="#" aria-label="Back to top">Alternative: Use UUID for potentially more stable identification if labels change/conflict</a>
        
    
  </h1>
      
  <h1 id="get-uuid-using-sudo-blkid-devsdx2-on-prep-machine-then-set">
    
    
     <a href="#get-uuid-using-sudo-blkid-devsdx2-on-prep-machine-then-set">#</a><a href="#" aria-label="Back to top">Get UUID using ‘sudo blkid /dev/sdX2’ on prep machine, then set:</a>
        
    
  </h1>
      
  <h1 id="data_uuidyour-uuid-here">
    
    
     <a href="#data_uuidyour-uuid-here">#</a><a href="#" aria-label="Back to top">DATA_UUID=”YOUR-UUID-HERE”</a>
        
    
  </h1>
      
<p>MAX_WAIT_SECONDS=15           # Max time (seconds) to wait for the device node/label
WAIT_INTERVAL=1               # Check frequency (seconds)
MOUNT_OPTS=”defaults,noatime,nodiratime” # Mount options (noatime/nodiratime reduce writes on flash)</p>
  <h1 id="-end-configuration-">
    
    
     <a href="#-end-configuration-">#</a><a href="#" aria-label="Back to top">— End Configuration —</a>
        
    
  </h1>
      

<p>DATA_DEVICE=””                # Will hold the found device path</p>
  <h1 id="-wait-loop-for-device-">
    
    
     <a href="#-wait-loop-for-device-">#</a><a href="#" aria-label="Back to top">— Wait Loop for Device —</a>
        
    
  </h1>
      
  <h1 id="attempts-to-find-the-device-by-label-or-uuid-if-configured">
    
    
     <a href="#attempts-to-find-the-device-by-label-or-uuid-if-configured">#</a><a href="#" aria-label="Back to top">Attempts to find the device by label or UUID (if configured).</a>
        
    
  </h1>
      
  <h1 id="waits-because-device-node-creation-by-kerneludev-might-be-delayed">
    
    
     <a href="#waits-because-device-node-creation-by-kerneludev-might-be-delayed">#</a><a href="#" aria-label="Back to top">Waits because device node creation by kernel/udev might be delayed.</a>
        
    
  </h1>
      
<p>elapsed_wait=0
log_msg “Waiting up to ${MAX_WAIT_SECONDS}s for device (Label: ${DATA_LABEL:-N/A})…”
while [ -z “$DATA_DEVICE” ] &amp;&amp; [ $elapsed_wait -lt $MAX_WAIT_SECONDS ]; do
  # Check for device using the label symlink first (usually faster if udev ran)
  label_path=”/dev/disk/by-label/${DATA_LABEL}”
  if [ -e “$label_path” ]; then
      # Readlink -f resolves the symlink to the actual device path (e.g., /dev/sdb2)
      DATA_DEVICE=$(readlink -f “$label_path”)
      log_msg “Found device via label symlink: $label_path -&gt; $DATA_DEVICE”
      break # Exit loop
  fi</p>

<p># Fallback: Use blkid command to scan for the label (can be slower)
  blkid_device=$(blkid -L “${DATA_LABEL}” 2&gt;/dev/null)
  if [ -n “$blkid_device” ]; then
      DATA_DEVICE=”$blkid_device”
      log_msg “Found device via blkid label lookup: $DATA_DEVICE”
      break # Exit loop
  fi</p>

<p># (Add similar checks here using DATA_UUID if using UUID instead of Label)</p>

<p># Device not found yet, wait before next check
  sleep $WAIT_INTERVAL
  elapsed_wait=$((elapsed_wait + WAIT_INTERVAL))
done</p>
  <h1 id="-mount-logic-">
    
    
     <a href="#-mount-logic-">#</a><a href="#" aria-label="Back to top">— Mount Logic —</a>
        
    
  </h1>
      
  <h1 id="proceed-only-if-a-device-path-was-successfully-determined">
    
    
     <a href="#proceed-only-if-a-device-path-was-successfully-determined">#</a><a href="#" aria-label="Back to top">Proceed only if a device path was successfully determined</a>
        
    
  </h1>
      
<p>if [ -n “$DATA_DEVICE” ] &amp;&amp; [ -e “$DATA_DEVICE” ]; then
  log_msg “Data partition device resolved to ${DATA_DEVICE} after ${elapsed_wait}s.”</p>

<p># Check if the target directory is already a mount point
  if ! mountpoint -q “$MOUNT_POINT”; then
    log_msg “Attempting to mount $DATA_DEVICE at $MOUNT_POINT with options: $MOUNT_OPTS…”
    # Ensure the target directory exists
    mkdir -p “$MOUNT_POINT”
    # Mount the device
    if mount -o “$MOUNT_OPTS” “$DATA_DEVICE” “$MOUNT_POINT”; then
      log_msg “Successfully mounted persistent partition at $MOUNT_POINT.”
    else
      mount_exit_code=$?
      log_msg “ERROR: Failed to mount $DATA_DEVICE at $MOUNT_POINT (exit code: $mount_exit_code). Check filesystem type/integrity (run fsck?). See dmesg for details.” &gt;&amp;2
    fi
  else
    # Mount point exists, verify if it’s the correct device
    log_msg “$MOUNT_POINT is already a mount point. Checking device…”
    # Check /proc/mounts for the currently mounted device at MOUNT_POINT
    if grep -qs “$DATA_DEVICE $MOUNT_POINT” /proc/mounts; then
          log_msg “Persistent partition already correctly mounted at $MOUNT_POINT.”
    else
          mounted_dev=$(grep -s “$MOUNT_POINT” /proc/mounts | awk ‘{print $1}’)
          log_msg “ERROR: $MOUNT_POINT is already mounted, but by ‘$mounted_dev’ NOT ‘$DATA_DEVICE’! Check system configuration.” &gt;&amp;2
    fi
  fi
else
  # Device wasn’t found within the timeout
  log_msg “ERROR: Data partition device (Label: ${DATA_LABEL:-N/A}) not found after waiting ${MAX_WAIT_SECONDS}s. Cannot mount persistent storage.” &gt;&amp;2
fi</p>

<p>mkdir -p /etc/docker
cp /mnt/sbnb-data/docker/docker-daemon.json.template /etc/docker/daemon.json</p>

<p>log_msg “— Finished Custom USB Partition Mount Script —”</p>
  <h1 id="exit-0-ensures-the-rest-of-the-sbnb-boot-sequence-continues">
    
    
     <a href="#exit-0-ensures-the-rest-of-the-sbnb-boot-sequence-continues">#</a><a href="#" aria-label="Back to top">Exit 0 ensures the rest of the Sbnb boot sequence continues</a>
        
    
  </h1>
      
<p>exit 0
```
    * Place script content into <code class="language-plaintext highlighter-rouge">/mnt/sbnb-mount/sbnb-cmds.sh</code>.
    * Make executable: <code class="language-plaintext highlighter-rouge">sudo chmod +x /mnt/sbnb-mount/sbnb-cmds.sh</code>.</p>

<ol>
  <li><strong>Unmount the EFI Partition:</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Unmounting ESP partition ---"</span>
<span class="c"># Ensure buffers are flushed before unmounting</span>
<span class="nb">sync
sudo </span>umount /mnt/sbnb-mount
</code></section></div>    </div>
  </li>
</ol>
  <h3 id="phase-45-backing-up-data-critical">
    
    
     <a href="#phase-45-backing-up-data-critical">#</a><a href="#" aria-label="Back to top">Phase 4.5: Backing Up Data (CRITICAL!)</a>
        
    
  </h3>
      

<ul>
  <li><strong>Why Essential:</strong> High risk of USB drive failure. Backups are mandatory.</li>
  <li><strong>Strategy:</strong> Automate regular backups of <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code>.</li>
  <li><strong>File Data Backup (<code class="language-plaintext highlighter-rouge">rsync</code>):</strong> Ensure the backup destination (NAS, cloud, another server) has sufficient free space.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  <span class="c"># Example: From Sbnb to backup-server (requires ssh key auth)</span>
  rsync <span class="nt">-avz</span> <span class="nt">--delete</span> <span class="nt">--progress</span> <span class="nt">--human-readable</span> /mnt/sbnb-data/ user@backup-server:/path/to/backups/sbnb-usb-data/
</code></section></div>    </div>
  </li>
  <li><strong>Frequency:</strong> Daily recommended for active data.</li>
  <li><strong>Automation:</strong> Use cron/systemd timers or remote triggers.</li>
  <li><strong>Testing Restores:</strong> Vital! Don’t assume backups work.
    <ul>
      <li><strong>Conceptual Restore:</strong> Boot Linux Live env -&gt; Mount backup source -&gt; Mount target USB data partition (new/reformatted) to <code class="language-plaintext highlighter-rouge">/mnt/restore</code> -&gt; <code class="language-plaintext highlighter-rouge">sudo rsync -av --progress /path/to/backup/sbnb-usb-data/ /mnt/restore/</code> -&gt; Verify restored files (count, size, checksums, spot checks).</li>
    </ul>
  </li>
  <li><strong>Verification:</strong> Use tools like <code class="language-plaintext highlighter-rouge">diff -r</code>, <code class="language-plaintext highlighter-rouge">md5sum</code>, or <code class="language-plaintext highlighter-rouge">sha256sum</code> to compare restored files against originals or known good copies.</li>
  <li><em>Untested backups provide a false sense of security.</em></li>
</ul>
  <h3 id="phase-5-boot-and-verify">
    
    
     <a href="#phase-5-boot-and-verify">#</a><a href="#" aria-label="Back to top">Phase 5: Boot and Verify</a>
        
    
  </h3>
      

<ol>
  <li><strong>Safely Eject:</strong> Eject USB from prep system.</li>
  <li><strong>Configure Server BIOS/UEFI:</strong> Enter setup (DEL, F2, F10, F12, etc.). Ensure UEFI Mode ON, CSM/Legacy OFF, Secure Boot OFF. Set “UEFI: USB…” as first boot device. Save &amp; Exit.</li>
  <li><strong>Boot Sbnb Linux.</strong></li>
  <li><strong>Verify Operation:</strong>
    <ul>
      <li>Monitor Boot: Watch console for <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> logs, errors.</li>
      <li>SSH into Sbnb.</li>
      <li>Check Mounts:
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,LABEL,MOUNTPOINT <span class="c"># Look for mount at /mnt/sbnb-data</span>
  <span class="nb">df</span> <span class="nt">-hT</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'Filesystem|/mnt/sbnb-data'</span>     <span class="c"># Check usage/type</span>
  mount | <span class="nb">grep</span> /mnt/sbnb-data                      <span class="c"># Check mount options (rw, noatime)</span>
  findmnt /mnt/sbnb-data                           <span class="c"># Another way to check mount info</span>
</code></section></div>        </div>
      </li>
      <li>Test Persistence:
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  <span class="c"># After SSHing in:</span>
  <span class="nv">TIMESTAMP</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span>
  <span class="nb">echo</span> <span class="s2">"Sbnb USB Persistence test - </span><span class="nv">$TIMESTAMP</span><span class="s2">"</span> | <span class="nb">sudo tee</span> /mnt/sbnb-data/persistence_test.txt <span class="o">&gt;</span> /dev/null
  <span class="nb">sync</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Synced data to disk."</span>
  <span class="nb">echo</span> <span class="s2">"File created. Content:"</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo cat</span> /mnt/sbnb-data/persistence_test.txt
  <span class="nb">echo</span> <span class="s2">"Rebooting server now..."</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>reboot

  <span class="c"># --- Wait for reboot and reconnect via SSH ---</span>
  <span class="nb">echo</span> <span class="s2">"Checking for file after reboot..."</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> /mnt/sbnb-data/persistence_test.txt <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"SUCCESS: File found. Content:"</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo cat</span> /mnt/sbnb-data/persistence_test.txt
    <span class="nb">sudo rm</span> /mnt/sbnb-data/persistence_test.txt <span class="c"># Clean up</span>
  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"FAILURE: File NOT FOUND after reboot! Persistence failed."</span>
  <span class="k">fi</span>
</code></section></div>        </div>
      </li>
    </ul>
  </li>
</ol>
  <h2 id="troubleshooting">
    
    
     <a href="#troubleshooting">#</a><a href="#" aria-label="Back to top">Troubleshooting</a>
        
    
  </h2>
      

<ul>
  <li><strong>Doesn’t Boot / No Bootable Device:</strong>
    <ul>
      <li>Re-verify BIOS settings (UEFI, Secure Boot OFF, Boot Order).</li>
      <li>Re-verify USB Prep: Partitions (<code class="language-plaintext highlighter-rouge">parted print</code>), ESP flags (<code class="language-plaintext highlighter-rouge">boot</code>,<code class="language-plaintext highlighter-rouge">esp</code>), ESP filesystem label (<code class="language-plaintext highlighter-rouge">blkid /dev/sdX1</code> -&gt; <code class="language-plaintext highlighter-rouge">LABEL="sbnb"</code>), EFI file path (<code class="language-plaintext highlighter-rouge">/EFI/BOOT/BOOTX64.EFI</code>).</li>
      <li>Try different USB ports (check if port provides sufficient power). Test drive health on prep machine (<code class="language-plaintext highlighter-rouge">fsck</code>, <code class="language-plaintext highlighter-rouge">badblocks -nvs /dev/sdX</code>). Recreate drive meticulously.</li>
    </ul>
  </li>
  <li><strong>Data Partition Not Mounted / <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> Empty:</strong>
    <ul>
      <li>Check boot logs (<code class="language-plaintext highlighter-rouge">journalctl -b</code>, console) for <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> errors (“Device… not found”, “Failed to mount”). Check <code class="language-plaintext highlighter-rouge">dmesg</code> for USB errors (<code class="language-plaintext highlighter-rouge">dmesg | grep -iE 'usb|sdX'</code>) or filesystem errors (<code class="language-plaintext highlighter-rouge">dmesg | grep -i ext4</code>).</li>
      <li>SSH in:
        <ul>
          <li>Verify partition &amp; label: <code class="language-plaintext highlighter-rouge">sudo blkid</code>, <code class="language-plaintext highlighter-rouge">ls -l /dev/disk/by-label/</code>. Is <code class="language-plaintext highlighter-rouge">SBNB_DATA</code> present? Does it point to the correct device?</li>
          <li>If label wrong/missing: Re-label from prep env (<code class="language-plaintext highlighter-rouge">sudo e2label /dev/sdX2 SBNB_DATA</code>).</li>
          <li>If device/label exists, try manual mount: <code class="language-plaintext highlighter-rouge">sudo mkdir -p /mnt/sbnb-data &amp;&amp; sudo mount /dev/disk/by-label/SBNB_DATA /mnt/sbnb-data</code>. Check <code class="language-plaintext highlighter-rouge">dmesg</code> for errors (e.g., <code class="language-plaintext highlighter-rouge">mount: wrong fs type, bad option, bad superblock</code>). If manual mount works, debug <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> (add <code class="language-plaintext highlighter-rouge">set -x</code>, check paths, loop duration, check script permissions <code class="language-plaintext highlighter-rouge">ls -l /mnt/sbnb/sbnb-cmds.sh</code>).</li>
          <li>Run filesystem check (unmounted): <code class="language-plaintext highlighter-rouge">sudo e2fsck -f /dev/disk/by-label/SBNB_DATA</code>.</li>
          <li>Check kernel modules: <code class="language-plaintext highlighter-rouge">lsmod | grep ext4</code>. Is the module loaded? Check <code class="language-plaintext highlighter-rouge">dmesg</code> for errors loading filesystem modules.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Poor Performance / Drive Failure:</strong>
    <ul>
      <li><strong>Performance:</strong> Inherent limitation.</li>
      <li><strong>Lifespan/Failure:</strong> Monitor <code class="language-plaintext highlighter-rouge">dmesg</code> for I/O errors. Restore from verified backups upon failure. This setup will wear out consumer flash drives with persistent writes.</li>
    </ul>
  </li>
</ul>
  <h2 id="final-recommendation">
    
    
     <a href="#final-recommendation">#</a><a href="#" aria-label="Back to top">Final Recommendation</a>
        
    
  </h2>
      

<p>This guide details a complex, non-standard configuration fraught with performance and reliability risks. While it provides a technically feasible path for single-drive boot and persistence under specific constraints, users should strongly prefer the standard Sbnb architecture using reliable internal server storage whenever possible. Evaluate the trade-offs carefully before committing to this approach.</p>

        </div>
        
          URL: https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage
        
      </article>
      <nav class="post-navigation-combined" aria-label="Post navigation">
        <!-- Chronological Navigation (always visible at 40vh) -->
        
          <div class="nav-arrow chronological prev">
            <a href="/to-enable-video-acceleration-on-rpi4/" title="to enable video acceleration on RPI4" rel="prev">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
        
          <div class="nav-arrow chronological next">
            <a href="/images-to-searchable-pdf/" title="Images to Searchable PDF" rel="next">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
            
            
              
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  
                  
              
              
              
              <!-- Navigation block for tag "scratchpad"; default display for the first tag -->
              <div class="nav-group tags" id="tag-nav-scratchpad" style="display: block;">
                <div class="nav-arrow tags prev">
                  
                    <a href="/aot-3/" title="AoT 3" rel="prev">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
                <div class="nav-arrow tags next">
                  
                    <a href="/onetabbak/" title="oneTAB.bak" rel="next">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
              </div>
            
          
          <!-- JavaScript to Toggle the Tag-based Navigation -->
          <script>
            document.addEventListener("DOMContentLoaded", function(){
              var tagLinks = document.querySelectorAll('.tag-option');
              tagLinks.forEach(function(link){
                link.addEventListener('click', function(event){
                  event.preventDefault();
                  // Remove "active" class from all tag options.
                  tagLinks.forEach(function(el){ el.classList.remove('active'); });
                  // Add active class to the clicked tag option.
                  this.classList.add('active');
                  // Hide all tag navigation blocks.
                  document.querySelectorAll('.nav-group.tags').forEach(function(block){
                    block.style.display = 'none';
                  });
                  // Show the navigation block corresponding to the selected tag.
                  var tagSlug = this.getAttribute('data-tag');
                  var target = document.getElementById('tag-nav-' + tagSlug);
                  if(target) {
                    target.style.display = 'block';
                  }
                });
              });
            });
          </script>
      </nav>
      
    </main>
    <footer id="bottom-of-page" class="site-footer">
      <div class="footer-content">
        <!-- Back to top link -->
        <a href="#" aria-label="Back to top" class="back2top-link">
          <span class="sronly">Back to top</span>
        </a>
    
        <!-- Liquid Time Calculation and Display -->
        
        
        
        <a href="https://ib.bsb.br/404" aria-label="404">
          2025-04-13 14:45:38
        </a>
        &#x23;
    
        <!-- Tag Selector -->
        <ul class="tag-selector">
          
            
            
              <li>
                <a href="#" class="tag-option active" data-tag="scratchpad">
                  scratchpad
                </a>
              </li>
            
          
        </ul>
        &hArr;
    
        <!-- GitHub Link -->
        <a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io" aria-label="GitHub">
          &#8505;
        </a>
    
        <!-- Homepage Link -->
        <a href="/" aria-label="Homepage">
          infoBAG
        </a>
    
        <!-- Copy All Code Button -->
        <button id="copyAllButton" aria-label="Copy all code">
          &copy;
        </button>
      </div>
    </footer>
    <style>
      .back2top-link {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: url("/assets/Rope_(Old).gif") center center no-repeat;
        background-size: contain;
        text-decoration: none;
        vertical-align: middle;
      }
      .sronly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/"
        },
        "headline": "Single USB for Sbnb Boot and Persistent Storage",
        "description": "",
        "datePublished": "2025-04-07T00:00:00+00:00",
        "dateModified": "2025-04-12T20:33:58+00:00",
        "author": {
          "@type": "Person",
          "name": "Author"
        },
        "publisher": {
          "@type": "Organization",
          "name": "infoBAG"
          
        }
        
      }
    </script>
    <script src="/assets/js/prism.js" defer></script>
    <script src="/assets/js/copy-all-code.js"></script>
  </body>
</html>
