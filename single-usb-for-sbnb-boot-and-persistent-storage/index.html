<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      
        Single USB for Sbnb Boot and Persistent Storage - infoBAG
      
    </title>
    <meta name="title" content="Single USB for Sbnb Boot and Persistent Storage - infoBAG" />
    <meta name="description" content="">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/">
    <meta property="og:title" content="Single USB for Sbnb Boot and Persistent Storage - infoBAG">
    <meta property="og:description" content="">
    <meta property="og:image" content="/favicon.ico">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/">
    <meta name="twitter:title" content="Single USB for Sbnb Boot and Persistent Storage - infoBAG">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/favicon.ico">
    <link rel="canonical" href="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/">
    <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">
    
      <meta name="keywords" content="scratchpad">
      
        <meta property="article:tag" content="scratchpad">
      
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/style.css">
  </head>
  <body class="post-content-body">
    <header class="header-container">
      <nav aria-label="Main navigation" class="header-content">
        <a href="/" aria-label="Home">
          <img src="/favicon.ico" alt="Home" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/tags" aria-label="Tags">
          <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/send" aria-label="send">
          <img src="/assets/rot.gif" alt="send" class="favicon search-link" width="32" height="32" loading="lazy">
        </a> 
        <a href="/created" aria-label="archive created">
          <img src="/assets/Loose_Stone_Pile.gif" alt="archive created" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/events" aria-label="Events">
          <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
        <a href="/modified" aria-label="archive modified">
          <img src="/assets/Hole_(Rock).gif" alt="archive modified" class="favicon search-link" width="32" height="32" loading="lazy">
        </a>
    </nav>
      <h5 class="post-title">
        <a href="#bottom-of-page" aria-label="Go to bottom">
          Single USB for Sbnb Boot and Persistent Storage
        </a>
      </h5>
      <div class="post-meta">
        <time datetime="2025-04-07T00:00:00+00:00" class="post-date">
          07 Apr 2025
        </time>
        
          <span class="post-updated">
            ↣
            <time datetime="2025-04-07T14:04:23+00:00">
              07 Apr 2025
            </time>
          </span>
        
        
          <p class="post-slug">
            Slug: <a href="https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage" class="tag">single-usb-for-sbnb-boot-and-persistent-storage</a>
          </p>
        
        
          <p class="post-tags">
            Tags:
            
              <a href="https://ib.bsb.br/tags/#scratchpad" class="tag">scratchpad</a>
            
          </p>
        
      </div>
      <div class="post-actions">
        <div class="page-stats mt-3" role="status" aria-label="Page statistics">
      
      <span class="badge bg-primary">
        22295 characters
      </span>
        <span class="separator mx-2" aria-hidden="true">•</span>
        <span class="badge bg-primary">
        2910 words
      </span>
      </div>
        <div class="action-buttons d-flex flex-wrap gap-2">
          
            
              <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2025-04-07-single-usb-for-sbnb-boot-and-persistent-storage.md"
                    method="GET"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="d-inline-block">
                <button type="submit" class="btn btn-danger" aria-label="Edit page content">
                  <span class="button-text">Improve this page?</span>
                  <span class="info-text">aberto.</span>
                </button>
              </form>
            
            <form action="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2025-04-07-single-usb-for-sbnb-boot-and-persistent-storage.md"
                  method="GET"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="d-inline-block">
              <button type="submit" class="btn btn-danger" aria-label="View page revision history">
                View revision history
              </button>
            </form>
          
        </div>
      </div>
    </header>
    <main class="content">
      <article class="post-wrapper">
        <div class="post-content-body">
          
<ul><li><a href="#primary-drawbacks--warnings-reiterated--expanded">Primary Drawbacks &amp; Warnings (Reiterated &amp; Expanded):</a><ul><li><a href="#when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">When Might This Be Considered? (Limited Scenarios with Full Risk Acceptance)</a></li></ul></li><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#step-by-step-instructions">Step-by-Step Instructions</a><ul><li><a href="#phase-1-prepare-the-linux-environment-opensuse-tumbleweed">Phase 1: Prepare the Linux Environment (openSUSE Tumbleweed)</a></li><li><a href="#phase-2-partition-the-usb-drive">Phase 2: Partition the USB Drive</a></li><li><a href="#phase-3-format-filesystems">Phase 3: Format Filesystems</a></li><li><a href="#phase-4-install-sbnb-boot-files-and-configuration">Phase 4: Install Sbnb Boot Files and Configuration</a></li><li><a href="#phase-45-backing-up-data-critical">Phase 4.5: Backing Up Data (CRITICAL!)</a></li><li><a href="#phase-5-boot-and-verify">Phase 5: Boot and Verify</a></li></ul></li><li><a href="#troubleshooting">Troubleshooting</a></li><li><a href="#final-recommendation">Final Recommendation</a></li></ul>
          <p>This guide provides comprehensive, step-by-step instructions for configuring a single USB flash drive (or potentially an external USB hard drive) to perform two distinct functions simultaneously:</p>

<ol>
  <li><strong>Booting the Sbnb Linux Operating System:</strong> The drive will be prepared with a standard UEFI-compatible structure, specifically an EFI System Partition (ESP) containing the Sbnb EFI bootloader (<code class="language-plaintext highlighter-rouge">sbnb.efi</code>) and necessary configuration files. This allows the server’s firmware to locate and start the Sbnb boot process. The <code class="language-plaintext highlighter-rouge">sbnb.efi</code> file itself is typically a Unified Kernel Image (UKI), bundling the Linux kernel, initramfs, and kernel command line into a single executable file.</li>
  <li><strong>Providing Simple Persistent Storage:</strong> Utilizing a separate partition on the same physical USB drive, formatted with a standard Linux filesystem (<code class="language-plaintext highlighter-rouge">ext4</code> is used in this guide). This partition is intended to be automatically mounted at the <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> directory path within the running Sbnb Linux system via a custom boot script (<code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code>). This provides a space where data (like container volumes, application data, logs, user files) can persist across reboots of the otherwise ephemeral, RAM-based Sbnb OS.</li>
</ol>

<p><strong>Important Note on Sbnb Version:</strong> This guide is based on analysis of the Sbnb GitHub repository content provided previously. If you are using a significantly different version of Sbnb Linux, the boot process, script names, expected labels, or available tools might differ. Always consult the documentation specific to your Sbnb version if available, and be prepared to adapt these steps.</p>

<p><strong>Why <code class="language-plaintext highlighter-rouge">ext4</code> instead of LVM:</strong> Initial analysis suggested LVM might be suitable, but further review of the default Sbnb Linux build configuration indicates the necessary <code class="language-plaintext highlighter-rouge">lvm2</code> user-space tools are likely missing from the base runtime environment. Without these tools, managing LVM volumes during boot via standard scripts is infeasible unless you create a custom Sbnb build that includes the <code class="language-plaintext highlighter-rouge">lvm2</code> package. This revised guide therefore uses a standard <code class="language-plaintext highlighter-rouge">ext4</code> filesystem partition, relying only on basic tools expected to be present in Sbnb.</p>

<p><strong>Contrasting with Standard Sbnb Workflow:</strong> It’s crucial to understand that this guide describes a highly non-standard setup. The intended Sbnb workflow prioritizes resilience, performance, and statelessness:</p>

<ul>
  <li>Boot the minimal Sbnb OS from simple USB/network.</li>
  <li>Use automation (Ansible) or manual scripts (<code class="language-plaintext highlighter-rouge">sbnb-configure-storage.sh</code>) post-boot to configure LVM on internal server drives.</li>
  <li>Run workloads utilizing this fast, reliable internal storage. This guide’s method compromises these benefits for single-drive convenience under specific constraints.</li>
</ul><hr />

<blockquote>
  <p><strong>*** EXTREME CAUTION: IRREVERSIBLE DATA DESTRUCTION IMMINENT! **</strong>*</p>

  <p>This procedure involves low-level disk operations (partitioning, formatting) that will completely and <strong>PERMANENTLY ERASE ALL DATA</strong> currently residing on the USB drive you select. There is <strong>NO UNDO</strong> function. Data recovery after accidental formatting is often impossible.</p>

  <p>The most critical risk is selecting the <strong>wrong target device</strong>. Mistakenly choosing your computer’s internal hard drive (e.g., <code class="language-plaintext highlighter-rouge">/dev/sda</code>, <code class="language-plaintext highlighter-rouge">/dev/nvme0n1</code>) instead of the intended USB drive (e.g., <code class="language-plaintext highlighter-rouge">/dev/sdb</code>, <code class="language-plaintext highlighter-rouge">/dev/sdc</code>) <strong>WILL RESULT IN CATASTROPHIC AND LIKELY IRRECOVERABLE LOSS OF YOUR OPERATING SYSTEM, APPLICATIONS, AND PERSONAL FILES.</strong></p>

  <p>You <strong>MUST</strong> verify the target device name multiple times using different commands (like <code class="language-plaintext highlighter-rouge">lsblk</code>, <code class="language-plaintext highlighter-rouge">fdisk</code>, <code class="language-plaintext highlighter-rouge">parted</code>) and cross-reference with expected drive sizes and models before executing any partitioning or formatting commands. Proceed with extreme vigilance, double-checking each step, entirely at your own sole risk!</p>
</blockquote><hr />
  <h2 id="primary-drawbacks--warnings-reiterated--expanded">
    
    
     <a href="#primary-drawbacks--warnings-reiterated--expanded">#</a><a href="#" aria-label="Back to top">Primary Drawbacks &amp; Warnings (Reiterated &amp; Expanded):</a>
        
    
  </h2>
      

<ul>
  <li><strong>Highly Non-Standard &amp; Complex:</strong> Deviates significantly from Sbnb’s design. Setup is intricate, runtime behavior depends on precise script execution and timing. Future Sbnb updates might break this.</li>
  <li><strong>Severe Performance Penalty:</strong> USB storage is inherently slow (latency, throughput, IOPS) compared to internal NVMe/SATA drives. Disk I/O to <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> will be a major bottleneck.</li>
  <li><strong>Drastically Reduced Lifespan &amp; Reliability:</strong> USB flash drives will wear out quickly under persistent write load due to limited write cycles, write amplification, and lack of TRIM support. Unsuitable for write-intensive workloads or high reliability needs. Expect eventual failure and data loss without robust backups.</li>
  <li><strong>Potential Instability &amp; Boot Issues:</strong> Relies on correct partition detection, udev node creation, filesystem integrity, and <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> execution timing. Failures can leave persistent storage unavailable.</li>
</ul>
  <h3 id="when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">
    
    
     <a href="#when-might-this-be-considered-limited-scenarios-with-full-risk-acceptance">#</a><a href="#" aria-label="Back to top">When Might This Be Considered? (Limited Scenarios with Full Risk Acceptance)</a>
        
    
  </h3>
      

<ul>
  <li><strong>Temporary Testing/Experimentation ONLY:</strong> Brief evaluations on hardware lacking internal drives.</li>
  <li><strong>Specific, Very Low-Intensity, Read-Mostly Use Cases:</strong> Infrequent writes, performance irrelevant (e.g., static config kiosk).</li>
  <li><strong>Absolute Hardware Constraints:</strong> Sealed systems where internal drives are impossible, and risks are fully accepted.</li>
</ul>

<p><em>Even in these limited scenarios, regular, automated, and verified backups are non-negotiable.</em></p>
  <h2 id="prerequisites">
    
    
     <a href="#prerequisites">#</a><a href="#" aria-label="Back to top">Prerequisites</a>
        
    
  </h2>
      

<ul>
  <li><strong>A Suitable USB Flash Drive:</strong>
    <ul>
      <li><strong>Capacity:</strong> Min ~1GB ESP + desired data size (32GB+ recommended).</li>
      <li><strong>Quality &amp; Speed:</strong> Reputable brand, USB 3.0+ advised for marginal speed benefit. Endurance matters more than peak speed.</li>
    </ul>
  </li>
  <li><strong>A Working Linux System (Preparation Environment):</strong>
    <ul>
      <li><strong>Necessity:</strong> Required for partitioning/formatting the target USB safely. openSUSE Tumbleweed assumed.</li>
      <li><strong>Live Environment Benefit:</strong> Using a Live USB/CD (e.g., openSUSE Tumbleweed Live) is highly recommended as it provides a non-destructive environment.</li>
    </ul>
  </li>
  <li><strong>Sbnb Linux Boot File (<code class="language-plaintext highlighter-rouge">sbnb.efi</code>):</strong>
    <ul>
      <li><strong>Method 1 (Easier):</strong> Run official Sbnb install script on a temporary USB, then copy <code class="language-plaintext highlighter-rouge">/EFI/BOOT/BOOTX64.EFI</code> from its ESP.</li>
      <li><strong>Method 2 (Advanced):</strong> Build Sbnb from source, find <code class="language-plaintext highlighter-rouge">sbnb.efi</code> in <code class="language-plaintext highlighter-rouge">output/images/</code>.</li>
    </ul>
  </li>
  <li><strong>Root/Sudo Privileges:</strong> Needed on the openSUSE prep system for disk commands.</li>
  <li><strong>Internet Connection:</strong> May be needed for <code class="language-plaintext highlighter-rouge">zypper</code>.</li>
</ul>
  <h2 id="step-by-step-instructions">
    
    
     <a href="#step-by-step-instructions">#</a><a href="#" aria-label="Back to top">Step-by-Step Instructions</a>
        
    
  </h2>
      

<p><em>(Reminder: TRIPLE-CHECK your target device name, e.g., <code class="language-plaintext highlighter-rouge">/dev/sdX</code>, before every destructive command!)</em></p>
  <h3 id="phase-1-prepare-the-linux-environment-opensuse-tumbleweed">
    
    
     <a href="#phase-1-prepare-the-linux-environment-opensuse-tumbleweed">#</a><a href="#" aria-label="Back to top">Phase 1: Prepare the Linux Environment (openSUSE Tumbleweed)</a>
        
    
  </h3>
      

<ol>
  <li><strong>Boot into openSUSE:</strong> Start your preparation environment.</li>
  <li><strong>Install Necessary Tools:</strong> Open a terminal. <code class="language-plaintext highlighter-rouge">zypper refresh</code> updates package lists. <code class="language-plaintext highlighter-rouge">zypper install</code> installs tools.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">sudo </span>zypper refresh
<span class="nb">sudo </span>zypper <span class="nb">install</span> <span class="nt">-y</span> parted lvm2 dosfstools e2fsprogs
</code></section></div>    </div>
  </li>
  <li><strong>Identify Target USB Drive:</strong> <strong>CRITICAL SAFETY STEP!</strong> Unplug other USB storage.
    <ul>
      <li>Insert the target USB drive.</li>
      <li>Use multiple commands. Compare SIZE and MODEL. Check <code class="language-plaintext highlighter-rouge">dmesg | tail</code> after plugging in for kernel messages like <code class="language-plaintext highlighter-rouge">sd 2:0:0:0: [sdc] Attached SCSI removable disk</code>.
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>lsblk <span class="nt">-d</span> <span class="nt">-o</span> NAME,SIZE,MODEL,VENDOR,TYPE | <span class="nb">grep</span> <span class="s1">'disk'</span>
<span class="nb">sudo </span>fdisk <span class="nt">-l</span> | <span class="nb">grep</span> <span class="s1">'^Disk /dev/'</span>
<span class="nb">sudo </span>parted <span class="nt">-l</span> | <span class="nb">grep</span> <span class="s1">'^Disk /dev/'</span>
<span class="c"># Example: If consistently identified as /dev/sdc, use /dev/sdc below.</span>
</code></section></div>        </div>
      </li>
      <li>Visually confirm with YaST Partitioner (<code class="language-plaintext highlighter-rouge">sudo yast2 partitioner</code>) or GParted (<code class="language-plaintext highlighter-rouge">sudo zypper install -y gparted &amp;&amp; sudo gparted</code>) if preferred. Look for the drive matching the expected size and vendor/model.</li>
      <li>Assume <code class="language-plaintext highlighter-rouge">/dev/sdX</code> is your verified target drive. <strong>Replace it carefully!</strong></li>
    </ul>
  </li>
</ol>
  <h3 id="phase-2-partition-the-usb-drive">
    
    
     <a href="#phase-2-partition-the-usb-drive">#</a><a href="#" aria-label="Back to top">Phase 2: Partition the USB Drive</a>
        
    
  </h3>
      

<p><strong>(Warning: The following <code class="language-plaintext highlighter-rouge">parted</code> commands are DESTRUCTIVE to <code class="language-plaintext highlighter-rouge">/dev/sdX</code>. Double-check the device name!)</strong></p>

<ol>
  <li><strong>Unmount Existing Partitions:</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Unmounting any partitions on /dev/sdX ---"</span>
findmnt <span class="nt">-n</span> <span class="nt">-o</span> TARGET <span class="nt">--source</span> /dev/sdX<span class="k">*</span> | xargs <span class="nt">--no-run-if-empty</span> <span class="nb">sudo </span>umount <span class="nt">-v</span> <span class="nt">-l</span>
lsblk /dev/sdX
</code></section></div>    </div>
  </li>
  <li><strong>Wipe Existing Signatures (Recommended):</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Wiping signatures from /dev/sdX ---"</span>
<span class="nb">sudo </span>wipefs <span class="nt">--all</span> <span class="nt">--force</span> /dev/sdX
</code></section></div>    </div>
  </li>
  <li><strong>Create New GPT Partition Table:</strong> Needed for UEFI and modern features.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating new GPT label on /dev/sdX ---"</span>
<span class="nb">sudo </span>parted /dev/sdX <span class="nt">--script</span> <span class="nt">--</span> mklabel gpt
</code></section></div>    </div>
  </li>
  <li><strong>Create EFI System Partition (ESP):</strong> FAT32, ~1GB. The UEFI firmware identifies this via the <code class="language-plaintext highlighter-rouge">boot</code> and <code class="language-plaintext highlighter-rouge">esp</code> flags to find bootloaders.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating ESP partition (1) on /dev/sdX ---"</span>
<span class="nb">sudo </span>parted /dev/sdX <span class="nt">--script</span> <span class="nt">--</span> mkpart <span class="s2">"sbnb-esp"</span> fat32 1MiB 1025MiB
<span class="nb">sudo </span>parted /dev/sdX <span class="nt">--script</span> <span class="nt">--</span> <span class="nb">set </span>1 boot on
<span class="nb">sudo </span>parted /dev/sdX <span class="nt">--script</span> <span class="nt">--</span> <span class="nb">set </span>1 esp on
</code></section></div>    </div>
  </li>
  <li><strong>Create Linux Data Partition:</strong> Uses remaining space. Standard Linux filesystem type (ID <code class="language-plaintext highlighter-rouge">8300</code>).
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating Linux data partition (2) on /dev/sdX ---"</span>
<span class="nb">sudo </span>parted /dev/sdX <span class="nt">--script</span> <span class="nt">--</span> mkpart <span class="s2">"sbnb-data"</span> ext4 1025MiB 100%
</code></section></div>    </div>
  </li>
  <li><strong>Verify Partitioning:</strong> Check layout, types, flags, sizes.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Verifying partitions on /dev/sdX ---"</span>
<span class="nb">sudo </span>parted /dev/sdX <span class="nt">--script</span> <span class="nt">--</span> print
<span class="nb">echo</span> <span class="s2">"--- Block device view: ---"</span>
lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,PARTLABEL,MOUNTPOINT,PARTFLAGS /dev/sdX
<span class="c"># Expect /dev/sdX1: ~1G, Type EFI System, PARTFLAGS includes 'boot', 'esp'</span>
<span class="c"># Expect /dev/sdX2: remaining size, Type Linux</span>
<span class="c"># Graphical tools should show a small FAT32 partition flagged boot/esp, and a larger second partition.</span>
</code></section></div>    </div>
  </li>
</ol>
  <h3 id="phase-3-format-filesystems">
    
    
     <a href="#phase-3-format-filesystems">#</a><a href="#" aria-label="Back to top">Phase 3: Format Filesystems</a>
        
    
  </h3>
      

<ol>
  <li><strong>Format EFI Partition (with <code class="language-plaintext highlighter-rouge">sbnb</code> label):</strong> <strong>CRITICAL LABEL!</strong> <code class="language-plaintext highlighter-rouge">mkfs.vfat</code> creates FAT32. <code class="language-plaintext highlighter-rouge">-n sbnb</code> sets the label checked by <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Formatting ESP partition (/dev/sdX1) as FAT32 with label 'sbnb' ---"</span>
<span class="nb">sudo </span>mkfs.vfat <span class="nt">-F</span> 32 <span class="nt">-n</span> sbnb /dev/sdX1
<span class="c"># (Optional but recommended) Check filesystem integrity before use.</span>
<span class="nb">echo</span> <span class="s2">"--- Checking ESP filesystem (fsck.vfat) ---"</span>
<span class="nb">sudo </span>fsck.vfat <span class="nt">-a</span> /dev/sdX1
<span class="c"># Check fsck exit code (0 = OK, non-zero = errors found/uncorrected)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="s2">"WARNING: fsck found errors on ESP partition!"</span><span class="p">;</span> <span class="k">fi</span>
<span class="c"># Verify label using blkid (reads filesystem metadata)</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying ESP label ---"</span>
<span class="nb">sudo </span>blkid /dev/sdX1 <span class="c"># Output MUST include LABEL="sbnb"</span>
</code></section></div>    </div>
  </li>
  <li><strong>Format Data Partition:</strong> <code class="language-plaintext highlighter-rouge">mkfs.ext4</code> creates ext4. <code class="language-plaintext highlighter-rouge">-L DATA_LABEL</code> aids identification. <code class="language-plaintext highlighter-rouge">-m 0</code> maximizes space. Ext4 journaling helps data integrity on unclean shutdown. (Note: F2FS is another option sometimes recommended for flash, but requires Sbnb kernel/tools support and different <code class="language-plaintext highlighter-rouge">mkfs.f2fs</code> command).
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nv">DATA_PARTITION</span><span class="o">=</span><span class="s2">"/dev/sdX2"</span>
<span class="nv">DATA_LABEL</span><span class="o">=</span><span class="s2">"SBNB_DATA"</span>
<span class="nb">echo</span> <span class="s2">"--- Formatting Data partition (</span><span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span><span class="s2">) as ext4 with label '</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">' ---"</span>
<span class="nb">sudo </span>mkfs.ext4 <span class="nt">-m</span> 0 <span class="nt">-L</span> <span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span> <span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span>
<span class="c"># (Optional but recommended) Check the new ext4 filesystem integrity.</span>
<span class="nb">echo</span> <span class="s2">"--- Checking Data partition filesystem (e2fsck) ---"</span>
<span class="nb">sudo </span>e2fsck <span class="nt">-f</span> <span class="nt">-y</span> <span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span> <span class="c"># -f forces check, -y assumes yes</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="s2">"WARNING: e2fsck found errors on Data partition!"</span><span class="p">;</span> <span class="k">fi</span>
<span class="c"># Verify the label using blkid</span>
<span class="nb">echo</span> <span class="s2">"--- Verifying Data partition label ---"</span>
<span class="nb">sudo </span>blkid <span class="k">${</span><span class="nv">DATA_PARTITION</span><span class="k">}</span> <span class="c"># Output should include LABEL="SBNB_DATA" and TYPE="ext4"</span>
</code></section></div>    </div>
  </li>
</ol>
  <h3 id="phase-4-install-sbnb-boot-files-and-configuration">
    
    
     <a href="#phase-4-install-sbnb-boot-files-and-configuration">#</a><a href="#" aria-label="Back to top">Phase 4: Install Sbnb Boot Files and Configuration</a>
        
    
  </h3>
      

<ol>
  <li><strong>Mount EFI Partition:</strong> Access the ESP filesystem.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Mounting ESP partition ---"</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /mnt/sbnb-mount
<span class="nb">sudo </span>mount /dev/sdX1 /mnt/sbnb-mount
</code></section></div>    </div>
  </li>
  <li><strong>Create EFI Boot Directory:</strong> Standard UEFI fallback path.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating EFI boot directories ---"</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /mnt/sbnb-mount/EFI/BOOT
</code></section></div>    </div>
  </li>
  <li><strong>Copy Sbnb EFI Boot File:</strong> Place the bootloader (<code class="language-plaintext highlighter-rouge">sbnb.efi</code> as <code class="language-plaintext highlighter-rouge">BOOTX64.EFI</code>).
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Copying Sbnb EFI boot file ---"</span>
<span class="nb">sudo cp </span>sbnb.efi /mnt/sbnb-mount/EFI/BOOT/BOOTX64.EFI
</code></section></div>    </div>
  </li>
  <li><strong>(Recommended) Create Sbnb Configuration File:</strong> Place <code class="language-plaintext highlighter-rouge">sbnb-tskey.txt</code> in ESP root (<code class="language-plaintext highlighter-rouge">/mnt/sbnb-mount/</code>). The <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code> script reads this to configure Tailscale.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Creating Sbnb configuration file (sbnb-tskey.txt) ---"</span>
<span class="nb">echo</span> <span class="s2">"SBNB_TAILSCALE_KEY=tskey-auth-..."</span> | <span class="nb">sudo tee</span> /mnt/sbnb-mount/sbnb-tskey.txt <span class="o">&gt;</span> /dev/null
</code></section></div>    </div>
  </li>
  <li><strong>(Crucial) Handle Data Partition Mounting via <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code>:</strong>
    <ul>
      <li><strong>Context &amp; Goal:</strong> Sbnb boots -&gt; systemd -&gt; <code class="language-plaintext highlighter-rouge">sbnb.service</code> -&gt; <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code> -&gt; mounts ESP to <code class="language-plaintext highlighter-rouge">/mnt/sbnb</code> -&gt; executes <code class="language-plaintext highlighter-rouge">/mnt/sbnb/sbnb-cmds.sh</code>. This script mounts the data partition (labeled <code class="language-plaintext highlighter-rouge">SBNB_DATA</code>) to <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code>.</li>
      <li><strong>Device Detection Timing:</strong> There’s a potential race: the kernel/udev might not have created the <code class="language-plaintext highlighter-rouge">/dev/disk/by-label/SBNB_DATA</code> symlink or the <code class="language-plaintext highlighter-rouge">/dev/sdX2</code> node exactly when the script runs. The wait loop mitigates this.</li>
      <li><strong>Default Script Conflict Uncertainty:</strong> The <code class="language-plaintext highlighter-rouge">boot-sbnb.sh</code> excerpt doesn’t show conflicting actions at its execution point. However, other early boot mechanisms could exist in Sbnb. If <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> behaves unexpectedly, investigate potential early boot scripts/services related to storage in your Sbnb version (advanced).</li>
      <li><strong><code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> Script (Wait Loop &amp; Logging):</strong> Create this in the ESP root (<code class="language-plaintext highlighter-rouge">/mnt/sbnb-mount/</code> during prep).
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  <span class="c">#!/bin/sh</span>
  <span class="c"># Custom sbnb-cmds.sh for USB Persistent Partition setup (No LVM)</span>
  <span class="c"># Mounts partition labeled DATA_LABEL to MOUNT_POINT after waiting for device.</span>
  <span class="c"># For debugging, uncomment 'set -x' to trace command execution.</span>
  <span class="c"># set -x</span>

  <span class="c"># Function to log messages consistently to kernel buffer (dmesg) and console (tty)</span>
  log_msg<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"sbnb-cmds.sh: </span><span class="nv">$1</span><span class="s2">"</span> | <span class="nb">tee</span> /dev/kmsg
  <span class="o">}</span>

  log_msg <span class="s2">"--- Running Custom USB Partition Mount Script ---"</span>

  <span class="c"># --- Configuration ---</span>
  <span class="nv">MOUNT_POINT</span><span class="o">=</span><span class="s2">"/mnt/sbnb-data"</span>  <span class="c"># Target directory for persistent data</span>
  <span class="nv">DATA_LABEL</span><span class="o">=</span><span class="s2">"SBNB_DATA"</span>        <span class="c"># Filesystem label of the data partition (MUST match mkfs.ext4 -L)</span>
  <span class="c"># Alternative: Use UUID for potentially more stable identification if labels change/conflict</span>
  <span class="c"># Get UUID using 'sudo blkid /dev/sdX2' on prep machine, then set:</span>
  <span class="c"># DATA_UUID="YOUR-UUID-HERE"</span>
  <span class="nv">MAX_WAIT_SECONDS</span><span class="o">=</span>15           <span class="c"># Max time (seconds) to wait for the device node/label</span>
  <span class="nv">WAIT_INTERVAL</span><span class="o">=</span>1               <span class="c"># Check frequency (seconds)</span>
  <span class="nv">MOUNT_OPTS</span><span class="o">=</span><span class="s2">"defaults,noatime,nodiratime"</span> <span class="c"># Mount options (noatime/nodiratime reduce writes on flash)</span>
  <span class="c"># --- End Configuration ---</span>

  <span class="nv">DATA_DEVICE</span><span class="o">=</span><span class="s2">""</span>                <span class="c"># Will hold the found device path</span>

  <span class="c"># --- Wait Loop for Device ---</span>
  <span class="c"># Attempts to find the device by label or UUID (if configured).</span>
  <span class="c"># Waits because device node creation by kernel/udev might be delayed.</span>
  <span class="nv">elapsed_wait</span><span class="o">=</span>0
  log_msg <span class="s2">"Waiting up to </span><span class="k">${</span><span class="nv">MAX_WAIT_SECONDS</span><span class="k">}</span><span class="s2">s for device (Label: </span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">:-</span><span class="nv">N</span><span class="p">/A</span><span class="k">}</span><span class="s2">)..."</span>
  <span class="k">while</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$DATA_DEVICE</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$elapsed_wait</span> <span class="nt">-lt</span> <span class="nv">$MAX_WAIT_SECONDS</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="c"># Check for device using the label symlink first (usually faster if udev ran)</span>
    <span class="nv">label_path</span><span class="o">=</span><span class="s2">"/dev/disk/by-label/</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$label_path</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c"># Readlink -f resolves the symlink to the actual device path (e.g., /dev/sdb2)</span>
        <span class="nv">DATA_DEVICE</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$label_path</span><span class="s2">"</span><span class="si">)</span>
        log_msg <span class="s2">"Found device via label symlink: </span><span class="nv">$label_path</span><span class="s2"> -&gt; </span><span class="nv">$DATA_DEVICE</span><span class="s2">"</span>
        <span class="nb">break</span> <span class="c"># Exit loop</span>
    <span class="k">fi</span>

    <span class="c"># Fallback: Use blkid command to scan for the label (can be slower)</span>
    <span class="nv">blkid_device</span><span class="o">=</span><span class="si">$(</span>blkid <span class="nt">-L</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">}</span><span class="s2">"</span> 2&gt;/dev/null<span class="si">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$blkid_device</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">DATA_DEVICE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$blkid_device</span><span class="s2">"</span>
        log_msg <span class="s2">"Found device via blkid label lookup: </span><span class="nv">$DATA_DEVICE</span><span class="s2">"</span>
        <span class="nb">break</span> <span class="c"># Exit loop</span>
    <span class="k">fi</span>

    <span class="c"># (Add similar checks here using DATA_UUID if using UUID instead of Label)</span>

    <span class="c"># Device not found yet, wait before next check</span>
    <span class="nb">sleep</span> <span class="nv">$WAIT_INTERVAL</span>
    <span class="nv">elapsed_wait</span><span class="o">=</span><span class="k">$((</span>elapsed_wait <span class="o">+</span> WAIT_INTERVAL<span class="k">))</span>
  <span class="k">done</span>

  <span class="c"># --- Mount Logic ---</span>
  <span class="c"># Proceed only if a device path was successfully determined</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$DATA_DEVICE</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$DATA_DEVICE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>log_msg <span class="s2">"Data partition device resolved to </span><span class="k">${</span><span class="nv">DATA_DEVICE</span><span class="k">}</span><span class="s2"> after </span><span class="k">${</span><span class="nv">elapsed_wait</span><span class="k">}</span><span class="s2">s."</span>

    <span class="c"># Check if the target directory is already a mount point</span>
    <span class="k">if</span> <span class="o">!</span> mountpoint <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$MOUNT_POINT</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
      </span>log_msg <span class="s2">"Attempting to mount </span><span class="nv">$DATA_DEVICE</span><span class="s2"> at </span><span class="nv">$MOUNT_POINT</span><span class="s2"> with options: </span><span class="nv">$MOUNT_OPTS</span><span class="s2">..."</span>
      <span class="c"># Ensure the target directory exists</span>
      <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$MOUNT_POINT</span><span class="s2">"</span>
      <span class="c"># Mount the device</span>
      <span class="k">if </span>mount <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$MOUNT_OPTS</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$DATA_DEVICE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$MOUNT_POINT</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
        </span>log_msg <span class="s2">"Successfully mounted persistent partition at </span><span class="nv">$MOUNT_POINT</span><span class="s2">."</span>
      <span class="k">else
        </span><span class="nv">mount_exit_code</span><span class="o">=</span><span class="nv">$?</span>
        log_msg <span class="s2">"ERROR: Failed to mount </span><span class="nv">$DATA_DEVICE</span><span class="s2"> at </span><span class="nv">$MOUNT_POINT</span><span class="s2"> (exit code: </span><span class="nv">$mount_exit_code</span><span class="s2">). Check filesystem type/integrity (run fsck?). See dmesg for details."</span> <span class="o">&gt;</span>&amp;2
      <span class="k">fi
    else</span>
      <span class="c"># Mount point exists, verify if it's the correct device</span>
      log_msg <span class="s2">"</span><span class="nv">$MOUNT_POINT</span><span class="s2"> is already a mount point. Checking device..."</span>
      <span class="c"># Check /proc/mounts for the currently mounted device at MOUNT_POINT</span>
      <span class="k">if </span><span class="nb">grep</span> <span class="nt">-qs</span> <span class="s2">"</span><span class="nv">$DATA_DEVICE</span><span class="s2"> </span><span class="nv">$MOUNT_POINT</span><span class="s2">"</span> /proc/mounts<span class="p">;</span> <span class="k">then
            </span>log_msg <span class="s2">"Persistent partition already correctly mounted at </span><span class="nv">$MOUNT_POINT</span><span class="s2">."</span>
      <span class="k">else
            </span><span class="nv">mounted_dev</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$MOUNT_POINT</span><span class="s2">"</span> /proc/mounts | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>
            log_msg <span class="s2">"ERROR: </span><span class="nv">$MOUNT_POINT</span><span class="s2"> is already mounted, but by '</span><span class="nv">$mounted_dev</span><span class="s2">' NOT '</span><span class="nv">$DATA_DEVICE</span><span class="s2">'! Check system configuration."</span> <span class="o">&gt;</span>&amp;2
      <span class="k">fi
    fi
  else</span>
    <span class="c"># Device wasn't found within the timeout</span>
    log_msg <span class="s2">"ERROR: Data partition device (Label: </span><span class="k">${</span><span class="nv">DATA_LABEL</span><span class="k">:-</span><span class="nv">N</span><span class="p">/A</span><span class="k">}</span><span class="s2">) not found after waiting </span><span class="k">${</span><span class="nv">MAX_WAIT_SECONDS</span><span class="k">}</span><span class="s2">s. Cannot mount persistent storage."</span> <span class="o">&gt;</span>&amp;2
  <span class="k">fi

  </span>log_msg <span class="s2">"--- Finished Custom USB Partition Mount Script ---"</span>
  <span class="c"># Exit 0 ensures the rest of the Sbnb boot sequence continues</span>
  <span class="nb">exit </span>0
</code></section></div>        </div>
      </li>
      <li>Place script content into <code class="language-plaintext highlighter-rouge">/mnt/sbnb-mount/sbnb-cmds.sh</code>.</li>
      <li>Make executable: <code class="language-plaintext highlighter-rouge">sudo chmod +x /mnt/sbnb-mount/sbnb-cmds.sh</code>.</li>
    </ul>
  </li>
  <li><strong>Unmount the EFI Partition:</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code><span class="nb">echo</span> <span class="s2">"--- Unmounting ESP partition ---"</span>
<span class="c"># Ensure buffers are flushed before unmounting</span>
<span class="nb">sync
sudo </span>umount /mnt/sbnb-mount
</code></section></div>    </div>
  </li>
</ol>
  <h3 id="phase-45-backing-up-data-critical">
    
    
     <a href="#phase-45-backing-up-data-critical">#</a><a href="#" aria-label="Back to top">Phase 4.5: Backing Up Data (CRITICAL!)</a>
        
    
  </h3>
      

<ul>
  <li><strong>Why Essential:</strong> High risk of USB drive failure. Backups are mandatory.</li>
  <li><strong>Strategy:</strong> Automate regular backups of <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code>.</li>
  <li><strong>File Data Backup (<code class="language-plaintext highlighter-rouge">rsync</code>):</strong> Ensure the backup destination (NAS, cloud, another server) has sufficient free space.
    <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  <span class="c"># Example: From Sbnb to backup-server (requires ssh key auth)</span>
  rsync <span class="nt">-avz</span> <span class="nt">--delete</span> <span class="nt">--progress</span> <span class="nt">--human-readable</span> /mnt/sbnb-data/ user@backup-server:/path/to/backups/sbnb-usb-data/
</code></section></div>    </div>
  </li>
  <li><strong>Frequency:</strong> Daily recommended for active data.</li>
  <li><strong>Automation:</strong> Use cron/systemd timers or remote triggers.</li>
  <li><strong>Testing Restores:</strong> Vital! Don’t assume backups work.
    <ul>
      <li><strong>Conceptual Restore:</strong> Boot Linux Live env -&gt; Mount backup source -&gt; Mount target USB data partition (new/reformatted) to <code class="language-plaintext highlighter-rouge">/mnt/restore</code> -&gt; <code class="language-plaintext highlighter-rouge">sudo rsync -av --progress /path/to/backup/sbnb-usb-data/ /mnt/restore/</code> -&gt; Verify restored files (count, size, checksums, spot checks).</li>
    </ul>
  </li>
  <li><strong>Verification:</strong> Use tools like <code class="language-plaintext highlighter-rouge">diff -r</code>, <code class="language-plaintext highlighter-rouge">md5sum</code>, or <code class="language-plaintext highlighter-rouge">sha256sum</code> to compare restored files against originals or known good copies.</li>
  <li><em>Untested backups provide a false sense of security.</em></li>
</ul>
  <h3 id="phase-5-boot-and-verify">
    
    
     <a href="#phase-5-boot-and-verify">#</a><a href="#" aria-label="Back to top">Phase 5: Boot and Verify</a>
        
    
  </h3>
      

<ol>
  <li><strong>Safely Eject:</strong> Eject USB from prep system.</li>
  <li><strong>Configure Server BIOS/UEFI:</strong> Enter setup (DEL, F2, F10, F12, etc.). Ensure UEFI Mode ON, CSM/Legacy OFF, Secure Boot OFF. Set “UEFI: USB…” as first boot device. Save &amp; Exit.</li>
  <li><strong>Boot Sbnb Linux.</strong></li>
  <li><strong>Verify Operation:</strong>
    <ul>
      <li>Monitor Boot: Watch console for <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> logs, errors.</li>
      <li>SSH into Sbnb.</li>
      <li>Check Mounts:
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  lsblk <span class="nt">-o</span> NAME,SIZE,TYPE,FSTYPE,LABEL,MOUNTPOINT <span class="c"># Look for mount at /mnt/sbnb-data</span>
  <span class="nb">df</span> <span class="nt">-hT</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'Filesystem|/mnt/sbnb-data'</span>     <span class="c"># Check usage/type</span>
  mount | <span class="nb">grep</span> /mnt/sbnb-data                      <span class="c"># Check mount options (rw, noatime)</span>
  findmnt /mnt/sbnb-data                           <span class="c"># Another way to check mount info</span>
</code></section></div>        </div>
      </li>
      <li>Test Persistence:
        <div class="language-bash highlighter-rouge"><div class="highlight"><section><code>  <span class="c"># After SSHing in:</span>
  <span class="nv">TIMESTAMP</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span>
  <span class="nb">echo</span> <span class="s2">"Sbnb USB Persistence test - </span><span class="nv">$TIMESTAMP</span><span class="s2">"</span> | <span class="nb">sudo tee</span> /mnt/sbnb-data/persistence_test.txt <span class="o">&gt;</span> /dev/null
  <span class="nb">sync</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Synced data to disk."</span>
  <span class="nb">echo</span> <span class="s2">"File created. Content:"</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo cat</span> /mnt/sbnb-data/persistence_test.txt
  <span class="nb">echo</span> <span class="s2">"Rebooting server now..."</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>reboot

  <span class="c"># --- Wait for reboot and reconnect via SSH ---</span>
  <span class="nb">echo</span> <span class="s2">"Checking for file after reboot..."</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> /mnt/sbnb-data/persistence_test.txt <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"SUCCESS: File found. Content:"</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo cat</span> /mnt/sbnb-data/persistence_test.txt
    <span class="nb">sudo rm</span> /mnt/sbnb-data/persistence_test.txt <span class="c"># Clean up</span>
  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"FAILURE: File NOT FOUND after reboot! Persistence failed."</span>
  <span class="k">fi</span>
</code></section></div>        </div>
      </li>
    </ul>
  </li>
</ol>
  <h2 id="troubleshooting">
    
    
     <a href="#troubleshooting">#</a><a href="#" aria-label="Back to top">Troubleshooting</a>
        
    
  </h2>
      

<ul>
  <li><strong>Doesn’t Boot / No Bootable Device:</strong>
    <ul>
      <li>Re-verify BIOS settings (UEFI, Secure Boot OFF, Boot Order).</li>
      <li>Re-verify USB Prep: Partitions (<code class="language-plaintext highlighter-rouge">parted print</code>), ESP flags (<code class="language-plaintext highlighter-rouge">boot</code>,<code class="language-plaintext highlighter-rouge">esp</code>), ESP filesystem label (<code class="language-plaintext highlighter-rouge">blkid /dev/sdX1</code> -&gt; <code class="language-plaintext highlighter-rouge">LABEL="sbnb"</code>), EFI file path (<code class="language-plaintext highlighter-rouge">/EFI/BOOT/BOOTX64.EFI</code>).</li>
      <li>Try different USB ports (check if port provides sufficient power). Test drive health on prep machine (<code class="language-plaintext highlighter-rouge">fsck</code>, <code class="language-plaintext highlighter-rouge">badblocks -nvs /dev/sdX</code>). Recreate drive meticulously.</li>
    </ul>
  </li>
  <li><strong>Data Partition Not Mounted / <code class="language-plaintext highlighter-rouge">/mnt/sbnb-data</code> Empty:</strong>
    <ul>
      <li>Check boot logs (<code class="language-plaintext highlighter-rouge">journalctl -b</code>, console) for <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> errors (“Device… not found”, “Failed to mount”). Check <code class="language-plaintext highlighter-rouge">dmesg</code> for USB errors (<code class="language-plaintext highlighter-rouge">dmesg | grep -iE 'usb|sdX'</code>) or filesystem errors (<code class="language-plaintext highlighter-rouge">dmesg | grep -i ext4</code>).</li>
      <li>SSH in:
        <ul>
          <li>Verify partition &amp; label: <code class="language-plaintext highlighter-rouge">sudo blkid</code>, <code class="language-plaintext highlighter-rouge">ls -l /dev/disk/by-label/</code>. Is <code class="language-plaintext highlighter-rouge">SBNB_DATA</code> present? Does it point to the correct device?</li>
          <li>If label wrong/missing: Re-label from prep env (<code class="language-plaintext highlighter-rouge">sudo e2label /dev/sdX2 SBNB_DATA</code>).</li>
          <li>If device/label exists, try manual mount: <code class="language-plaintext highlighter-rouge">sudo mkdir -p /mnt/sbnb-data &amp;&amp; sudo mount /dev/disk/by-label/SBNB_DATA /mnt/sbnb-data</code>. Check <code class="language-plaintext highlighter-rouge">dmesg</code> for errors (e.g., <code class="language-plaintext highlighter-rouge">mount: wrong fs type, bad option, bad superblock</code>). If manual mount works, debug <code class="language-plaintext highlighter-rouge">sbnb-cmds.sh</code> (add <code class="language-plaintext highlighter-rouge">set -x</code>, check paths, loop duration, check script permissions <code class="language-plaintext highlighter-rouge">ls -l /mnt/sbnb/sbnb-cmds.sh</code>).</li>
          <li>Run filesystem check (unmounted): <code class="language-plaintext highlighter-rouge">sudo e2fsck -f /dev/disk/by-label/SBNB_DATA</code>.</li>
          <li>Check kernel modules: <code class="language-plaintext highlighter-rouge">lsmod | grep ext4</code>. Is the module loaded? Check <code class="language-plaintext highlighter-rouge">dmesg</code> for errors loading filesystem modules.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Poor Performance / Drive Failure:</strong>
    <ul>
      <li><strong>Performance:</strong> Inherent limitation.</li>
      <li><strong>Lifespan/Failure:</strong> Monitor <code class="language-plaintext highlighter-rouge">dmesg</code> for I/O errors. Restore from verified backups upon failure. This setup will wear out consumer flash drives with persistent writes.</li>
    </ul>
  </li>
</ul>
  <h2 id="final-recommendation">
    
    
     <a href="#final-recommendation">#</a><a href="#" aria-label="Back to top">Final Recommendation</a>
        
    
  </h2>
      

<p>This guide details a complex, non-standard configuration fraught with performance and reliability risks. While it provides a technically feasible path for single-drive boot and persistence under specific constraints, users should strongly prefer the standard Sbnb architecture using reliable internal server storage whenever possible. Evaluate the trade-offs carefully before committing to this approach.</p>

        </div>
        
          URL: https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage
        
      </article>
      <nav class="post-navigation-combined" aria-label="Post navigation">
        <!-- Chronological Navigation (always visible at 40vh) -->
        
          <div class="nav-arrow chronological prev">
            <a href="/to-enable-video-acceleration-on-rpi4/" title="to enable video acceleration on RPI4" rel="prev">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
        
          <div class="nav-arrow chronological next">
            <a href="/images-to-searchable-pdf/" title="Images to Searchable PDF" rel="next">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next article" width="45" height="45" loading="lazy">
            </a>
          </div>
        
            
            
              
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  
                  
              
              
              
              <!-- Navigation block for tag "scratchpad"; default display for the first tag -->
              <div class="nav-group tags" id="tag-nav-scratchpad" style="display: block;">
                <div class="nav-arrow tags prev">
                  
                    <a href="/aot-3/" title="AoT 3" rel="prev">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ+lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
                <div class="nav-arrow tags next">
                  
                    <a href="/onetabbak/" title="oneTAB.bak" rel="next">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAwdJREFUaEPtl01rG1cUht9z7p070ijKWLVS3I9YULtNMBRn2UIXxZtuvCjedNWfoKVXBvsHeOUfoIUx5AeY0pVXXSR052UxBJSi0kDiRplII83HvadI9CMtOFjCmBjubC7cc8+Zc555eYdLuIEP3cCe4Zu+rq/mSXvSbyHg5eHl4eVxXRrwpD3p+Qh4n56P2+xZnvTszC7MCAAUF0XfOdJa62+IaCeO40GSJA/zPP8RwB9vDjBtWmv9JRE5ImpZawdVpbo58CkAIyJnIrLAzEvOuXNm/h3AfQDOAGdj5z5m5gXn3G9ENCKilckaiDwpiFZEpCoiTyYrM3/knOtXmHs58BkABvCLc+4DZl6cxIjoh4ODA728vIzt7W2sra09PT4+fgTgQES4LMvHZIy5LyI/f/dJvfK6FKMJqAdqmBS2ZgWINY9zJyZ1whUiRJrTfmGjybSxUemwcFEmghqT1UxlUrpQEXD7jRq3NWelEz10okIi1AJOX+U2EgALgUrT0kVnmcKvQ+uazSZvbW2hWq2i3++j3W5jf38f6+vrebvdHovI5pT09+vN7teLYev990K8GpQYjS1u1TQqhnHez6EU4cM7FTw7z5AXDo16ACcyPRsaxp2FEM9ejKd7zUaIYVpiOCpRq2rUIo0XLzMwEZaaFTzvZ8hyh/iWnu69fF1AAoOfFr/A5w8eYDQaIY5jJEmC09NTNBoNdLtd7O3t4ejoCIeHh8k/pL8KUSkCZcg6hCLDjLk2ufYGpRuXAuOMYiosQiDNNEcQILQuzYgi0QxVWKuAMtcqJPdXDaKaMMOUNrOAtoFSVE5jaaY4mtQPS5dmQPS8WkdfGReYgDe/3cTdpbvo9XrY2NhAp9NBq9XKO53Ov6T/r2mlVBeX0DSAMzeHppm5h7doemdvR99buYfd3V2srq4+PTk5+a+mr9CmrqTU3+5Rr9cHg8HgYve4krddbZGb5dOXmf2d+7n4pi9D4LrOeHl40v42fl0a8KQ96fkIeJ+ej9vsWZ707Mzmy/Ck5+M2e9afhmuAz1BhwewAAAAASUVORK5CYII=" alt="Next in Tag" width="45" height="45" loading="lazy">
                    </a>
                  
                </div>
              </div>
            
          
          <!-- JavaScript to Toggle the Tag-based Navigation -->
          <script>
            document.addEventListener("DOMContentLoaded", function(){
              var tagLinks = document.querySelectorAll('.tag-option');
              tagLinks.forEach(function(link){
                link.addEventListener('click', function(event){
                  event.preventDefault();
                  // Remove "active" class from all tag options.
                  tagLinks.forEach(function(el){ el.classList.remove('active'); });
                  // Add active class to the clicked tag option.
                  this.classList.add('active');
                  // Hide all tag navigation blocks.
                  document.querySelectorAll('.nav-group.tags').forEach(function(block){
                    block.style.display = 'none';
                  });
                  // Show the navigation block corresponding to the selected tag.
                  var tagSlug = this.getAttribute('data-tag');
                  var target = document.getElementById('tag-nav-' + tagSlug);
                  if(target) {
                    target.style.display = 'block';
                  }
                });
              });
            });
          </script>
      </nav>
      
    </main>
    <footer id="bottom-of-page" class="site-footer">
      <div class="footer-content">
        <!-- Back to top link -->
        <a href="#" aria-label="Back to top" class="back2top-link">
          <span class="sronly">Back to top</span>
        </a>
    
        <!-- Liquid Time Calculation and Display -->
        
        
        
        <a href="https://ib.bsb.br/404" aria-label="404">
          2025-04-10 06:07:22
        </a>
        &#x23;
    
        <!-- Tag Selector -->
        <ul class="tag-selector">
          
            
            
              <li>
                <a href="#" class="tag-option active" data-tag="scratchpad">
                  scratchpad
                </a>
              </li>
            
          
        </ul>
        &hArr;
    
        <!-- GitHub Link -->
        <a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io" aria-label="GitHub">
          &#8505;
        </a>
    
        <!-- Homepage Link -->
        <a href="/" aria-label="Homepage">
          infoBAG
        </a>
    
        <!-- Copy All Code Button -->
        <button id="copyAllButton" aria-label="Copy all code">
          &copy;
        </button>
      </div>
    </footer>
    <style>
      .back2top-link {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: url("/assets/Rope_(Old).gif") center center no-repeat;
        background-size: contain;
        text-decoration: none;
        vertical-align: middle;
      }
      .sronly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://ib.bsb.br/single-usb-for-sbnb-boot-and-persistent-storage/"
        },
        "headline": "Single USB for Sbnb Boot and Persistent Storage",
        "description": "",
        "datePublished": "2025-04-07T00:00:00+00:00",
        "dateModified": "2025-04-07T14:04:23+00:00",
        "author": {
          "@type": "Person",
          "name": "Author"
        },
        "publisher": {
          "@type": "Organization",
          "name": "infoBAG"
          
        }
        
      }
    </script>
    <script src="/assets/js/prism.js" defer></script>
    <script src="/assets/js/copy-all-code.js"></script>
  </body>
</html>
