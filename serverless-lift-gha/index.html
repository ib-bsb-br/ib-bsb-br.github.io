<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    
      Github actions workflow dispatch + Webhooks using `Serverless.com` Lift plugin — infoBAG
    
  </title>
  <meta name="title" content="Github actions workflow dispatch + Webhooks using `Serverless.com` Lift plugin" />
  <meta name="description" content="can't steer unless already moving" />  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Github actions workflow dispatch + Webhooks using `Serverless.com` Lift plugin — infoBAG" />
  <meta property="og:description" content="can't steer unless already moving" />
  <meta property="og:url" content="https://ib.bsb.br/serverless-lift-gha/" />
  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="infoBAG" />
    
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Github actions workflow dispatch + Webhooks using `Serverless.com` Lift plugin — infoBAG">
  <meta name="twitter:description" content="can't steer unless already moving">
    
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://ib.bsb.br/serverless-lift-gha/"
    },
    "headline": "Github actions workflow dispatch + Webhooks using `Serverless.com` Lift plugin",
    "description": "",
    "datePublished": "2024-10-18T00:00:00+00:00",
    "dateModified": "2024-10-18T15:49:28+00:00",
    "author": {
      "@type": "Person",
      "name": "Author"
    },
    "publisher": {
      "@type": "Organization",
      "name": "infoBAG",
      
    }
    
  }
  </script>  
  <link rel="canonical" href="https://ib.bsb.br/serverless-lift-gha/">
  <link rel="alternate" type="application/rss+xml" title="infoBAG" href="https://ib.bsb.br/rss.xml">  
  
    <meta name="keywords" content="scripts>cloud, tools>github">
    
      <meta property="article:tag" content="scripts>cloud, tools>github">
    
    
  <!-- Favicons and Icons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
  <link href="/style.css" rel="stylesheet">  
  <script src="/assets/js/prism.js" defer></script>
</head>
<body class="post-content-body">
  <header class="header-container">
    <nav aria-label="Main navigation" class="header-content">
      <a href="/" aria-label="Home">
        <img src="/favicon.ico" alt="Home" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>
      <a href="/tags" aria-label="Tags">
        <img src="/assets/Label.gif" alt="Tags" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>
      <a href="/events" aria-label="Events">
        <img src="/assets/Paralyse_Rune.gif" alt="Events" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>
      <a href="/archive" aria-label="Archive">
        <img src="/assets/Loose_Stone_Pile.gif" alt="Archive" class="favicon search-link" width="45" height="45" loading="lazy">
      </a>      
    </nav>
    <h1 class="post-title">Github actions workflow dispatch + Webhooks using `Serverless.com` Lift plugin</h1>
        <div class="post-meta">
          <time datetime="2024-10-18T00:00:00+00:00" class="post-date">
            18 Oct 2024</time>
          
            <span class="post-updated"> &rightarrowtail; <time datetime="2024-10-18T15:49:28+00:00">18 Oct 2024</time></span>
          
          
          <div class="post-info">
            Edit: aberto.
          </div>
          
          
          <div class="post-tags">
            Tags:
            
            <a href="https://ib.bsb.br/tags/#scripts-cloud-tools-github" class="tag">
              scripts>cloud, tools>github
            </a>
          
          
          </div>
          
          <div class="post-actions">
            <a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io/edit/main/_posts/2024-10-18-serverless-lift-gha.md" target="_blank" rel="noopener noreferrer" class="btn-primary">
              Improve this page
            </a>&hArr;<a href="https://github.com/ib-bsb-br/ib-bsb-br.github.io/commits/main/_posts/2024-10-18-serverless-lift-gha.md" target="_blank" rel="noopener noreferrer" class="btn-secondary">
              View revision history
            </a>
          </div>
        </div>
  </header>
  <main class="content">
    <article class="post-wrapper">      
      <div class="post-content">
        
<ul><li><a href="#overview">Overview:</a></li><li><a href="#integration-steps">Integration Steps:</a></li><li><a href="#updated-code">Updated Code</a></li><li><a href="#1-serverlessyml-configuration">1. <code class="language-plaintext highlighter-rouge">serverless.yml</code> Configuration:</a></li><li><a href="#2-handler-functions-handlermjs">2. Handler Functions (<code class="language-plaintext highlighter-rouge">handler.mjs</code>):</a></li><li><a href="#3-client-side-javascript-if-applicable">3. Client-Side JavaScript (If Applicable):</a></li><li><a href="#comprehensive-documentation">Comprehensive Documentation</a></li><li><a href="#changes-and-enhancements">Changes and Enhancements:</a></li><li><a href="#deployment-and-configuration-instructions">Deployment and Configuration Instructions:**</a></li><li><a href="#conclusion">Conclusion:</a></li><li><a href="#notes">Notes:</a></li><li><a href="#references">References:</a></li></ul>
        <h1 id="overview">
    
    
     <a href="#overview">#</a><a href="#" aria-label="Back to top">Overview:</a>
        
    
  </h1>
      

<p>The goal is to integrate functions and implementations from different approaches into the original AI ASSISTANT’s response, enhancing functionality, performance, and security while maintaining code integrity, coherence, and logic. The integration focuses on:</p>

<ul>
  <li>Improving the <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code> function with enhanced error handling and support for workflow inputs.</li>
  <li>Enhancing the <code class="language-plaintext highlighter-rouge">handleWebhook</code> function with better error management and logging.</li>
  <li>Optionally adding a separate <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> function to allow manual triggering of GitHub Actions workflows via an HTTP endpoint.</li>
  <li>Ensuring environment variables are correctly configured and securely used.</li>
  <li>Updating the <code class="language-plaintext highlighter-rouge">serverless.yml</code> configuration to reflect changes in functions and environment variables.</li>
  <li>Maintaining code cohesiveness and adhering to security best practices.</li>
</ul>
  <h1 id="integration-steps">
    
    
     <a href="#integration-steps">#</a><a href="#" aria-label="Back to top">Integration Steps:</a>
        
    
  </h1>
      

<ol>
  <li>
    <p><strong>Enhance <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code> Function:</strong></p>

    <ul>
      <li>Integrate the improved <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code> function from the first and second different approaches.</li>
      <li>Add an <code class="language-plaintext highlighter-rouge">inputs</code> parameter to allow passing inputs to the GitHub Actions workflow.</li>
      <li>Implement robust error handling by throwing errors that can be caught by calling functions.</li>
      <li>Ensure informative logging for both success and failure cases.</li>
    </ul>
  </li>
  <li>
    <p><strong>Update <code class="language-plaintext highlighter-rouge">handleWebhook</code> Function:</strong></p>

    <ul>
      <li>Incorporate enhanced error handling and logging from the different approaches.</li>
      <li>Catch errors from <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code> and handle them appropriately.</li>
      <li>Parse <code class="language-plaintext highlighter-rouge">inputs</code> from the request body or event to allow dynamic workflow configuration.</li>
      <li>Validate inputs to prevent security vulnerabilities.</li>
    </ul>
  </li>
  <li>
    <p><strong>Add <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> Function (Optional):</strong></p>

    <ul>
      <li>Include a new function <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> to enable manual triggering of workflows via an HTTP endpoint.</li>
      <li>Configure this function in <code class="language-plaintext highlighter-rouge">serverless.yml</code> with appropriate HTTP events and security settings.</li>
      <li>Ensure proper authentication and input validation in the function.</li>
    </ul>
  </li>
  <li>
    <p><strong>Refine Environment Variables:</strong></p>

    <ul>
      <li>Standardize environment variables by including <code class="language-plaintext highlighter-rouge">GITHUB_REPOSITORY</code>, <code class="language-plaintext highlighter-rouge">REPO_OWNER</code>, <code class="language-plaintext highlighter-rouge">REPO_NAME</code>, and <code class="language-plaintext highlighter-rouge">WORKFLOW_ID</code>.</li>
      <li>Use <code class="language-plaintext highlighter-rouge">GITHUB_REPOSITORY</code> to extract <code class="language-plaintext highlighter-rouge">REPO_OWNER</code> and <code class="language-plaintext highlighter-rouge">REPO_NAME</code> in the functions.</li>
      <li>Ensure sensitive variables like <code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code> are securely handled and not exposed client-side.</li>
    </ul>
  </li>
  <li>
    <p><strong>Update <code class="language-plaintext highlighter-rouge">serverless.yml</code> Configuration:</strong></p>

    <ul>
      <li>Include the new <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> function, if added, with appropriate HTTP events.</li>
      <li>Update environment variables and ensure they are correctly referenced in the functions.</li>
      <li>Adjust function configurations to align with best practices and enhance performance.</li>
    </ul>
  </li>
  <li>
    <p><strong>Improve Security:</strong></p>

    <ul>
      <li>Validate all inputs from events and requests to prevent injection attacks.</li>
      <li>Ensure error messages do not expose sensitive information.</li>
      <li>Keep all tokens and sensitive data on the server-side.</li>
    </ul>
  </li>
  <li>
    <p><strong>Optimize Performance and Code Quality:</strong></p>

    <ul>
      <li>Eliminate redundant code by reusing functions like <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code>.</li>
      <li>Use async/await patterns effectively to avoid blocking operations.</li>
      <li>Follow consistent coding conventions and add JSDoc comments for better maintainability.</li>
    </ul>
  </li>
  <li>
    <p><strong>Testing:</strong></p>

    <ul>
      <li>Although not executable here, the code should be thoroughly tested in a development environment.</li>
      <li>Test cases should cover successful paths, error handling, and edge cases.</li>
      <li>Security testing should be conducted to ensure no vulnerabilities are introduced.</li>
    </ul>
  </li>
  <li>
    <p><strong>Documentation:</strong></p>

    <ul>
      <li>Add comprehensive comments to the code explaining the functionality and any changes made.</li>
      <li>Update any existing documentation to reflect the new features and configurations.</li>
      <li>Provide clear instructions for deploying and configuring the application.</li>
    </ul>
  </li>
</ol><hr />
  <h1 id="updated-code">
    
    
     <a href="#updated-code">#</a><a href="#" aria-label="Back to top">Updated Code</a>
        
    
  </h1>
      
  <h1 id="1-serverlessyml-configuration">
    
    
     <a href="#1-serverlessyml-configuration">#</a><a href="#" aria-label="Back to top">1. <code class="language-plaintext highlighter-rouge">serverless.yml</code> Configuration:</a>
        
    
  </h1>
      

<section data-filename="yaml_code-block.yaml" data-code="service: github-webhook-service
provider:
name: aws
runtime: nodejs20.x
region: us-east-1
environment:
GITHUB_TOKEN: ${env:GITHUB_TOKEN} # Secure GitHub token for API authentication
GITHUB_REPOSITORY: your-github-username/your-repo-name # Format: owner/repo
WORKFLOW_ID: your-workflow-file.yml # Default workflow ID, can be overridden
plugins:
- serverless-lift
functions:
handleWebhook:
handler: handler.handleWebhook
events:
- http:
path: /webhook  # Webhook endpoint path
method: post
cors: true # Enable CORS for cross-origin requests
# Optional: Function to manually trigger GitHub workflows
triggerGithubWorkflow:
handler: handler.triggerGithubWorkflow
events:
- http:
path: /trigger_github_workflow
method: post
cors: true
constructs:
# If needed for other purposes
webhook:
type: webhook
# ... (rest of your construct definition)
package:
patterns:
- '!node_modules/aws-sdk/**'
- '!node_modules/@aws-sdk/**'" data-download-link="" data-download-link-label="Download Yaml"><code class="language-yaml">service: github-webhook-service
provider:
name: aws
runtime: nodejs20.x
region: us-east-1
environment:
GITHUB_TOKEN: ${env:GITHUB_TOKEN} # Secure GitHub token for API authentication
GITHUB_REPOSITORY: your-github-username/your-repo-name # Format: owner/repo
WORKFLOW_ID: your-workflow-file.yml # Default workflow ID, can be overridden
plugins:
- serverless-lift
functions:
handleWebhook:
handler: handler.handleWebhook
events:
- http:
path: /webhook  # Webhook endpoint path
method: post
cors: true # Enable CORS for cross-origin requests
# Optional: Function to manually trigger GitHub workflows
triggerGithubWorkflow:
handler: handler.triggerGithubWorkflow
events:
- http:
path: /trigger_github_workflow
method: post
cors: true
constructs:
# If needed for other purposes
webhook:
type: webhook
# ... (rest of your construct definition)
package:
patterns:
- '!node_modules/aws-sdk/**'
- '!node_modules/@aws-sdk/**'</code></section>
  <h1 id="2-handler-functions-handlermjs">
    
    
     <a href="#2-handler-functions-handlermjs">#</a><a href="#" aria-label="Back to top">2. Handler Functions (<code class="language-plaintext highlighter-rouge">handler.mjs</code>):</a>
        
    
  </h1>
      

<section data-filename="javascript_code-block.js" data-code="import { Octokit } from &quot;@octokit/rest&quot;;
import { Base64 } from &quot;js-base64&quot;;
/**
* Converts a string to a URL-friendly slug.
* @param {string} text - The text to slugify.
* @return {string} Slugified text.
*/
const slugify = (text) =&gt; {
return text
.toString()
.toLowerCase()
.trim()
.replace(/\s+/g, '-')       // Replace spaces with -
.replace(/[^\w\-]+/g, '')   // Remove all non-word chars
.replace(/\-\-+/g, '-')     // Replace multiple - with single -
.replace(/^-+/, '')         // Trim - from start of text
.replace(/-+$/, '');        // Trim - from end of text
};
/**
* Formats a date string to YYYY-MM-DD.
* @param {string|Date} date - The date to format.
* @return {string} Formatted date string.
*/
const formatDate = (date) =&gt; {
const d = new Date(date);
if (isNaN(d.getTime())) {
throw new Error('Invalid date provided');
}
return d.toISOString().split('T')[0];
};
/**
* Creates the content for a blog post in Markdown format.
* @param {Object} data - Data for the blog post.
* @param {string} data.by_nickname - Author's nickname.
* @param {string} data.by_email - Author's email.
* @param {string} data.content - Post content.
* @param {string|Date} data.time - Timestamp of the post.
* @return {string} Formatted blog post content.
*/
const createPostContent = (data) =&gt; {
const { by_nickname, by_email, content, time } = data;
const slugName = slugify(by_nickname);
const date = formatDate(time);
return `---
tags:
- ${by_email}
info: aberto.
date: ${date}
type: post
layout: post
published: true
slug: ${slugName}
title: '${by_nickname}'
---
${content}`;
};
/**
* Triggers a GitHub Actions workflow using workflow_dispatch.
* @param {Octokit} octokit - Authenticated Octokit instance.
* @param {string} owner - Repository owner.
* @param {string} repo - Repository name.
* @param {string} ref - Git reference (branch or tag).
* @param {string} workflowId - Workflow file name or ID.
* @param {Object} inputs - Inputs for the workflow.
*/
const triggerWorkflowDispatch = async (octokit, owner, repo, ref, workflowId, inputs = {}) =&gt; {
try {
const response = await octokit.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
owner,
repo,
workflow_id: workflowId,
ref,
inputs,
});
if (response.status !== 204) {
throw new Error(`Failed to dispatch workflow. GitHub API status: ${response.status}`);
}
console.log(`Workflow '${workflowId}' dispatched successfully on ${repo}`);
return response.data;
} catch (error) {
console.error('Error dispatching workflow:', error);
throw error; // Re-throw to be caught in calling function
}
};
/**
* Handles incoming webhook events to create/update a blog post and trigger a workflow.
* @param {Object} event - Event data from AWS Lambda invocation.
* @return {Object} Response object with statusCode and body.
*/
export const handleWebhook = async (event) =&gt; {
try {
const body = event.body ? JSON.parse(event.body) : {};
const { inputs } = body; // Get inputs from request body if any
// Validate required environment variables
const githubToken = process.env.GITHUB_TOKEN;
const githubRepository = process.env.GITHUB_REPOSITORY;
const workflowId = process.env.WORKFLOW_ID;
if (!githubToken || !githubRepository || !workflowId) {
throw new Error('Missing required environment variables.');
}
const [owner, repo] = githubRepository.split('/');
const octokit = new Octokit({ auth: githubToken });
// Extract and validate data from the webhook event
const eventData = body || {};
const { by_nickname, by_email, content } = eventData;
const time = eventData.time || new Date().toISOString();
if (!by_email || !by_nickname || !content) {
throw new Error('Missing required fields: by_email, by_nickname, or content.');
}
// Create or update the blog post file in the repository
const date = formatDate(time);
const slugName = slugify(by_nickname);
const path = `_posts/${date}-${slugName}.md`;
const message = `New post by ${by_nickname}`;
const postContent = createPostContent({ by_nickname, by_email, content, time });
const contentEncoded = Base64.encode(postContent);
await octokit.repos.createOrUpdateFileContents({
owner,
repo,
path,
message,
content: contentEncoded,
});
// Dispatch the workflow
const ref = 'main'; // You can make this dynamic if needed
await triggerWorkflowDispatch(octokit, owner, repo, ref, workflowId, inputs);
return {
statusCode: 200,
body: JSON.stringify({ message: 'File created/updated and workflow triggered', path }),
};
} catch (error) {
console.error('Error in handleWebhook:', error);
return {
statusCode: error.status || 500,
body: JSON.stringify({ message: error.message || 'An unexpected error occurred.' }),
};
}
};
/**
* Optional function to manually trigger a GitHub Actions workflow via HTTP endpoint.
* @param {Object} event - Event data from AWS Lambda invocation.
* @return {Object} Response object with statusCode and body.
*/
export const triggerGithubWorkflow = async (event) =&gt; {
try {
const body = event.body ? JSON.parse(event.body) : {};
const { ref = 'main', workflow_id, inputs = {} } = body;
// Validate required environment variables
const githubToken = process.env.GITHUB_TOKEN;
const githubRepository = process.env.GITHUB_REPOSITORY;
if (!githubToken || !githubRepository) {
throw new Error('Missing required environment variables.');
}
const workflowId = workflow_id || process.env.WORKFLOW_ID;
if (!workflowId) {
throw new Error('Workflow ID is required.');
}
const [owner, repo] = githubRepository.split('/');
const octokit = new Octokit({ auth: githubToken });
// Dispatch the workflow
const response = await triggerWorkflowDispatch(octokit, owner, repo, ref, workflowId, inputs);
return {
statusCode: 200,
body: JSON.stringify({ message: 'Workflow dispatched successfully.', details: response }),
};
} catch (error) {
console.error('Error in triggerGithubWorkflow:', error);
return {
statusCode: error.status || 500,
body: JSON.stringify({ message: error.message || 'Failed to dispatch workflow.' }),
};
}
};" data-download-link="" data-download-link-label="Download Javascript"><code class="language-javascript">import { Octokit } from "@octokit/rest";
import { Base64 } from "js-base64";
/**
* Converts a string to a URL-friendly slug.
* @param {string} text - The text to slugify.
* @return {string} Slugified text.
*/
const slugify = (text) =&gt; {
return text
.toString()
.toLowerCase()
.trim()
.replace(/\s+/g, '-')       // Replace spaces with -
.replace(/[^\w\-]+/g, '')   // Remove all non-word chars
.replace(/\-\-+/g, '-')     // Replace multiple - with single -
.replace(/^-+/, '')         // Trim - from start of text
.replace(/-+$/, '');        // Trim - from end of text
};
/**
* Formats a date string to YYYY-MM-DD.
* @param {string|Date} date - The date to format.
* @return {string} Formatted date string.
*/
const formatDate = (date) =&gt; {
const d = new Date(date);
if (isNaN(d.getTime())) {
throw new Error('Invalid date provided');
}
return d.toISOString().split('T')[0];
};
/**
* Creates the content for a blog post in Markdown format.
* @param {Object} data - Data for the blog post.
* @param {string} data.by_nickname - Author's nickname.
* @param {string} data.by_email - Author's email.
* @param {string} data.content - Post content.
* @param {string|Date} data.time - Timestamp of the post.
* @return {string} Formatted blog post content.
*/
const createPostContent = (data) =&gt; {
const { by_nickname, by_email, content, time } = data;
const slugName = slugify(by_nickname);
const date = formatDate(time);
return `---
tags:
- ${by_email}
info: aberto.
date: ${date}
type: post
layout: post
published: true
slug: ${slugName}
title: '${by_nickname}'
---
${content}`;
};
/**
* Triggers a GitHub Actions workflow using workflow_dispatch.
* @param {Octokit} octokit - Authenticated Octokit instance.
* @param {string} owner - Repository owner.
* @param {string} repo - Repository name.
* @param {string} ref - Git reference (branch or tag).
* @param {string} workflowId - Workflow file name or ID.
* @param {Object} inputs - Inputs for the workflow.
*/
const triggerWorkflowDispatch = async (octokit, owner, repo, ref, workflowId, inputs = {}) =&gt; {
try {
const response = await octokit.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
owner,
repo,
workflow_id: workflowId,
ref,
inputs,
});
if (response.status !== 204) {
throw new Error(`Failed to dispatch workflow. GitHub API status: ${response.status}`);
}
console.log(`Workflow '${workflowId}' dispatched successfully on ${repo}`);
return response.data;
} catch (error) {
console.error('Error dispatching workflow:', error);
throw error; // Re-throw to be caught in calling function
}
};
/**
* Handles incoming webhook events to create/update a blog post and trigger a workflow.
* @param {Object} event - Event data from AWS Lambda invocation.
* @return {Object} Response object with statusCode and body.
*/
export const handleWebhook = async (event) =&gt; {
try {
const body = event.body ? JSON.parse(event.body) : {};
const { inputs } = body; // Get inputs from request body if any
// Validate required environment variables
const githubToken = process.env.GITHUB_TOKEN;
const githubRepository = process.env.GITHUB_REPOSITORY;
const workflowId = process.env.WORKFLOW_ID;
if (!githubToken || !githubRepository || !workflowId) {
throw new Error('Missing required environment variables.');
}
const [owner, repo] = githubRepository.split('/');
const octokit = new Octokit({ auth: githubToken });
// Extract and validate data from the webhook event
const eventData = body || {};
const { by_nickname, by_email, content } = eventData;
const time = eventData.time || new Date().toISOString();
if (!by_email || !by_nickname || !content) {
throw new Error('Missing required fields: by_email, by_nickname, or content.');
}
// Create or update the blog post file in the repository
const date = formatDate(time);
const slugName = slugify(by_nickname);
const path = `_posts/${date}-${slugName}.md`;
const message = `New post by ${by_nickname}`;
const postContent = createPostContent({ by_nickname, by_email, content, time });
const contentEncoded = Base64.encode(postContent);
await octokit.repos.createOrUpdateFileContents({
owner,
repo,
path,
message,
content: contentEncoded,
});
// Dispatch the workflow
const ref = 'main'; // You can make this dynamic if needed
await triggerWorkflowDispatch(octokit, owner, repo, ref, workflowId, inputs);
return {
statusCode: 200,
body: JSON.stringify({ message: 'File created/updated and workflow triggered', path }),
};
} catch (error) {
console.error('Error in handleWebhook:', error);
return {
statusCode: error.status || 500,
body: JSON.stringify({ message: error.message || 'An unexpected error occurred.' }),
};
}
};
/**
* Optional function to manually trigger a GitHub Actions workflow via HTTP endpoint.
* @param {Object} event - Event data from AWS Lambda invocation.
* @return {Object} Response object with statusCode and body.
*/
export const triggerGithubWorkflow = async (event) =&gt; {
try {
const body = event.body ? JSON.parse(event.body) : {};
const { ref = 'main', workflow_id, inputs = {} } = body;
// Validate required environment variables
const githubToken = process.env.GITHUB_TOKEN;
const githubRepository = process.env.GITHUB_REPOSITORY;
if (!githubToken || !githubRepository) {
throw new Error('Missing required environment variables.');
}
const workflowId = workflow_id || process.env.WORKFLOW_ID;
if (!workflowId) {
throw new Error('Workflow ID is required.');
}
const [owner, repo] = githubRepository.split('/');
const octokit = new Octokit({ auth: githubToken });
// Dispatch the workflow
const response = await triggerWorkflowDispatch(octokit, owner, repo, ref, workflowId, inputs);
return {
statusCode: 200,
body: JSON.stringify({ message: 'Workflow dispatched successfully.', details: response }),
};
} catch (error) {
console.error('Error in triggerGithubWorkflow:', error);
return {
statusCode: error.status || 500,
body: JSON.stringify({ message: error.message || 'Failed to dispatch workflow.' }),
};
}
};</code></section>
  <h1 id="3-client-side-javascript-if-applicable">
    
    
     <a href="#3-client-side-javascript-if-applicable">#</a><a href="#" aria-label="Back to top">3. Client-Side JavaScript (If Applicable):</a>
        
    
  </h1>
      

<section data-filename="javascript_code-block.js" data-code="const webhookEndpoint = '/webhook'; // Path to your webhook endpoint
document.getElementById('triggerWorkflow').addEventListener('click', async () =&gt; {
// Display status message to user
// ...
try {
const inputs = { run_workflow: 'yes', testParam: Math.random() }; // Example inputs
const response = await fetch(webhookEndpoint, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
by_nickname: 'John Doe', // Example data
by_email: 'john.doe@example.com',
content: 'This is a test post.',
inputs, // Send inputs in the request body
}),
});
if (!response.ok) {
const errorData = await response.json();
throw new Error(`Server error: ${response.status} - ${errorData.message}`);
}
const data = await response.json();
// Handle successful response
// ...
} catch (error) {
// Handle error and display message to user
// ...
}
});" data-download-link="" data-download-link-label="Download Javascript"><code class="language-javascript">const webhookEndpoint = '/webhook'; // Path to your webhook endpoint
document.getElementById('triggerWorkflow').addEventListener('click', async () =&gt; {
// Display status message to user
// ...
try {
const inputs = { run_workflow: 'yes', testParam: Math.random() }; // Example inputs
const response = await fetch(webhookEndpoint, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
by_nickname: 'John Doe', // Example data
by_email: 'john.doe@example.com',
content: 'This is a test post.',
inputs, // Send inputs in the request body
}),
});
if (!response.ok) {
const errorData = await response.json();
throw new Error(`Server error: ${response.status} - ${errorData.message}`);
}
const data = await response.json();
// Handle successful response
// ...
} catch (error) {
// Handle error and display message to user
// ...
}
});</code></section><hr />
  <h1 id="comprehensive-documentation">
    
    
     <a href="#comprehensive-documentation">#</a><a href="#" aria-label="Back to top">Comprehensive Documentation</a>
        
    
  </h1>
      
  <h1 id="changes-and-enhancements">
    
    
     <a href="#changes-and-enhancements">#</a><a href="#" aria-label="Back to top">Changes and Enhancements:</a>
        
    
  </h1>
      

<ol>
  <li>
    <p><strong>Enhanced <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code> Function:</strong></p>

    <ul>
      <li><strong>Inputs Parameter:</strong> Added an <code class="language-plaintext highlighter-rouge">inputs</code> parameter to pass dynamic inputs to the GitHub Actions workflow, allowing for greater flexibility in workflow configuration.</li>
      <li><strong>Improved Error Handling:</strong> The function now throws errors that include the GitHub API response, enabling better error reporting and debugging in calling functions.</li>
      <li><strong>Informative Logging:</strong> Added console logs for successful dispatches and errors, aiding in monitoring and troubleshooting.</li>
    </ul>
  </li>
  <li>
    <p><strong>Updated <code class="language-plaintext highlighter-rouge">handleWebhook</code> Function:</strong></p>

    <ul>
      <li><strong>Error Handling:</strong> Improved error catching and response formatting to ensure that users receive meaningful error messages without exposing sensitive information.</li>
      <li><strong>Input Parsing:</strong> Extracted <code class="language-plaintext highlighter-rouge">inputs</code> from the request body, allowing clients to send custom inputs for the workflow dispatch.</li>
      <li><strong>Environment Variables Validation:</strong> Added checks to ensure that all required environment variables (<code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code>, <code class="language-plaintext highlighter-rouge">GITHUB_REPOSITORY</code>, <code class="language-plaintext highlighter-rouge">WORKFLOW_ID</code>) are set before proceeding, preventing runtime errors.</li>
      <li><strong>Security Improvements:</strong> Validated inputs and sanitized data to prevent potential security vulnerabilities like injection attacks.</li>
    </ul>
  </li>
  <li>
    <p><strong>Added <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> Function (Optional):</strong></p>

    <ul>
      <li><strong>Manual Workflow Triggering:</strong> Provides a separate HTTP endpoint to manually trigger GitHub Actions workflows, useful for testing or administrative tasks.</li>
      <li><strong>Error Handling and Validation:</strong> Includes robust error handling and input validation, ensuring secure operation.</li>
      <li><strong>Configuration Flexibility:</strong> Allows clients to specify <code class="language-plaintext highlighter-rouge">ref</code>, <code class="language-plaintext highlighter-rouge">workflow_id</code>, and <code class="language-plaintext highlighter-rouge">inputs</code>, making the function highly adaptable.</li>
    </ul>
  </li>
  <li>
    <p><strong>Refined Environment Variables:</strong></p>

    <ul>
      <li><strong>Consistent Naming:</strong> Standardized environment variable names for clarity (<code class="language-plaintext highlighter-rouge">GITHUB_REPOSITORY</code>, <code class="language-plaintext highlighter-rouge">WORKFLOW_ID</code>).</li>
      <li><strong>Secure Handling:</strong> Emphasized the secure use of <code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code> by ensuring it is never exposed to the client-side or logged.</li>
    </ul>
  </li>
  <li>
    <p><strong>Updated <code class="language-plaintext highlighter-rouge">serverless.yml</code> Configuration:</strong></p>

    <ul>
      <li><strong>Added Functions:</strong> Included the <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> function with its HTTP event configuration.</li>
      <li><strong>Environment Variables:</strong> Updated the environment variables section to reflect the required variables used in the functions.</li>
      <li><strong>Removed Redundant Configurations:</strong> Streamlined the configuration by removing unnecessary constructs, focusing on the essential components.</li>
    </ul>
  </li>
  <li>
    <p><strong>Security Enhancements:</strong></p>

    <ul>
      <li><strong>Input Validation:</strong> Implemented validation for all inputs, checking for the presence of required fields and ensuring data integrity.</li>
      <li><strong>Error Messages:</strong> Ensured that error messages do not leak sensitive information, conforming to security best practices.</li>
      <li><strong>Token Security:</strong> Kept all sensitive tokens and credentials on the server-side, preventing exposure to unauthorized users.</li>
    </ul>
  </li>
  <li>
    <p><strong>Performance Optimizations:</strong></p>

    <ul>
      <li><strong>Code Reuse:</strong> Utilized the <code class="language-plaintext highlighter-rouge">triggerWorkflowDispatch</code> function across both <code class="language-plaintext highlighter-rouge">handleWebhook</code> and <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> to avoid code duplication.</li>
      <li><strong>Async/Await Use:</strong> Ensured async/await is used effectively for non-blocking operations, improving the responsiveness of the Lambda functions.</li>
      <li><strong>Efficient Logging:</strong> Kept logging informative but concise, reducing unnecessary overhead.</li>
    </ul>
  </li>
  <li>
    <p><strong>Code Quality Improvements:</strong></p>

    <ul>
      <li><strong>Comments and JSDoc:</strong> Added detailed comments and JSDoc annotations for functions and important code segments, improving readability and maintainability.</li>
      <li><strong>Consistent Coding Style:</strong> Followed consistent indentation, naming conventions, and code formatting throughout the codebase.</li>
    </ul>
  </li>
  <li>
    <p><strong>Documentation Updates:</strong></p>

    <ul>
      <li><strong>Deployment Instructions:</strong> Provided clear guidance on setting environment variables and deploying the application.</li>
      <li><strong>Usage Examples:</strong> Included examples of how to invoke the functions and what kind of data to send in requests.</li>
      <li><strong>Workflow Setup:</strong> Advised on setting up the GitHub Actions workflow file (<code class="language-plaintext highlighter-rouge">workflow_dispatch</code>), ensuring that the workflow can be triggered as expected.</li>
    </ul>
  </li>
</ol>
  <h1 id="deployment-and-configuration-instructions">
    
    
     <a href="#deployment-and-configuration-instructions">#</a><a href="#" aria-label="Back to top">Deployment and Configuration Instructions:**</a>
        
    
  </h1>
      

<ol>
  <li>
    <p><strong>Set Environment Variables:</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code>: Personal Access Token with appropriate permissions (stored securely).</li>
      <li><code class="language-plaintext highlighter-rouge">GITHUB_REPOSITORY</code>: Your GitHub repository in the format <code class="language-plaintext highlighter-rouge">owner/repo</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">WORKFLOW_ID</code>: The filename or ID of the GitHub Actions workflow to trigger.</li>
    </ul>
  </li>
  <li>
    <p><strong>Deploy the Serverless Application:</strong></p>

    <ul>
      <li>Install dependencies: <code class="language-plaintext highlighter-rouge">npm install</code></li>
      <li>Deploy using the Serverless Framework: <code class="language-plaintext highlighter-rouge">serverless deploy</code></li>
    </ul>
  </li>
  <li>
    <p><strong>Configure GitHub Actions Workflow:</strong></p>

    <ul>
      <li>Create a workflow file in your repository (e.g., <code class="language-plaintext highlighter-rouge">your-workflow-file.yml</code>).</li>
      <li>Ensure it includes <code class="language-plaintext highlighter-rouge">workflow_dispatch</code> in the <code class="language-plaintext highlighter-rouge">on</code> section:
        <section data-filename="yaml_code-block.yaml" data-code="on:
workflow_dispatch:
inputs:
run_workflow:
description: 'Trigger to run the workflow'
required: true
default: 'yes'" data-download-link="" data-download-link-label="Download Yaml"><code class="language-yaml">on:
workflow_dispatch:
inputs:
run_workflow:
description: 'Trigger to run the workflow'
required: true
default: 'yes'</code></section>
      </li>
      <li>Define the jobs and steps as needed for your application.</li>
    </ul>
  </li>
  <li>
    <p><strong>Testing the Functions:</strong></p>

    <ul>
      <li>Test the <code class="language-plaintext highlighter-rouge">handleWebhook</code> function by sending a POST request to the <code class="language-plaintext highlighter-rouge">/webhook</code> endpoint.
        <ul>
          <li>Include required data fields in the request body (<code class="language-plaintext highlighter-rouge">by_nickname</code>, <code class="language-plaintext highlighter-rouge">by_email</code>, <code class="language-plaintext highlighter-rouge">content</code>).</li>
          <li>Optionally include <code class="language-plaintext highlighter-rouge">inputs</code> for the workflow.</li>
        </ul>
      </li>
      <li>If the <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> function is added, test it by sending a POST request to the <code class="language-plaintext highlighter-rouge">/trigger_github_workflow</code> endpoint.
        <ul>
          <li>Include <code class="language-plaintext highlighter-rouge">workflow_id</code>, <code class="language-plaintext highlighter-rouge">ref</code>, and <code class="language-plaintext highlighter-rouge">inputs</code> in the request body as needed.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Security Considerations:</strong></p>

    <ul>
      <li>Ensure that all tokens and sensitive data are securely stored and not exposed to users.</li>
      <li>Regularly review and update dependencies to fix any known vulnerabilities.</li>
      <li>Monitor logs for any suspicious activities or errors.</li>
    </ul>
  </li>
</ol>
  <h1 id="conclusion">
    
    
     <a href="#conclusion">#</a><a href="#" aria-label="Back to top">Conclusion:</a>
        
    
  </h1>
      

<p>By integrating the enhanced functions and implementations from the different approaches, the updated codebase now offers improved functionality, performance, and security. The <code class="language-plaintext highlighter-rouge">handleWebhook</code> function is more robust, capable of handling errors gracefully, and supports dynamic inputs for workflow dispatch. The optional <code class="language-plaintext highlighter-rouge">triggerGithubWorkflow</code> function adds flexibility for manual workflow triggers. The code adheres to best practices in coding standards, error handling, and security measures, ensuring a reliable and maintainable application.</p>
  <h1 id="notes">
    
    
     <a href="#notes">#</a><a href="#" aria-label="Back to top">Notes:</a>
        
    
  </h1>
      

<ul>
  <li>Remember to replace placeholder values like <code class="language-plaintext highlighter-rouge">your-github-username</code>, <code class="language-plaintext highlighter-rouge">your-repo-name</code>, and <code class="language-plaintext highlighter-rouge">your-workflow-file.yml</code> with your actual GitHub username, repository name, and workflow file.</li>
  <li>Ensure that the GitHub token used (<code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code>) has the necessary permissions to create/update files and dispatch workflows in the repository.</li>
  <li>Keep your dependencies up to date to benefit from security patches and performance improvements.</li>
</ul><hr />
  <h1 id="references">
    
    
     <a href="#references">#</a><a href="#" aria-label="Back to top">References:</a>
        
    
  </h1>
      

<ul>
  <li><a href="https://docs.github.com/en/rest/actions/workflows?apiVersion=2022-11-28#create-a-workflow-dispatch-event">GitHub Actions Workflow Dispatch</a></li>
  <li><a href="https://www.serverless.com/framework/docs/">Serverless Framework Documentation</a></li>
  <li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-nodejs.html">AWS Lambda Node.js Runtime</a></li>
  <li><a href="https://octokit.github.io/rest.js/">Octokit REST.js Documentation</a></li>
</ul>

      </div>
    </article>
    <nav class="post-navigation" aria-label="Post navigation">
      
      <div class="nav-arrow prev">
        <a href="/llm-history/" title="Compile LLM chat-history" rel="prev">
          <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAtCAYAAAA6GuKaAAAAAXNSR0IArs4c6QAAAxVJREFUaEPt18FqG1cUBuD/nLkzI42UiVInkFLTCAKhS+9KA+3Kq1L8AAHjhR7AKz+ADV55qUfoqhvThTfdmC4KzTKmYJrELshJW9PIlSeKRpqZe88pUtouihvVRknqMNoMzD1zdPXNrzMM4RJ+6BLuGeWm39RdK6VL6VcIlPEo41HG401loJQupS8mUM7pi7md/6p3UtoHUJzf4vVecZb0e0EQfB7H8b0kSeqqummt/eb1buN83SebNsZ8QkQCYHVpaenu/v7+ra2tLRwdHWF1ddWq6hfM3BCRE2b+FcBHACQAHo1E5v9c+5mIhkR0e3z0VQ8LotuqWlXVw/GRmT8QkdMK89McuAOAAfwoIu8z85yIHBPRKRGN1/IAeDx0rul53hivo6psrf2ejDGfEtFOu92u7O3tBWtra2i322g0GhgOh9je3ka325UPax7fCR0iw+lp4aLxr70aeOmgkChTRY3JGSb73EroERD73uB54WpOgdhwZkXNQNQLiVDzOU1yFymAhu+lqZVopIqISQKmPLFS+atHv3A1q8AVQ/lXP/VHRPQx+b6frKysxMvLy1hfX0ez2USv18PCwgLiOEaSJKhWq/jhwQN8dnIfVOS4dsWHqCJ5YREGjBuNEMfd0eTc9WshBqnFYGhRqxrUIoNuLwMT4eb1Cp6dZshywdW6mZzr9QsEPuPmXIhfno3gnGKuEWCUC14MLKoVb1L72+8Zvj3JOl/udZt/S7darUqn0wlarRZ2d3cxPz+PJ8dPsPP1Doq8kIbL+cawjxBIM8MRFAidpBlRpIbhFc55gM2NF5IIQtVBRlRTZgTWZQ4wzvc8spO1NPM4Gr9Wh1bSDIjU98C5E0PIC8OVSX+Rlz08hl+4/LsML6X/menFxcW7BwcHtzY2NvDw8CE21zf/NdMAHskFMs3MT/EfMg3gsTsr02f8byfTo16v3+v3+//f6fGKgXNp5vT5huZbqH4nH+NvwXH6V5bS041mU1FKz8ZxepdSerrRbCpK6dk4Tu9SSk83mk1FKT0bx+ldSunpRrOpuJTSfwBcuImxpyA7XgAAAABJRU5ErkJggg==" alt="Previous article" width="45" height="45" loading="lazy">
        </a>
      </div>
      
      
    </nav>    
        
  </main>
  <footer class="site-footer">
      <p>
        
        
        
        2024-10-18 12:50:00
        <a href="/" aria-label="Homepage">
          &#8505; infoBAG
        </a>
        <a href="#" aria-label="Back to top">
          <img src="/assets/Rope_(Old).gif" alt="Back to top" width="32" height="32" loading="lazy">
        </a>
      </p>
    </footer>
</body>
</html>
