---
tags: scripts>cloud
info: aberto.
date: 2024-11-03
type: post
layout: post
published: true
slug: gingko-python-websocket-script
title: 'Gingko Python WebSocket script'
---
You initiated our collaboration by sharing your endeavor to implement a Python WebSocket client script designed to interact with the Gingko Writer application. Your primary objective was to establish a stable WebSocket connection to `wss://app.gingkowriter.com/ws`, manage authentication through cookies, and handle various message types, including `'rt:join'`, `'trees'`, and `'user'` messages. You provided an initial script that encompassed WebSocket connection logic, logging configuration, and mechanisms for sending and receiving messages.

As you progressed, you encountered challenges related to effectively utilizing the established WebSocket connection to perform specific requests to the server, such as creating cards within the Gingko Writer service. This pivot from basic connectivity to practical application prompted a deeper exploration into message formatting, asynchronous handling of user inputs alongside incoming messages, and the necessity for a structured request mechanism within the script. You sought guidance on enhancing the script's capabilities to include an interactive command interface, concurrent processing, improved logging, and robust error handling to ensure maintainability and extensibility.

In response, I provided an updated and more sophisticated version of your Python script. This version incorporated the necessary credentials and authentication details extracted from your browser's Developer Tools, ensuring that the `'rt:join'` message was correctly formatted with accurate `tr` (tree ID), `uid` (user ID), and `m` (authentication token) parameters. The script was enhanced to handle various message types, including confirmation of successful joins (`'rt:joinOk'`) and acknowledgment of push messages (`'pushOk'`). Additionally, I emphasized the importance of securing your credentials by using environment variables and ensuring that your system's cookies were valid and up-to-date.

Upon implementing these modifications, you shared the logs of your script's execution, which initially revealed that the `'rt:joinOk'` message was not being received, indicating potential issues with authentication. Following detailed diagnostic steps and instructions to extract and correctly incorporate your authentication details from Developer Tools, you updated your script accordingly. This adjustment led to a successful connection and the proper creation of cards within the Gingko Writer application, as evidenced by the logs you provided. The logs demonstrated that the script was able to send push messages, receive acknowledgments (`'pushOk'`), and create the intended card hierarchy seamlessly.

Throughout our interaction, we navigated several challenges, including ensuring the accuracy of authentication parameters, managing session checkpoints, and handling real-time message exchanges. Key moments of progress included correctly formatting the `'rt:join'` message with precise credentials and successfully interpreting and responding to server acknowledgments. These milestones were crucial in transforming your initial script into a functional tool capable of interacting effectively with the Gingko Writer service.

In conclusion, our collaborative efforts culminated in the successful implementation of a robust Python WebSocket client that not only established a secure connection with the Gingko Writer server but also performed essential operations like creating structured card hierarchies. This achievement was made possible by meticulously addressing authentication issues, enhancing message handling capabilities, and ensuring the script's adaptability through improved logging and error management. Moving forward, this foundation allows for further extensions, such as adding more interactive features or integrating additional message types, thereby expanding the script's utility and effectiveness in managing your Gingko Writer documents programmatically.

{% codeblock python %}
aW1wb3J0IGFzeW5jaW8KaW1wb3J0IGpzb24KaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHJhbmRvbQppbXBvcnQgc3RyaW5nCmltcG9ydCB0aW1lCmltcG9ydCB3ZWJzb2NrZXRzCmZyb20gd2Vic29ja2V0cy5leGNlcHRpb25zIGltcG9ydCBDb25uZWN0aW9uQ2xvc2VkRXJyb3IsIFdlYlNvY2tldEV4Y2VwdGlvbgoKIyBDb25maWd1cmUgbG9nZ2luZyBmb3IgZGV0YWlsZWQgZGVidWdnaW5nCmxvZ2dpbmcuYmFzaWNDb25maWcoCiAgICBsZXZlbD1sb2dnaW5nLkRFQlVHLCAgIyBTZXQgdG8gREVCVUcgZm9yIGNvbXByZWhlbnNpdmUgbG9ncwogICAgZm9ybWF0PSclKGFzY3RpbWUpcyAtICUobGV2ZWxuYW1lKXMgLSAlKG1lc3NhZ2UpcycKKQpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCgpjbGFzcyBHaW5na29XZWJzb2NrZXRDbGllbnQ6CiAgICAiIiIKICAgIEEgY2xpZW50IHRvIGludGVyYWN0IHdpdGggdGhlIEdpbmdrbyBXcml0ZXIgYXBwbGljYXRpb24gdmlhIFdlYlNvY2tldC4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB1cmw6IHN0ciwgY29va2llczogc3RyLCB0cmVlX2lkOiBzdHIsIHVzZXJfaWQ6IHN0ciwgYXV0aF90b2tlbjogc3RyKToKICAgICAgICAiIiIKICAgICAgICBJbml0aWFsaXplcyB0aGUgR2luZ2tvV2Vic29ja2V0Q2xpZW50IHdpdGggdGhlIG5lY2Vzc2FyeSBjcmVkZW50aWFscyBhbmQgcGFyYW1ldGVycy4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdXJsIChzdHIpOiBUaGUgV2ViU29ja2V0IFVSTCBmb3IgdGhlIEdpbmdrbyBXcml0ZXIgYXBwbGljYXRpb24uCiAgICAgICAgICAgIGNvb2tpZXMgKHN0cik6IFRoZSBhdXRoZW50aWNhdGlvbiBjb29raWVzLgogICAgICAgICAgICB0cmVlX2lkIChzdHIpOiBUaGUgSUQgb2YgdGhlIHRyZWUgKGRvY3VtZW50KSB0byBpbnRlcmFjdCB3aXRoLgogICAgICAgICAgICB1c2VyX2lkIChzdHIpOiBUaGUgdXNlcidzIEdpbmdrbyBXcml0ZXIgdXNlciBJRC4KICAgICAgICAgICAgYXV0aF90b2tlbiAoc3RyKTogVGhlIGF1dGhlbnRpY2F0aW9uIHRva2VuIGZyb20gdGhlICdydDpqb2luJyBtZXNzYWdlLgogICAgICAgICIiIgogICAgICAgIHNlbGYudXJsID0gdXJsCiAgICAgICAgc2VsZi5jb29raWVzID0gY29va2llcwogICAgICAgIHNlbGYudHJlZV9pZCA9IHRyZWVfaWQKICAgICAgICBzZWxmLnVzZXJfaWQgPSB1c2VyX2lkCiAgICAgICAgc2VsZi5hdXRoX3Rva2VuID0gYXV0aF90b2tlbgogICAgICAgIHNlbGYuc2Vzc2lvbl9pZCA9IE5vbmUKICAgICAgICBzZWxmLmNoZWNrcG9pbnQgPSBOb25lCiAgICAgICAgc2VsZi5wdXNoX29rX2V2ZW50ID0gYXN5bmNpby5FdmVudCgpCiAgICAgICAgc2VsZi53cyA9IE5vbmUKICAgICAgICBzZWxmLnJlY29ubmVjdF9hdHRlbXB0cyA9IDAKICAgICAgICBzZWxmLm1heF9yZWNvbm5lY3RfYXR0ZW1wdHMgPSA1CgogICAgYXN5bmMgZGVmIGdlbmVyYXRlX3RpbWVzdGFtcChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgR2VuZXJhdGVzIGEgdW5pcXVlIHRpbWVzdGFtcCBmb3Igb3BlcmF0aW9ucy4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBBIHRpbWVzdGFtcCBzdHJpbmcgaW4gdGhlIGZvcm1hdCAnbWlsbGlzZWNvbmRzOnNlcXVlbmNlOnNlc3Npb25fZnJhZ21lbnQnCiAgICAgICAgIiIiCiAgICAgICAgbWlsbGlzID0gaW50KHRpbWUudGltZSgpICogMTAwMCkKICAgICAgICBzZXF1ZW5jZSA9IHJhbmRvbS5yYW5kaW50KDAsIDkpCiAgICAgICAgc2Vzc2lvbl9mcmFnbWVudCA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX2xvd2VyY2FzZSArIHN0cmluZy5kaWdpdHMsIGs9OCkpCiAgICAgICAgcmV0dXJuIGYie21pbGxpc306e3NlcXVlbmNlfTp7c2Vzc2lvbl9mcmFnbWVudH0iCgogICAgYXN5bmMgZGVmIGdlbmVyYXRlX2NhcmRfaWQoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEdlbmVyYXRlcyBhIHVuaXF1ZSBjYXJkIElELgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IEEgMjQtY2hhcmFjdGVyIGFscGhhbnVtZXJpYyBzdHJpbmcuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX2xldHRlcnMgKyBzdHJpbmcuZGlnaXRzLCBrPTI0KSkKCiAgICBhc3luYyBkZWYgc2VuZF9tZXNzYWdlKHNlbGYsIG1lc3NhZ2VfdHlwZTogc3RyLCBkYXRhOiBkaWN0KToKICAgICAgICAiIiIKICAgICAgICBTZW5kcyBhIGZvcm1hdHRlZCBtZXNzYWdlIG92ZXIgdGhlIFdlYlNvY2tldCBjb25uZWN0aW9uLgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBtZXNzYWdlX3R5cGUgKHN0cik6IFRoZSB0eXBlIG9mIHRoZSBtZXNzYWdlIChlLmcuLCAncHVzaCcsICdydDpqb2luJykuCiAgICAgICAgICAgIGRhdGEgKGRpY3QpOiBUaGUgbWVzc2FnZSBkYXRhIHBheWxvYWQuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi53cyBpcyBOb25lOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIldlYlNvY2tldCBjb25uZWN0aW9uIGlzIG5vdCBlc3RhYmxpc2hlZC4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBtZXNzYWdlID0geyJ0IjogbWVzc2FnZV90eXBlLCAiZCI6IGRhdGF9CiAgICAgICAgdHJ5OgogICAgICAgICAgICBhd2FpdCBzZWxmLndzLnNlbmQoanNvbi5kdW1wcyhtZXNzYWdlKSkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU2VudCB7bWVzc2FnZV90eXBlfSBtZXNzYWdlOiB7anNvbi5kdW1wcyhkYXRhKX0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRmFpbGVkIHRvIHNlbmQgbWVzc2FnZSAne21lc3NhZ2VfdHlwZX0nOiB7ZX0iKQoKICAgIGFzeW5jIGRlZiBoYW5kbGVfdXNlcl9tZXNzYWdlKHNlbGYsIGRhdGE6IGRpY3QpOgogICAgICAgIGxvZ2dlci5pbmZvKGYiUmVjZWl2ZWQgdXNlciBkYXRhOiB7anNvbi5kdW1wcyhkYXRhLCBpbmRlbnQ9Mil9IikKCiAgICBhc3luYyBkZWYgaGFuZGxlX3RyZWVzX21lc3NhZ2Uoc2VsZiwgZGF0YTogbGlzdCk6CiAgICAgICAgdHJlZXMgPSBkYXRhCiAgICAgICAgbG9nZ2VyLmluZm8oZiJSZWNlaXZlZCB0cmVlcyBkYXRhOiB7anNvbi5kdW1wcyh0cmVlcywgaW5kZW50PTIpfSIpCiAgICAgICAgdHJlZV9pZHMgPSBbdHJlZVsnaWQnXSBmb3IgdHJlZSBpbiB0cmVlc10KICAgICAgICBpZiBzZWxmLnRyZWVfaWQgaW4gdHJlZV9pZHM6CiAgICAgICAgICAgIHNlbGYuc2Vzc2lvbl9pZCA9ICJTZXNzaW9uTm90UHJvdmlkZWQiCiAgICAgICAgICAgIHNlbGYucHVzaF9va19ldmVudC5zZXQoKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRyZWUgJ3tzZWxmLnRyZWVfaWR9JyBpcyBhdmFpbGFibGUuIFByb2NlZWRpbmcgd2l0aCBvcGVyYXRpb25zLiIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiVHJlZSAne3NlbGYudHJlZV9pZH0nIG5vdCBmb3VuZCBpbiB5b3VyIGFjY291bnQuIikKCiAgICBhc3luYyBkZWYgaGFuZGxlX3J0X3VzZXJzX21lc3NhZ2Uoc2VsZiwgZGF0YTogbGlzdCk6CiAgICAgICAgbG9nZ2VyLmluZm8oZiJSZWNlaXZlZCBydDp1c2VycyBkYXRhOiB7anNvbi5kdW1wcyhkYXRhLCBpbmRlbnQ9Mil9IikKCiAgICBhc3luYyBkZWYgaGFuZGxlX3B1c2hfb2tfbWVzc2FnZShzZWxmLCBkYXRhOiBsaXN0KToKICAgICAgICBjaGVja3BvaW50X2xpc3QgPSBkYXRhCiAgICAgICAgaWYgY2hlY2twb2ludF9saXN0OgogICAgICAgICAgICBzZWxmLmNoZWNrcG9pbnQgPSBjaGVja3BvaW50X2xpc3RbMF0KICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVXBkYXRlZCBjaGVja3BvaW50IHRvOiB7c2VsZi5jaGVja3BvaW50fSIpCiAgICAgICAgICAgIHNlbGYucHVzaF9va19ldmVudC5zZXQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJSZWNlaXZlZCBwdXNoT2sgd2l0aG91dCBjaGVja3BvaW50IGRhdGEuIikKCiAgICBhc3luYyBkZWYgaGFuZGxlX3J0X2pvaW5fb2tfbWVzc2FnZShzZWxmLCBkYXRhOiBkaWN0KToKICAgICAgICBzZWxmLnNlc3Npb25faWQgPSBkYXRhLmdldCgic2lkIikKICAgICAgICBpbml0aWFsX2NoZWNrcG9pbnQgPSBkYXRhLmdldCgiY2hrIikKICAgICAgICBpZiBpbml0aWFsX2NoZWNrcG9pbnQ6CiAgICAgICAgICAgIHNlbGYuY2hlY2twb2ludCA9IGluaXRpYWxfY2hlY2twb2ludAogICAgICAgIGxvZ2dlci5pbmZvKGYiSm9pbmVkIHNlc3Npb246IHtzZWxmLnNlc3Npb25faWR9LCBpbml0aWFsIGNoZWNrcG9pbnQ6IHtzZWxmLmNoZWNrcG9pbnR9IikKICAgICAgICBzZWxmLnB1c2hfb2tfZXZlbnQuc2V0KCkKCiAgICBhc3luYyBkZWYgaGFuZGxlX2Vycm9yX21lc3NhZ2Uoc2VsZiwgZGF0YTogZGljdCk6CiAgICAgICAgbG9nZ2VyLmVycm9yKGYiUmVjZWl2ZWQgZXJyb3IgZnJvbSBzZXJ2ZXI6IHtqc29uLmR1bXBzKGRhdGEsIGluZGVudD0yKX0iKQoKICAgIGFzeW5jIGRlZiBoYW5kbGVfbWVzc2FnZShzZWxmLCBtZXNzYWdlX2RhdGE6IGRpY3QpOgogICAgICAgICIiIgogICAgICAgIEhhbmRsZXMgaW5jb21pbmcgbWVzc2FnZXMgZnJvbSB0aGUgV2ViU29ja2V0LgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBtZXNzYWdlX2RhdGEgKGRpY3QpOiBUaGUgcmVjZWl2ZWQgbWVzc2FnZSBkYXRhLgogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlY2VpdmVkIG1lc3NhZ2U6IHtqc29uLmR1bXBzKG1lc3NhZ2VfZGF0YSwgaW5kZW50PTIpfSIpCiAgICAgICAgbWVzc2FnZV90eXBlID0gbWVzc2FnZV9kYXRhLmdldCgidCIpCiAgICAgICAgZGF0YSA9IG1lc3NhZ2VfZGF0YS5nZXQoImQiLCB7fSkKCiAgICAgICAgaGFuZGxlciA9IHsKICAgICAgICAgICAgInVzZXIiOiBzZWxmLmhhbmRsZV91c2VyX21lc3NhZ2UsCiAgICAgICAgICAgICJ0cmVlcyI6IHNlbGYuaGFuZGxlX3RyZWVzX21lc3NhZ2UsCiAgICAgICAgICAgICJydDp1c2VycyI6IHNlbGYuaGFuZGxlX3J0X3VzZXJzX21lc3NhZ2UsCiAgICAgICAgICAgICJwdXNoT2siOiBzZWxmLmhhbmRsZV9wdXNoX29rX21lc3NhZ2UsCiAgICAgICAgICAgICJydDpqb2luT2siOiBzZWxmLmhhbmRsZV9ydF9qb2luX29rX21lc3NhZ2UsCiAgICAgICAgICAgICJlcnJvciI6IHNlbGYuaGFuZGxlX2Vycm9yX21lc3NhZ2UsCiAgICAgICAgICAgICJwaW5nIjogbGFtYmRhIF86IHNlbGYuc2VuZF9tZXNzYWdlKCJwb25nIiwge30pCiAgICAgICAgfS5nZXQobWVzc2FnZV90eXBlKQoKICAgICAgICBpZiBoYW5kbGVyOgogICAgICAgICAgICBhd2FpdCBoYW5kbGVyKGRhdGEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVW5oYW5kbGVkIG1lc3NhZ2UgdHlwZToge21lc3NhZ2VfdHlwZX0sIGRhdGE6IHtqc29uLmR1bXBzKGRhdGEsIGluZGVudD0yKX0iKQoKICAgIGFzeW5jIGRlZiBtZXNzYWdlX2hhbmRsZXIoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ29udGludW91c2x5IGhhbmRsZXMgaW5jb21pbmcgbWVzc2FnZXMgZnJvbSB0aGUgV2ViU29ja2V0LgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXN5bmMgZm9yIG1lc3NhZ2UgaW4gc2VsZi53czoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlX2RhdGEgPSBqc29uLmxvYWRzKG1lc3NhZ2UpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5oYW5kbGVfbWVzc2FnZShtZXNzYWdlX2RhdGEpCiAgICAgICAgICAgICAgICBleGNlcHQganNvbi5KU09ORGVjb2RlRXJyb3IgYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJGYWlsZWQgdG8gZGVjb2RlIEpTT04gbWVzc2FnZToge2V9IikKICAgICAgICBleGNlcHQgKENvbm5lY3Rpb25DbG9zZWRFcnJvciwgV2ViU29ja2V0RXhjZXB0aW9uKSBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJDb25uZWN0aW9uIGNsb3NlZDoge2V9IikKICAgICAgICAgICAgYXdhaXQgc2VsZi5yZWNvbm5lY3QoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiVW5leHBlY3RlZCBlcnJvciBpbiBtZXNzYWdlIGhhbmRsZXI6IHtlfSIpCiAgICAgICAgICAgIGF3YWl0IHNlbGYucmVjb25uZWN0KCkKCiAgICBkZWYgZ2V0X2pvaW5fbWVzc2FnZShzZWxmKSAtPiBkaWN0OgogICAgICAgICIiIgogICAgICAgIENvbnN0cnVjdHMgdGhlICdydDpqb2luJyBtZXNzYWdlIHRvIGpvaW4gdGhlIEdpbmdrbyBzZXNzaW9uLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBkaWN0OiBUaGUgJ3J0OmpvaW4nIG1lc3NhZ2UgZGF0YS4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAidHIiOiBzZWxmLnRyZWVfaWQsCiAgICAgICAgICAgICJ1aWQiOiBzZWxmLnVzZXJfaWQsCiAgICAgICAgICAgICJtIjogWyJhIiwgc2VsZi5hdXRoX3Rva2VuXQogICAgICAgIH0KCiAgICBhc3luYyBkZWYgY3JlYXRlX2NhcmQoc2VsZiwgY29udGVudDogc3RyLCBwYXJlbnRfaWQ6IHN0ciA9IE5vbmUsIHBvc2l0aW9uOiBpbnQgPSAwKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgQ3JlYXRlcyBhIG5ldyBjYXJkIGluIHRoZSBHaW5na28gdHJlZS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29udGVudCAoc3RyKTogVGhlIGNvbnRlbnQgb2YgdGhlIGNhcmQuCiAgICAgICAgICAgIHBhcmVudF9pZCAoc3RyLCBvcHRpb25hbCk6IFRoZSBJRCBvZiB0aGUgcGFyZW50IGNhcmQuIERlZmF1bHRzIHRvIE5vbmUuCiAgICAgICAgICAgIHBvc2l0aW9uIChpbnQsIG9wdGlvbmFsKTogVGhlIHBvc2l0aW9uIGFtb25nIHNpYmxpbmdzLiBEZWZhdWx0cyB0byAwLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFRoZSBJRCBvZiB0aGUgY3JlYXRlZCBjYXJkLgogICAgICAgICIiIgogICAgICAgIGNhcmRfaWQgPSBhd2FpdCBzZWxmLmdlbmVyYXRlX2NhcmRfaWQoKQogICAgICAgIGluc2VydF90cyA9IGF3YWl0IHNlbGYuZ2VuZXJhdGVfdGltZXN0YW1wKCkKICAgICAgICB1cGRhdGVfdHMgPSBhd2FpdCBzZWxmLmdlbmVyYXRlX3RpbWVzdGFtcCgpCgogICAgICAgICMgSW5zZXJ0IG9wZXJhdGlvbgogICAgICAgIGluc2VydF9kZWx0YSA9IHsKICAgICAgICAgICAgImlkIjogY2FyZF9pZCwKICAgICAgICAgICAgInRzIjogaW5zZXJ0X3RzLAogICAgICAgICAgICAib3BzIjogWwogICAgICAgICAgICAgICAgeyJ0IjogImkiLCAiYyI6ICIiLCAicCI6IHBhcmVudF9pZCwgInBvcyI6IHBvc2l0aW9ufQogICAgICAgICAgICBdCiAgICAgICAgfQoKICAgICAgICAjIFVwZGF0ZSBvcGVyYXRpb24KICAgICAgICB1cGRhdGVfZGVsdGEgPSB7CiAgICAgICAgICAgICJpZCI6IGNhcmRfaWQsCiAgICAgICAgICAgICJ0cyI6IHVwZGF0ZV90cywKICAgICAgICAgICAgIm9wcyI6IFsKICAgICAgICAgICAgICAgIHsidCI6ICJ1IiwgImMiOiBjb250ZW50LCAiZSI6IGluc2VydF90c30KICAgICAgICAgICAgXQogICAgICAgIH0KCiAgICAgICAgcHVzaF9kYXRhID0gewogICAgICAgICAgICAiZGx0cyI6IFtpbnNlcnRfZGVsdGEsIHVwZGF0ZV9kZWx0YV0sCiAgICAgICAgICAgICJ0ciI6IHNlbGYudHJlZV9pZCwKICAgICAgICAgICAgImNoayI6IHNlbGYuY2hlY2twb2ludCBvciBpbnNlcnRfdHMKICAgICAgICB9CgogICAgICAgIHNlbGYucHVzaF9va19ldmVudC5jbGVhcigpCiAgICAgICAgYXdhaXQgc2VsZi5zZW5kX21lc3NhZ2UoInB1c2giLCBwdXNoX2RhdGEpCiAgICAgICAgbG9nZ2VyLmluZm8oZiJTZW50IHB1c2ggZm9yIGNhcmQgJ3tjb250ZW50fScgd2l0aCBJRCB7Y2FyZF9pZH0iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8ud2FpdF9mb3Ioc2VsZi5wdXNoX29rX2V2ZW50LndhaXQoKSwgdGltZW91dD0xMCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQdXNoIGFja25vd2xlZGdtZW50IHJlY2VpdmVkIGZvciBjYXJkICd7Y29udGVudH0nIikKICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiRGlkIG5vdCByZWNlaXZlIHB1c2hPayBhY2tub3dsZWRnbWVudCBpbiB0aW1lLiIpCiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigicHVzaE9rIHRpbWVvdXQiKQoKICAgICAgICByZXR1cm4gY2FyZF9pZAoKICAgIGFzeW5jIGRlZiBjcmVhdGVfdHJlZV9zdHJ1Y3R1cmUoc2VsZiwgc3RydWN0dXJlOiBsaXN0LCBwYXJlbnRfaWQ6IHN0ciA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIFJlY3Vyc2l2ZWx5IGNyZWF0ZXMgYSB0cmVlIHN0cnVjdHVyZSBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgZGF0YS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc3RydWN0dXJlIChsaXN0KTogQSBsaXN0IG9mIGRpY3RzIHJlcHJlc2VudGluZyB0aGUgdHJlZSBzdHJ1Y3R1cmUuCiAgICAgICAgICAgIHBhcmVudF9pZCAoc3RyLCBvcHRpb25hbCk6IFRoZSBJRCBvZiB0aGUgcGFyZW50IGNhcmQuIERlZmF1bHRzIHRvIE5vbmUuCiAgICAgICAgIiIiCiAgICAgICAgZm9yIHBvc2l0aW9uLCBub2RlIGluIGVudW1lcmF0ZShzdHJ1Y3R1cmUpOgogICAgICAgICAgICBjb250ZW50ID0gbm9kZS5nZXQoImNvbnRlbnQiLCAiIikuc3RyaXAoKQogICAgICAgICAgICBjaGlsZHJlbiA9IG5vZGUuZ2V0KCJjaGlsZHJlbiIsIFtdKQoKICAgICAgICAgICAgaWYgbm90IGNvbnRlbnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiRW5jb3VudGVyZWQgbm9kZSB3aXRob3V0IGNvbnRlbnQuIFNraXBwaW5nLiIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY2FyZF9pZCA9IGF3YWl0IHNlbGYuY3JlYXRlX2NhcmQoY29udGVudCwgcGFyZW50X2lkLCBwb3NpdGlvbikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ3JlYXRlZCBjYXJkICd7Y29udGVudH0nIHdpdGggSUQge2NhcmRfaWR9IikKCiAgICAgICAgICAgICAgICBpZiBjaGlsZHJlbjoKICAgICAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLmNyZWF0ZV90cmVlX3N0cnVjdHVyZShjaGlsZHJlbiwgY2FyZF9pZCkKCiAgICAgICAgICAgICAgICAjIFNtYWxsIGRlbGF5IHRvIGF2b2lkIG92ZXJ3aGVsbWluZyB0aGUgc2VydmVyCiAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKDAuMSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRmFpbGVkIHRvIGNyZWF0ZSBjYXJkICd7Y29udGVudH0nOiB7ZX0iKQoKICAgIGFzeW5jIGRlZiBwZXJmb3JtX29wZXJhdGlvbnMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUGVyZm9ybXMgZGVzaXJlZCBvcGVyYXRpb25zIGFmdGVyIGVzdGFibGlzaGluZyB0aGUgV2ViU29ja2V0IGNvbm5lY3Rpb24uCiAgICAgICAgVGhpcyBjb3VsZCBiZSBpbnRlcmFjdGluZyB3aXRoIHRoZSB0cmVlLCBjcmVhdGluZyBjYXJkcywgZXRjLgogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJTdGFydGluZyBvcGVyYXRpb25zLi4uIikKCiAgICAgICAgIyBFeGFtcGxlOiBDcmVhdGUgYSBzaW5nbGUgY2FyZC4KICAgICAgICBleGFtcGxlX3N0cnVjdHVyZSA9IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgImNvbnRlbnQiOiAiQXV0b21hdGVkIFJvb3QgQ2FyZCIsCiAgICAgICAgICAgICAgICAiY2hpbGRyZW4iOiBbCiAgICAgICAgICAgICAgICAgICAgeyJjb250ZW50IjogIkF1dG9tYXRlZCBDaGlsZCAxIn0sCiAgICAgICAgICAgICAgICAgICAgeyJjb250ZW50IjogIkF1dG9tYXRlZCBDaGlsZCAyIn0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgIF0KCiAgICAgICAgYXdhaXQgc2VsZi5jcmVhdGVfdHJlZV9zdHJ1Y3R1cmUoZXhhbXBsZV9zdHJ1Y3R1cmUpCiAgICAgICAgbG9nZ2VyLmluZm8oIkNvbXBsZXRlZCBjcmVhdGluZyBleGFtcGxlIGNhcmQgc3RydWN0dXJlLiIpCgogICAgYXN5bmMgZGVmIGNvbm5lY3Qoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgRXN0YWJsaXNoZXMgdGhlIFdlYlNvY2tldCBjb25uZWN0aW9uIGFuZCBoYW5kbGVzIHJlY29ubmVjdGlvbiBsb2dpYy4KICAgICAgICAiIiIKICAgICAgICB3aGlsZSBzZWxmLnJlY29ubmVjdF9hdHRlbXB0cyA8IHNlbGYubWF4X3JlY29ubmVjdF9hdHRlbXB0czoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYXN5bmMgd2l0aCB3ZWJzb2NrZXRzLmNvbm5lY3QoCiAgICAgICAgICAgICAgICAgICAgc2VsZi51cmwsCiAgICAgICAgICAgICAgICAgICAgZXh0cmFfaGVhZGVycz17IkNvb2tpZSI6IHNlbGYuY29va2llc30KICAgICAgICAgICAgICAgICkgYXMgd3M6CiAgICAgICAgICAgICAgICAgICAgc2VsZi53cyA9IHdzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfYXR0ZW1wdHMgPSAwCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDb25uZWN0ZWQgdG8ge3NlbGYudXJsfSIpCgogICAgICAgICAgICAgICAgICAgICMgU2VuZCAncnQ6am9pbicgbWVzc2FnZQogICAgICAgICAgICAgICAgICAgIGpvaW5fbWVzc2FnZSA9IHNlbGYuZ2V0X2pvaW5fbWVzc2FnZSgpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5zZW5kX21lc3NhZ2UoInJ0OmpvaW4iLCBqb2luX21lc3NhZ2UpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU2VudCAncnQ6am9pbicgbWVzc2FnZToge2pzb24uZHVtcHMoam9pbl9tZXNzYWdlKX0iKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiV2FpdGluZyBmb3IgJ3J0OmpvaW5PaycgbWVzc2FnZS4uLiIpCgogICAgICAgICAgICAgICAgICAgICMgU3RhcnQgaGFuZGxpbmcgaW5jb21pbmcgbWVzc2FnZXMKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlX3Rhc2sgPSBhc3luY2lvLmNyZWF0ZV90YXNrKHNlbGYubWVzc2FnZV9oYW5kbGVyKCkpCgogICAgICAgICAgICAgICAgICAgICMgV2FpdCB1bnRpbCBzZXNzaW9uIElEIGlzIHJlY2VpdmVkCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLndhaXRfZm9yKHNlbGYucHVzaF9va19ldmVudC53YWl0KCksIHRpbWVvdXQ9MTApCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IGFzeW5jaW8uVGltZW91dEVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIkRpZCBub3QgcmVjZWl2ZSAncnQ6am9pbk9rJyBhY2tub3dsZWRnbWVudCBpbiB0aW1lLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYucmVjb25uZWN0KCkKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAgICAgIyBQcm9jZWVkIHdpdGggb3BlcmF0aW9ucwogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYucGVyZm9ybV9vcGVyYXRpb25zKCkKCiAgICAgICAgICAgICAgICAgICAgIyBLZWVwIHRoZSBjb25uZWN0aW9uIGFsaXZlCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbWVzc2FnZV90YXNrCgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYiQ29ubmVjdGlvbiBlcnJvcjoge2V9IikKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYucmVjb25uZWN0KCkKCiAgICBhc3luYyBkZWYgcmVjb25uZWN0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEhhbmRsZXMgcmVjb25uZWN0aW9uIGxvZ2ljIHdpdGggZXhwb25lbnRpYWwgYmFja29mZi4KICAgICAgICAiIiIKICAgICAgICBzZWxmLnJlY29ubmVjdF9hdHRlbXB0cyArPSAxCiAgICAgICAgaWYgc2VsZi5yZWNvbm5lY3RfYXR0ZW1wdHMgPj0gc2VsZi5tYXhfcmVjb25uZWN0X2F0dGVtcHRzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIk1heGltdW0gcmVjb25uZWN0aW9uIGF0dGVtcHRzIHJlYWNoZWQuIEV4aXRpbmcuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgd2FpdF90aW1lID0gbWluKDIgKiogc2VsZi5yZWNvbm5lY3RfYXR0ZW1wdHMsIDYwKQogICAgICAgIGxvZ2dlci5pbmZvKGYiQXR0ZW1wdGluZyB0byByZWNvbm5lY3QgaW4ge3dhaXRfdGltZX0gc2Vjb25kcyAoQXR0ZW1wdCB7c2VsZi5yZWNvbm5lY3RfYXR0ZW1wdHN9L3tzZWxmLm1heF9yZWNvbm5lY3RfYXR0ZW1wdHN9KS4uLiIpCiAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcCh3YWl0X3RpbWUpCiAgICAgICAgbG9nZ2VyLmluZm8oIlJlY29ubmVjdGluZy4uLiIpCiAgICAgICAgIyBSZXNldCBzZXNzaW9uLXNwZWNpZmljIGRhdGEKICAgICAgICBzZWxmLnNlc3Npb25faWQgPSBOb25lCiAgICAgICAgc2VsZi5jaGVja3BvaW50ID0gTm9uZQogICAgICAgIHNlbGYucHVzaF9va19ldmVudC5jbGVhcigpCgogICAgYXN5bmMgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFN0YXJ0cyB0aGUgY2xpZW50LCBjb25uZWN0cyB0byB0aGUgc2VydmVyLCBhbmQgaW5pdGlhdGVzIG9wZXJhdGlvbnMuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhd2FpdCBzZWxmLmNvbm5lY3QoKQogICAgICAgIGV4Y2VwdCBLZXlib2FyZEludGVycnVwdDoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkludGVycnVwdGVkIGJ5IHVzZXIuIikKICAgICAgICAgICAgaWYgc2VsZi53czoKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYud3MuY2xvc2UoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmIkFuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQ6IHtlfSIpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGxvYWRfY3JlZGVudGlhbHNfZnJvbV9lbnYoKToKICAgICAgICAiIiIKICAgICAgICBMb2FkcyBjcmVkZW50aWFscyBmcm9tIGVudmlyb25tZW50IHZhcmlhYmxlcy4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgdHVwbGU6IEEgdHVwbGUgY29udGFpbmluZyB1cmwsIGNvb2tpZXMsIHRyZWVfaWQsIHVzZXJfaWQsIGF1dGhfdG9rZW4KICAgICAgICAiIiIKICAgICAgICB1cmwgPSAid3NzOi8vYXBwLmdpbmdrb3dyaXRlci5jb20vd3MiICAjIEZpeGVkIFVSTAogICAgICAgIGNvb2tpZXMgPSAoCiAgICAgICAgICAgICJjb25uZWN0LnNpZD1zJTNBWGtKRkk5OGVxUUdacjFSQUdCSWZZc1lCVnItVXV0M1UuMWttOHFzekJZUmJ0NHk4UHQlMkZyZkZpSllpSnhPYW5EVFZtRzVNMW5lQk84OyAiCiAgICAgICAgICAgICJfbHJfdWZfLWp0cWpyYz03NTM2MzE5NS0yZjIzLTQzNjctYTI4MC0yODVmOTkwZjdlMDU7ICIKICAgICAgICAgICAgIl9CRUFNRVJfVVNFUl9JRF9tWUpMUkltWTM4NTQ3PTI1ZGRmNzUxLTBjNTktNDU4Ni04MDJiLTM2M2M5YWU4NjIyMjsgIgogICAgICAgICAgICAiX0JFQU1FUl9GSVJTVF9WSVNJVF9tWUpMUkltWTM4NTQ3PTIwMjQtMTAtMTJUMjM6MjU6NTEuMzIwWjsgIgogICAgICAgICAgICAiX19zdHJpcGVfbWlkPWNmNmQ3MzhiLTJmNGYtNDA1Ni04MGMxLTFjOWM3MWFkZDUzNWI1MWFiYjsgIgogICAgICAgICAgICAiX0JFQU1FUl9MQVNUX1BPU1RfU0hPV05fbVlKTFJJbVkzODU0Nz1udWxsOyAiCiAgICAgICAgICAgICJfQkVBTUVSX0RBVEVfbVlKTFJJbVkzODU0Nz0yMDI0LTExLTAyVDE4OjEyOjUxLjU0NFo7ICIKICAgICAgICAgICAgIl9CRUFNRVJfRklMVEVSX0JZX1VSTF9tWUpMUkltWTM4NTQ3PWZhbHNlOyAiCiAgICAgICAgICAgICJfX3N0cmlwZV9zaWQ9ZmY2YTQzMmUtYTkxMS00YWVjLWI3MDUtZjRkMmVlMjBiODIxYTc5MGUzOyAiCiAgICAgICAgICAgICJfbHJfdGFic18tanRxanJjJTJGZ2luZ2tvLXdyaXRlci1wcm9kdWN0aW9uPXslMjJzZXNzaW9uSUQlMjI6NCUyQyUyMnJlY29yZGluZ0lEJTIyOiUyMjUtMzBjY2YwMzQtN2JlOC00YTA5LTgxOGMtZDBiYjI1NzA0Yzc1JTIyJTJDJTIybGFzdEFjdGl2aXR5JTIyOjE3MzA2MzMxNDE4MTclMkMlMjJoYXNBY3Rpdml0eSUyMjp0cnVlfTsgIgogICAgICAgICAgICAiX2xyX2hiXy1qdHFqcmMlMkZnaW5na28td3JpdGVyLXByb2R1Y3Rpb249eyUyMmhlYXJ0YmVhdCUyMjoxNzMwNjMzMTQxODE4fSIKICAgICAgICApCiAgICAgICAgdHJlZV9pZCA9ICI2b2o0UnpiIiAgIyBBcyBwZXIgeW91ciAncnQ6am9pbicgbWVzc2FnZQogICAgICAgIHVzZXJfaWQgPSAiaDlvZ29laDJvMnU3IiAgIyBBcyBwZXIgeW91ciAncnQ6am9pbicgbWVzc2FnZQogICAgICAgIGF1dGhfdG9rZW4gPSAiVExPQmNGSENPUFU2b0k2bVlIS2RwUjVGIiAgIyBBcyBwZXIgeW91ciAncnQ6am9pbicgbWVzc2FnZQogICAgICAgIHJldHVybiB1cmwsIGNvb2tpZXMsIHRyZWVfaWQsIHVzZXJfaWQsIGF1dGhfdG9rZW4KCgphc3luYyBkZWYgbWFpbigpOgogICAgIiIiCiAgICBNYWluIGZ1bmN0aW9uIHRvIHN0YXJ0IHRoZSBHaW5na29XZWJzb2NrZXRDbGllbnQuCiAgICAiIiIKICAgICMgTG9hZCBjcmVkZW50aWFscyBkaXJlY3RseSBmcm9tIHByb3ZpZGVkIGRhdGEKICAgIFVSTCwgQ09PS0lFUywgVFJFRV9JRCwgVVNFUl9JRCwgQVVUSF9UT0tFTiA9IEdpbmdrb1dlYnNvY2tldENsaWVudC5sb2FkX2NyZWRlbnRpYWxzX2Zyb21fZW52KCkKCiAgICBjbGllbnQgPSBHaW5na29XZWJzb2NrZXRDbGllbnQoVVJMLCBDT09LSUVTLCBUUkVFX0lELCBVU0VSX0lELCBBVVRIX1RPS0VOKQogICAgYXdhaXQgY2xpZW50LnN0YXJ0KCkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgYXN5bmNpby5ydW4obWFpbigpKQ==
{% endcodeblock %}
