<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://ib.bsb.br/feed.xml" rel="self" type="application/atom+xml" /><link href="https://ib.bsb.br/" rel="alternate" type="text/html" /><updated>2025-10-04T11:19:31+00:00</updated><id>https://ib.bsb.br/feed.xml</id><title type="html">infoBAG</title><entry><title type="html">feed2exec</title><link href="https://ib.bsb.br/feed2exec/" rel="alternate" type="text/html" title="feed2exec" /><published>2025-10-04T00:00:00+00:00</published><updated>2025-10-04T11:15:05+00:00</updated><id>https://ib.bsb.br/feed2exec</id><content type="html" xml:base="https://ib.bsb.br/feed2exec/"><![CDATA[<p>bibref https://feed2exec.readthedocs.io/_/downloads/en/latest/pdf/</p>

<h1 id="feed2exec-documentation">feed2exec Documentation</h1>

<p>feed2exec is a simple program that runs custom actions on new RSS feed items (or whatever feedparser can read). It currently has support for writing into mailboxes (Maildir folders) or executing commands, but more actions can be easily implemented through plugins. Email are saved as multipart plain/HTML and can be sent to arbitrary folders.</p>

<p>CONTENTS 1feed2exec Documentation, Release ??? 2 CONTENTS CHAPTER</p>

<h1 id="one-examples">ONE EXAMPLES</h1>

<p>Simple run with no side effects:</p>

<p>feed2exec parse https://www.nasa.gov/rss/dyn/breaking_news.rss –output echo –args ‘</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>{item.title} ‘</p>

<p>Saving feed items to a Maildir folder:</p>

<p>feed2exec add “NASA breaking news” https://www.nasa.gov/rss/dyn/breaking_news.rss –</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>folder nasa feed2exec fetch</p>

<p>This creates the equivalent of this configuration file in ~/.config/feed2exec.ini :</p>

<p>[DEFAULT] output = feed2exec.plugins.maildir mailbox = ~/Maildir [NASA breaking news] folder = nasa url = https://www.nasa.gov/rss/dyn/breaking_news.rss</p>

<p>Send new feed items to Transmission:</p>

<p>feed2exec add “Example torrent list” http://example.com/torrents/feed –output␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>transmission –folder /srv/incoming</p>

<p>Send new feed items to Mastodon, using the toot commandline client:</p>

<p>feed2exec add “My site” http://example.com/blog/feed –output exec –args ‘toot post “</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>{item.title} {item.link} “’</p>

<p>Send new feed items to Twitter, using the tweet commandline client from python-twitter:</p>

<p>feed2exec add “My site on twitter” http://example.com/blog/feed –output exec –args</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>‘tweet “ {item.title:.40s} {item.link:.100s} “’</p>

<p>Show feed contents:</p>

<p>feed2exec add “NASA breaking news” https://www.nasa.gov/rss/dyn/breaking_news.rss –</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>output echo –args “ {item.title} {item.link} “feed2exec fetch</p>

<p>3feed2exec Documentation, Release ???</p>

<p>Multiple feeds can also be added with the OPML import command. See the usage document for more information including known issues and limitations.</p>

<p>4 Chapter 1. Examples CHAPTER</p>

<h1 id="two-installation">TWO INSTALLATION</h1>

<p>This can be installed using the normal Python procedures:</p>

<p>pip install feed2exec</p>

<p>It can also be installed from source, using:</p>

<p>pip install .</p>

<p>It can also be ran straight from the source, using:</p>

<p>python -m feed2exec</p>

<p>Important: feed2exec is explicitly written for Python 3. It may be possible to backport it to Python 2 if there is sufficient demand, but there are too many convenient Python3 constructs to make this useful. Furthermore, all dependencies are well-packaged for Py3 and the platform is widely available. Upgrade already. The program may also be available as an official package from your Linux distribution. Source, documentation and issues are available on GitLab.</p>

<p>Note: feed2exec relies on the feedparser module to parse feeds and as such has all the bugs and limitations of that modules. In particular, feeds with non-standard dates will break the parser, unless the dateparser module is installed.</p>

<p>5feed2exec Documentation, Release ??? 6 Chapter 2. Installation CHAPTER</p>

<h1 id="three-why-the-name">THREE WHY THE NAME?</h1>

<p>There are already feed2tweet and feed2imap out there so I figured I would just reuse the prefix and extend both programs at once. Contents:</p>

<h1 id="31-feed2exec-manual-page">3.1 feed2exec manual page</h1>

<h1 id="311-synopsis">3.1.1 Synopsis</h1>

<p>feed2exec {add,ls,rm,fetch,import,export}</p>

<h1 id="312-description">3.1.2 Description</h1>

<p>This command will take a configured set of feeds and fire specific plugin for every new item found in the feed.</p>

<h1 id="313-options">3.1.3 Options</h1>

<p>–version Show the version and exit.</p>

<p>–loglevel choose specific log level [default: WARNING]</p>

<p>-v, –verbose show what is happening (loglevel: VERBOSE)</p>

<p>-d, –debug show debugging information (loglevel: DEBUG)</p>

<p>–syslog LEVEL send LEVEL logs to syslog</p>

<p>–config TEXT use a different configuration file</p>

<p>–database DB use a different database</p>

<p>-h, –help Show this message and exit.</p>

<p>7feed2exec Documentation, Release ???</p>

<h1 id="314-examples">3.1.4 Examples</h1>

<p>Simple run with no side effects:</p>

<p>feed2exec parse https://www.nasa.gov/rss/dyn/breaking_news.rss –output echo –args ‘</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>{item.title} ‘</p>

<p>Saving feed items to a Maildir folder:</p>

<p>feed2exec add “NASA breaking news” https://www.nasa.gov/rss/dyn/breaking_news.rss –</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>folder nasa feed2exec fetch</p>

<p>This creates the equivalent of this configuration file in ~/.config/feed2exec.ini :</p>

<p>[DEFAULT] output = feed2exec.plugins.maildir mailbox = ~/Maildir [NASA breaking news] folder = nasa url = https://www.nasa.gov/rss/dyn/breaking_news.rss</p>

<p>Send new feed items to Transmission:</p>

<p>feed2exec add “Example torrent list” http://example.com/torrents/feed –output␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>transmission –folder /srv/incoming</p>

<p>Send new feed items to Mastodon, using the toot commandline client:</p>

<p>feed2exec add “My site” http://example.com/blog/feed –output exec –args ‘toot post “</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>{item.title} {item.link} “’</p>

<p>Send new feed items to Twitter, using the tweet commandline client from python-twitter:</p>

<p>feed2exec add “My site on twitter” http://example.com/blog/feed –output exec –args</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>‘tweet “ {item.title:.40s} {item.link:.100s} “’</p>

<p>Show feed contents:</p>

<p>feed2exec add “NASA breaking news” https://www.nasa.gov/rss/dyn/breaking_news.rss –</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>output echo –args “ {item.title} {item.link} “feed2exec fetch</p>

<h1 id="315-commands">3.1.5 Commands</h1>

<p>• parse</p>

<p>• fetch</p>

<p>• add</p>

<p>• ls</p>

<p>8 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<p>• rm</p>

<p>• import</p>

<p>• export</p>

<p>parse</p>

<p>Usage:</p>

<p>parse URL [–output PLUGIN [–args ARG [ARG […]]] [–filter PLUGIN] [–filter_args ARG [ARG […]]] [–mailbox PATH] [–folder PATH]</p>

<p>The parse command loads and parses a single feed, without touching the database. This is similar to calling add then</p>

<p>fetch on a single feed, but the feed is not kept in the configuration. This is designed to make quick tests with a new feed. The arguments are the same as the add command.</p>

<p>fetch</p>

<p>Usage:</p>

<table>
  <tbody>
    <tr>
      <td>fetch [–parallel</td>
      <td>-p</td>
      <td>–jobs N</td>
      <td>-j N] [–force</td>
      <td>-f] [–pattern pattern]</td>
    </tr>
  </tbody>
</table>

<p>The fetch command iterates through all the configured feeds or those matching the pattern substring if provided. Options:</p>

<p>–pattern TEXT only fetch feeds matching name or URL</p>

<p>–parallel parse feeds in the background to improve performance</p>

<p>-j, –jobs N start N jobs in parallel, implies –parallel which defaults to the number of CPUs detected on the machine</p>

<p>-f, –force skip reading and writing the cache and will consider all entries as new</p>

<p>-n, –catchup tell output plugins plugins to simulate their actions</p>

<p>add</p>

<p>Usage:</p>

<p>add NAME URL [–output PLUGIN [–args ARG [ARG […]]] [–filter PLUGIN] [–filter_args ARG [ARG […]]] [–mailbox PATH] [–folder PATH]</p>

<p>The add command adds the given feed NAME that will be fetched from the provided URL .Options:</p>

<p>3.1. feed2exec manual page 9feed2exec Documentation, Release ???</p>

<p>–output PLUGIN use PLUGIN as an output module. defaults to maildir to store in a mailbox. use null or echo to just fetch the feed without doing any-thing. Modules are searched in the feed2exec.plugins package unless the name contains a dot in which case the whole Python search path is used.</p>

<p>–args ARGS pass arguments ARGS to the output plugin. supports interpolation of feed parameters using, for example {title}</p>

<p>–filter PLUGIN filter feed items through the PLUGIN filter plugin</p>

<p>–filter_args ARGS arguments passed to the filter plugin</p>

<p>–mailbox PATH folder to store email into, defaults to ~/Maildir .</p>

<p>–folder PATH subfolder to store the email into Those parameters are documented more extensively in their equivalent settings in the configuration file, see below.</p>

<p>ls</p>

<p>The ls command lists all configured feeds as JSON packets.</p>

<p>rm</p>

<p>Usage:</p>

<p>rm NAME</p>

<p>Remove the feed named NAME from the configuration.</p>

<p>import</p>

<p>Usage:</p>

<p>import PATH</p>

<p>Import feeds from the file named PATH. The file is expected to have outline elements and only the title and xmlUrl</p>

<p>elements are imported, as NAME and URL parameters, respectively.</p>

<p>export</p>

<p>Usage:</p>

<p>export PATH</p>

<p>Export feeds into the file named PATH. The file will use the feed NAME elements as title and the URL as xmlUrl .</p>

<p>10 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<h1 id="316-files">3.1.6 Files</h1>

<p>Configuration file</p>

<p>The configuration file is loaded from (and written to, by add ) ~/.config/feed2exec.ini or $XDG_CONFIG_HOME/ feed2exec.ini . It can also be specified with the –config commandline parameter. This is an example configuration snippet:</p>

<p>[NASA breaking news] url = https://www.nasa.gov/rss/dyn/breaking_news.rss output = feed2exec.plugins.echo args = {title} {link}</p>

<p>Naturally, those settings can be changed directly in the config file. Note that there is a [DEFAULT] section that can be used to apply settings to all feeds. For example, this will make all feeds store new items in a maildir subfolder:</p>

<p>[DEFAULT] output = feed2exec.plugins.maildir folder = feeds</p>

<p>This way individual feeds do not need to be individually configured.</p>

<p>Note: feed2exec does not take care of adding the folder to “subscriptions” in the mailbox. it is assumed that folders are auto-susbcribed or the user ignores subscription. if that is a problem, you should subscribe to the folder by hand in your email client when you add a new config. you can also subscribe to a folder (say feeds above) directly using the</p>

<p>doveadm mailbox subscribe feeds command in Dovecot, for example. The following configuration parameters are supported:</p>

<p>name</p>

<p>Human readable name for the feed. Equivalent to the NAME argument in the add command.</p>

<p>url</p>

<p>Address to fetch the feed from. Can be HTTP or HTTPS, but also file:// resources for test pur-poses.</p>

<p>output</p>

<p>Output plugin to use. Equivalent to the –output option in the add command.</p>

<p>args</p>

<p>Arguments to pass to the output plugin. Equivalent to the –args option in the add command.</p>

<p>filter</p>

<p>Filter plugin to use. Equivalent to the –filter option in the add command.</p>

<p>mailbox</p>

<p>Store emails in that mailbox prefix. Defaults to ~/Maildir .</p>

<p>folder</p>

<p>Subfolder to use when writing to a mailbox. By default, a slugified version of the feed name (where spaces and special character are replaced by -) is used. For example, the feed named “NASA breaking news” would be stored in ~/Maildir/nasa-breaking-news/ . Note that the mailbox prefix is used only if the folder path is relative.</p>

<p>catchup</p>

<p>Skip to the latest feed items. The feed is still read and parsed, and new feed items are added to the database, but output plugins are never called.</p>

<p>3.1. feed2exec manual page 11 feed2exec Documentation, Release ???</p>

<p>pause</p>

<p>Completely skip feed during fetch or parse. Similar to catchup, but doesn’t fetch the feed at all and doesn’t touch the cache. Here is a more complete example configuration with all the settings used:</p>

<h1 id="this-section-will-apply-to-all-feeds-default--special-folder-location-for-maildir-i-use-this-when-i-have-multiple--accounts-synchronized-with-offlineimap-mailbox--maildirremote--a-feed-to-store-nasa-breaking-news-entry-in-a-nasa-subfolder--this-also-demonstrates-the-droptitle-filter-nasa-breaking-news-url--httpswwwnasagovrssdynbreaking_newsrss-folder--nasa-filter--feed2execpluginsdroptitle-filter_args--trump--some-maildir-storage-require-dots-to-get-subfolders-for-example--this-will-store-messages-in-inboxfeedsimages-on-dovecot-nasa-image-of-the-day-url--httpswwwnasagovrssdynlg_image_of_the_dayrss-folder--feedsimages--same-feed-but-save-to-wayback-machine-nasa-iotd-wayback-url--httpswwwnasagovrssdynlg_image_of_the_dayrss-output--feed2execpluginswayback--this-demonstrates-the-emptysummary-filter-which-fixes-github-feeds--that-lack-a-proper-summary-restic-url--httpsgithubcomresticrestictagsatom-filter--feed2execpluginsemptysummary--saving-to-a-mbox-folder-one-file-per-feed-instead-of-one-file-per-item-international-space-station-reports-url--httpblogsnasagovstationreportfeed-mailbox--mail-folder--stationreportmbx--simple-generic-exec-call-example-check-for-broken-links-using-linkchecker-nasa-linkchecker-url--httpswwwnasagovrssdynbreaking_newsrss-output--feed2execpluginsexec-args--linkchecker-check-extern-no-robots-recursion-level-1-quiet-itemlink-">this section will apply to all feeds [DEFAULT] # special folder location for maildir. I use this when I have multiple # accounts synchronized with Offlineimap mailbox = ~/Maildir/Remote/ # a feed to store NASA breaking news entry in a “nasa” subfolder # this also demonstrates the droptitle filter [NASA breaking news] url = https://www.nasa.gov/rss/dyn/breaking_news.rss folder = nasa filter = feed2exec.plugins.droptitle filter_args = trump # some maildir storage require dots to get subfolders. for example, # this will store messages in INBOX/feeds/images/ on Dovecot [NASA image of the day] url = https://www.nasa.gov/rss/dyn/lg_image_of_the_day.rss folder = .feeds.images # same feed, but save to wayback machine [NASA IOTD wayback] url = https://www.nasa.gov/rss/dyn/lg_image_of_the_day.rss output = feed2exec.plugins.wayback # this demonstrates the emptysummary filter, which fixes GitHub feeds # that lack a proper summary [restic] url = https://github.com/restic/restic/tags.atom filter = feed2exec.plugins.emptysummary # saving to a mbox folder, one file per feed instead of one file per item [International Space Station Reports] url = http://blogs.nasa.gov/stationreport/feed/ mailbox = ~/Mail/ folder = stationreport.mbx # simple generic exec call example: check for broken links using linkchecker [NASA linkchecker] url = https://www.nasa.gov/rss/dyn/breaking_news.rss output = feed2exec.plugins.exec args = linkchecker –check-extern –no-robots –recursion-level 1 –quiet ‘{item.link} ‘</h1>

<h1 id="same-but-with-a-ikiwiki-rss-feed-which-needs-fixing-ikiwiki-linkchecker-url--httpikiwikiinforecentchangesindexrss-output--feed2execpluginsexec-filter--feed2execpluginsikiwiki_recentchanges">same, but with a Ikiwiki RSS feed, which needs fixing [Ikiwiki linkchecker] url = http://ikiwiki.info/recentchanges/index.rss output = feed2exec.plugins.exec filter = feed2exec.plugins.ikiwiki_recentchanges</h1>

<blockquote>
  <p>(continues on next page)</p>
</blockquote>

<p>12 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<blockquote>
  <p>(continued from previous page)</p>
</blockquote>

<p>args = linkchecker –check-extern –no-robots –recursion-level 1 –quiet ‘{item.link} ‘</p>

<h1 id="retweet-hurricane-news-nasa-hurricane-breaking-news-url--httpswwwnasagovrssdynhurricaneupdaterss-output--feed2execpluginsexec-args--tweet-itemtitle40s-itemlink100s--same-but-on-the-mastodon-network--we-can-have-multiple-entries-with-the-same-url-without-problems-as--long-as-the-feed-name-is-different-it-does-mean-that-the-feed-will--be-fetched-and-parsed-multiple-times-unfortunately--this-could-be-improved-to-include-the-itemsummary--and-extra-markup--for-example-nasa-hurricane-breaking-news---mastodon-url--httpswwwnasagovrssdynhurricaneupdaterss-output--feed2execpluginsexec--unfortunately-this-will-noisily-report-the-url-of-the-posted-link--which-you-may-not-want-to-avoid-that-encourage-upstream-to-do-the--right-thing-httpsgithubcomihabunektootissues46--or-use--another-tool-listed-here--httpsgithubcomtootsuitedocumentationblobmasterusing-mastodonappsmd-args--toot-post-itemtitle-itemlink--output-is-disabled-here-feed-will-be-fetched-and-parsed-but-no--toot-will-be-sent-catchup--true--same-but-on-the-pumpio-network-nasa-hurricane-breaking-news---pump-url--httpswwwnasagovrssdynhurricaneupdaterss-output--feed2execpluginsexec-args--p-post-note-itemtitle-itemlink--crude-podcast-client-nasa-what-up-url--httpswwwnasagovrssdynwhats_uprss-output--feed2execpluginsexec--xxx-this-doesn-t-handle-errors-properly-if-there-is-a-feed-without--enclosures-the-whole-thing-will-crash-args--wget--p-srvpodcastsnasa-itemenclosures0href--feed-is-paused-here-feed-will-not-be-fetched-and-parsed-at-all-and--no-post-will-be-sent-pause--true--download-torrents-linked-from-a-rss-feed-torrents-url--httpexamplecomtorrentsrss-output--feed2execpluginsexec-args--transmission-remote--a-itemlink---w-srvincoming-">retweet hurricane news [NASA Hurricane breaking news] url = https://www.nasa.gov/rss/dyn/hurricaneupdate.rss output = feed2exec.plugins.exec args = tweet “{item.title:.40s} {item.link:.100s}” # same, but on the mastodon network ## we can have multiple entries with the same URL without problems, as # long as the feed name is different. it does mean that the feed will # be fetched and parsed multiple times, unfortunately. ## this could be improved to include the ‘{item.summary} ‘ and extra markup, # for example. [NASA Hurricane breaking news - Mastodon] url = https://www.nasa.gov/rss/dyn/hurricaneupdate.rss output = feed2exec.plugins.exec # unfortunately, this will noisily report the URL of the posted link, # which you may not want. to avoid that, encourage upstream to do the # right thing: https://github.com/ihabunek/toot/issues/46 … or use # another tool listed here: # https://github.com/tootsuite/documentation/blob/master/Using-Mastodon/Apps.md args = toot post “{item.title} {item.link}” # output is disabled here. feed will be fetched and parsed, but no # toot will be sent catchup = True # same, but on the Pump.io network [NASA Hurricane breaking news - Pump] url = https://www.nasa.gov/rss/dyn/hurricaneupdate.rss output = feed2exec.plugins.exec args = p post note “{item.title} {item.link}” # crude podcast client [NASA What up?] url = https://www.nasa.gov/rss/dyn/whats_up.rss output = feed2exec.plugins.exec # XXX: this doesn ‘t handle errors properly: if there is a feed without # enclosures, the whole thing will crash. args = wget -P /srv/podcasts/nasa/ “{item.enclosures[0].href}” # feed is paused here. feed will not be fetched and parsed at all and # no post will be sent. pause = True # download torrents linked from a RSS feed [torrents] url = http://example.com/torrents.rss output = feed2exec.plugins.exec args = transmission-remote -a ‘{item.link} ‘ -w ‘/srv/incoming ‘</h1>

<blockquote>
  <p>(continues on next page)</p>
</blockquote>

<p>3.1. feed2exec manual page 13 feed2exec Documentation, Release ???</p>

<blockquote>
  <p>(continued from previous page)</p>
</blockquote>

<h1 id="same-thing-with-an-actual-plugin-torrents-url--httpexamplecomtorrentsrss-output--feed2execpluginstransmission-args--seedboxexamplecom-folder--srvincoming">same thing with an actual plugin [torrents] url = http://example.com/torrents.rss output = feed2exec.plugins.transmission args = seedbox.example.com folder = /srv/incoming</h1>

<p>Cache database</p>

<p>The feeds cache is stored in a feed2exec.db file. It is a SQLite database and can be inspected using standard sqlite tools. It is used to keep track of which feed and items have been processed. To clear the cache, you can simply remove the file, which will make the program process all feeds items from scratch again. In this case, you should use the</p>

<p>–catchup argument to avoid duplicate processing. You can also use the null output plugin to the same effect.</p>

<h1 id="317-limitations">3.1.7 Limitations</h1>

<p>Feed support is only as good as feedparser library which isn’t as solid as I expected. In particular, I had issues with feeds without dates and without guid. Unit test coverage is incomplete, but still pretty decent, above 90%. The exec plugin itself is not well tested and may have serious security issues. API, commandline interface, configuration file syntax and database format can be changed until the 1.0 release is published, at which point normal Semantic Versioning semantics apply. The program is written mainly targeting Python 3.5 and 3.7, but should support later releases as well. See the setup.py</p>

<p>classification for an authoritative reference. Python 2.7 is not supported anymore. The SQL storage layer is badly written and is known to trigger locking issues with SQLite when doing multiprocessing. The global LOCK object could be used to work around this issue but that could mean pretty bad coupling. A good inspiration may be the beets story about this problem. And of course, another alternative would be to considering something like SQLalchemy instead of rolling our own ORM. There has, however, been some improvements to the locking recently, although that has been done with thread instead of process -specific locks. Older feed items are not purged from the database when they disappear from the feed, which may lead to database bloat in the long term. Similarly, there is no way for plugins to remove old entry that expire from the feed.</p>

<h1 id="318-see-also">3.1.8 See also</h1>

<p>feed2exec-plugins(1) , feed2imap(1) , rss2email(1)</p>

<p>14 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<h1 id="32-design">3.2 Design</h1>

<p>This is a quick prototype that turned out to be quite usable. The design is minimal: some home-made ORM for the feed storage, crude parallelism with the multiprocessing module and a simple plugin API using importlib .More information about known issues and limitations in the feed2exec manual page document.</p>

<h1 id="321-quick-tour">3.2.1 Quick tour</h1>

<p>The most common workflow is through the fetch subcommand and goes something like this: 1. <strong>main</strong>.py is the main entrypoint, managed through the click module, which normally calls func-tions defined in controller.py . The base command ( <strong>main</strong>.main ) creates a feed2exec.controller. FeedManager object which gets passed to subcommands. In our case, it passes the control to the fetch sub-command. 2. The fetch command calls the feed2exec.controller.FeedManager.fetch() function which creates a</p>

<p>feed2exec.model.Feed object that is then used to parse the feed and return it as an opaque data object as returned by feedparser . The feed is parsed (and, below, dispatched) only if it not already present in the cache, managed by the cachecontrol module. 3. fetch then calls the feed2exec.controller.FeedManager.dispatch() function that calls the various filter and output plugins, passing in the feed configuration and one item at a time. The filters can modify the feed items while the output plugins are responsible for writing them somewhere. That distinction is mostly arbitrary, but the return values of the output plugins matter, while filters do not. The feed cache is stored in a minimal sqlite3 database. A table keeps track of which feed item has been seen and another is the backend for the cachecontrol module and has a copy of the actual requests, keyed by URL. Configuration is stored in a .ini file or whatever configparser supports. It was originally stored in the database as well, but it was found inconvenient to modify by hand and a configuration file was used instead. The .ini file format was chosen because it is well supported by Python and allows for default settings. There is the possibility for this project to cover more than RSS/Atom feeds. In theory, the parse function could also be pluggable and support reading from other data sources like Twitter or Facebook, which would bring us closer to the IFTTT concept.</p>

<h1 id="322-plugin-system">3.2.2 Plugin system</h1>

<p>Plugins are documented in the Plugins section. You can also refer to the Matchtitleregex section if you wish to write a new plugin or extend an existing one. The plugin system uses a simple importlib based architecture where plugin are simple Python modules loaded at runtime based on a module path provided by the user. This pattern was inspired by a StackOverflow discussion. The following options were also considered:</p>

<p>• pluggy: used by py.test, tox and devpi</p>

<p>• yapsy</p>

<p>• PluginBase</p>

<p>• plugnplay</p>

<p>• click-plugins: relevant only to add new commands</p>

<p>• PyPA plugin discovery</p>

<p>3.2. Design 15 feed2exec Documentation, Release ???</p>

<p>Those options were ultimately not used because they add an additional dependency and are more complicated than a simple import . We also did not need plugin listing or discovery, which greatly simplifies our design. There is some code duplication between different parts (e.g. the feed2exec.plugins.output() and feed2exec. plugins.filter() plugin interfaces, the maildir and mbox plugins, etc), but never more than twice.</p>

<h1 id="323-concurrent-processing">3.2.3 Concurrent processing</h1>

<p>The threading design may be a little clunky and is certainly less tested, which is why it is disabled by default (use</p>

<p>–parallel to use it). There are known deadlocks issues with high concurrency scenarios (e.g. with catchup en-abled). I had multiple design in minds: the current one ( multiprocessing.Pool and pool.apply_async ) vs aiohttp</p>

<p>(on the asyncio branch) vs pool.map (on the threadpoolmap branch). The aiohttp design was very hard to diagnose and debug, which made me abandon the whole thing. After reading up on Curio and Trio, I’m tempted to give async/await a try again, but that would mean completely dropping 2.7 compatibility. The pool.map design is just badly adapted, as it would load all the feed’s datastructure in memory before processing them. The current parallel design also doesn’t profit much from the caching system. While before we would spend a lot of time parsing all feeds (in parallel), now most feeds are not parsed anymore (because unchanged) so a lot of time is spent doing HTTP requests, which could be done in parallel (but currently isn’t).</p>

<h1 id="324-test-suite">3.2.4 Test suite</h1>

<p>The test suite is in feed2exec/tests but also as doctest comments in some functions imported from the ecdysis project. You can run all the tests with pytest, using, for example:</p>

<p>pytest-3</p>

<p>This is also hooked into the setup.py command, so this also works:</p>

<p>python3 setup.py test</p>

<p>Note: It’s recommended to use the tox command to run tests, as some tests are picky about dependencies version numbers. That’s how the Continuous Integration (CI) system runs tests, through the .gitlab-ci.yml file. Enabling the catchlog plugin will also enable logging in the test suite which will help diagnostics. Note that some tests will fail in Python 2, as the code is written and tested in Python3. Furthermore, the feed output is taken from an up to date (5.2.1) feedparser version, so the tests are marked as expected to fail for lower versions. You should, naturally, run and write tests before submitting patches. See the Writing tests section for more information about how to write tests. The test suite also uses the betamax module to cache HTTP requests locally so the test suite can run offline. If a new test requires networking, you can simply add a new test doing requests with the right fixture ( betamax_session() )provided by upstream if you are going to do standalone HTTP request (not going through the feed2exec libraries). But you would more likely use the existing session by using the feed2exec.tests.fixtures.feed_manager() fixture, which has a session member you can use. If a new test is added in an existing test, you may need to configure recording (in feed2exec/tests/conftest.py )to new_episodes :</p>

<p>16 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<p>config.default_cassette_options[ ‘record_mode ‘] = ‘none ‘</p>

<p>We commit the recordings in git so the test suite actually runs offline, so be careful about the content added there. Ideally, the license of that content should be documented in debian/copyright .vcrpy was first used for tests since it was simpler and didn’t require using a global requests.session.Session</p>

<p>object. But in the end betamax seems better maintained and more flexible: it supports pytest fixtures, for example, and multiple cassette storage (including vcr backwards compatibility). Configuration is also easier, done in feed2exec/ tests/conftest.py . Using a session also allows us to use a custom user agent.</p>

<h1 id="325-comparison">3.2.5 Comparison</h1>

<p>feed2exec is a fairly new and minimal program, so features you may expect from another feed reader may not be present. I chose to write a new program because, when I started, both existing alternatives were in a questionable state: feed2imap was mostly abandoned and rss2email’s maintainer was also unresponsive. Both were missing the features I was looking for, which was to unify my feed parsers in a single program: i needed something that could deliver mail, run commands and send tweets. The latter isn’t done yet, but I am hoping to complete this eventually. The program may not be for everyone, however, so I made those comparison tables to clarify what feed2exec does compared to the alternatives. General information:</p>

<p>Program Version Date SLOC Language</p>

<p>feed2exec 0.10 2017 989 Python feed2imap 1.2.5 2015 3238 Ruby rss2email 3.9 2014 1754 Python</p>

<p>• version: the version analysed</p>

<p>• date: the date of that release</p>

<p>• SLOC: Source Lines of Codes as counted by sloccount, only counting dominant language (e.g. excluding XML from test feeds) and excluding tests</p>

<p>• Language: primary programming language Delivery options:</p>

<p>Program Maildir Mbox IMAP SMTP sendmail exec</p>

<p>feed2exec ✓ ✓ ✓</p>

<p>feed2imap ✓ ✓</p>

<p>rss2email ✓ ✓ ✓</p>

<p>• maildir: writing to Maildir folders. r2e has a pull request to implement maildir support, but it’s not merged at the time of writing</p>

<p>• IMAP: sending emails to IMAP servers</p>

<p>• SMTP: delivering emails over the SMTP protocol, with authentication</p>

<p>• sendmail: delivering local using the local MTA</p>

<p>• exec: run arbitrary commands to run on new entries. feed2imap has a execurl parameter to execute commands, but it receives an unparsed dump of the feed instead of individual entries. rss2email has a postprocess filter that is a Python plugin that can act on individual (or digest) messages which</p>

<p>3.2. Design 17 feed2exec Documentation, Release ???</p>

<p>could possibly be extended to support arbitrary commands, but that is rather difficult to implement for normal users. Features:</p>

<p>Program Pause OPML Retry Images Filter Reply Digest</p>

<p>feed2exec ✓ ✓ ✓ ✓</p>

<p>feed2imap ✓ ✓ ✓ ✓</p>

<p>rss2email ✓ ✓ ✓ ✓ ✓ ✓</p>

<p>• pause: feed reading can be disabled temporarily by user. in feed2exec, this is implemented with the pause</p>

<p>configuration setting. the catchup option can also be used to catchup with feed entries.</p>

<p>• retry: tolerate temporary errors. For example, feed2imap will report errors only after 10 failures.</p>

<p>• images: download images found in feed. feed2imap can download images and attach them to the email.</p>

<p>• filter: if we can apply arbitrary filters to the feed output. feed2imap can apply filters to the unparsed dump of the feed.</p>

<p>• reply: if the generated email ‘from’ header is usable to make a reply. rss2email has a use-publisher-email</p>

<p>setting (off by default) for this, for example. feed2exec does this by default.</p>

<p>• digest: possibility of sending a single email per run instead of one per entry</p>

<p>Note: feed2imap supports only importing OPML feeds, exporting is supported by a third-party plugin.</p>

<p>Note: feed2exec might one day be expanded to support other feeds than RSS/Atom, and turn into a more generic “if-this-then-that” type of program, to support, say, REST APIs, or Gemini, or whatever. In the meantime, see gmi2email for an alternative supporting Gemini.</p>

<h1 id="326-related-software">3.2.6 Related software</h1>

<p>• rss-bridge can be used to provide RSS feeds for hundreds of sites that do not, including Twitter, Reddit, Youtube, etc</p>

<h1 id="33-api-documentation">3.3 API documentation</h1>

<p>This is the API documentation of the program. It should explain how to create new plugins and navigate the code.</p>

<h1 id="331-controller-module">3.3.1 Controller module</h1>

<p>This is the core modules that processes all feeds and talks to the storage. It’s where most of the logic lies, although the parsing is still currently done inside the model. It dispatches the plugin logic to the plugin module.</p>

<p>18 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<h1 id="332-model">3.3.2 Model</h1>

<p>The “model” keeps track of feeds and their items. It handles configuration and cache storage.</p>

<h1 id="333-main-entry-point">3.3.3 Main entry point</h1>

<p>The main entry point of the program is in the feed2exec.<strong>main</strong> module. This is to make it possible to call the program directly from the source code through the Python interpreter with:</p>

<p>python -m feed2exec</p>

<p>All this code is here rather than in <strong>init</strong>.py to avoid requiring too many dependencies in the base module, which contains useful metadata for setup.py .This uses the click module to define the base command and options.</p>

<h1 id="334-plugins">3.3.4 Plugins</h1>

<p>Plugin interface</p>

<p>In this context, a “plugin” is simply a Python module with a defined interface.</p>

<p>feed2exec.plugins. output (feed , item , lock=None , session=None )</p>

<p>load and run the given plugin with the given arguments an “output plugin” is a simple Python module with an output callable defined which will process arguments and should output them somewhere, for example by email or through another command. the plugin is called (from feed2exec.feeds.parse() ) when a new item is found, unless cache is flushed or ignored. The “callable” can be a class, in which case only the constructor is called or a function. The *args and **kwargs</p>

<p>parameter SHOULD be used in the function definition for forward-compatibility (ie. to make sure new parameters added do not cause a regression). Plugins should also expect to be called in parallel and should use the provided lock (a multiprocessor.Lock object) to acquire and release locks around contentious resources. Finally, the FeedManager will pass along his own session that should be reused by plugins to do requests. This allows plugins to be unit-tested and leverages the built-in cache as well. The following keywords are usually replaced in the arguments:</p>

<p>• {item.link}</p>

<p>• {item.title}</p>

<p>• {item.description}</p>

<p>• {item.published}</p>

<p>• {item.updated}</p>

<p>• {item.guid} The full list of such parameters is determined by the :module:feedparser module. Similarly, feed parameters from the configuration file are accessible.</p>

<p>3.3. API documentation 19 feed2exec Documentation, Release ???</p>

<p>Caution: None of those parameters are sanitized in any way other than what feedparser does, so plugins writing files, executing code or talking to the network should be careful to sanitize the input appropriately. The feed and items are also passed to the plugin as keyword arguments. Plugins should especially respect the</p>

<p>catchup argument that, when set, forbids plugins to do any permanent activity. For example, plugins MUST NOT run commands, write files, or make network requests. In general, “catchup mode” should be fast : it allows users to quickly catchup with new feeds without firing plugins, but it should also allow users to test configura-tions so plugins SHOULD give information to the user about what would have been done by the plugin without</p>

<p>catchup .</p>

<p>Parameters</p>

<p>• feed (dict ) – the feed metadata</p>

<p>• item (dict ) – the updated item</p>

<p>Return object</p>

<p>the loaded plugin</p>

<p>Note: more information about plugin design is in the Matchtitleregex document.</p>

<p>feed2exec.plugins. filter (feed , item , lock=None , session=None )</p>

<p>call filter plugins. very similar to the output plugin, but just calls the filter module member instead of output</p>

<p>Todo: common code with output() should be factored out, but output() takes arguments. . .</p>

<p>feed2exec.plugins. resolve (plugin )</p>

<p>resolve a short plugin name to a loadable plugin path Some parts of feed2exec allow shorter plugin names. For example, on the commandline, users can pass maildir</p>

<p>instead of feed2exec.plugins.maildir .Plugin resolution works like this: 1. search for the module in the feed2exec.plugins namespace 2. if that fails, consider the module to be an absolute path</p>

<p>Note: actual plugins are documented in the Plugins document.</p>

<h1 id="335-utilities">3.3.5 Utilities</h1>

<p>Those are various utilities reused in multiple modules that did not fit anywhere else.</p>

<p>20 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<h1 id="34-plugins">3.4 Plugins</h1>

<p>This is a quick overview of the available plugins.</p>

<h1 id="341-output-plugins">3.4.1 Output plugins</h1>

<p>Archive Echo</p>

<p>class feed2exec.plugins.echo. output (*args , feed=None , **kwargs )</p>

<p>This plugin outputs, to standard output, the arguments it receives. It can be useful to test your configuration. It also creates a side effect for the test suite to determine if the plugin was called. This plugin does a similar thing when acting as a filter.</p>

<p>feed2exec.plugins.echo. filter</p>

<p>This filter just keeps the feed unmodified. It is just there for testing purposes.</p>

<p>Error</p>

<p>feed2exec.plugins.error. output (*args , **kwargs )</p>

<p>The error plugin is a simple plugin which raises an exception when called. It is designed for use in the test suite and should generally not be used elsewhere.</p>

<p>Exec</p>

<p>feed2exec.plugins.exec. output (command , *args , feed=None , **kwargs )</p>

<p>The exec plugin is the ultimate security disaster. It simply executes whatever you feed it without any sort of sanitization. It does avoid to call to the shell and executes the command directly, however. Feed contents are also somewhat sanitized by the feedparser module, see the Sanitization documentation for more information in that regard. That is limited to stripping out hostile HTML tags, however. You should be careful when sending arbitrary parameters to other programs. Even if we do not use the shell to execute the program, an hostile feed could still inject commandline flags to change the program behavior without injecting shell commands themselves. For example, if a program can write files with the -o option, a feed could set their title to -oevil to overwrite the evil file. The only way to workaround that issue is to carefully craft the commandline so that this cannot happen. Alternatively, writing a Python plugin is much safer as you can sanitize the arguments yourself. Example:</p>

<p>[NASA What ‘s up?] url = https://www.nasa.gov/rss/dyn/whats_up.rss output = feed2exec.plugins.exec args = wget -P /srv/archives/nasa/ {item.link}</p>

<p>The above is the equivalent of the archive plugin: it will save feed item links to the given directory.</p>

<p>3.4. Plugins 21 feed2exec Documentation, Release ??? Maildir Mbox Null</p>

<p>feed2exec.plugins.null. output (*args , **kwargs )</p>

<p>This plugin does nothing. It can be useful in cases where you want to catchup with imported feeds.</p>

<p>feed2exec.plugins.null. filter (item=None , *args , **kwargs )</p>

<p>The null filter removes all elements from a feed item</p>

<p>Transmission Wayback</p>

<h1 id="342-filter-plugins">3.4.2 Filter plugins</h1>

<p>Droptitle</p>

<p>feed2exec.plugins.droptitle. filter (*args , feed=None , item=None , **kwargs )</p>

<p>the droptitle filter will drop any feed item with a title matching the given args. Example:</p>

<p>[NASA breaking news] url = https://www.nasa.gov/rss/dyn/breaking_news.rss filter = feed2exec.plugins.droptitle filter_args = Trump</p>

<p>The above will process the feed items according to the global configuration, but will skip any item that has the word “Trump” anywhere in the title field. Arguments are processed as a single string. If you need to match more complex patterns, look at the droptitleregex plugin instead.</p>

<p>Droptitleregex</p>

<p>feed2exec.plugins.droptitleregex. filter (*args , feed=None , item=None , **kwargs )</p>

<p>the droptitleregex filter will drop any feed item with a title matching the given regular expression pattern. Example:</p>

<p>[NASA breaking news] url = https://www.nasa.gov/rss/dyn/breaking_news.rss filter = feed2exec.plugins.droptitleregex filter_args = ^ham</p>

<p>The above configuration processes the feed items based on the global configuration, but it will skip any item whose title starts with the word “ham”.</p>

<p>22 Chapter 3. Why the name? feed2exec Documentation, Release ??? Emptysummary</p>

<p>feed2exec.plugins.emptysummary. filter (*args , feed=None , item=None , **kwargs )</p>

<p>example of fixes for a broken feed, in this case, the GitHub release feed which (sometimes) sends empty contents, in which case the item link field is used as a summary instead.</p>

<p>Html2text Ikiwiki Recentchanges</p>

<p>feed2exec.plugins.ikiwiki_recentchanges. filter (*args , item=None , **kwargs )</p>

<p>the ikiwiki_recentchanges plugin fixes links in ikiwiki feeds Ikiwiki recent changes show all the recent edits to pages, but the <link /> element doesn’t point to the edit page: it points to the recent changes page itself, which make them useless for link checking or archival purposes. This parses the recent changes entries and extracts the relevant links from it. An alternative to this is to use the following entry to generate a special feed in Ikiwiki:</p>

<p>[[!inline pages=”*” feeds=yes feedonly=yes feedfile=archive show=10]]</p>

<p>This generates a feed with proper <link /> elements but requires write access to the wiki. This will also add the date to the URL GUID so that we refresh when a page is updated. Otherwise feed2exec would think the entry has already been passed.</p>

<p>Matchtitleregex</p>

<p>feed2exec.plugins.matchtitleregex. filter (*args , feed=None , item=None , **kwargs )</p>

<p>The matchtitleregex filter selects only the feed items whose title match the given regular expression pattern. Example:</p>

<p>[NASA breaking news] url = https://www.nasa.gov/rss/dyn/breaking_news.rss filter = feed2exec.plugins.matchtitleregex filter_args = ^spam</p>

<p>The above configuration processes the feed items based on the global configuration, but it will skip any item whose title does not start with the word “spam”.</p>

<h1 id="343-writing-new-plugins">3.4.3 Writing new plugins</h1>

<p>Most of the actual work in the program is performed by plugins. A plugin is a simple Python module that has a output</p>

<p>or filter “callable” (function or class) with a predefined interface.</p>

<p>3.4. Plugins 23 feed2exec Documentation, Release ??? Basic plugin principles</p>

<p>To write a new plugin, you should start by creating a simple Python module, in your PYTHONPATH. You can find which directories are in the path by calling:</p>

<p>$ python3 -c “import sys; print(sys.path)” [’’ , ‘/usr/lib/python35.zip ‘, ‘/usr/lib/python3.5 ‘, ‘/usr/lib/python3.5/plat-x86_64-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>linux-gnu ‘, ‘/usr/lib/python3.5/lib-dynload ‘, ‘/usr/local/lib/python3.5/dist-packages ‘,</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>‘/usr/lib/python3/dist-packages ‘]</p>

<p>In the above example, a good location would be /usr/local/lib/python3.5/dist-packages . The naming con-vention is loose: as long as the plugin matches the expected API, it should just work. For the purpose of this demon-stration, we’ll call our plugin trumpery, so we will create the plugin code like this:</p>

<p>touch /usr/local/lib/python3.5/dist-packages/trumpery.py</p>

<p>Naturally, if you are going to write multiple plugins, you may want to regroup your multiple plugins in a package, see the module documentation for more information about this concept in Python.</p>

<p>Note: There is a rudimentary plugin resolution process that looks for plugins first in the feed2exec.plugins namespace but then globally. This is done in feed2exec.plugins.resolve() , called from the add and parse commands. This means that the absolute path is expected to be used in the configuration file and internally. You are welcome to distribute plugins separately or send them as merge requests, see Contribution guide for more information on how to participate in this project. We of course welcome contributions to this documentation as well!</p>

<p>Filters</p>

<p>Now, you need your plugin to do something. In our case, let’s say we’d like to skip any feed entry that has the word Trump in it. For that purpose, we’ll create a plugin similar to the already existing feed2exec.plugins.droptitle</p>

<p>plugin, but that operates on the body of the feed, but that also hardcodes the word, because this is just a demonstration and we want to keep it simple. Let’s look at the title plugin to see how it works:</p>

<p>def filter(*args, feed= None , item= None , **kwargs):</p>

<p>’’’ the droptitle filter will drop any feed item with a title matching the given args. Example:: [NASA breaking news] url = https://www.nasa.gov/rss/dyn/breaking_news.rss filter = feed2exec.plugins.droptitle filter_args = Trump The above will process the feed items according to the global configuration, but will skip any item that has the word “Trump” anywhere in the title field. Arguments are processed as a single string. If you need to match more complex patterns, look at the droptitleregex plugin instead.</p>

<p>’’’</p>

<p>item[ ‘skip ‘] = ‘ ‘ .join(args) in item.get( ‘title ‘, ‘’ )</p>

<p>24 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<p>That may look like complete gibberish to you if you are not familiar with programming or with Python programming in particular. But let’s take this from the top and copy that in our own plugin. The first line declares a function that takes at least a feed and a item argument, but can also accept any other arbitrary argument. This is important because we want to have the plugin keep on working if the plugin API changes in the future. This is called “forward-compatibility”. So let’s copy that in our plugin and add a pass statement to make sure the plugin works (even if it does nothing for now):</p>

<p>def filter(*args, feed= None , item= None , **kwargs):</p>

<p>pass</p>

<p>We can already test our plugin by adding it to our configuration, in ~/.config/feed2exec.ini :</p>

<p>[NASA] url = https://www.nasa.gov/rss/dyn/breaking_news.rss output = feed2exec.plugins.echo args = {item.title} filter = trumpery</p>

<p>Notice how we use the output plugin to show the title of feed items selected, as a debugging tool. Let’s fetch this feed in debugging mode to see what happens:</p>

<p>$ python3 -m feed2exec –verbose fetch –force opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>(10355 bytes) connecting to database at ./doc/feed2exec.db arguments received: ( ‘President Trump Welcomes Home Record-breaking NASA Astronaut Peggy␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Whitson ‘,) arguments received: ( ‘Three International Space Station Crewmates Safely Return to Earth</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>’,) arguments received: ( ‘NASA Statement on Nomination for Agency Administrator ‘,) arguments received: ( ‘NASA Television to Air Return of Three International Space Station␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Crew Members ‘,) arguments received: ( ‘NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary ‘,) arguments received: ( ‘NASA’s Johnson Space Center Closes Through Labor Day for Tropical␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Storm Harvey ‘,) arguments received: ( ‘NASA Cancels Planned Media Availabilities with Astronauts ‘,) arguments received: ( ‘NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Competition ‘,) arguments received: ( ‘NASA Awards Contract for Center Protective Services for Glenn␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Research Center ‘,) arguments received: ( ‘NASA Announces Cassini End-of-Mission Media Activities ‘,) 1 feeds processed</p>

<p>Good! The feed is fetched and items are displayed. It means our filter didn’t interfere, but now it’s time to make it do</p>

<p>something. To skip items, we need to set the skip attribute for the feed item to True if we want to skip it and False</p>

<p>otherwise. So we’ll use a simple recipe, a bit like droptitle does, but simpler, to look at the feed content to look for our evil word. The feedparser documentation tells us feed items have a summary field which we can inspect. There’s also a content list, but that’s a little more complicated so we’ll skip that for now. So, let’s set the skip parameter to match if there is the evil word in our feed item, like this:</p>

<p>def filter(*args, feed= None , item= None , **kwargs): item[ ‘skip ‘] = ‘Trump ‘ in item.get( ‘summary ‘, ‘’ )</p>

<p>And let’s see the result (note that we use the –force argument here otherwise we would just skip all items because</p>

<p>3.4. Plugins 25 feed2exec Documentation, Release ???</p>

<p>of the cache):</p>

<p>$ python3 -m feed2exec –verbose fetch –force opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>(10355 bytes) connecting to database at ./doc/feed2exec.db item President Trump Welcomes Home Record-breaking NASA Astronaut Peggy Whitson of feed␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>NASA filtered out arguments received: ( ‘Three International Space Station Crewmates Safely Return to Earth</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>’,) item NASA Statement on Nomination for Agency Administrator of feed NASA filtered out arguments received: ( ‘NASA Television to Air Return of Three International Space Station␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Crew Members ‘,) arguments received: ( ‘NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary ‘,) arguments received: ( ‘NASA’s Johnson Space Center Closes Through Labor Day for Tropical␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Storm Harvey ‘,) arguments received: ( ‘NASA Cancels Planned Media Availabilities with Astronauts ‘,) arguments received: ( ‘NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Competition ‘,) arguments received: ( ‘NASA Awards Contract for Center Protective Services for Glenn␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Research Center ‘,) arguments received: ( ‘NASA Announces Cassini End-of-Mission Media Activities ‘,) 1 feeds processed</p>

<p>Success! We have skipped the two items that contain the fraud we wanted to remove from the world. Notice how we were able to modify the feed item: we can also use that to change the feed content. Normally, we would use this to fix malformed feeds, but let’s have some fun instead and rename Trump to Drumpf:</p>

<p>def filter(*args, feed= None , item= None , **kwargs): item[ ‘title ‘] = item.get( ‘title ‘, ‘’ ).replace( ‘Trump ‘, ‘Drumpf ‘)</p>

<p>And the result:</p>

<p>$ python3 -m feed2exec –verbose fetch –force opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>(10355 bytes) connecting to database at ./doc/feed2exec.db arguments received: ( ‘President Drumpf Welcomes Home Record-breaking NASA Astronaut␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Peggy Whitson ‘,) arguments received: ( ‘Three International Space Station Crewmates Safely Return to Earth</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>’,) arguments received: ( ‘NASA Statement on Nomination for Agency Administrator ‘,) arguments received: ( ‘NASA Television to Air Return of Three International Space Station␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Crew Members ‘,) arguments received: ( ‘NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary ‘,) arguments received: ( ‘NASA’s Johnson Space Center Closes Through Labor Day for Tropical␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Storm Harvey ‘,) arguments received: ( ‘NASA Cancels Planned Media Availabilities with Astronauts ‘,) arguments received: ( ‘NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Competition ‘,) arguments received: ( ‘NASA Awards Contract for Center Protective Services for Glenn␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Research Center ‘,)</p>

<blockquote>
  <p>(continues on next page)</p>
</blockquote>

<p>26 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<blockquote>
  <p>(continued from previous page)</p>
</blockquote>

<p>arguments received: ( ‘NASA Announces Cassini End-of-Mission Media Activities ‘,) 1 feeds processed</p>

<p>I know, absolutely hilarious, right? More seriously, this is also how the feed2exec.plugins.html2text filter works, which is enabled by default and helps the email output plugin do its job by turning HTML into text. At this point, the only limit is your knowledge of Python programming and your imagination!</p>

<p>Output plugins</p>

<p>Output plugins are another beast entirely. While they operate with the same principle than filter plugins (search path and function signature are similar), they are designed to actually output something for each new feed item found. This can be anything: a file, email, HTTP request, whatever. If there is a commandline tool that does what you need, it is probably simpler to just call the exec plugin and there are numerous examples of this in the sample configuration file. For more complex things, however, it may be easier to actually write this as a Python.</p>

<p>Basic arguments</p>

<p>For our example, we’ll write an archival plugin which writes each new entry to a file hierarchy. First, we start with the same simple function signature as filters, except we name it output:</p>

<p>def output(*args, feed= None , item= None , **kwargs):</p>

<p>pass</p>

<p>This is the equivalent of the null plugin and basically outputs nothing at all. To archive the feed items, we’ll need to look at the link element feedparser gives us. Let’s see what that looks like for the NASA feed:</p>

<p>def output(*args, feed= None , item= None , **kwargs):</p>

<h1 id="only-operate-on-items-that-actually-have-a-link">only operate on items that actually have a link</h1>

<p>if item.get( ‘link ‘): print(item.get( ‘link ‘, ‘’ ))</p>

<p>else :logging.info( ‘no link for feed item %s , not archiving ‘, item.get( ‘title ‘))</p>

<p>Note: Note that we try to make plugins silent in general. You can use logging.info() to have things show up in</p>

<p>–verbose and logging.debug() for –debug but by default, your plugin should be silent unless there’s an error that requires the user’s intervention, in which case you should use logging.warning() for transient errors that may be automatically recovered and logging.error() for errors that require user intervention. This is to allow users to ignore warnings safely. Note that here we first check to see if the feed item actually has a link - not all feeds do! After adding the above to our</p>

<p>trumpery plugin and adding it as an output plugin:</p>

<p>[NASA] url = https://www.nasa.gov/rss/dyn/breaking_news.rss output = trumpery filter = trumpery</p>

<p>We can try to see what happens when we call it:</p>

<p>3.4. Plugins 27 feed2exec Documentation, Release ???</p>

<p>$ python3 -m feed2exec –verbose fetch –force opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>(10355 bytes) connecting to database at ./doc/feed2exec.db http://www.nasa.gov/press-release/president-trump-welcomes-home-record-breaking-nasa-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>astronaut-peggy-whitson http://www.nasa.gov/press-release/three-international-space-station-crewmates-safely-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>return-to-earth http://www.nasa.gov/press-release/nasa-statement-on-nomination-for-agency-administrator http://www.nasa.gov/press-release/nasa-television-to-air-return-of-three-international-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>space-station-crew-members http://www.nasa.gov/press-release/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>anniversary http://www.nasa.gov/press-release/nasa-s-johnson-space-center-closes-through-labor-day-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>for-tropical-storm-harvey http://www.nasa.gov/press-release/nasa-cancels-planned-media-availabilities-with-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>astronauts http://www.nasa.gov/press-release/nasa-awards-400000-to-top-teams-at-second-phase-of-3d-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>printing-competition http://www.nasa.gov/press-release/nasa-awards-contract-for-center-protective-services-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>for-glenn-research-center http://www.nasa.gov/press-release/nasa-announces-cassini-end-of-mission-media-activities 1 feeds processed</p>

<p>Sanitizing contents</p>

<p>Good. Those are the URLs we want to save to disk. Let’s start by just writing those to a file. We will also use a simple</p>

<p>slug function to make a filesystem-safe name from the feed title and save those files in a pre-determined location:</p>

<p>import logging import os.path from feed2exec.utils import slug ARCHIVE_DIR= ‘/run/user/1000/feed-archives/ ‘</p>

<p>def output(*args, feed= None , item= None , session= None , **kwargs):</p>

<h1 id="make-a-safe-path-from-the-item-name">make a safe path from the item name</h1>

<p>path = slug(item.get( ‘title ‘, ‘no-name ‘))</p>

<h1 id="put-the-file-in-the-archive-directory">put the file in the archive directory</h1>

<p>path = os.path.join(ARCHIVE_DIR, path)</p>

<h1 id="only-operate-on-items-that-actually-have-a-link-1">only operate on items that actually have a link</h1>

<p>if item.get( ‘link ‘):</p>

<h1 id="tell-the-user-what-s-going-on-if-verbose--otherwise-we-try-to-stay-silent-if-all-goes-well">tell the user what ‘s going on, if verbose # otherwise, we try to stay silent if all goes well</h1>

<p>logging.info( ‘saving feed item %s to %s from %s ‘,item.get( ‘title ‘), path, item.get( ‘link ‘))</p>

<h1 id="open-the-file">open the file</h1>

<p>with open(path, ‘w’) as archive:</p>

<h1 id="write-the-response">write the response</h1>

<p>archive.write(item.get( ‘link ‘))</p>

<blockquote>
  <p>(continues on next page)</p>
</blockquote>

<p>28 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<blockquote>
  <p>(continued from previous page)</p>
</blockquote>

<p>else :logging.info( ‘no link for feed item %s , not archiving ‘, item.get( ‘title ‘))</p>

<p>Now I know this may look like a huge step from the previous one but I’m sorry, I couldn’t find a simpler second step. :) The output now looks like this:</p>

<p>$ python3 -m feed2exec –config ./doc/ –verbose fetch –force opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>(10355 bytes) connecting to database at ./doc/feed2exec.db saving feed item President Drumpf Welcomes Home Record-breaking NASA Astronaut Peggy␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Whitson to /run/user/1000/president-drumpf-welcomes-home-record-breaking-nasa-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>astronaut-peggy-whitson from http://www.nasa.gov/press-release/president-trump-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>welcomes-home-record-breaking-nasa-astronaut-peggy-whitson saving feed item Three International Space Station Crewmates Safely Return to Earth to /</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>run/user/1000/three-international-space-station-crewmates-safely-return-to-earth from␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>http://www.nasa.gov/press-release/three-international-space-station-crewmates-safely-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>return-to-earth saving feed item NASA Statement on Nomination for Agency Administrator to /run/user/1000/</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>nasa-statement-on-nomination-for-agency-administrator from http://www.nasa.gov/press-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>release/nasa-statement-on-nomination-for-agency-administrator saving feed item NASA Television to Air Return of Three International Space Station Crew␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Members to /run/user/1000/nasa-television-to-air-return-of-three-international-space-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>station-crew-members from http://www.nasa.gov/press-release/nasa-television-to-air-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>return-of-three-international-space-station-crew-members saving feed item NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary to /</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>run/user/1000/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-anniversary from␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>http://www.nasa.gov/press-release/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>anniversary saving feed item NASA’s Johnson Space Center Closes Through Labor Day for Tropical Storm␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Harvey to /run/user/1000/nasa-s-johnson-space-center-closes-through-labor-day-for-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>tropical-storm-harvey from http://www.nasa.gov/press-release/nasa-s-johnson-space-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>center-closes-through-labor-day-for-tropical-storm-harvey saving feed item NASA Cancels Planned Media Availabilities with Astronauts to /run/user/</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>1000/nasa-cancels-planned-media-availabilities-with-astronauts from http://www.nasa.</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>gov/press-release/nasa-cancels-planned-media-availabilities-with-astronauts saving feed item NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Competition to /run/user/1000/nasa-awards-400-000-to-top-teams-at-second-phase-of-3d-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>printing-competition from http://www.nasa.gov/press-release/nasa-awards-400000-to-top-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>teams-at-second-phase-of-3d-printing-competition saving feed item NASA Awards Contract for Center Protective Services for Glenn Research␣</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>Center to /run/user/1000/nasa-awards-contract-for-center-protective-services-for-glenn-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>research-center from http://www.nasa.gov/press-release/nasa-awards-contract-for-center-</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>protective-services-for-glenn-research-center saving feed item NASA Announces Cassini End-of-Mission Media Activities to /run/user/</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>1000/nasa-announces-cassini-end-of-mission-media-activities from http://www.nasa.gov/</p>

<blockquote>
  <p>˓→</p>
</blockquote>

<p>press-release/nasa-announces-cassini-end-of-mission-media-activities</p>

<p>Sweet! Now it’s not really nice to save this in /run/user/1000 . I just chose this directory because it was a safe place to write but it’s not a persistent directory. Best make that configurable, which is where plugin arguments come in.</p>

<p>3.4. Plugins 29 feed2exec Documentation, Release ??? User configuration</p>

<p>You see that *args parameter? That comes straight from the configuration file. So you could set the path in the configuration file, like this:</p>

<p>[NASA] url = https://www.nasa.gov/rss/dyn/breaking_news.rss output = trumpery args = /srv/archives/nasa/ filter = trumpery</p>

<p>We also need to modify the plugin to fetch that configuration, like this:</p>

<p>def output(*args, feed= None , item= None , session= None , **kwargs):</p>

<h1 id="make-a-safe-path-from-the-item-name-1">make a safe path from the item name</h1>

<p>path = slug(item.get( ‘title ‘, ‘no-name ‘))</p>

<h1 id="take-the-archive-dir-from-the-user-or-use-the-default">take the archive dir from the user or use the default</h1>

<p>archive_dir = ‘ ‘ .join(args) if args else DEFAULT_ARCHIVE_DIR</p>

<h1 id="put-the-file-in-the-archive-directory-1">put the file in the archive directory</h1>

<p>path = os.path.join(archive_dir, path)</p>

<h1 id="--rest-of-the-function-unchanged">[…] # rest of the function unchanged</h1>

<p>Making HTTP requests</p>

<p>And now obviously, we only saved the link itself, not the link content . For that we need some help from the requests</p>

<p>module, and do something like this:</p>

<h1 id="fetch-the-url-in-memory">fetch the URL in memory</h1>

<p>result = session.get(item.get( ‘link ‘))</p>

<p>if result.status_code != requests.codes.ok: logging.warning( ‘failed to fetch link %s : %s ‘,item.get( ‘link ‘), result.status_code)</p>

<h1 id="make-sure-we-retry-next-time">make sure we retry next time</h1>

<p>return False</p>

<h1 id="open-the-file-1">open the file</h1>

<p>with open(path, ‘w’) as archive:</p>

<h1 id="write-the-response-1">write the response</h1>

<p>archive.write(result.text)</p>

<p>This will save the actual link content ( result.text ) to the file. The important statement here is:</p>

<h1 id="fetch-the-url-in-memory-1">fetch the URL in memory</h1>

<p>result = session.get(item.get( ‘link ‘))</p>

<p>which fetches the URL in memory and checks for errors. The other change in the final plugin is simply:</p>

<p>archive.write(result.text)</p>

<p>which writes the article content instead of the link. Notice how the session argument is used here instead of talking directly to the requests module. This leverages a caching system we already have, alongside configuration like user-agent and so on.</p>

<p>30 Chapter 3. Why the name? feed2exec Documentation, Release ??? Plugin return values</p>

<p>Notice how we return False here: this makes the plugin system avoid adding the item to the cache, so it is retried on the next run. If the plugin returns True or nothing ( None ), the plugin is considered to have succeeded and the entry is added to the cache. That logic is defined in feed2exec.controller.FeedManager.fetch() .</p>

<p>Catchup</p>

<p>A final thing that is missing that is critical in all plugins is to respect the catchup setting. It is propagated up from the commandline or configuration all the way down to plugins, through the feed parameters. How you handle it varies from plugin to plugin, but the basic idea is to give feedback (when verbose) of activity when the plugin is run but to not actually do anything. In our case, we simply return success, right before we fetch the URL:</p>

<p>if feed.get( ‘catchup ‘):</p>

<p>return True</p>

<h1 id="fetch-the-url-in-memory-2">fetch the URL in memory</h1>

<p>result = session.get(item.get( ‘link ‘))</p>

<p>Notice how we still fetch the actual feed content but stop before doing any permanent operation. That is the spirit of the “catchup” operation: we not only skip “write” operation, but also any operation which could slow down the “catchup”: fetching stuff over the network takes time and while it can be considered a “readonly” operation as far as the local machine is concerned, we are effectively writing to the network so that operation shouldn’t occur. Hopefully that should get you going with most of the plugins you are thinking of writing!</p>

<p>Writing tests</p>

<p>Writing tests is essential in ensuring that the code will stay maintainable in the future. It allows for easy refactoring and can find bugs that manual testing may not, especially when you get complete coverage (although that is no guarantee either). We’ll take our archive plugin as an example. The first step is to edit the tests/test/test_plugins.py file, where other plugins are tests as well. We start by creating a function named test_archive so that Pytest, our test bed, will find it:</p>

<p>def test_archive(tmpdir, betamax): # noqa</p>

<p>pass</p>

<p>Notice the two arguments named tmpdir and betamax . Both of those are fixtures, a pytest concept that allows to simulate an environment. In particular, the tmpdir fixture, shipped with pytest, allows you to easily manage (and automatically remove) temporary directories. The betamax fixtures is a uses the betamax module to record then replay HTTP requests. Then we need to do something. We need to create a feed and a feed item that we can then send into the plugin. We could also directly parse an existing feed and indeed some plugins do exactly that. But our plugin is simple and we can afford to skip full feed parsing and just synthesize what we need:</p>

<p>feed = Feed( ‘test archive ‘, test_sample) item = feedparser.FeedParserDict({ ‘link ‘: ‘http://example.com/ ‘,</p>

<p>‘title ‘: ‘example site ‘})</p>

<p>This creates a new feed based on the test_sample feed. This is necessary so that the session is properly re-initialized in the feed item (otherwise the betamax fixture will not work). Then it creates a fake feed entry simply with one link</p>

<p>3.4. Plugins 31 feed2exec Documentation, Release ???</p>

<p>and a title. Then we can call our plugin, and verify that it saves the file as we expected. The test for the most common case looks like this:</p>

<p>def test_archive(tmpdir, betamax): # noqa</p>

<p>dest = tmpdir.join( ‘archive ‘)feed = Feed( ‘test archive ‘, test_sample) item = feedparser.FeedParserDict({ ‘link ‘: ‘http://example.com/ ‘,</p>

<p>‘title ‘: ‘example site ‘})</p>

<p>assert archive_plugin.output(str(dest), feed=feed, item=item)</p>

<p>assert dest.join( ‘example-site ‘).check()</p>

<p>Then we can try to run this with pytest-3 :</p>

<p>[1084]anarcat@curie:feed2exec$ pytest-3 =============================== test session starts =============================== platform linux – Python 3.5.3, pytest-3.0.6, py-1.4.32, pluggy-0.4.0 rootdir: /home/anarcat/src/feed2exec, inifile: setup.cfg plugins: profiling-1.2.11, cov-2.4.0, betamax-0.8.0 collected 26 items feed2exec/utils.py .. feed2exec/plugins/transmission.py . feed2exec/tests/test_feeds.py …….. feed2exec/tests/test_main.py ….. feed2exec/tests/test_opml.py . feed2exec/tests/test_plugins.py ……… ———– coverage: platform linux, python 3.5.3-final-0 ———–Name Stmts Miss Cover —————————————————————-feed2exec/<strong>init</strong>.py 12 0 100% feed2exec/<strong>main</strong>.py 87 1 99% feed2exec/_version.py 1 0 100% feed2exec/email.py 81 7 91% feed2exec/feeds.py 243 8 97% feed2exec/logging.py 31 11 65% feed2exec/plugins/<strong>init</strong>.py 47 6 87% feed2exec/plugins/archive.py 23 5 78% feed2exec/plugins/droptitle.py 2 0 100% feed2exec/plugins/echo.py 8 0 100% feed2exec/plugins/emptysummary.py 5 0 100% feed2exec/plugins/error.py 2 0 100% feed2exec/plugins/exec.py 7 0 100% feed2exec/plugins/html2text.py 20 4 80% feed2exec/plugins/ikiwiki_recentchanges.py 9 5 44% feed2exec/plugins/maildir.py 28 0 100% feed2exec/plugins/mbox.py 29 1 97% feed2exec/plugins/null.py 5 1 80% feed2exec/plugins/transmission.py 20 0 100% feed2exec/plugins/wayback.py 20 0 100% feed2exec/tests/<strong>init</strong>.py 0 0 100% feed2exec/tests/conftest.py 3 0 100% feed2exec/tests/fixtures.py 19 0 100% feed2exec/tests/test_feeds.py 124 0 100% (continues on next page)</p>

<p>32 Chapter 3. Why the name? feed2exec Documentation, Release ???</p>

<blockquote>
  <p>(continued from previous page)</p>
</blockquote>

<p>feed2exec/tests/test_main.py 90 0 100% feed2exec/tests/test_opml.py 17 0 100% feed2exec/tests/test_plugins.py 162 0 100% feed2exec/utils.py 41 12 71% —————————————————————-TOTAL 1136 61 95% =========================== 26 passed in 10.83 seconds ============================</p>

<p>Notice the test coverage: we only have 78% test coverage for our plugin. This means that some branches of the code were not executed at all! Let’s see if we can improve that. Looking at the code, I see there are some conditionals for error handling. So let’s simulate an error, and make sure that we don’t create a file on error:</p>

<p>dest.remove() item = feedparser.FeedParserDict({ ‘link ‘: ‘http://example.com/404 ‘,</p>

<p>‘title ‘: ‘example site ‘})</p>

<p>assert not archive_plugin.output(str(dest), feed=feed, item=item)</p>

<p>assert not dest.join( ‘example-site ‘).check()</p>

<p>There. Let’s see the effect on the test coverage:</p>

<p>[1085]anarcat@curie:feed2exec2$ pytest-3 feed2exec/tests/test_plugins.py::test_archive =============================== test session starts =============================== platform linux – Python 3.5.3, pytest-3.0.6, py-1.4.32, pluggy-0.4.0 rootdir: /home/anarcat/src/feed2exec, inifile: setup.cfg plugins: profiling-1.2.11, cov-2.4.0, betamax-0.8.0 collected 10 items feed2exec/tests/test_plugins.py . ———– coverage: platform linux, python 3.5.3-final-0 ———–Name Stmts Miss Cover —————————————————————-feed2exec/<strong>init</strong>.py 12 0 100% feed2exec/<strong>main</strong>.py 87 87 0% feed2exec/_version.py 1 0 100% feed2exec/email.py 81 64 21% feed2exec/feeds.py 243 172 29% feed2exec/logging.py 31 31 0% feed2exec/plugins/<strong>init</strong>.py 47 38 19% feed2exec/plugins/archive.py 23 3 87% feed2exec/plugins/droptitle.py 2 2 0% feed2exec/plugins/echo.py 8 3 62% feed2exec/plugins/emptysummary.py 5 5 0% feed2exec/plugins/error.py 2 2 0% feed2exec/plugins/exec.py 7 7 0% feed2exec/plugins/html2text.py 20 13 35% feed2exec/plugins/ikiwiki_recentchanges.py 9 9 0% feed2exec/plugins/maildir.py 28 19 32% feed2exec/plugins/mbox.py 29 29 0% feed2exec/plugins/null.py 5 5 0%</p>

<blockquote>
  <p>(continues on next page)</p>
</blockquote>

<p>3.4. Plugins 33 feed2exec Documentation, Release ???</p>

<blockquote>
  <p>(continued from previous page)</p>
</blockquote>

<p>feed2exec/plugins/transmission.py 20 12 40% feed2exec/plugins/wayback.py 20 20 0% feed2exec/tests/<strong>init</strong>.py 0 0 100% feed2exec/tests/conftest.py 3 0 100% feed2exec/tests/fixtures.py 19 6 68% feed2exec/tests/test_feeds.py 124 101 19% feed2exec/tests/test_main.py 90 90 0% feed2exec/tests/test_opml.py 17 17 0% feed2exec/tests/test_plugins.py 166 123 26% feed2exec/utils.py 41 16 61% —————————————————————-TOTAL 1140 874 23% ============================ 1 passed in 2.46 seconds =============================</p>

<p>Much better! Only 3 lines left to cover!</p>

<p>Note: Notice how I explicitly provided a path to my test. This is entirely optional. You can just run pytest-3 and it will run the whole test suite: this method is just faster. Notice also how the coverage ratio is very low: this is normal; we are testing, after all, only one plugin here. The only branches left to test in the code is the other possible error (“no link in the feed”) and to test the “catchup” mode. You can see this in the actual test_plugins.py file distributed with this documentation.</p>

<p>Note: If you discover a bug associated with a single feed, you can use the betamax session and the feed2exec.model. Feed.parse() function to manually parse a feed and fire your plugin. This is how email functionality is tested: see the feed2exec.tests.test_plugins.test_email() function for an example.</p>]]></content><author><name></name></author><category term="scratchpad" /></entry><entry><title type="html">ARC PRIZE</title><link href="https://ib.bsb.br/arc-prize/" rel="alternate" type="text/html" title="ARC PRIZE" /><published>2025-09-29T00:00:00+00:00</published><updated>2025-09-29T17:16:05+00:00</updated><id>https://ib.bsb.br/arc-prize</id><content type="html" xml:base="https://ib.bsb.br/arc-prize/"><![CDATA[<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Subtask 1 — System Role &amp; Run Flow
Objective  Define the pipeline goal and top-level control flow.
Inputs  ARC JSON challenges; RunConfig; env vars (keys, MAX_CONCURRENCY, flags).
Procedure / Prompt Spec or Algorithm  Use src/run.py::run() → run_from_json() to load challenges, choose preset, orchestrate solve_challenges() which schedules solve_challenge(); within it call get_answer_grids() to generate/score instructions and finalize guesses.
Outputs / Artifacts  Attempts JSON in attempts/arc-prize-20XX/...; per-task temp_solutions/*.json.
Dependencies / Anchors  README.md (How the system works, Running a solve); src/run.py::{run, run_from_json, solve_challenges, solve_challenge, get_answer_grids, return_answer}.
Acceptance Criteria  Running python src/run.py produces an attempts file and (if truth present) printed accuracy; no unhandled exceptions.
Failure Modes &amp; Mitigations  Missing env keys → set per README; rate limits → lower concurrency flags.
:::

Subtask 2 — Data Models &amp; Grid Representation
Objective  Normalize grid IO for prompts and scoring.
Inputs  Challenge, Example, Input models; integer grids; COLOR_MAP.
Procedure / Prompt Spec or Algorithm  Render grids via Challenge.grid_to_str; optionally embed base64 PNG via Challenge.grid_to_base64/viz.base64_from_grid.
Outputs / Artifacts  Text matrices; optional images.
Dependencies / Anchors  src/models.py::{Challenge, Example, Input, grid_to_str, grid_to_base64, COLOR_MAP}; src/viz.py::{base64_from_grid}.
Acceptance Criteria  Stringified grids are rectangular, integer-only; base64 generation does not raise.
Failure Modes &amp; Mitigations  Image encoding errors → log and fall back to text-only (see main.contents_from_grid try/except).
:::

Subtask 3 — Prompt Packing
Objective  Build consistent message content for LLMs.
Inputs  Training examples, optional attempts, test inputs; toggles: include_base64, use_diffs.
Procedure / Prompt Spec or Algorithm  Use contents_from_grid, contents_from_example, contents_from_challenge to produce a list of typed parts with labeled sections and (optionally) diffs.
Outputs / Artifacts  Structured message content lists.
Dependencies / Anchors  src/main.py::{contents_from_grid, contents_from_example, contents_from_challenge}; diff text via src/run.py::generate_grid_diff.
Acceptance Criteria  Message list order matches training→tests; when diffs enabled, mismatches include ASCII diff.
Failure Modes &amp; Mitigations  Context bloat → disable images/diffs; reduce step sizes.
:::

Subtask 4 — Instruction Synthesis
Objective  Derive a general rule as stepwise instructions.
Inputs  INTUITIVE_PROMPT; packed examples/tests.
Procedure / Prompt Spec or Algorithm  Call get_next_structure(InstructionsResponse, model=step.instruction_model, messages=…) from get_instructions_from_challenge.
Outputs / Artifacts  InstructionsResponse.instructions.
Dependencies / Anchors  src/main.py::{INTUITIVE_PROMPT, InstructionsResponse}; src/run.py::{get_instructions_from_challenge}.
Acceptance Criteria  Non-empty string; avoids example-specific indices per prompt guidance.
Failure Modes &amp; Mitigations  Empty/invalid → retry via step sampling; move to revision/pooling.
:::

Subtask 5 — Executor (Follow Instructions)
Objective  Apply instructions to a test grid to produce an output grid.
Inputs  Instructions; training examples (as reference); one test input; flags is_perfect, include_base64, use_diffs.
Procedure / Prompt Spec or Algorithm  Use AGENT_FOLLOW_INSTRUCTIONS_PROMPT and optional PERFECT_PROMPT; call output_grid_from_instructions which invokes get_next_structure(GridResponse, …).
Outputs / Artifacts  GridResponse.grid (2D ints).
Dependencies / Anchors  src/main.py::{AGENT_FOLLOW_INSTRUCTIONS_PROMPT, PERFECT_PROMPT, GridResponse, output_grid_from_instructions}.
Acceptance Criteria  Grid shape matches target’s shape during scoring; integers only.
Failure Modes &amp; Mitigations  Free text instead of grid → schema enforcement via get_next_structure.
:::

Subtask 6 — Structured Output Enforcement
Objective  Ensure parseable, schema-validated LLM outputs.
Inputs  Pydantic schemas; provider selection.
Procedure / Prompt Spec or Algorithm  Route via get_next_structure which dispatches to _get_next_structure_* per model (OpenAI/Anthropic/Gemini/DeepSeek/xAI/OpenRouter), using JSON/object or tool use as supported.
Outputs / Artifacts  Parsed Pydantic instances.
Dependencies / Anchors  src/llms/structured.py::{get_next_structure, _get_next_structure_openai, _get_next_structure_anthropic, _get_next_structure_gemini, _get_next_structure_deepseek, _get_next_structure_xai, _get_next_structure_openrouter}; src/llms/models.py::Model.
Acceptance Criteria  Successful parse or controlled failure with retries; no downstream string parsing needed.
Failure Modes &amp; Mitigations  Model lacks json_schema → use json_object path; retry with backoff.
:::

Subtask 7 — Scoring (Leave-One-Out)
Objective  Quantify instruction generalization.
Inputs  Candidate instructions; full training set; follow_model.
Procedure / Prompt Spec or Algorithm  For each training example i, hold out i, execute on its input, compare to its output using get_grid_similarity (exact cell-wise match proportion); average over examples.
Outputs / Artifacts  InstructionsScore with example_scores and aggregate score.
Dependencies / Anchors  src/run.py::{get_example_score, get_grid_similarity, score_instructions_on_challenge}.
Acceptance Criteria  Score in [0,1]; 1.0 iff all cells match on all held-out examples.
Failure Modes &amp; Mitigations  Dimensional mismatch → similarity 0; optional viz when VIZ=1.
:::

Subtask 8 — Revision (Self-Repair)
Objective  Improve weak instructions using feedback from mismatches.
Inputs  Prior InstructionsScore; diffs/attempts; StepRevision config.
Procedure / Prompt Spec or Algorithm  Prompt with REVISION_PROMPT via InstructionsScore.get_revised_instructions; rescore revised outputs.
Outputs / Artifacts  New InstructionsScore items.
Dependencies / Anchors  src/run.py::{REVISION_PROMPT, InstructionsScore.get_revised_instructions}; src/configs/models.py::StepRevision.
Acceptance Criteria  Best revised score ≥ previous best; log improvement metrics.
Failure Modes &amp; Mitigations  No gains → move to pooling; adjust sampling counts.
:::

Subtask 9 — Pooling (Synthesis Across Attempts)
Objective  Fuse strengths from several near-miss instruction sets.
Inputs  Top InstructionsScore samples; StepRevisionPool config.
Procedure / Prompt Spec or Algorithm  Use SYNTHESIS_PROMPT via get_pooling_instruction_from_scores; rescore; merge with candidates.
Outputs / Artifacts  Pooled instruction texts and scores.
Dependencies / Anchors  src/run.py::{SYNTHESIS_PROMPT, get_pooling_instruction_from_scores}; src/configs/models.py::StepRevisionPool.
Acceptance Criteria  At least one pooled instruction’s score ≥ prior top.
Failure Modes &amp; Mitigations  Convergence to weak consensus → increase diversity (times), keep multiple candidates.
:::

Subtask 10 — Step Orchestration &amp; Sampling
Objective  Execute configured Step/Revision/Pool sequence.
Inputs  RunConfig.steps with per-step models, counts, timeouts, flags.
Procedure / Prompt Spec or Algorithm  In get_answer_grids, generate candidates per step, rescore, sort desc, short-list for subsequent steps; exit early on perfect score.
Outputs / Artifacts  Sorted candidate list.
Dependencies / Anchors  src/run.py::{get_instruction_scores, get_score_from_instructions, get_answer_grids}; src/configs/models.py::{RunConfig, Step, StepRevision, StepRevisionPool}.
Acceptance Criteria  Deterministic step flow with early exit on score==1.
Failure Modes &amp; Mitigations  Empty candidate set → log error and halt (exception path).
:::

Subtask 11 — Finalization &amp; Diversity
Objective  Produce up to two distinct final guesses per test grid.
Inputs  Top candidates; final_follow_model; final_follow_times.
Procedure / Prompt Spec or Algorithm  Use get_diverse_attempts to generate multiple outputs; prefer perfect-score instructions; otherwise split attempts between top two candidates; ensure diversity when possible.
Outputs / Artifacts  Two Guess objects; attempts JSON updated.
Dependencies / Anchors  src/run.py::{get_diverse_attempts, return_answer, Guess}.
Acceptance Criteria  Each test input yields ≤2 outputs; if all generated outputs are identical, duplicates are allowed per code.
Failure Modes &amp; Mitigations  Lack of diversity → explicitly bias attempts across top-2 instruction sources (as implemented).
:::

Subtask 12 — Concurrency Control
Objective  Prevent provider overload and monitor saturation.
Inputs  Env MAX_CONCURRENCY; config max_concurrent_tasks.
Procedure / Prompt Spec or Algorithm  Use MonitoredSemaphore in both run loop and get_next_structure (API semaphore); log active/available permits.
Outputs / Artifacts  Saturation logs, orderly task scheduling.
Dependencies / Anchors  src/async_utils/semaphore_monitor.py::MonitoredSemaphore; usage in src/run.py::solve_challenges and src/llms/structured.py::API_SEMAPHORE.
Acceptance Criteria  No storm of RESOURCE_EXHAUSTED; visible saturation percentage logs.
Failure Modes &amp; Mitigations  Starvation/deadlocks → minimal critical sections; staggered starts in solve_challenges.
:::

Subtask 13 — Provider Adapters &amp; Retries
Objective  Uniform structured calls across providers with robust retries.
Inputs  Model enum; messages; schemas.
Procedure / Prompt Spec or Algorithm  Dispatch in get_next_structure; per-provider adapters enforce structured output; retry_with_backoff wraps transient failures (xAI/OpenRouter paths) with jitter and caps.
Outputs / Artifacts  Parsed outputs; usage logs.
Dependencies / Anchors  src/llms/structured.py::{retry_with_backoff, get_next_structure, _get_next_structure_*}; src/llms/models.py::Model.
Acceptance Criteria  Recover from transient failures; bounded retries; logged attempts.
Failure Modes &amp; Mitigations  Non-retryable errors → immediate fail with error logs.
:::

Subtask 14 — Logging &amp; Trace Context
Objective  Record spans and mirror to local file while scrubbing sensitive data.
Inputs  LOGFIRE_API_KEY, LOCAL_LOGS_ONLY, LOG_LEVEL.
Procedure / Prompt Spec or Algorithm  Patch logfire methods to inject run_id/task_id; write rotating file logs/arc.log; wrap spans with start/end/error messages.
Outputs / Artifacts  Local log file; optional remote telemetry.
Dependencies / Anchors  src/logging_config.py::{generate_run_id, set_task_id, logfire patches}; src/log.py::log facade.
Acceptance Criteria  Every major operation creates span logs; no secret leakage (scrubbing callback).
Failure Modes &amp; Mitigations  No token/network → LOCAL_LOGS_ONLY=1 path.
:::

Subtask 15 — Persistence (Files &amp; Optional DB)
Objective  Store attempts and optionally DB rows for analysis.
Inputs  Guesses and instruction scores; NEON_DSN (optional).
Procedure / Prompt Spec or Algorithm  Write attempts / temp files; if DB configured, InstructionsScore.save_to_db and Guess.save_to_db insert rows (JSONB fields) with metadata.
Outputs / Artifacts  JSON files; DB rows when enabled.
Dependencies / Anchors  src/run.py::{solve_challenge, Guess.save_to_db, InstructionsScore.save_to_db}.
Acceptance Criteria  Files are valid JSON; DB insert does not raise.
Failure Modes &amp; Mitigations  DB failure → continue with file artifacts only.
:::

Subtask 16 — Visualization &amp; Base64
Objective  Aid debugging and multimodal prompting.
Inputs  VIZ, LOG_GRIDS env toggles; color map.
Procedure / Prompt Spec or Algorithm  When enabled, viz_many shows mismatches; base64_from_grid generates PNGs for embedding.
Outputs / Artifacts  On-screen figures; base64 strings.
Dependencies / Anchors  src/viz.py::{viz_many, base64_from_grid}; hooks in src/run.py and src/main.py.
Acceptance Criteria  No GUI errors when disabled; images created when requested.
Failure Modes &amp; Mitigations  Headless errors → keep defaults off.
:::

Subtask 17 — Environment &amp; Runbook
Objective  Prepare environment and execute.
Inputs  .env with provider keys; MAX_CONCURRENCY; Python 3.12 target in tooling.
Procedure / Prompt Spec or Algorithm  Load env early (src/__init__.py); install deps per pyproject.toml; run python src/run.py; adjust run() to select preset (grok_config_prod, gpt_config_prod, oss_config, mini_config).
Outputs / Artifacts  Successful run start; log output including run id.
Dependencies / Anchors  README.md (Requirements, Environment configuration, Running a solve); src/__init__.py; src/configs/*.
Acceptance Criteria  Smoke test runs with defaults; no KeyError for MAX_CONCURRENCY.
Failure Modes &amp; Mitigations  Missing var → set in .env per README.
:::

Subtask 18 — Evaluation
Objective  Compute accuracy when ground truth is provided.
Inputs  Attempts JSON; solutions JSON.
Procedure / Prompt Spec or Algorithm  Use evaluate_solutions to compare attempts against truth; count either attempt as correct; report aggregate accuracy.
Outputs / Artifacts  Printed accuracy; logs.
Dependencies / Anchors  src/run.py::{evaluate_solutions}.
Acceptance Criteria  Accuracy matches competition scoring semantics (either attempt counts).
Failure Modes &amp; Mitigations  Schema mismatch → validate inputs before evaluation.
</code></pre></div></div>]]></content><author><name></name></author><category term="AI&gt;prompt" /><category term="scratchpad" /></entry><entry><title type="html">git merge</title><link href="https://ib.bsb.br/git-merge/" rel="alternate" type="text/html" title="git merge" /><published>2025-09-28T00:00:00+00:00</published><updated>2025-09-28T18:54:06+00:00</updated><id>https://ib.bsb.br/git-merge</id><content type="html" xml:base="https://ib.bsb.br/git-merge/"><![CDATA[<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;purpose&gt;
    You consolidate a chat history summary ([[chat_history_summary]]), its output documentation ([[history_outputs_doc]]), and two approach artifacts ([[first_approach]], [[second_approach]]) into a single coherent framework for the repository [[repo_name]]. Produce: a harmonized framework spec, a generation policy, three worked examples, and a JSON manifest for CI.
  &lt;/purpose&gt;
  &lt;context&gt;
    &lt;audience&gt;engineer&lt;/audience&gt;
    &lt;style&gt;
      &lt;tone&gt;extensive, technical, testable&lt;/tone&gt;
      &lt;format&gt;Markdown for specs; JSON for manifest&lt;/format&gt;
    &lt;/style&gt;
    &lt;constraints&gt;
      &lt;constraint&gt;Do not invent facts beyond inputs.&lt;/constraint&gt;
      &lt;constraint&gt;Respect safety and neutrality; no PII enrichment.&lt;/constraint&gt;
      &lt;constraint&gt;Outputs must be self-contained.&lt;/constraint&gt;
    &lt;/constraints&gt;
  &lt;/context&gt;
  &lt;instructions&gt;
    &lt;instruction&gt;Extract goals/constraints from [[chat_history_summary]].&lt;/instruction&gt;
    &lt;instruction&gt;Capture contracts/edge-cases from [[history_outputs_doc]].&lt;/instruction&gt;
    &lt;instruction&gt;Derive principles/workflows from [[first_approach]].&lt;/instruction&gt;
    &lt;instruction&gt;Derive principles/workflows from [[second_approach]].&lt;/instruction&gt;
    &lt;instruction&gt;Harmonize via precedence: documentation → first_approach → second_approach.&lt;/instruction&gt;
    &lt;instruction&gt;Synthesize a unified framework (roles, data flow, instructions, constraints, examples).&lt;/instruction&gt;
    &lt;instruction&gt;Emit: Framework Spec (MD), Generation Policy (MD), three worked examples (MD), Manifest (JSON).&lt;/instruction&gt;
    &lt;instruction&gt;Describe repository wiring paths for [[repo_name]].&lt;/instruction&gt;
  &lt;/instructions&gt;
  &lt;input_data&gt;
    &lt;repo_name&gt;[[repo_name]]&lt;/repo_name&gt;
    &lt;chat_history_summary&gt;[[chat_history_summary]]&lt;/chat_history_summary&gt;
    &lt;history_outputs_doc&gt;[[history_outputs_doc]]&lt;/history_outputs_doc&gt;
    &lt;first_approach&gt;[[first_approach]]&lt;/first_approach&gt;
    &lt;second_approach&gt;[[second_approach]]&lt;/second_approach&gt;
  &lt;/input_data&gt;
  &lt;output_format_specification&gt;
    &lt;framework_spec_markdown&gt;# Overview\n# Roles\n# Data Flow\n# Instructions Hierarchy\n# Constraints\n# Examples&lt;/framework_spec_markdown&gt;
    &lt;generation_policy&gt;- Actionable bullets; each with provenance tag.&lt;/generation_policy&gt;
    &lt;worked_examples&gt;Three minimal worked examples covering typical, conflict, and sparse scenarios.&lt;/worked_examples&gt;
    &lt;manifest_json&gt;{"repo_name":"string","artifacts":[{"path":"string","type":"spec|policy|example|schema|test","generated":true}],"metrics":["format_adherence","consistency","task_success","rule_conflict_free"]}&lt;/manifest_json&gt;
  &lt;/output_format_specification&gt;
  &lt;examples&gt;
    &lt;example&gt;Example inputs/outputs for a straightforward merge.&lt;/example&gt;
  &lt;/examples&gt;
</code></pre></div></div>]]></content><author><name></name></author><category term="AI&gt;prompt" /></entry><entry><title type="html">grounded theory</title><link href="https://ib.bsb.br/grounded-theory/" rel="alternate" type="text/html" title="grounded theory" /><published>2025-09-28T00:00:00+00:00</published><updated>2025-09-28T18:15:09+00:00</updated><id>https://ib.bsb.br/grounded-theory</id><content type="html" xml:base="https://ib.bsb.br/grounded-theory/"><![CDATA[<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;purpose&gt;
    You are an AI scientist implementing a two-stage discovery pipeline over [[dataset_raw]].
    Stage 1 (Empirical Exploration): profile [[dataset_raw]], mine patterns, and synthesize candidate hypotheses with evidence.
    Stage 2 (Deductive Validation): formalize claims, choose appropriate tests/proofs (statistical tests, counterexample search, formal reasoning, computational experiments), execute them, and output verdicts with transparent reasoning.
    Return machine-readable JSON per [[output_schema_json]] plus a extensive executive description.
  &lt;/purpose&gt;

  &lt;context&gt;
    &lt;audience&gt;
      &lt;primary&gt;Analyst/Researcher (advanced statistics proficiency)&lt;/primary&gt;
      &lt;secondary&gt;technical reviewer&lt;/secondary&gt;
    &lt;/audience&gt;
    &lt;toolkit&gt;
      &lt;proof_tools&gt;[[proof_tools]]&lt;/proof_tools&gt;
      &lt;enable_code&gt;[[enable_code]]&lt;/enable_code&gt;
      &lt;max_iterations&gt;[[max_iterations]]&lt;/max_iterations&gt;
    &lt;/toolkit&gt;
    &lt;constraints&gt;
      &lt;constraint&gt;Operate offline on provided inputs; do not use external sources.&lt;/constraint&gt;
      &lt;constraint&gt;Be explicit about assumptions and data quality issues.&lt;/constraint&gt;
      &lt;constraint&gt;Prefer non-parametric or exact methods when sample sizes are small.&lt;/constraint&gt;
      &lt;constraint&gt;Apply multiple-testing correction when evaluating many related hypotheses.&lt;/constraint&gt;
      &lt;constraint&gt;Avoid causal language unless justified; label causality explicitly.&lt;/constraint&gt;
      &lt;constraint&gt;Numeric precision: 3–4 significant figures.&lt;/constraint&gt;
    &lt;/constraints&gt;
    &lt;dialectical_notes&gt;
      &lt;note&gt;Parametric tests may be more powerful under distributional assumptions; non-parametric tests are safer when those assumptions are doubtful or n is small.&lt;/note&gt;
      &lt;note&gt;Correlation does not imply causation; consider directed tests or natural experiments only if justified by design.&lt;/note&gt;
    &lt;/dialectical_notes&gt;
  &lt;/context&gt;

  &lt;instructions&gt;
    &lt;instruction&gt;Ingest [[dataset_raw]] and infer schema/types; describe in "schema_inference".&lt;/instruction&gt;
    &lt;instruction&gt;Profile the data (distributions, missingness, correlations/associations, structure/time order/categories/text motifs); record in "profiling".&lt;/instruction&gt;
    &lt;instruction&gt;Mine salient "patterns" broadly, or focus via [[exploration_objectives]] if provided.&lt;/instruction&gt;
    &lt;instruction&gt;Formulate ≥3 "candidate_hypotheses"; each includes: id, claim, formalization, evidence (with references to profiling/patterns), and priority_score ∈ [0,1].&lt;/instruction&gt;
    &lt;instruction&gt;For each hypothesis, choose a method from [[proof_tools]]; state assumptions and a extensive, reproducible procedure.&lt;/instruction&gt;
    &lt;instruction&gt;Execute the checks/proofs; write outcomes in "tests" (include statistics, error bounds, or constructive counterexamples as applicable).&lt;/instruction&gt;
    &lt;instruction&gt;Issue a "verdict" ∈ {Proven, Falsified, Inconclusive} for each hypothesis, with justification tied to results and assumptions.&lt;/instruction&gt;
    &lt;instruction&gt;Compose an "executive_description", then list "caveats" and "next_steps".&lt;/instruction&gt;
    &lt;instruction&gt;Emit only the JSON object matching [[output_schema_json]] followed by the executive description block.&lt;/instruction&gt;
  &lt;/instructions&gt;

  &lt;input_data&gt;
    &lt;dataset_raw&gt;[[dataset_raw]]&lt;/dataset_raw&gt;
    &lt;dataset_description&gt;[[dataset_description]]&lt;/dataset_description&gt;
    &lt;exploration_objectives&gt;[[exploration_objectives]]&lt;/exploration_objectives&gt;
    &lt;output_schema_json&gt;[[output_schema_json]]&lt;/output_schema_json&gt;
    &lt;proof_tools&gt;["stats","counterexample","combinatorial","simulation"]&lt;/proof_tools&gt;
    &lt;enable_code&gt;no&lt;/enable_code&gt;
    &lt;max_iterations&gt;1&lt;/max_iterations&gt;
  &lt;/input_data&gt;

  &lt;output_format_specification&gt;
    &lt;schema&gt;[[output_schema_json]]&lt;/schema&gt;
    &lt;notes&gt;Return the JSON first; then a extensive executive description paragraph.&lt;/notes&gt;
  &lt;/output_format_specification&gt;

  &lt;examples&gt;
    &lt;example&gt;
      &lt;input_data&gt;
        &lt;dataset_raw&gt;
month,value
1,3
2,4
3,3
4,6
5,4
6,8
7,3
8,5
        &lt;/dataset_raw&gt;
        &lt;exploration_objectives&gt;Check seasonality or periodicity.&lt;/exploration_objectives&gt;
      &lt;/input_data&gt;
      &lt;output&gt;
{"stage_1":{"schema_inference":"Two columns: month(int), value(int)","profiling":"Mean≈4.5; sd≈1.7; mild peaks at months 4 and 6; small n=8","patterns":["autocorr hint at lag 6 (weak)","outlier risk low"],"candidate_hypotheses":[{"id":"H1","claim":"Series exhibits 6-month periodicity","formalization":"ACF lag=6 &amp;gt; 2 sd of ACF noise","evidence":"Peaks near months 4–6; small n"},{"id":"H2","claim":"Upward drift from months 1→6","formalization":"Kendall tau &amp;gt; 0","evidence":"Median rises"},{"id":"H3","claim":"Variance stable across halves","formalization":"Levene p&amp;gt;0.05","evidence":"Similar spread"}]},"stage_2":{"tests":[{"hypothesis_id":"H1","method":"stats","assumptions":"Weak stationarity","procedure":"Compute ACF; compare to CI","result":"ACF lag6 within CI; p≈0.28"},{"hypothesis_id":"H2","method":"stats","assumptions":"Monotone trend test","procedure":"Kendall tau","result":"tau≈0.29; p≈0.31"},{"hypothesis_id":"H3","method":"stats","assumptions":"Equal variance","procedure":"Levene","result":"p≈0.62"}],"verdicts":[{"hypothesis_id":"H1","verdict":"Inconclusive","justification":"Insufficient length"},{"hypothesis_id":"H2","verdict":"Inconclusive","justification":"Not significant"},{"hypothesis_id":"H3","verdict":"Proven","justification":"No variance shift detected"}]},"caveats":["Very small sample"],"next_steps":["Collect more periods","Use STL decomposition"]}

Executive description: Small time series shows no reliable periodicity; variance appears stable. More data recommended.
      &lt;/output&gt;
    &lt;/example&gt;

    &lt;example&gt;
      &lt;input_data&gt;
        &lt;dataset_raw&gt;
A,B,count
yes,yes,18
yes,no,2
no,yes,3
no,no,17
        &lt;/dataset_raw&gt;
        &lt;exploration_objectives&gt;Association between A and B&lt;/exploration_objectives&gt;
      &lt;/input_data&gt;
      &lt;output&gt;
{"stage_1":{"schema_inference":"Contingency table 2×2","profiling":"Row/col margins unbalanced","patterns":["High diagonal counts"],"candidate_hypotheses":[{"id":"H1","claim":"A and B are associated","formalization":"P(A,B) ≠ P(A)P(B)","evidence":"Diagonal dominance"}]},"stage_2":{"tests":[{"hypothesis_id":"H1","method":"stats","assumptions":"Fixed margins","procedure":"Fisher exact test","result":"p&amp;lt;0.01; OR≈51"}],"verdicts":[{"hypothesis_id":"H1","verdict":"Proven","justification":"Strong association"}]},"caveats":["Small table; check sampling"],"next_steps":["Validate with holdout"]}

Executive description: 2×2 data show strong association between A and B (Fisher p&amp;lt;0.01; OR≈51). Sampling assumptions should be verified.
      &lt;/output&gt;
    &lt;/example&gt;
  &lt;/examples&gt;

~~~
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "TwoStrokeDiscoveryResult",
  "type": "object",
  "required": ["stage_1", "stage_2", "executive_description"],
  "properties": {
    "stage_1": {
      "type": "object",
      "required": ["schema_inference", "profiling", "patterns", "candidate_hypotheses"],
      "properties": {
        "schema_inference": { "type": "string" },
        "profiling": { "type": "string" },
        "patterns": { "type": "array", "items": { "type": "string" } },
        "candidate_hypotheses": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "claim", "formalization", "evidence"],
            "properties": {
              "id": { "type": "string" },
              "claim": { "type": "string" },
              "formalization": { "type": "string" },
              "evidence": { "type": "string" },
              "priority_score": { "type": "number" }
            }
          }
        }
      }
    },
    "stage_2": {
      "type": "object",
      "required": ["tests", "verdicts"],
      "properties": {
        "tests": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["hypothesis_id", "method", "assumptions", "procedure", "result"],
            "properties": {
              "hypothesis_id": { "type": "string" },
              "method": { "type": "string" },
              "assumptions": { "type": "string" },
              "procedure": { "type": "string" },
              "result": { "type": "string" }
            }
          }
        },
        "verdicts": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["hypothesis_id", "verdict", "justification"],
            "properties": {
              "hypothesis_id": { "type": "string" },
              "verdict": { "type": "string", "enum": ["Proven", "Falsified", "Inconclusive"] },
              "justification": { "type": "string" }
            }
          }
        }
      }
    },
    "executive_description": { "type": "string" },
    "caveats": { "type": "array", "items": { "type": "string" } },
    "next_steps": { "type": "array", "items": { "type": "string" } }
  }
}
~~~
</code></pre></div></div>]]></content><author><name></name></author><category term="AI&gt;prompt" /></entry><entry><title type="html">bnmp</title><link href="https://ib.bsb.br/bnmp/" rel="alternate" type="text/html" title="bnmp" /><published>2025-09-22T00:00:00+00:00</published><updated>2025-09-29T09:47:36+00:00</updated><id>https://ib.bsb.br/bnmp</id><content type="html" xml:base="https://ib.bsb.br/bnmp/"><![CDATA[<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
BNMP — UF-wide harvester (final refactor, 415 fix)

Fix in this version
-------------------
* Adds explicit **Content-Type: application/json;charset=UTF-8** for POST requests
  (some BNMP endpoints return HTTP 415 without it).

Goal
----
Harvest **as much data as possible** from portal BNMP **filtered only by a given UF/Estado**, with
strong robustness and good operator UX. This script merges the best ideas from the provided
scripts and adds:

* Resilient HTTP (browser-like headers, gzip handling, retries w/ exponential backoff + jitter).
* Two complementary strategies for **maximum coverage**:
  1) **per-órgão** pagination via `/bnmpportal/api/pesquisa-pecas/pecas` (UF + órgão filters);
  2) **UF-wide** pagination via `/bnmpportal/api/pesquisa-pecas/filter` (buscaOrgaoRecursivo=True).
* Streamed, memory-safe outputs (GZIP NDJSON) + merged deduplicated stream.
* Detailed run manifest (JSON) and a small HTML preview of sample rows.
* Rich progress logging, counters (401 / transient failures), and configurable knobs.
* No external dependencies (stdlib only). Cross-platform.

Outputs (under an auto-created run directory):
  - `raw_pecas_orgao.ndjson.gz`      — flattened records from per-órgão strategy
  - `raw_filter_uf.ndjson.gz`        — flattened records from UF `/filter` strategy
  - `merged_dedup.ndjson.gz`         — flattened, deduplicated union of both
  - `manifest.json`                  — summary metrics and parameters
  - `sample_preview.html`            — HTML preview (first N merged rows)

Authentication
--------------
Provide the BNMP session cookie and fingerprint via flags or environment:
  - `--cookie` or env `BNMP_COOKIE`
  - `--fp`     or env `BNMP_FP`

UF selection
------------
Use `--uf-id` (int) **or** `--state` (name/sigla). Examples: `--state "Goiás"`, `--state GO`, `--uf-id 9`.

Basic usage
-----------
$ python bnmp_uf_harvester.py --state "DF" --cookie "$BNMP_COOKIE" --fp "$BNMP_FP"

Common knobs
------------
  --strategy both|pecas-orgao|filter-uf   (default: both)
  --page-size-pecas 200                   page size for per-órgão calls
  --page-size-filter 500                  page size for UF /filter calls
  --retries 6                             max attempts for transient failures
  --sleep-page 0.25                       throttle between pages
  --sleep-org 0.35                        throttle between órgãos
  --sort-filter "dataExpedicao,DESC"      sort for /filter (optional)
  --sample 200                            number of rows kept for HTML preview
  --out-dir ./bnmp_out                    parent output folder (a timestamped run dir is created inside)

Notes
-----
* To target **only warrants** (mandados), pass `--tipo-peca MANDADO_DE_PRISAO`. Without `--tipo-peca`,
  the script collects **all peças** available for the UF.
* The merged stream is deduped by best-effort key selection among common ID fields; if none found,
  a content hash is used.
* On 401 errors for a given órgão/page, the script skips forward and continues (counts reported).

"""

from __future__ import annotations
import argparse
import gzip
import hashlib
import html
import io
import json
import os
import pathlib
import random
import sys
import time
from collections import defaultdict, deque
from datetime import datetime
from typing import Any, Dict, Iterable, List, Optional, Tuple
from urllib import error, request
import unicodedata as u

BASE = "https://portalbnmp.cnj.jus.br"
PECAS_URL = f"{BASE}/bnmpportal/api/pesquisa-pecas/pecas"
FILTER_URL = f"{BASE}/bnmpportal/api/pesquisa-pecas/filter"
ORGAOS_UF_URL = f"{BASE}/bnmpportal/api/pesquisa-pecas/orgaos/unidade-federativa"

TRANSIENT = {429, 502, 503, 504}

STATE_MAP = {
    'acre':1,'ac':1,
    'alagoas':2,'al':2,
    'amapa':3,'amapá':3,'ap':3,
    'amazonas':4,'am':4,
    'bahia':5,'ba':5,
    'ceara':6,'ceará':6,'ce':6,
    'distrito federal':7,'df':7,
    'espirito santo':8,'espírito santo':8,'es':8,
    'goias':9,'goiás':9,'go':9,
    'maranhao':10,'maranhão':10,'ma':10,
    'mato grosso':11,'mt':11,
    'mato grosso do sul':12,'ms':12,
    'minas gerais':13,'mg':13,
    'para':14,'pará':14,'pa':14,
    'paraiba':15,'paraíba':15,'pb':15,
    'parana':16,'paraná':16,'pr':16,
    'pernambuco':17,'pe':17,
    'piaui':18,'piauí':18,'pi':18,
    'rio de janeiro':19,'rj':19,
    'rio grande do norte':20,'rn':20,
    'rio grande do sul':21,'rs':21,
    'rondonia':22,'rondônia':22,'ro':22,
    'roraima':23,'rr':23,
    'santa catarina':24,'sc':24,
    'sao paulo':25,'são paulo':25,'sp':25,
    'sergipe':26,'se':26,
    'tocantins':27,'to':27,
}

def norm(s: str) -&gt; str:
    return u.normalize('NFKD', (s or '')).encode('ASCII','ignore').decode().strip().lower()

# --- 415 fix: always include JSON content-type for POSTs ---
JSON_CT = 'application/json;charset=UTF-8'

def build_headers(cookie: str, fp: str) -&gt; Dict[str, str]:
    # Browser-like headers to reduce auth/throttle friction
    return {
        'Accept': 'application/json, text/plain, */*',
        'Accept-Encoding': 'gzip',
        'Accept-Language': 'pt-BR,pt;q=0.9',
        'User-Agent': 'Mozilla/5.0',
        'Origin': BASE,
        'Referer': BASE + '/',
        'X-Requested-With': 'XMLHttpRequest',
        'Connection': 'keep-alive',
        'fingerprint': fp,
        'Cookie': f'portalbnmp={cookie}',
        # Tolerated if ignored; some stacks mirror session validation here
        'Authorization': f'Bearer {cookie}',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
        # Important for POST endpoints (prevents HTTP 415 on /filter and /pecas)
        'Content-Type': JSON_CT,
    }


def open_json(url: str, method: str, headers: Dict[str, str], payload: Optional[Dict[str, Any]] = None,
              max_tries: int = 6, base_sleep: float = 0.6, timeout: int = 90,
              query: Optional[Dict[str, Any]] = None) -&gt; Dict[str, Any] | List[Any]:
    """Perform an HTTP request and parse JSON, with retries on transient errors."""
    from urllib.parse import urlencode
    body = json.dumps(payload, ensure_ascii=False).encode('utf-8') if payload is not None else None
    full = url
    if query:
        qs = urlencode(query, doseq=True)
        if qs:
            full = f"{url}?{qs}"
    last_exc: Optional[Exception] = None
    for attempt in range(1, max_tries + 1):
        # ensure JSON content-type for POSTs even if caller headers were modified
        req_headers = dict(headers)
        if body is not None:
            req_headers.setdefault('Content-Type', JSON_CT)
        req = request.Request(full, headers=req_headers, data=body, method=method)
        try:
            with request.urlopen(req, timeout=timeout) as r:
                raw = r.read()
                enc = (r.headers.get('Content-Encoding') or '').lower()
                if 'gzip' in enc:
                    raw = gzip.decompress(raw)
                return json.loads(raw.decode('utf-8', 'replace'))
        except error.HTTPError as e:
            last_exc = e
            code = getattr(e, 'code', None)
            if code in TRANSIENT:
                sleep = base_sleep * (2 ** (attempt - 1)) + random.random() * 0.2
                print(f"[retry {attempt}/{max_tries}] {code} {method} {full} — aguardando {sleep:.2f}s…", file=sys.stderr)
                time.sleep(sleep)
                continue
            # Non-transient: bubble up
            raise
        except error.URLError as e:
            last_exc = e
            sleep = base_sleep * (2 ** (attempt - 1)) + random.random() * 0.2
            print(f"[retry {attempt}/{max_tries}] URLError {getattr(e, 'reason', e)} — aguardando {sleep:.2f}s…", file=sys.stderr)
            time.sleep(sleep)
            continue
    if last_exc:
        raise last_exc
    # Should not reach here
    return {}


def autodetect_items(container: Any) -&gt; List[Any]:
    # Broad detection (covers observed envelopes across scripts)
    if isinstance(container, list):
        return container
    if not isinstance(container, dict):
        return []
    for key in (
        'content','resultados','itens','dados','items','lista','data','registros','records',
        'pecas','mandados','result'
    ):
        v = container.get(key)
        if isinstance(v, list):
            return v
    page = container.get('page') or {}
    if isinstance(page, dict):
        for k in ('content','items','itens','dados'):
            v = page.get(k)
            if isinstance(v, list):
                return v
    for v in container.values():
        if isinstance(v, list) and v and isinstance(v[0], dict):
            return v
    return []


def flatten(obj: Any, prefix: str = '') -&gt; Dict[str, Any]:
    out: Dict[str, Any] = {}
    if isinstance(obj, dict):
        for k, v in obj.items():
            kk = f"{prefix}.{k}" if prefix else str(k)
            if isinstance(v, (dict, list)):
                out.update(flatten(v, kk))
            else:
                out[kk] = v
    elif isinstance(obj, list):
        for i, v in enumerate(obj):
            kk = f"{prefix}[{i}]"
            if isinstance(v, (dict, list)):
                out.update(flatten(v, kk))
            else:
                out[kk] = v
    else:
        out[prefix or 'valor'] = obj
    return out


def enrich_person_columns(flat: Dict[str, Any]) -&gt; Dict[str, Any]:
    # Surface likely person fields into predictable columns (best-effort)
    out = dict(flat)
    for k in list(flat.keys()):
        nk = norm(k)
        if nk.endswith('.nome') and 'pessoa.nome' not in out:
            out['pessoa.nome'] = flat[k]
        if nk.endswith('.cpf') and 'pessoa.cpf' not in out:
            out['pessoa.cpf'] = flat[k]
        if nk.endswith('.rg') and 'pessoa.rg' not in out:
            out['pessoa.rg'] = flat[k]
        if 'nascimento' in nk and 'pessoa.nascimento' not in out:
            out['pessoa.nascimento'] = flat[k]
        if 'envolvido' in nk and 'nome' in nk and 'pessoa.nome' not in out:
            out['pessoa.nome'] = flat[k]
    return out


def make_run_dir(parent: pathlib.Path) -&gt; pathlib.Path:
    ts = datetime.now().strftime('%Y%m%d_%H%M%S')
    run_dir = parent / f"bnmp_run_{ts}"
    run_dir.mkdir(parents=True, exist_ok=True)
    return run_dir


def ndjson_gzip_writer(path: pathlib.Path):
    f = gzip.open(path, 'wt', encoding='utf-8')
    def write(obj: Dict[str, Any]):
        f.write(json.dumps(obj, ensure_ascii=False) + "\n")
    return f, write


def html_preview(rows: List[Dict[str, Any]], title: str) -&gt; str:
    # Determine columns: person/context first, then others
    preferred = ['pessoa.nome','pessoa.cpf','pessoa.rg','pessoa.nascimento','__orgao.id','__orgao.nome','__uf.id']
    cols, seen = [], set()
    for c in preferred:
        if any(c in r for r in rows) and c not in seen:
            seen.add(c); cols.append(c)
    for r in rows:
        for k in r.keys():
            if k not in seen:
                seen.add(k); cols.append(k)
    thead = ''.join(f'&lt;th&gt;{html.escape(c)}&lt;/th&gt;' for c in cols)
    body = []
    for r in rows:
        tds = []
        for c in cols:
            v = r.get(c)
            if isinstance(v, (dict, list)):
                cell = f"&lt;code&gt;{html.escape(json.dumps(v, ensure_ascii=False))}&lt;/code&gt;"
            else:
                cell = html.escape('' if v is None else str(v))
            tds.append(f'&lt;td&gt;{cell}&lt;/td&gt;')
        body.append(f"&lt;tr&gt;{''.join(tds)}&lt;/tr&gt;")
    head = f"""
&lt;!doctype html&gt;&lt;html lang="pt-br"&gt;&lt;meta charset="utf-8"&gt;
&lt;title&gt;{html.escape(title)}&lt;/title&gt;
&lt;style&gt;
 body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px}}
 h1{{font-size:20px;margin:0}}
 .meta{{color:#444;margin:6px 0 14px 0;font-size:12px}}
 table{{border-collapse:collapse;width:100%}}
 th,td{{border:1px solid #ddd;padding:6px 8px;font-size:12px;vertical-align:top}}
 th{{position:sticky;top:0;background:#f6f6f6;text-align:left}}
 tr:nth-child(even){{background:#fafafa}}
 code{{white-space:pre-wrap}}
&lt;/style&gt;
"""
    return head + f"&lt;h1&gt;{html.escape(title)}&lt;/h1&gt;" + f"&lt;table&gt;&lt;thead&gt;&lt;tr&gt;{thead}&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;{''.join(body)}&lt;/tbody&gt;&lt;/table&gt;&lt;/html&gt;"

# --- ID / dedupe helpers ---
CANDIDATE_ID_KEYS = [
    'id',
    'peca.id', 'pecaId', 'idPeca',
    'mandado.id', 'idMandado',
    'processo.id', 'idProcesso',
    'pecas[0].id',  # occasional shapes
]

def best_effort_uid(flat: Dict[str, Any]) -&gt; str:
    for k in CANDIDATE_ID_KEYS:
        if k in flat and flat[k] is not None:
            return f"{k}:{flat[k]}"
    # fallback: stable hash of sorted items
    items = sorted((str(k), json.dumps(v, ensure_ascii=False, sort_keys=True)) for k, v in flat.items())
    h = hashlib.sha1()
    for k, v in items:
        h.update(k.encode('utf-8'))
        h.update(b'\x00')
        h.update(v.encode('utf-8'))
        h.update(b'\x00')
    return f"hash:{h.hexdigest()}"

# --- Harvest strategies ---

def list_orgaos_for_uf(headers: Dict[str, str], uf_id: int, *, retries: int, base_sleep: float, timeout: int) -&gt; List[Dict[str, Any]]:
    url = f"{ORGAOS_UF_URL}/{uf_id}"
    resp = open_json(url, 'GET', headers, None, max_tries=retries, base_sleep=base_sleep, timeout=timeout)
    if not isinstance(resp, list):
        raise SystemExit('Resposta inesperada ao listar órgãos (array esperado).')
    resp.sort(key=lambda o: ((o.get('nome') or '').casefold(), int(o.get('id') or 0)))
    return resp


def harvest_pecas_por_orgao(headers: Dict[str, str], uf_id: int, *, writer, counters: Dict[str, int],
                             page_size: int, retries: int, base_sleep: float, timeout: int,
                             sleep_page: float, sleep_org: float, tipo_peca: Optional[List[str]],
                             sample_buf: deque, sample_cap: int) -&gt; None:
    orgaos = list_orgaos_for_uf(headers, uf_id, retries=retries, base_sleep=base_sleep, timeout=timeout)
    counters['orgaos_total'] = len(orgaos)
    print(f"[pecas-orgao] órgãos encontrados: {len(orgaos)}", file=sys.stderr)
    for org in orgaos:
        org_id = org.get('id'); org_nome = org.get('nome')
        if org_id is None:
            continue
        counters['orgaos_consultados'] += 1
        page = 0
        while True:
            payload = {
                'pagina': page, 'tamanhoPagina': page_size,
                'page': page,   'size': page_size,
                'filtros': {
                    'unidadeFederativaId': uf_id,
                    'orgaoId': org_id,
                },
                'ordenacao': [ {'propriedade':'dataExpedicao','direcao':'DESC'} ]
            }
            if tipo_peca:
                payload['filtros']['tipoPeca'] = tipo_peca
            try:
                resp = open_json(PECAS_URL, 'POST', headers, payload,
                                  max_tries=retries, base_sleep=base_sleep, timeout=timeout)
            except error.HTTPError as e:
                if e.code == 401:
                    counters['count_401'] += 1
                    print(f"[401] órgão {org_id} — {org_nome}: acesso não autorizado; seguindo…", file=sys.stderr)
                    break
                elif e.code in TRANSIENT:
                    counters['transient_failures'] += 1
                    print(f"[WARN] {e.code} persistente em órgão {org_id} — {org_nome}; seguindo…", file=sys.stderr)
                    break
                else:
                    print(f"[WARN] órgão {org_id} — {org_nome}: erro '{e}'; seguindo…", file=sys.stderr)
                    break
            except error.URLError as e:
                counters['transient_failures'] += 1
                print(f"[WARN] URLError em órgão {org_id} — {org_nome}: '{e.reason}'; seguindo…", file=sys.stderr)
                break

            items = autodetect_items(resp)
            if not items:
                break
            added = 0
            for it in items:
                flat = enrich_person_columns(flatten(it))
                flat['__orgao.id'] = org_id
                flat['__orgao.nome'] = org_nome
                flat['__uf.id'] = uf_id
                writer(flat)
                counters['rows_pecas_orgao'] += 1
                added += 1
                if len(sample_buf) &lt; sample_cap:
                    sample_buf.append(dict(flat))
            page += 1
            print(f"[pecas-orgao] UF {uf_id} — órgão {org_id} — página {page} (+{added}) total={counters['rows_pecas_orgao']}", file=sys.stderr)
            time.sleep(sleep_page)
        time.sleep(sleep_org)


def harvest_filter_uf(headers: Dict[str, str], uf_id: int, *, writer, counters: Dict[str, int],
                       page_size: int, retries: int, base_sleep: float, timeout: int,
                       sleep_page: float, sort_filter: Optional[str], sample_buf: deque, sample_cap: int) -&gt; None:
    page = 0
    while True:
        query = {'page': page, 'size': page_size}
        if sort_filter:
            query['sort'] = sort_filter
        payload = {
            'buscaOrgaoRecursivo': True,
            'orgaoExpeditor': {},
            'idEstado': uf_id,
        }
        try:
            resp = open_json(FILTER_URL, 'POST', headers, payload,
                              max_tries=retries, base_sleep=base_sleep, timeout=timeout,
                              query=query)
        except error.HTTPError as e:
            if e.code == 401:
                counters['count_401'] += 1
                print(f"[401] filter UF {uf_id}: acesso não autorizado; encerrando.", file=sys.stderr)
                break
            elif e.code in TRANSIENT:
                counters['transient_failures'] += 1
                print(f"[WARN] {e.code} persistente no filter UF; encerrando.", file=sys.stderr)
                break
            else:
                print(f"[WARN] filter UF erro '{e}'; encerrando.", file=sys.stderr)
                break
        except error.URLError as e:
            counters['transient_failures'] += 1
            print(f"[WARN] URLError no filter UF: '{e.reason}'; encerrando.", file=sys.stderr)
            break

        items = autodetect_items(resp)
        if not items:
            break
        added = 0
        for it in items:
            flat = enrich_person_columns(flatten(it))
            flat['__uf.id'] = uf_id
            writer(flat)
            counters['rows_filter_uf'] += 1
            added += 1
            if len(sample_buf) &lt; sample_cap:
                sample_buf.append(dict(flat))
        last = bool(resp.get('last')) if isinstance(resp, dict) else False
        number = int(resp.get('number', page)) if isinstance(resp, dict) else page
        total_pages = int(resp.get('totalPages', (page + 1))) if isinstance(resp, dict) else None
        print(f"[filter-uf] UF {uf_id} — página {page} (+{added}) total={counters['rows_filter_uf']} last={last} totalPages={total_pages}", file=sys.stderr)
        if last:
            break
        if total_pages is not None and (number + 1) &gt;= total_pages:
            break
        page += 1
        time.sleep(sleep_page)

# --- Merging &amp; HTML preview ---

def merge_streams_dedup(in_paths: List[pathlib.Path], out_path: pathlib.Path, sample_buf: deque, sample_cap: int) -&gt; Dict[str, int]:
    seen: set[str] = set()
    counts = defaultdict(int)
    with gzip.open(out_path, 'wt', encoding='utf-8') as out:
        for p in in_paths:
            if not p or not p.exists():
                continue
            with gzip.open(p, 'rt', encoding='utf-8') as f:
                for line in f:
                    try:
                        obj = json.loads(line)
                    except Exception:
                        counts['decode_errors'] += 1
                        continue
                    uid = best_effort_uid(obj)
                    if uid in seen:
                        counts['dedup_skipped'] += 1
                        continue
                    seen.add(uid)
                    out.write(json.dumps(obj, ensure_ascii=False) + "\n")
                    counts['merged_rows'] += 1
                    if len(sample_buf) &lt; sample_cap:
                        sample_buf.append(dict(obj))
    counts['unique_keys'] = len(seen)
    return counts

# --- CLI &amp; main ---

def resolve_uf_id(args_state: Optional[str], args_uf_id: Optional[int]) -&gt; Tuple[int, str]:
    if args_uf_id is not None:
        return int(args_uf_id), f"UF {int(args_uf_id)}"
    if not args_state:
        raise SystemExit('Defina --state ou --uf-id.')
    uf_id = STATE_MAP.get(norm(args_state))
    if not uf_id:
        raise SystemExit(f"UF/Estado desconhecido: '{args_state}'. Use nome por extenso ou sigla.")
    return uf_id, args_state


def main():
    ap = argparse.ArgumentParser(description='BNMP — UF-wide harvester (both per-órgão and UF filter).')
    ap.add_argument('--state', help='UF name/sigla, e.g., "Goiás", "GO", "DF"')
    ap.add_argument('--uf-id', type=int, help='UF id num (1..27)')
    ap.add_argument('--cookie', default=os.environ.get('BNMP_COOKIE'), help='portalbnmp cookie (JWT) or env BNMP_COOKIE')
    ap.add_argument('--fp', default=os.environ.get('BNMP_FP'), help='fingerprint header or env BNMP_FP')
    ap.add_argument('--strategy', choices=['both','pecas-orgao','filter-uf'], default='both')
    ap.add_argument('--tipo-peca', nargs='*', help='Optional tipoPeca list (e.g., MANDADO_DE_PRISAO). If omitted, collects ALL peças.')
    ap.add_argument('--page-size-pecas', type=int, default=int(os.environ.get('BNMP_PAGE_SIZE_PECAS', '200')))
    ap.add_argument('--page-size-filter', type=int, default=int(os.environ.get('BNMP_PAGE_SIZE_FILTER', '500')))
    ap.add_argument('--retries', type=int, default=int(os.environ.get('BNMP_RETRIES', '6')))
    ap.add_argument('--timeout', type=int, default=int(os.environ.get('BNMP_TIMEOUT', '90')))
    ap.add_argument('--sleep-page', type=float, default=float(os.environ.get('BNMP_SLEEP_PAGE', '0.25')))
    ap.add_argument('--sleep-org', type=float, default=float(os.environ.get('BNMP_SLEEP_ORG', '0.35')))
    ap.add_argument('--base-sleep', type=float, default=float(os.environ.get('BNMP_BASE_SLEEP', '0.6')))
    ap.add_argument('--sort-filter', default=os.environ.get('BNMP_SORT_FILTER', 'dataExpedicao,DESC'))
    ap.add_argument('--sample', type=int, default=int(os.environ.get('BNMP_SAMPLE', '200')))
    ap.add_argument('--out-dir', default=os.environ.get('BNMP_OUT_DIR', './bnmp_out'))
    args = ap.parse_args()

    if not args.cookie or not args.fp:
        raise SystemExit('Defina --cookie/BNMP_COOKIE e --fp/BNMP_FP.')

    uf_id, state_label = resolve_uf_id(args.state, args.uf_id)

    headers = build_headers(args.cookie, args.fp)

    parent = pathlib.Path(args.out_dir)
    run_dir = make_run_dir(parent)

    # Prepare outputs
    f1_path = run_dir / 'raw_pecas_orgao.ndjson.gz'
    f2_path = run_dir / 'raw_filter_uf.ndjson.gz'
    merged_path = run_dir / 'merged_dedup.ndjson.gz'
    sample_path = run_dir / 'sample_preview.html'
    manifest_path = run_dir / 'manifest.json'

    sample_buf: deque = deque()

    counters: Dict[str, int] = defaultdict(int)
    meta: Dict[str, Any] = {
        'started_at': datetime.now().isoformat(timespec='seconds'),
        'uf_id': uf_id,
        'state_label': state_label,
        'strategy': args.strategy,
        'page_size_pecas': args.page_size_pecas,
        'page_size_filter': args.page_size_filter,
        'retries': args.retries,
        'timeout': args.timeout,
        'sleep_page': args.sleep_page,
        'sleep_org': args.sleep_org,
        'base_sleep': args.base_sleep,
        'sort_filter': args.sort_filter,
        'tipo_peca': args.tipo_peca or [],
        'out_dir': str(run_dir),
    }

    print(f"[init] UF {uf_id} / {state_label} — strategy={args.strategy} — out={run_dir}", file=sys.stderr)

    t0 = time.time()

    # Strategy: per-órgão
    if args.strategy in ('both', 'pecas-orgao'):
        f1, write1 = ndjson_gzip_writer(f1_path)
        try:
            harvest_pecas_por_orgao(headers, uf_id,
                                     writer=write1, counters=counters,
                                     page_size=args.page_size_pecas, retries=args.retries,
                                     base_sleep=args.base_sleep, timeout=args.timeout,
                                     sleep_page=args.sleep_page, sleep_org=args.sleep_org,
                                     tipo_peca=(args.tipo_peca or None),
                                     sample_buf=sample_buf, sample_cap=args.sample)
        finally:
            f1.close()

    # Strategy: UF filter
    if args.strategy in ('both', 'filter-uf'):
        f2, write2 = ndjson_gzip_writer(f2_path)
        try:
            harvest_filter_uf(headers, uf_id,
                              writer=write2, counters=counters,
                              page_size=args.page_size_filter, retries=args.retries,
                              base_sleep=args.base_sleep, timeout=args.timeout,
                              sleep_page=args.sleep_page, sort_filter=args.sort_filter,
                              sample_buf=sample_buf, sample_cap=args.sample)
        finally:
            f2.close()

    # Merge &amp; dedup
    merge_counts = merge_streams_dedup(
        [f1_path if f1_path.exists() else None, f2_path if f2_path.exists() else None],
        merged_path, sample_buf, args.sample
    )

    # HTML preview from sample
    title = (
        f"BNMP — UF {uf_id} / {state_label} — merged rows={merge_counts.get('merged_rows',0)} — "
        f"{datetime.now():%Y-%m-%d %H:%M:%S}"
    )
    html_text = html_preview(list(sample_buf), title)
    sample_path.write_text(html_text, encoding='utf-8')

    # Manifest
    meta.update({
        'finished_at': datetime.now().isoformat(timespec='seconds'),
        'duration_sec': round(time.time() - t0, 2),
        'counters': dict(counters),
        'merge_counts': dict(merge_counts),
        'outputs': {
            'per_orgao': str(f1_path) if f1_path.exists() else None,
            'filter_uf': str(f2_path) if f2_path.exists() else None,
            'merged': str(merged_path),
            'html_preview': str(sample_path),
        }
    })
    manifest_path.write_text(json.dumps(meta, ensure_ascii=False, indent=2), encoding='utf-8')

    print(json.dumps(meta, ensure_ascii=False, indent=2))


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\n[abort] interrupted by user", file=sys.stderr)
        sys.exit(130)
</code></pre></div></div>]]></content><author><name></name></author><category term="scratchpad" /></entry><entry><title type="html">coolice reset script</title><link href="https://ib.bsb.br/coolice-reset-script/" rel="alternate" type="text/html" title="coolice reset script" /><published>2025-09-15T00:00:00+00:00</published><updated>2025-09-15T09:34:14+00:00</updated><id>https://ib.bsb.br/coolice-reset-script</id><content type="html" xml:base="https://ib.bsb.br/coolice-reset-script/"><![CDATA[<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
<span class="c">#</span>
<span class="c"># Revised: stable logging and safe optional tracing.</span>
<span class="c"># - Key changes vs. previous iteration:</span>
<span class="c">#   * Use a stable log file in BASEDIR (not inside ephemeral WORKDIR) for all persistent logs.</span>
<span class="c">#   * Open a single persistent FD (3) for programmatic logging and (optionally) BASH_XTRACEFD.</span>
<span class="c">#   * Do NOT use DEBUG traps (they are fragile with process substitution); rely on BASH_XTRACEFD when available.</span>
<span class="c">#   * Avoid tee pipelines for log writes; use single FD writes to avoid FD lifecycle races.</span>
<span class="c">#</span>
<span class="nb">set</span> <span class="nt">-Eeuo</span> pipefail
<span class="nb">shopt</span> <span class="nt">-s</span> inherit_errexit 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
</span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n\t</span><span class="s1">'</span>

<span class="c"># -----------------------</span>
<span class="c"># Small helpers early (used by arg parsing/sanity checks)</span>
<span class="c"># -----------------------</span>
timestamp<span class="o">()</span> <span class="o">{</span> <span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="p">;</span> <span class="o">}</span>

abs<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">p</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">realpath</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    </span><span class="nb">realpath</span> <span class="nt">-m</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">elif </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">readlink</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    </span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">else</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s/%s\n'</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span> <span class="nt">-P</span><span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span><span class="o">)</span> <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">fi</span>
<span class="o">}</span>

is_special<span class="o">()</span> <span class="o">{</span> <span class="o">[</span> <span class="nt">-S</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Configuration defaults</span>
<span class="c"># -----------------------</span>
<span class="nv">DEFAULT_BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">:-</span><span class="p">/home/ibbsbbry</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="nv">$DEFAULT_BASEDIR</span><span class="s2">"</span>
<span class="nv">APPLY</span><span class="o">=</span>0
<span class="nv">USE_ZIP</span><span class="o">=</span>0
<span class="nv">DEBUG</span><span class="o">=</span>0
<span class="nv">TRACE</span><span class="o">=</span>0
<span class="nv">TIMESTAMP</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">date</span> +%Y%m%d_%H%M%S<span class="si">)</span><span class="s2">"</span>
<span class="nv">MIN_FREE_KB</span><span class="o">=</span>102400

<span class="c"># -----------------------</span>
<span class="c"># Tool detection (FIX for latent bug)</span>
<span class="c"># -----------------------</span>
<span class="nv">TAR_GNU</span><span class="o">=</span>0
<span class="k">if </span><span class="nb">tar</span> <span class="nt">--version</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s1">'GNU tar'</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">TAR_GNU</span><span class="o">=</span>1
<span class="k">fi
</span><span class="nv">HAS_ZIP</span><span class="o">=</span>0
<span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> zip <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
  </span><span class="nv">HAS_ZIP</span><span class="o">=</span>1
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Lightweight logging helpers (they write to FD 3 when available)</span>
<span class="c"># -----------------------</span>
_log_to_fd3<span class="o">()</span> <span class="o">{</span>
  <span class="c"># write a single line to FD3 if it's open; fall back to stdout/stderr</span>
  <span class="nb">local ln</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="k">if</span> <span class="o">{</span> <span class="nb">true</span> <span class="o">&gt;</span>&amp;3<span class="p">;</span> <span class="o">}</span> 2&gt;/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$ln</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;3 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span><span class="k">else
    </span><span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$ln</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span><span class="k">fi</span>
<span class="o">}</span>

log<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] INFO: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="o">}</span>
warn<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] WARN: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>
err<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] ERROR: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>
dbg<span class="o">()</span> <span class="o">{</span>
  <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DEBUG</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>0
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] DEBUG: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="o">}</span>
trace_log<span class="o">()</span> <span class="o">{</span>
  <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TRACE</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>0
  <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">local </span>line
  <span class="nv">line</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'[%s] TRACE: %s'</span> <span class="s2">"</span><span class="si">$(</span>timestamp<span class="si">)</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$msg</span><span class="s2">"</span><span class="si">)</span>
  _log_to_fd3 <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># Capture minimal last/current command for error context</span>
<span class="nv">CURRENT_COMMAND</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">LAST_COMMAND</span><span class="o">=</span><span class="s2">""</span>

<span class="c"># -----------------------</span>
<span class="c"># Argument parsing</span>
<span class="c"># -----------------------</span>
usage<span class="o">()</span> <span class="o">{</span>
  <span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">USAGE</span><span class="sh">
Usage: trim_and_fixperms.sh [options]
Default: DRY-RUN (no destructive actions).

Options:
  -y, --apply        Execute archive + remove + permissions (destructive)
      --zip          Prefer ZIP archive (requires 'zip')
      --base DIR     Base directory (default: </span><span class="se">\$</span><span class="sh">HOME)
      --debug        Enable verbose debug logging (paths &amp; outcomes)
      --trace        Enable command tracing (command-level trace; requires bash &gt;= 4.1)
  -h, --help         Show this help
</span><span class="no">USAGE
</span><span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">do
  case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in</span>
    <span class="nt">-y</span><span class="p">|</span><span class="nt">--apply</span><span class="p">)</span> <span class="nv">APPLY</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">--zip</span><span class="p">)</span> <span class="nv">USE_ZIP</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">--base</span><span class="p">)</span>
      <span class="nb">shift
      </span><span class="nv">BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$BASEDIR</span><span class="k">}</span><span class="s2">"</span>
      <span class="nb">shift</span>
      <span class="p">;;</span>
    <span class="nt">--debug</span><span class="p">)</span> <span class="nv">DEBUG</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">--trace</span><span class="p">)</span> <span class="nv">TRACE</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">shift</span> <span class="p">;;</span>
    <span class="nt">-h</span><span class="p">|</span><span class="nt">--help</span><span class="p">)</span> usage<span class="p">;</span> <span class="nb">exit </span>0 <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Unknown option: </span><span class="nv">$1</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> usage<span class="p">;</span> <span class="nb">exit </span>1 <span class="p">;;</span>
  <span class="k">esac</span>
<span class="k">done</span>

<span class="c"># -----------------------</span>
<span class="c"># Resolve BASEDIR and do early safety checks (we create persistent log in BASEDIR)</span>
<span class="c"># -----------------------</span>
<span class="nv">BASEDIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="k">in</span>
  <span class="s2">"/"</span><span class="p">|</span><span class="s2">"/root"</span><span class="p">|</span><span class="s2">"/home"</span><span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Refusing to operate on </span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="nb">exit </span>1 <span class="p">;;</span>
<span class="k">esac</span>
<span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"Base dir not found: </span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>

<span class="nv">FREE_KB</span><span class="o">=</span><span class="si">$(</span><span class="nb">df</span> <span class="nt">-k</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'NR==2{print $4}'</span> <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$FREE_KB</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$FREE_KB</span><span class="s2">"</span> <span class="nt">-lt</span> <span class="s2">"</span><span class="nv">$MIN_FREE_KB</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Low free space on filesystem containing </span><span class="nv">$BASEDIR</span><span class="s2"> (</span><span class="nv">$FREE_KB</span><span class="s2"> KB &lt; </span><span class="nv">$MIN_FREE_KB</span><span class="s2"> KB)"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Prepare stable log (outside WORKDIR) and open FD3</span>
<span class="c"># -----------------------</span>
<span class="nv">LOG_STABLE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log"</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
<span class="c"># Open FD3 for persistent programmatic logging; leave it open until on_exit</span>
<span class="nb">exec </span>3&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>

<span class="c"># If TRACE requested, enable Bash xtrace to FD3 (requires bash &gt;= 4.1)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TRACE</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
  if</span> <span class="o">((</span>BASH_VERSINFO[0] <span class="o">&gt;</span> 4 <span class="o">||</span> <span class="o">(</span>BASH_VERSINFO[0] <span class="o">==</span> 4 <span class="o">&amp;&amp;</span> BASH_VERSINFO[1] <span class="o">&gt;=</span> 1<span class="o">)))</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">export </span><span class="nv">BASH_XTRACEFD</span><span class="o">=</span>3
    <span class="nv">PS4</span><span class="o">=</span><span class="s1">'+[$(date "+%Y-%m-%d %H:%M:%S")] '</span>
    <span class="nb">set</span> <span class="nt">-x</span>
    trace_log <span class="s2">"Enabled per-command xtrace to </span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>
  <span class="k">else
    </span><span class="nv">TRACE</span><span class="o">=</span>0
    dbg <span class="s2">"TRACE disabled: bash too old to safely redirect xtrace (requires bash &gt;= 4.1)"</span>
  <span class="k">fi
fi

</span>log <span class="s2">"Script started: </span><span class="nv">$0</span><span class="s2"> (TIMESTAMP=</span><span class="nv">$TIMESTAMP</span><span class="s2">) LOG=</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>

<span class="c"># -----------------------</span>
<span class="c"># Prepare WORKDIR (ephemeral)</span>
<span class="c"># -----------------------</span>
<span class="nv">WORKDIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TMPDIR</span><span class="k">:-</span><span class="p">/tmp</span><span class="k">}</span><span class="s2">/trimwork.</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.XXXXXX"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span><span class="si">)</span><span class="s2">"</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-w</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">WORKDIR</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.trimwork_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="o">{</span> err <span class="s2">"Cannot create workdir: </span><span class="nv">$WORKDIR</span><span class="s2">"</span><span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>
  <span class="nb">chmod </span>700 <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
</span><span class="k">fi</span>

<span class="c"># local copies of path variables inside workdir if needed</span>
<span class="nv">DOMAINS_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/domains_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.lst"</span>
<span class="nv">CAND_ABS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/candidates_abs_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.nul"</span>
<span class="nv">CAND_REL</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/candidates_rel_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.nul"</span>

: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>

dbg <span class="s2">"WORKDIR=</span><span class="nv">$WORKDIR</span><span class="s2">"</span>

<span class="c"># -----------------------</span>
<span class="c"># Error handler uses stable log (LOG_STABLE). Keep WORKDIR until on_exit.</span>
<span class="c"># -----------------------</span>
on_error<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">rc</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$?</span><span class="k">}</span>
  <span class="nv">LAST_COMMAND</span><span class="o">=</span><span class="k">${</span><span class="nv">LAST_COMMAND</span><span class="k">:-</span><span class="s1">'&lt;none&gt;'</span><span class="k">}</span>
  <span class="nv">CURRENT_COMMAND</span><span class="o">=</span><span class="k">${</span><span class="nv">CURRENT_COMMAND</span><span class="k">:-</span><span class="s2">"</span><span class="nv">$BASH_COMMAND</span><span class="s2">"</span><span class="k">}</span>
  err <span class="s2">"Script failed (exit code </span><span class="k">${</span><span class="nv">rc</span><span class="k">}</span><span class="s2">)."</span>
  err <span class="s2">"Last command: </span><span class="k">${</span><span class="nv">LAST_COMMAND</span><span class="k">}</span><span class="s2">"</span>
  err <span class="s2">"Current command: </span><span class="k">${</span><span class="nv">CURRENT_COMMAND</span><span class="k">}</span><span class="s2">"</span>
  err <span class="s2">"Location: PWD=</span><span class="si">$(</span><span class="nb">pwd </span>2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s1">'&lt;pwd?&gt;'</span><span class="si">)</span><span class="s2"> USER=</span><span class="k">${</span><span class="nv">USER</span><span class="k">:-}</span><span class="s2">"</span>
  err <span class="s2">"Preserved WORKDIR for inspection: </span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-</span><span class="p">&lt;none&gt;</span><span class="k">}</span><span class="s2">"</span>
  <span class="nv">KEEP_WORKDIR_ON_EXIT</span><span class="o">=</span>1
  <span class="c"># Ensure stable log has been copied/available; it's already in BASEDIR so no-op most times.</span>
  <span class="nb">cp</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log.FAILED"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span>err <span class="s2">"Copied runtime log (best-effort) to </span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log.FAILED"</span>
  <span class="c"># Close FD3 only at the end via on_exit; exit now</span>
  <span class="nb">exit</span> <span class="s2">"</span><span class="nv">$rc</span><span class="s2">"</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s1">'on_error $?'</span> ERR

on_exit<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">rc</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$?</span><span class="k">}</span>
  <span class="c"># flush/close FD3 last (best-effort)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$rc</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">cp</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/trim_and_fixperms_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.log"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>dbg <span class="s2">"Final log left at </span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>
  <span class="k">fi
  if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">KEEP_WORKDIR_ON_EXIT</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Preserving WORKDIR for inspection: </span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-</span><span class="p">&lt;none&gt;</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">else
    if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
      </span>dbg <span class="s2">"Removed WORKDIR: </span><span class="nv">$WORKDIR</span><span class="s2">"</span>
    <span class="k">fi
  fi</span>
  <span class="c"># close FD3</span>
  <span class="nb">exec </span>3&gt;&amp;- 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s1">'on_exit $?'</span> EXIT

<span class="c"># -----------------------</span>
<span class="c"># Portable functions used below</span>
<span class="c"># -----------------------</span>
path_size<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">p</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s1">'0\n'</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="o">}</span>
  <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">stat</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    if </span><span class="nb">stat</span> <span class="nt">--version</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
      </span><span class="nb">stat</span> <span class="nt">-c</span>%s <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">du</span> <span class="nt">-sb</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="o">||</span> <span class="nb">echo </span>0
    <span class="k">else
      </span><span class="nb">stat</span> <span class="nt">-f</span>%z <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">du</span> <span class="nt">-sk</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1*1024}'</span> <span class="o">||</span> <span class="nb">echo </span>0
    <span class="k">fi
  else
    </span><span class="nb">du</span> <span class="nt">-sb</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="o">||</span> <span class="nb">du</span> <span class="nt">-sk</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $1*1024}'</span> <span class="o">||</span> <span class="nb">echo </span>0
  <span class="k">fi</span>
<span class="o">}</span>

human<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">n</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> <span class="nb">numfmt</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
    </span><span class="nb">numfmt</span> <span class="nt">--to</span><span class="o">=</span>iec <span class="nt">--suffix</span><span class="o">=</span>B <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">printf</span> <span class="s1">'%sB'</span> <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span>
  <span class="k">else
    </span><span class="nb">awk</span> <span class="nt">-v</span> <span class="nv">b</span><span class="o">=</span><span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span> <span class="s1">'BEGIN{function hr(x){s="B K M G";i=1;while(x&gt;=1024&amp;&amp;i&lt;4){x/=1024;i++}printf 
"%.1f%s",x,substr(s,i*2-1,1)};hr(b)}'</span>
  <span class="k">fi</span>
<span class="o">}</span>

safe_move<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">src</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="nv">dst</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
  dbg <span class="s2">"safe_move: '</span><span class="nv">$src</span><span class="s2">' -&gt; '</span><span class="nv">$dst</span><span class="s2">'"</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">APPLY</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    if </span><span class="nb">mv</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
      </span>dbg <span class="s2">"mv succeeded: </span><span class="nv">$src</span><span class="s2"> -&gt; </span><span class="nv">$dst</span><span class="s2">"</span>
      <span class="k">return </span>0
    <span class="k">fi
    </span>dbg <span class="s2">"mv failed, attempting cp -a + rm -rf for </span><span class="nv">$src</span><span class="s2">"</span>
    <span class="k">if </span><span class="nb">cp</span> <span class="nt">-a</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span> err <span class="s2">"rm after cp failed for </span><span class="nv">$src</span><span class="s2">"</span><span class="p">;</span> <span class="k">return </span>1<span class="p">;</span> <span class="o">}</span>
      dbg <span class="s2">"cp+rm succeeded for </span><span class="nv">$src</span><span class="s2">"</span>
      <span class="k">return </span>0
    <span class="k">fi
    </span>err <span class="s2">"safe_move failed for </span><span class="nv">$src</span><span class="s2"> -&gt; </span><span class="nv">$dst</span><span class="s2">"</span>
    <span class="k">return </span>1
  <span class="k">else
    </span>dbg <span class="s2">"DRY-RUN safe_move: </span><span class="nv">$src</span><span class="s2"> -&gt; </span><span class="nv">$dst</span><span class="s2">"</span>
    <span class="k">return </span>0
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Discover domain roots</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Discovering domain roots..."</span>
<span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/public_html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/domains"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  for </span>d <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/domains"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do</span>
    <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">/public_html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
  <span class="k">done
fi
for </span>d <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do</span>
  <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">/public_html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">done
if</span> <span class="o">[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">LC_ALL</span><span class="o">=</span>C <span class="nb">sort</span> <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">fi
</span><span class="nv">DOM_COUNT</span><span class="o">=</span><span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> &lt; <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
log <span class="s2">"Detected </span><span class="nv">$DOM_COUNT</span><span class="s2"> domain roots"</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOM_COUNT</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">sed</span> <span class="s1">'s/^/  /'</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
</span><span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Candidate collection helpers</span>
<span class="c"># -----------------------</span>
<span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
<span class="nv">SCRIPT_IN_BASE</span><span class="o">=</span>0
<span class="k">case</span> <span class="s2">"</span><span class="nv">$SCRIPT_PATH</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span><span class="p">|</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">)</span> <span class="nv">SCRIPT_IN_BASE</span><span class="o">=</span>1 <span class="p">;;</span> <span class="k">esac</span>

append_abs<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">p</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-}</span><span class="s2">"</span>
  <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>0
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SCRIPT_IN_BASE</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$SCRIPT_PATH</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Skipping script itself: </span><span class="nv">$p</span><span class="s2">"</span>
    <span class="k">return </span>0
  <span class="k">fi
  case</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">)</span> dbg <span class="s2">"Skipping workdir path: </span><span class="nv">$p</span><span class="s2">"</span><span class="p">;</span> <span class="k">return </span>0 <span class="p">;;</span> <span class="k">esac</span>
  <span class="k">if </span>is_special <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Skipping special file: </span><span class="nv">$p</span><span class="s2">"</span>
    <span class="k">return </span>0
  <span class="k">fi
  </span><span class="nb">printf</span> <span class="s1">'%s\0'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>
  dbg <span class="s2">"Appended candidate: </span><span class="nv">$p</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Collect candidates</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Collecting candidate files..."</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOM_COUNT</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> D<span class="p">;</span> <span class="k">do
    </span><span class="nv">D</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
    dbg <span class="s2">"Processing domain root: </span><span class="nv">$D</span><span class="s2">"</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/cgi-bin"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats/.data"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp/incoming"</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true</span>

    <span class="c"># Find all items (files, links, directories) at the top level of the domain root.</span>
    find <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> item<span class="p">;</span> <span class="k">do
      </span><span class="nv">base_item</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
      <span class="c"># Exclude standard directories that are handled by later, specific loops.</span>
      <span class="k">case</span> <span class="s2">"</span><span class="nv">$base_item</span><span class="s2">"</span> <span class="k">in
        </span>public_html|cgi-bin|logs|stats|awstats|public_ftp|.htpasswd<span class="p">)</span>
          dbg <span class="s2">"Skipping standard path in main loop: </span><span class="nv">$item</span><span class="s2">"</span>
          <span class="k">continue</span>
          <span class="p">;;</span>
      <span class="k">esac</span>

      <span class="c"># If the item is a file or symlink at the domain root, add it as a candidate.</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-L</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>append_abs <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span>
      <span class="c"># If the item is a directory not in our exclusion list (e.g., 'data'),</span>
      <span class="c"># recursively find and add all files within it.</span>
      <span class="k">elif</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>dbg <span class="s2">"Scanning non-standard directory for files: </span><span class="nv">$item</span><span class="s2">"</span>
        find <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
          </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
        <span class="k">done
      fi
    done</span>

    <span class="c"># Now, process the standard directories with their specific rules.</span>
    <span class="nv">PH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$PH</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        </span><span class="nv">base</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$base</span><span class="s2">"</span> <span class="k">in </span>index.html|index.htm|index.php<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/.well-known"</span><span class="p">|</span><span class="s2">"</span><span class="k">${</span><span class="nv">PH</span><span class="k">}</span><span class="s2">/.well-known/"</span><span class="k">*</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
      <span class="k">done
    fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
    fi
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
    fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        </span><span class="nv">bn</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$bn</span><span class="s2">"</span> <span class="k">in</span> .data|awstats.pl<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$bn</span><span class="s2">"</span> <span class="k">in </span>awstats<span class="k">*</span>.conf<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
      <span class="k">done
    fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        case</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp/incoming"</span><span class="p">|</span><span class="s2">"</span><span class="k">${</span><span class="nv">D</span><span class="k">}</span><span class="s2">/public_ftp/incoming/"</span><span class="k">*</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span>
      <span class="k">done
    fi
  done</span> &lt; <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># Top-level under BASEDIR</span>
find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> top<span class="p">;</span> <span class="k">do</span>
  <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="k">continue
  case</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span><span class="p">|</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/public_html"</span><span class="p">|</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/domains"</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
  <span class="nv">skip</span><span class="o">=</span>0
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOM_COUNT</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> D<span class="p">;</span> <span class="k">do</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nv">skip</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="k">done</span> &lt; <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
  <span class="k">fi</span>
  <span class="o">[</span> <span class="s2">"</span><span class="nv">$skip</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue
  if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-L</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span>append_abs <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span>
  <span class="k">elif</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>find <span class="s2">"</span><span class="nv">$top</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do </span>append_abs <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
  fi
done</span>

<span class="c"># If no candidates, exit gracefully</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>log <span class="s2">"No candidates found; nothing to do."</span>
  <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Build relative list and compute totals</span>
<span class="c"># -----------------------</span>
: <span class="o">&gt;</span><span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> abs<span class="p">;</span> <span class="k">do
  case</span> <span class="s2">"</span><span class="nv">$abs</span><span class="s2">"</span> <span class="k">in</span>
    <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span><span class="p">)</span> <span class="nv">rel</span><span class="o">=</span><span class="s1">'.'</span> <span class="p">;;</span>
    <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span>/<span class="k">*</span><span class="p">)</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">abs</span><span class="p">#</span><span class="nv">$BASEDIR</span><span class="p">/</span><span class="k">}</span><span class="s2">"</span> <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"</span><span class="nv">$abs</span><span class="s2">"</span> <span class="p">;;</span>
  <span class="k">esac</span>
  <span class="nb">printf</span> <span class="s1">'%s\0'</span> <span class="s2">"</span><span class="nv">$rel</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>
<span class="k">done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>

<span class="nv">CAND_COUNT</span><span class="o">=</span><span class="si">$(</span><span class="nb">tr</span> <span class="nt">-cd</span> <span class="s1">'\0'</span> &lt;<span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span> | <span class="nb">wc</span> <span class="nt">-c</span> <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
<span class="nv">TOTAL_BYTES</span><span class="o">=</span>0
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> p<span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">bytes</span><span class="o">=</span><span class="si">$(</span>path_size <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo </span>0<span class="si">)</span>
    <span class="k">case</span> <span class="s2">"</span><span class="nv">$bytes</span><span class="s2">"</span> <span class="k">in</span> <span class="s1">''</span><span class="p">|</span><span class="k">*</span><span class="o">[!</span>0-9]<span class="k">*</span><span class="p">)</span> <span class="nv">bytes</span><span class="o">=</span>0 <span class="p">;;</span> <span class="k">esac</span>
    <span class="nv">TOTAL_BYTES</span><span class="o">=</span><span class="k">$((</span>TOTAL_BYTES <span class="o">+</span> bytes<span class="k">))</span>
  <span class="k">fi
done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>
log <span class="s2">"Candidates: </span><span class="nv">$CAND_COUNT</span><span class="s2"> (~</span><span class="si">$(</span>human <span class="s2">"</span><span class="nv">$TOTAL_BYTES</span><span class="s2">"</span><span class="si">)</span><span class="s2">)"</span>
log <span class="s2">"Sample (first 20):"</span>
<span class="nv">i</span><span class="o">=</span>0
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> p <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$i</span> <span class="nt">-lt</span> 20 <span class="o">]</span><span class="p">;</span> <span class="k">do
  </span><span class="nb">printf</span> <span class="s1">'  %s\n'</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">&gt;&gt;</span><span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
  </span><span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
<span class="k">done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>

<span class="c"># Dry-run: report and exit</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$APPLY</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>log <span class="s2">"DRY-RUN: no changes made. Re-run with --apply to execute."</span>
  <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># Confirm destructive action</span>
<span class="nb">printf</span> <span class="s1">'Type EXACTLY CONFIRM to proceed: '</span>
<span class="nb">read</span> <span class="nt">-r</span> CONFIRM
<span class="o">[</span> <span class="s2">"</span><span class="nv">$CONFIRM</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"CONFIRM"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> err <span class="s2">"Aborted by user"</span><span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>

<span class="c"># -----------------------</span>
<span class="c"># Archiving (same behavior)</span>
<span class="c"># -----------------------</span>
<span class="nv">ARCHIVE_TGZ</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/min_trim_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.tar.gz"</span>
<span class="nv">ARCHIVE_ZIP</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/min_trim_</span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2">.zip"</span>
log <span class="s2">"Archiving to: </span><span class="nv">$ARCHIVE_TGZ</span><span class="s2"> (tar) or </span><span class="nv">$ARCHIVE_ZIP</span><span class="s2"> (zip)"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TAR_GNU</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>log <span class="s2">"Using GNU tar with --remove-files"</span>
  <span class="nb">set</span> +e
  <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">--null</span> <span class="nt">--ignore-failed-read</span> <span class="nt">-czf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="nt">--remove-files</span> <span class="nt">-T</span> <span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span><span class="o">)</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span>
  <span class="nv">TAR_RC</span><span class="o">=</span><span class="nv">$?</span>
  <span class="nb">set</span> <span class="nt">-e</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$TAR_RC</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>warn <span class="s2">"tar returned </span><span class="nv">$TAR_RC</span><span class="s2">; some files may not have been archived/removed."</span>
  <span class="k">fi
  if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">tar</span> <span class="nt">-tzf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> warn <span class="s2">"Archive verification failed: </span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span>
  <span class="k">else
    </span>err <span class="s2">"Archive was not created: </span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span>
  <span class="k">fi
else
  </span><span class="nv">STAGE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">/stage"</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span>
  log <span class="s2">"Staging files to </span><span class="nv">$STAGE</span><span class="s2">"</span>
  <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> rel<span class="p">;</span> <span class="k">do
    </span><span class="nv">src</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/</span><span class="nv">$rel</span><span class="s2">"</span>
    <span class="nv">dst</span><span class="o">=</span><span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">/</span><span class="nv">$rel</span><span class="s2">"</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      if</span> <span class="o">!</span> safe_move <span class="s2">"</span><span class="nv">$src</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
        </span>err <span class="s2">"Failed to stage </span><span class="nv">$src</span><span class="s2">"</span>
      <span class="k">fi
    fi
  done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_REL</span><span class="s2">"</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$USE_ZIP</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$HAS_ZIP</span><span class="s2">"</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> zip <span class="nt">-r</span> <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$ARCHIVE_ZIP</span><span class="s2">"</span> .<span class="o">)</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> warn <span class="s2">"zip failed"</span>
    <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$ARCHIVE_ZIP</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> unzip <span class="nt">-t</span> <span class="s2">"</span><span class="nv">$ARCHIVE_ZIP</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> warn <span class="s2">"ZIP verification failed"</span>
  <span class="k">else</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-czf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> .<span class="o">)</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> warn <span class="s2">"tar failed"</span>
    <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-tzf</span> <span class="s2">"</span><span class="nv">$ARCHIVE_TGZ</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> warn <span class="s2">"tar.gz verification failed"</span>
  <span class="k">fi
  </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$STAGE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># Residual cleanup</span>
log <span class="s2">"Residual cleanup..."</span>
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> p<span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>dbg <span class="s2">"Removing residual: </span><span class="nv">$p</span><span class="s2">"</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> warn <span class="s2">"Failed to remove residual: </span><span class="nv">$p</span><span class="s2">"</span>
  <span class="k">fi
done</span> &lt;<span class="s2">"</span><span class="nv">$CAND_ABS</span><span class="s2">"</span>

find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-depth</span> <span class="nt">-type</span> d <span class="nt">-empty</span> <span class="nt">-delete</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true</span>

<span class="c"># -----------------------</span>
<span class="c"># Recreate skeletons</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Recreating skeletons..."</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> D<span class="p">;</span> <span class="k">do
    </span><span class="nv">D</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>abs <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
    dbg <span class="s2">"Recreating for domain: </span><span class="nv">$D</span><span class="s2">"</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/cgi-bin"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats/.data"</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_ftp/incoming"</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="nv">PH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$D</span><span class="s2">/public_html"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.html"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.php"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">cat</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.html"</span> <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">HTML</span><span class="sh">'
&lt;!doctype html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;Placeholder&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;&lt;h1&gt;Placeholder&lt;/h1&gt;&lt;p&gt;Minimal skeleton active. Upload your site to public_html.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
</span><span class="no">HTML
</span>      <span class="nb">chmod </span>644 <span class="s2">"</span><span class="nv">$PH</span><span class="s2">/index.html"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">fi

    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/logs"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">fi
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/stats"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
    </span><span class="k">fi
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span>find <span class="s2">"</span><span class="nv">$D</span><span class="s2">/awstats"</span> <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 1 <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> f<span class="p">;</span> <span class="k">do
        </span><span class="nv">bn</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$bn</span><span class="s2">"</span> <span class="k">in</span> .data|awstats.pl|awstats<span class="k">*</span>.conf<span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span> <span class="k">esac</span>
        <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$f</span><span class="s2">"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
      </span><span class="k">done
    fi
  done</span> &lt;<span class="s2">"</span><span class="nv">$DOMAINS_FILE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># -----------------------</span>
<span class="c"># Apply permissions</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Applying permissions..."</span>
find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0755 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0644 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-name</span> <span class="s2">"cgi-bin"</span> <span class="nt">-print0</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> d<span class="p">;</span> <span class="k">do
  </span>find <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0755 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span><span class="k">done
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s2">"awstats.pl"</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0755 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-path</span> <span class="s2">"*/public_ftp"</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0711 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> d <span class="nt">-path</span> <span class="s2">"*/public_ftp/incoming"</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0733 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> 
<span class="nb">true
</span><span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">chmod </span>700 <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
  </span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">/.ssh"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0600 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span><span class="k">fi
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="se">\(</span> <span class="nt">-name</span> <span class="s2">".htaccess"</span> <span class="nt">-o</span> <span class="nt">-name</span> <span class="s2">".htpasswd"</span> <span class="se">\)</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod </span>0644 <span class="nt">--</span> 
2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="se">\(</span> <span class="nt">-iname</span> <span class="s2">"wp-config.php"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">"config.php"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">".env"</span> <span class="se">\)</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> 
<span class="nt">-r</span> <span class="nb">chmod </span>0640 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true
</span>find <span class="s2">"</span><span class="nv">$BASEDIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="se">\(</span> <span class="nt">-iname</span> <span class="s2">"*token*"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">"*secret*"</span> <span class="nt">-o</span> <span class="nt">-name</span> <span class="s2">"id_*"</span> <span class="se">\)</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nt">-r</span> <span class="nb">chmod 
</span>0600 <span class="nt">--</span> 2&gt;&gt;<span class="s2">"</span><span class="nv">$LOG_STABLE</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">true</span>

<span class="c"># -----------------------</span>
<span class="c"># Finalization</span>
<span class="c"># -----------------------</span>
log <span class="s2">"Completed successfully."</span>
<span class="nb">exit </span>0
</code></pre></div></div>]]></content><author><name></name></author><category term="scratchpad" /></entry><entry><title type="html">coolice writable tree</title><link href="https://ib.bsb.br/coolice-writable-tree/" rel="alternate" type="text/html" title="coolice writable tree" /><published>2025-09-14T00:00:00+00:00</published><updated>2025-09-15T11:00:13+00:00</updated><id>https://ib.bsb.br/coolice-writable-tree</id><content type="html" xml:base="https://ib.bsb.br/coolice-writable-tree/"><![CDATA[<section class="code-block-container" role="group" aria-label=" Code Block" data-filename="_code_block.txt" data-code="find /home/ibbsbbry -type f -writable -print -o -type d -writable -executable -print | curl -fsS -F &#39;file=@-;filename=ibbsbbry-writable.txt&#39; https://x0.at/" data-download-link="" data-download-label="Download ">
  <code class="language-">find /home/ibbsbbry -type f -writable -print -o -type d -writable -executable -print | curl -fsS -F &#39;file=@-;filename=ibbsbbry-writable.txt&#39; https://x0.at/</code>
</section>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/ibbsbbry
/home/ibbsbbry/.redis
/home/ibbsbbry/.cagefs
/home/ibbsbbry/.cagefs/var
/home/ibbsbbry/.cagefs/var/run
/home/ibbsbbry/.cagefs/var/run/cagefs
/home/ibbsbbry/.cagefs/var/run/cagefs/utmp
/home/ibbsbbry/.cagefs/opt
/home/ibbsbbry/.cagefs/opt/alt
/home/ibbsbbry/.cagefs/opt/alt/php53
/home/ibbsbbry/.cagefs/opt/alt/php53/link
/home/ibbsbbry/.cagefs/opt/alt/php73
/home/ibbsbbry/.cagefs/opt/alt/php73/link
/home/ibbsbbry/.cagefs/opt/alt/php83
/home/ibbsbbry/.cagefs/opt/alt/php83/link
/home/ibbsbbry/.cagefs/opt/alt/php44
/home/ibbsbbry/.cagefs/opt/alt/php44/link
/home/ibbsbbry/.cagefs/opt/alt/php51
/home/ibbsbbry/.cagefs/opt/alt/php51/link
/home/ibbsbbry/.cagefs/opt/alt/php55
/home/ibbsbbry/.cagefs/opt/alt/php55/link
/home/ibbsbbry/.cagefs/opt/alt/php70
/home/ibbsbbry/.cagefs/opt/alt/php70/link
/home/ibbsbbry/.cagefs/opt/alt/php54
/home/ibbsbbry/.cagefs/opt/alt/php54/link
/home/ibbsbbry/.cagefs/opt/alt/php56
/home/ibbsbbry/.cagefs/opt/alt/php56/link
/home/ibbsbbry/.cagefs/opt/alt/php74
/home/ibbsbbry/.cagefs/opt/alt/php74/link
/home/ibbsbbry/.cagefs/opt/alt/php80
/home/ibbsbbry/.cagefs/opt/alt/php80/link
/home/ibbsbbry/.cagefs/opt/alt/php52
/home/ibbsbbry/.cagefs/opt/alt/php52/link
/home/ibbsbbry/.cagefs/opt/alt/php84
/home/ibbsbbry/.cagefs/opt/alt/php84/link
/home/ibbsbbry/.cagefs/opt/alt/php81
/home/ibbsbbry/.cagefs/opt/alt/php81/link
/home/ibbsbbry/.cagefs/opt/alt/php82
/home/ibbsbbry/.cagefs/opt/alt/php82/link
/home/ibbsbbry/.cagefs/opt/alt/php72
/home/ibbsbbry/.cagefs/opt/alt/php72/link
/home/ibbsbbry/.cagefs/opt/alt/php71
/home/ibbsbbry/.cagefs/opt/alt/php71/link
/home/ibbsbbry/.cagefs/tmp
/home/ibbsbbry/domains
/home/ibbsbbry/domains/memor.ia.br
/home/ibbsbbry/domains/memor.ia.br/awstats
/home/ibbsbbry/domains/memor.ia.br/awstats/.data
/home/ibbsbbry/domains/cut.ia.br
/home/ibbsbbry/domains/cut.ia.br/awstats
/home/ibbsbbry/domains/cut.ia.br/awstats/.data
/home/ibbsbbry/domains/arcreformas.com.br
/home/ibbsbbry/domains/arcreformas.com.br/public_html
/home/ibbsbbry/domains/arcreformas.com.br/public_html/wallabag
/home/ibbsbbry/domains/arcreformas.com.br/public_html/wallabag/web
/home/ibbsbbry/domains/arcreformas.com.br/public_html/wallabag/web/bundles
/home/ibbsbbry/domains/arcreformas.com.br/awstats
/home/ibbsbbry/domains/arcreformas.com.br/awstats/.data
/home/ibbsbbry/virtualenv
/home/ibbsbbry/virtualenv/bin
/home/ibbsbbry/virtualenv/include
/home/ibbsbbry/virtualenv/lib
/home/ibbsbbry/virtualenv/lib/python3.6
/home/ibbsbbry/virtualenv/python_apps
/home/ibbsbbry/virtualenv/python_apps/my_wsgi_test
/home/ibbsbbry/virtualenv/python_apps/my_wsgi_test/3.7
/home/ibbsbbry/virtualenv/python_apps/my_wsgi_test/3.7/bin
/home/ibbsbbry/virtualenv/python_apps/my_asgi_test
/home/ibbsbbry/virtualenv/python_apps/my_asgi_test/3.11
/home/ibbsbbry/virtualenv/python_apps/my_asgi_test/3.11/bin
/home/ibbsbbry/virtualenv/python_apps/my_asgi_test/3.8
/home/ibbsbbry/virtualenv/python_apps/my_asgi_test/3.8/bin
/home/ibbsbbry/trim_and_fixperms.sh
/home/ibbsbbry/.bash_history
/home/ibbsbbry/.local
/home/ibbsbbry/.local/bin
/home/ibbsbbry/.local/share
/home/ibbsbbry/.local/share/pipx
/home/ibbsbbry/.local/share/pipx/venvs
/home/ibbsbbry/.local/share/pipx/venvs/datasette
/home/ibbsbbry/.local/share/pipx/venvs/datasette/bin
/home/ibbsbbry/.local/share/pipx/shared
/home/ibbsbbry/.local/share/pipx/shared/bin
</code></pre></div></div>]]></content><author><name></name></author><category term="scratchpad" /></entry><entry><title type="html">CooliceHost’s Shared Hosting Service</title><link href="https://ib.bsb.br/coolicehost/" rel="alternate" type="text/html" title="CooliceHost’s Shared Hosting Service" /><published>2025-09-14T00:00:00+00:00</published><updated>2025-09-14T16:19:29+00:00</updated><id>https://ib.bsb.br/coolicehost</id><content type="html" xml:base="https://ib.bsb.br/coolicehost/"><![CDATA[<p>Section 1: Introduction to the CooliceHost Technology Stack
This report provides a comprehensive architectural analysis of the shared hosting services offered by the provider CooliceHost. The investigation focuses on a specific technology stack comprising the DirectAdmin control panel, a standalone Nginx web server configuration, and the provision of Secure Shell (SSH) access. The objective is to deconstruct this service by examining not just the technical implementation of each component, but the strategic rationale for their integration. This analysis will demonstrate that this combination of technologies represents a deliberate architectural choice, creating a high-performance ecosystem that stands in stark contrast to more traditional, compatibility-focused shared hosting environments.
1.1 Identifying the Provider: From “coolice.com” to CooliceHost
An initial investigation into the query “coolice.com” reveals a landscape of similarly named but functionally distinct entities. The domain coolice.com appears to be associated with various businesses, including those dealing in physical goods such as coolers, ice delivery services, and electronics.[1, 2, 3, 4, 5, 6, 7] However, the context of the query—shared hosting, DirectAdmin, Nginx, and SSH—points unequivocally to the web hosting provider known as CooliceHost.[8, 9, 10, 11] This provider, founded in 2016 and based in Dover, United States, specializes in high-performance hosting solutions.[8, 11] Therefore, this analysis will proceed with CooliceHost as the subject of investigation.
1.2 Market Positioning: A Provider for Webmasters
CooliceHost’s market positioning is a critical factor in understanding its technological choices. The company explicitly targets a technically proficient audience, repeatedly describing its services as “created by webmasters for webmasters”.[9, 12, 13] This positioning signals a departure from entry-level hosting aimed at non-technical users. Instead, it suggests a focus on performance, control, and the inclusion of advanced features that appeal to developers, system administrators, and experienced website managers. This target market is more likely to value the speed of Nginx and the power of SSH over the plug-and-play simplicity of more traditional, Apache-centric hosting environments. This strategic focus justifies the selection of a more customizable and performance-oriented, yet potentially more complex, technology stack.
1.3 The Four Pillars of the Service Architecture
The CooliceHost shared hosting service is built upon four interdependent technological pillars, each serving a distinct role in the overall architecture. A high-level overview of these core components is as follows:</p>
<ul>
  <li>The Shared Hosting Model: This forms the economic and operational foundation of the service. Multiple websites are hosted on a single physical server, allowing resources such as CPU, RAM, and storage to be shared among many users. This model significantly reduces costs for the end-user, as the provider manages server maintenance, security updates, and technical support.[14]</li>
  <li>The DirectAdmin Control Layer: This component serves as the administrative and user management interface. DirectAdmin is a graphical control panel that allows users to manage their websites, domains, emails, and databases without requiring direct server administration knowledge.[15, 16] Its selection is integral to the service’s overall performance and flexibility.</li>
  <li>The Standalone Nginx Performance Engine: This is the high-speed web server responsible for handling incoming HTTP and HTTPS requests. The “standalone” configuration implies that Nginx is the primary web server, not merely a caching layer for another server like Apache. This choice prioritizes raw performance and efficiency.[17, 18]</li>
  <li>SSH Advanced Access: This protocol provides a secure, encrypted channel for command-line management of the hosting account. It is a critical feature for developers and power users, enabling advanced workflows, automation, and direct server interaction that are impossible with standard tools like FTP.[19, 20]
1.4 Report Objective and Structure
This report will dissect the “how,” “why,” and “in what ways” these four components are architected and integrated within the CooliceHost shared hosting environment. It will provide an expert-level analysis of the platform’s architecture, exploring the inherent benefits and trade-offs of this specific technology stack. The subsequent sections will delve into each pillar in detail, culminating in a synthesized evaluation and a set of strategic recommendations for both prospective and existing users.
Section 2: The Foundation: Shared Hosting Architecture on CloudLinux
The foundational layer of any shared hosting service determines its stability, security, and performance. CooliceHost builds its platform on a standard shared hosting model but enhances it significantly through the strategic implementation of a specialized operating system, CloudLinux, and high-performance hardware. This section analyzes this underlying environment, focusing on how the architecture mitigates the inherent challenges of multi-tenancy.
2.1 Principles of Shared Web Hosting
Shared web hosting is a service model where a single physical server hosts numerous websites for multiple customers.[14] Each customer is allocated a portion of the server’s resources, including disk space, RAM, and CPU processing power.[21, 22] The primary advantage of this model is its cost-effectiveness; by distributing the costs of server hardware, maintenance, and administration across many users, providers can offer hosting plans at a very low price point.[22, 23, 24]
In this arrangement, the hosting provider is responsible for all aspects of server management, including software installation, security patching, network configuration, and technical support.[14, 21, 24] This managed approach is highly beneficial for users who lack the technical expertise or desire to perform complex system administration tasks, allowing them to focus solely on building and managing their websites.[14, 21] Websites on a shared server are typically managed through a web-based control panel, which provides a user-friendly interface for common tasks.[14]
2.2 Mitigating the “Noisy Neighbor” Problem with CloudLinux OS
The most significant architectural challenge in a conventional shared hosting environment is resource contention, commonly known as the “noisy neighbor” effect.[23] In a standard setup using a generic Linux distribution, server resources are shared in a common pool. If one website experiences a sudden surge in traffic or runs an inefficient script, it can consume a disproportionate amount of the server’s CPU and RAM. This monopolization of resources inevitably leads to performance degradation—slow loading times and even downtime—for every other website on the same server.[23] For a provider like CooliceHost, which positions itself on performance and reliability, leaving this critical factor to chance is not a viable strategy.[25, 26]
The solution implemented by CooliceHost is the adoption of CloudLinux OS, an operating system specifically engineered for multi-tenant hosting environments.[13, 27, 28] The core technology of CloudLinux is the Lightweight Virtualized Environment (LVE). LVE creates isolated, virtualized containers for each user account on the server. Within each container, strict limits are enforced on the amount of CPU, RAM, I/O, and concurrent processes that a single user can consume.[27]
This containerization fundamentally changes the dynamics of the shared server. If a user’s website exceeds its allocated resources, its processes are slowed down or throttled within its own LVE, preventing it from impacting the performance of any other user on the server. This transforms an unpredictable, shared resource pool into a stable, reliable environment where each tenant is guaranteed their allocated resources, effectively eliminating the “noisy neighbor” problem and ensuring a consistent level of performance for all customers.
2.3 Enhancing Security and Stability
Beyond resource isolation, CloudLinux OS provides critical security enhancements through a feature called CageFS.[29] CageFS is a virtualized, per-user file system that completely encapsulates each user’s data and processes. When a user is within their “cage,” they are unable to see or access the files of any other user on the server. Furthermore, CageFS prevents users from viewing sensitive server configuration files, such as /etc/passwd, which could be exploited in a standard shared environment. This file system virtualization adds a robust layer of security, significantly reducing the risk of information disclosure and privilege escalation attacks between accounts on the same server.
2.4 The Hardware Layer: Performance-Oriented Infrastructure
The software-level optimizations provided by CloudLinux are built upon a high-performance hardware foundation. CooliceHost utilizes enterprise-grade Solid-State Drives (SSD) and, in some plans, Non-Volatile Memory Express (NVMe) storage.[9, 27, 28, 29, 30, 31, 32] Compared to traditional Hard Disk Drives (HDD), SSD and NVMe technologies offer dramatically lower latency and higher read/write speeds. This is particularly important in a web hosting context, where the speed of database queries and file access directly impacts website loading times. By investing in this advanced storage hardware, CooliceHost ensures that disk I/O, a common performance bottleneck, is minimized, creating a fast and responsive base upon which the entire software stack can operate efficiently.
Section 3: The Control Layer: DirectAdmin Panel Integration
The control panel is the primary interface through which users interact with and manage their hosting environment. CooliceHost’s choice of DirectAdmin is a deliberate one, driven by its alignment with the overall architectural goals of performance, efficiency, and flexibility, particularly in the context of a standalone Nginx configuration.
3.1 An Overview of DirectAdmin
DirectAdmin is a graphical, web-based hosting control panel known for its simplicity, speed, and low resource consumption.[15, 33, 34, 35, 36] Its design philosophy emphasizes efficiency, aiming to use the bare minimum of system resources so that more are available for customer websites.[35, 36] This lightweight nature makes it an ideal counterpart to the high-performance Nginx web server.
The panel is structured with a three-tiered access system: Administrator, Reseller, and User.[34, 35] This hierarchy allows for granular control over the server. The Administrator has full server control, Resellers can manage a subset of user accounts, and Users have access only to the settings for their own websites. This structure is essential for managing a multi-tenant shared hosting environment effectively.
3.2 Why DirectAdmin for a Standalone Nginx Environment?
The selection of a control panel is not arbitrary; it is a critical architectural decision. For a hosting provider offering a standalone Nginx service, DirectAdmin presents significant advantages over more rigid, historically Apache-centric competitors like cPanel. The core reason lies in its superior flexibility for managing non-standard web server configurations.
A standalone Nginx setup operates fundamentally differently from an Apache-based one. Most notably, it does not use .htaccess files for directory-level configuration and URL rewrites.[37, 38] This is a performance-enhancing design choice by Nginx, as parsing these files for every request adds significant overhead. However, it means that all configuration directives, including the rewrite rules essential for applications like WordPress, must be placed directly within the main Nginx server block configuration.
A control panel in this environment must provide a secure and user-friendly mechanism for users to manage these server block configurations without granting them root-level access to the server’s core configuration files. DirectAdmin excels in this area due to its powerful and extensible templating system. The entire configuration for a user’s domain is generated from a set of .conf templates.[39, 40] This architecture allows the server administrator to create and customize base Nginx templates, which users can then select or modify on a per-domain basis through the control panel interface. This provides a structured and secure way to manage Nginx-specific settings.
In contrast, cPanel’s integration with Nginx has historically been more focused on using it as a caching reverse proxy in front of Apache, with less direct, user-facing control over the Nginx configuration itself.[41] While this is changing, DirectAdmin’s template-driven architecture makes it inherently more adaptable and powerful for a provider wishing to offer a true standalone Nginx experience with a high degree of user-level control.
3.3 Key Management Functions in DirectAdmin
Within the CooliceHost environment, users leverage DirectAdmin for a wide range of standard hosting management tasks:</li>
  <li>Domain and Website Management: Users can add new domains and subdomains, manage DNS records, and use the built-in file manager to upload, edit, and manage their website files.[16, 36]</li>
  <li>PHP-FPM Integration: A standalone Nginx server cannot execute PHP code directly. It must pass PHP requests to a separate process manager. The standard and recommended handler for this is PHP-FPM (FastCGI Process Manager).[37, 42] DirectAdmin seamlessly integrates with PHP-FPM, allowing users to select different PHP versions for their websites and manage PHP settings, ensuring compatibility and performance.</li>
  <li>Database and Email Management: DirectAdmin provides standard tools for managing the hosting environment. This includes the ability to create and manage MySQL or MariaDB databases, typically through the integrated phpMyAdmin interface, and to create and manage email accounts, forwarders, and auto-responders for their domains.[16, 29, 36]</li>
  <li>Security Features: The control panel serves as the user’s interface for key security features. This includes one-click installation and renewal of free SSL certificates via Let’s Encrypt, which is essential for modern web security.[34, 37] It also integrates with server-level security suites like Imunify360 and firewalls, providing a centralized point of management for security settings.[13, 28]
Section 4: The Performance Engine: Standalone Nginx Configuration
The web server is the heart of the hosting stack, directly responsible for processing client requests and delivering content. CooliceHost’s choice of a standalone Nginx configuration is a clear statement of intent, prioritizing speed, scalability, and efficiency over the traditional, more compatibility-focused approach of Apache.
4.1 Nginx Architecture: The Event-Driven Advantage
Nginx (pronounced “engine-x”) is a high-performance web server renowned for its ability to handle a massive number of concurrent connections with minimal resource consumption.[17, 18, 43, 44] Its architectural superiority stems from its asynchronous, event-driven model.
Unlike older, process-based servers like Apache (in its traditional prefork mode), which spawn a new process or thread for each incoming connection, Nginx uses a small, fixed number of worker processes. Each worker process can handle thousands of connections simultaneously. It listens for events (like a new request or data being ready to send) and processes them as they occur, without blocking or waiting. This non-blocking I/O model results in a significantly lower memory footprint and more predictable performance under high load, especially when serving static content like images, CSS, and JavaScript files.[17, 18] This fundamental design is the primary reason for Nginx’s widespread adoption by high-traffic websites and performance-focused hosting providers.
4.2 “Standalone” Nginx vs. Nginx Reverse Proxy
Within the DirectAdmin ecosystem, providers can deploy Nginx in two primary configurations, each with distinct characteristics and trade-offs.[37, 38] Understanding the difference is crucial to appreciating the CooliceHost offering.</li>
  <li>Standalone Nginx: In this model, Nginx is the sole web server handling all incoming HTTP/S requests. It serves static files directly from the disk. When a request for a dynamic script (like PHP) arrives, Nginx passes it to the PHP-FPM process manager for execution and then returns the result to the client. This is the purest, most efficient configuration, offering the lowest resource usage and the highest potential speed.[18, 38]</li>
  <li>Nginx + Apache (Reverse Proxy): This hybrid model uses Nginx as a front-end “reverse proxy.” Nginx receives all requests, serves static files with its characteristic speed, but “proxies” or forwards requests for dynamic content to a back-end Apache server. The primary benefit of this setup is compatibility. It combines Nginx’s performance for static assets with Apache’s full support for .htaccess files, which many legacy applications and non-technical users rely on.[38, 39, 45, 46]
The following table provides a comparative analysis of these configurations:
| Configuration Type | Performance Characteristics | Memory/CPU Usage | .htaccess Support | Ideal Use Case |
|—|—|—|—|—|
| Standalone Nginx | Highest performance for both static and dynamic content; lowest latency. | Lowest | None. All rules must be in the main Nginx configuration. | Performance-critical websites, modern applications, and developers comfortable with Nginx syntax. |
| Nginx + Apache | Excellent performance for static content (served by Nginx); good performance for dynamic content (served by Apache). | High. Runs two full web servers. | Full. Apache processes .htaccess files as usual. | Hosting environments requiring backward compatibility with .htaccess for legacy applications or mixed-user skill levels. |
| Standalone Apache | Good performance, but can struggle under high concurrent loads for static files compared to Nginx. | Moderate to High | Full | Traditional hosting, legacy applications, and environments where .htaccess flexibility is paramount. |
CooliceHost’s focus on a standalone Nginx service, as indicated by their marketing and technical documentation, caters specifically to the first use case: users who prioritize maximum performance and are willing to manage configuration directly rather than through .htaccess files.
4.3 Managing Configuration in a .htaccess-less World
The most significant practical consequence for users moving to a standalone Nginx environment is the absence of .htaccess support. This is not a bug but a core design principle of Nginx, which avoids the performance overhead associated with scanning the file system for configuration files on every request.[37, 38] However, popular content management systems like WordPress depend on .htaccess to enable user-friendly URLs, often called “pretty permalinks.” Without these rewrite rules, a WordPress site would only be accessible through URLs like example.com/?p=123.
To solve this critical compatibility issue, the necessary rewrite rules must be explicitly defined within the Nginx server block for the domain. DirectAdmin provides an elegant solution to this challenge through its Nginx Templates feature.[39] From the control panel, a user can select a pre-configured template for their application, such as “WordPress+FastCGI cache.” Applying this template automatically inserts the correct, optimized set of Nginx location and rewrite directives into the domain’s server configuration file. This allows complex applications to function correctly without requiring the user to manually write Nginx configuration code.
For custom applications or requirements not covered by a template, users must utilize the “Custom HTTPD Configuration” feature within DirectAdmin.[39, 47, 48] This interface provides text boxes where advanced users can insert their own valid Nginx directives directly into specific parts of their virtual host configuration. While this method is extremely powerful, it requires a working knowledge of Nginx syntax and is a steeper learning curve for those accustomed to the simplicity of uploading an .htaccess file.
4.4 Potential Pitfall: Cross-Domain Configuration Bleed
While DirectAdmin’s system is designed to isolate configurations on a per-domain basis, real-world user experiences suggest that this isolation may not always be perfect when mixing web server modes on a single account. A user on the DirectAdmin forums reported a specific and counter-intuitive issue: after enabling standalone Nginx for one domain (domain1.com), the .htaccess rewrite rules on a second domain (domain2.com), which was presumably running in the Nginx+Apache reverse proxy mode, stopped working.[49]
This behavior is unexpected, as the configuration for each virtual host should be self-contained. It suggests a potential anomaly in how DirectAdmin generates the global Nginx configuration file or includes the per-domain settings. It is possible that a global directive intended for the standalone domain was being inherited or applied incorrectly to the proxy configuration of the other domain. This is a critical point for any advanced user or agency managing multiple sites on a single CooliceHost account. It underscores the importance of rigorous testing across all hosted domains whenever a significant configuration change, such as switching a single domain to standalone Nginx mode, is made. An expert-level report must highlight such potential complexities, advising users to move beyond theoretical expectations and verify functionality in their specific multi-domain environment.
Section 5: The Access Protocol: Secure Shell (SSH) Management and Utility
The provision of Secure Shell (SSH) access is a defining feature that elevates a shared hosting plan from a simple content repository into a versatile development and deployment platform. For the “webmaster” audience targeted by CooliceHost, SSH is not a luxury but an essential tool for modern, efficient workflows.
5.1 Understanding SSH in a Web Hosting Context
The Secure Shell (SSH) protocol provides a secure, encrypted method for connecting to and interacting with a remote computer’s command-line interface over an unsecured network like the internet.[19, 50] Its core function is to create a secure tunnel between the user’s local machine and the hosting server, protecting all transmitted data, including login credentials and commands, from eavesdropping.
This capability fundamentally distinguishes SSH from older protocols like FTP (File Transfer Protocol). While FTP is designed solely for transferring files, SSH provides a full-fledged shell environment, allowing the user to execute commands on the server as if they were physically logged in.[50, 51] This opens up a vast range of possibilities for file management, application deployment, and server-side task automation.
5.2 Enabling and Managing SSH Access in DirectAdmin
On CooliceHost’s platform, as with most managed hosting environments, SSH access is a privileged feature that is not enabled by default for standard user accounts. This is a deliberate security measure, as improper use of command-line tools can pose risks to the user’s data and, in a poorly configured environment, to the server itself.[52, 53]
The process of granting SSH access is typically managed at the Administrator or Reseller level within the DirectAdmin panel.[52, 53, 54, 55, 56, 57] The workflow involves:</li>
  <li>Logging into DirectAdmin with administrative or reseller credentials.</li>
  <li>Navigating to the “Account Manager” and selecting “Show All Users” or “List Users.”</li>
  <li>Searching for and selecting the specific user account that requires SSH access.</li>
  <li>Navigating to the “Modify” tab for that user.</li>
  <li>Checking the box corresponding to “SSH Access” and saving the changes.[52, 53, 56, 57, 58]
In many cases, an ordinary user may need to submit a support ticket to request that this feature be enabled for their account, reinforcing its status as an advanced, power-user tool.[54] Once enabled, the user can connect to the server using an SSH client (like PuTTY on Windows or the built-in Terminal on macOS/Linux) with their standard hosting account username and password.
5.3 The Developer’s Toolkit: Practical Command-Line Operations
The true value of SSH access lies in the powerful set of command-line tools it unlocks. For a web developer, this transforms the workflow from a slow, manual process of uploading pre-built files via FTP to a fast, automated, and interactive development cycle. SSH enables the direct use of essential, industry-standard development tools on the server itself. This includes:</li>
  <li>Version Control: Using git to clone, pull, and deploy code directly from repositories like GitHub or Bitbucket.</li>
  <li>Dependency Management: Running tools like composer for PHP projects or npm for Node.js projects to install and update application libraries directly on the server.</li>
  <li>Framework CLIs: Interacting with application-specific command-line interfaces, such as wp-cli for managing WordPress installations, artisan for the Laravel framework, or drush for Drupal.</li>
  <li>Automation: Writing and executing shell scripts to automate repetitive tasks like backups, database operations, or deployment routines.</li>
  <li>Advanced Troubleshooting: Directly viewing log files, checking server processes, and diagnosing issues in real-time.
The following table outlines some of the most essential SSH commands that a web developer would use in the CooliceHost environment.
| Task/Objective | Relevant Command(s) | Explanation &amp; Example Usage |
|—|—|—|
| Navigating the File System | pwd, cd, ls | Determine your current location, change directories, and list files. Ex: cd /home/user/domains/example.com/public_html to enter the web root.[20, 59, 60] |
| File/Directory Manipulation | mkdir, touch, cp, mv, rm | Create new directories and files, copy, move/rename, and delete files. Ex: cp config.sample.php config.php to copy a configuration file.[20, 59, 60] |
| Viewing &amp; Editing Files | cat, nano, vi | Display file contents directly in the terminal or open them in a command-line text editor for modification. Ex: nano wp-config.php to edit the WordPress config.[59, 60] |
| Searching for Files/Content | find, grep | Search for files by name, type, or size, and search for specific text strings within files. Ex: grep -r “DB_PASSWORD”. to find the database password in the current directory.[59, 60] |
| Archiving &amp; Compression | tar, zip, unzip | Create or extract compressed archives, essential for backups or deploying application packages. Ex: tar -czvf backup.tar.gz public_html/ to create a compressed backup of the web root.[59] |
| Checking Resource Usage | du, df, top | Check disk usage of specific folders, view overall disk space, and monitor real-time system processes and resource usage.[60] |
| Managing Permissions | chmod, chown | Change the read, write, and execute permissions of files and directories to ensure proper application function and security. Ex: chmod 755 public_html. |
| Downloading Remote Files | wget, curl | Download files directly to the server from a URL, bypassing the need to download to a local machine first. Ex: wget https://wordpress.org/latest.zip.[59, 60] |
5.4 Advanced SSH Techniques
For users seeking to maximize both security and efficiency, SSH offers more advanced capabilities. The most important of these is SSH key authentication. This method involves generating a cryptographic key pair (a private key stored on the user’s local machine and a public key uploaded to the server). When connecting, the server uses the public key to verify the signature from the private key, granting access without requiring a password. This is significantly more secure than password-based authentication, as it is immune to brute-force attacks.[61, 62, 63, 64, 65] DirectAdmin provides an interface under “SSH Keys” to facilitate the management of these public keys.[63]
Another advanced technique is SSH tunneling (or port forwarding). This allows a user to securely forward a port from the remote server to their local machine. A common use case for web developers is to tunnel the server’s database port (e.g., 3306 for MySQL) to their local machine. This enables them to connect to the remote database using a local graphical database management tool as if the database were running on their own computer, all through a secure, encrypted connection.[66, 67]
Section 6: Synthesis and Strategic Recommendations
The preceding analysis has dissected the four core components of the CooliceHost shared hosting service. This final section synthesizes these findings to evaluate the platform as a cohesive ecosystem and provides targeted recommendations for different user profiles.
6.1 Architectural Synergy: A High-Performance Ecosystem
The technology stack chosen by CooliceHost is not a random assortment of popular tools but a carefully integrated ecosystem where each component complements the others to achieve a specific goal: high-performance, stable, and controllable shared hosting for a technical audience. This architecture is purpose-built to overcome the primary weaknesses of traditional shared hosting—unpredictable performance and limited developer control.
The synergy functions as follows:</li>
  <li>CloudLinux OS provides the stable, secure, and isolated foundation, solving the inherent resource contention problems of shared hosting. This allows the provider to guarantee a baseline level of performance, a promise that is difficult to keep in a standard Linux environment.</li>
  <li>Standalone Nginx is layered on top of this stable foundation to act as the performance engine. Its lightweight, event-driven architecture delivers raw speed and efficiency that would be impossible to achieve with a traditional Apache setup, especially under concurrent load.</li>
  <li>DirectAdmin serves as the essential control layer, providing the flexibility needed to manage a non-standard web server like standalone Nginx. Its powerful templating system bridges the gap left by the absence of .htaccess, giving technical users the necessary control over their environment without compromising security.</li>
  <li>SSH Access completes the ecosystem by providing the power-user access required to fully exploit the platform’s capabilities. It transforms the hosting account into a true development environment, enabling modern workflows that are critical for the “webmaster” and developer audience.
Together, these four pillars create a hosting environment that is strategically positioned to offer a superior experience for users who prioritize performance and control over beginner-friendly simplicity.
6.2 User Profile Suitability Analysis
The specialized nature of the CooliceHost shared hosting stack makes it an excellent choice for certain users and a potentially challenging one for others. A clear understanding of this suitability is crucial for any prospective customer.</li>
  <li>The Performance-Oriented Developer (Ideal User): A web developer who is comfortable with the Linux command line and understands the basics of Nginx configuration will thrive in this environment. They can leverage SSH for modern workflows with Git and Composer, fine-tune Nginx configurations for maximum application speed, and benefit from the stable, high-performance foundation. For this profile, the platform offers capabilities that approach those of a more expensive VPS, but in a managed, cost-effective package.</li>
  <li>The Small Digital Agency: An agency managing multiple client websites, particularly those built on common platforms like WordPress, can leverage this platform effectively. By using DirectAdmin’s reseller features and Nginx templates, they can rapidly deploy optimized websites that benefit from superior speed and security. The provision of SSH access allows their technical staff to efficiently manage and troubleshoot client sites.</li>
  <li>The Technical Hobbyist/Power User: An individual with a strong technical background working on personal projects will appreciate the high degree of control and performance offered. However, they must be willing to invest the time to learn the Nginx configuration paradigm, as they will not be able to rely on the copy-paste solutions often available for .htaccess.</li>
  <li>The Non-Technical Beginner (Poor Fit): A user with little to no technical experience, such as a small business owner wanting to set up their first website, would likely find this environment frustrating. The lack of .htaccess support means that common tutorials and guides for their chosen applications may not work out-of-the-box. The reliance on a control panel interface for rewrite rules and the emphasis on SSH for advanced tasks could present a steep and unnecessary learning curve. This user profile would be better served by a more traditional cPanel/Apache hosting provider that prioritizes simplicity and broad compatibility.
6.3 Recommendations for Prospective Customers
For those considering CooliceHost for their shared hosting needs, the following steps are recommended:</li>
  <li>Assess Your Technical Acumen: Before committing, honestly evaluate your comfort level with the command line and your willingness to manage web server configurations that go beyond a simple graphical interface. If you have never used SSH and your primary method of managing a website is through FTP and a GUI, this platform may introduce significant friction into your workflow.</li>
  <li>Understand the Nginx Paradigm: Invest time in learning the basics of Nginx server blocks, location directives, and the rewrite syntax. This knowledge is essential to replace your reliance on .htaccess and to troubleshoot any configuration-related issues you may encounter.</li>
  <li>Verify Application Compatibility: For any custom or less-common applications you plan to host, research and ensure that there are known-working Nginx configuration examples available. While DirectAdmin provides templates for popular CMSs, you will be responsible for configuring anything outside that scope.
6.4 Recommendations for Existing Users
For current customers of CooliceHost looking to maximize the value of their hosting plan:</li>
  <li>Embrace the Command Line: If you are not already doing so, make SSH your primary tool for website management. Use Git for deployments, manage dependencies with Composer/NPM, and write simple shell scripts to automate repetitive tasks like clearing caches or running database backups. This will dramatically increase your efficiency.</li>
  <li>Master DirectAdmin Templates: Move beyond the default settings. Explore the custom HTTPD configuration options in DirectAdmin to fine-tune your Nginx templates. Add custom headers for browser caching (Cache-Control, Expires) or implement security headers (like Content-Security-Policy) to improve both the performance and security of your applications.</li>
  <li>Implement SSH Key Authentication: As a top security priority, disable password-based SSH login for your account and switch exclusively to more secure key-based authentication. This is a simple process that provides a massive security benefit.</li>
  <li>Test Configuration Changes Rigorously: As highlighted by the potential for cross-domain issues (Section 4.4), never assume a configuration change on one domain will not affect another. When managing multiple sites, always test the functionality of all sites after making a significant change to any one of them, preferably in a staging environment or during low-traffic periods.</li>
</ul>]]></content><author><name></name></author><category term="scratchpad" /></entry><entry><title type="html">coolice todo webapp</title><link href="https://ib.bsb.br/coolice-todo-webapp/" rel="alternate" type="text/html" title="coolice todo webapp" /><published>2025-09-10T00:00:00+00:00</published><updated>2025-09-11T20:49:57+00:00</updated><id>https://ib.bsb.br/coolice-todo-webapp</id><content type="html" xml:base="https://ib.bsb.br/coolice-todo-webapp/"><![CDATA[<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="cm">/*
UX upgrades (fully implemented)
- Inline edits: Enter commits, Esc cancels and reverts, Tab moves to next, Shift+Tab to prev.
- Title: Enter saves, Esc cancels.
- Keyboard on list: Space toggles, Delete removes, E starts edit for focused item.
- Drag-and-drop reorder (disabled while filtering/searching); persists via new "reorder" API op.
- Filters &amp; search: All/Active/Completed + text search; persists in localStorage.
- Bulk ops: "Complete all"/"Uncheck all", "Clear completed", "Clear all" (with confirm).
- Undo for delete and clear completed (10s window).
- Recent boards history with datalist for quick switching.
- Accessibility and feedback: aria-live, counts, last updated, consistent flash messages.
- PWA retained with single-file assets; safer limits and headers; ETag + Last-Modified + 304 for fetch.
*/</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// Security &amp; headers</span>
<span class="c1">/////////////////////////////</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'X-Content-Type-Options: nosniff'</span><span class="p">);</span>

<span class="nv">$isHttps</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTPS'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTPS'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">'off'</span><span class="p">)</span>
  <span class="o">||</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_X_FORWARDED_PROTO'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_X_FORWARDED_PROTO'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'https'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$isHttps</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Strict-Transport-Security: max-age=31536000; includeSubDomains'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// Config and helpers</span>
<span class="c1">/////////////////////////////</span>

<span class="nv">$scheme</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$isHttps</span> <span class="o">?</span> <span class="s1">'https'</span> <span class="o">:</span> <span class="s1">'http'</span><span class="p">);</span>
<span class="nv">$host</span>   <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">'localhost'</span><span class="p">;</span>
<span class="nv">$origin</span> <span class="o">=</span> <span class="nv">$scheme</span> <span class="mf">.</span> <span class="s1">'://'</span> <span class="mf">.</span> <span class="nv">$host</span><span class="p">;</span>

<span class="nv">$dataDir</span> <span class="o">=</span> <span class="nb">realpath</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nb">realpath</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/data'</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../data'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$dataDir</span><span class="p">))</span> <span class="p">{</span>
  <span class="o">@</span><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dataDir</span><span class="p">,</span> <span class="mo">0755</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="no">MAX_TEXT_LEN</span>  <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
<span class="k">const</span> <span class="no">MAX_TITLE_LEN</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

<span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">rtrim</span><span class="p">(</span><span class="nb">strtr</span><span class="p">(</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nb">random_bytes</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span> <span class="s1">'+/'</span><span class="p">,</span> <span class="s1">'-_'</span><span class="p">),</span> <span class="s1">'='</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">safeSlug</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$b</span><span class="p">):</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="nv">$b</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-zA-Z0-9_-]/'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">,</span> <span class="nv">$b</span><span class="p">);</span>
  <span class="nv">$b</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$b</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span> <span class="nv">$b</span> <span class="o">:</span> <span class="s1">'public'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">pathOf</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$b</span><span class="p">):</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'dataDir'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nf">safeSlug</span><span class="p">(</span><span class="nv">$b</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'.json'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">emptyBoard</span><span class="p">():</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="nv">$t</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
  <span class="k">return</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'My Todo'</span><span class="p">,</span> <span class="s1">'tasks'</span> <span class="o">=&gt;</span> <span class="p">[],</span> <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">,</span> <span class="s1">'updated'</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">loadBoard</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$b</span><span class="p">):</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="nv">$f</span> <span class="o">=</span> <span class="nf">pathOf</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_file</span><span class="p">(</span><span class="nv">$f</span><span class="p">))</span> <span class="k">return</span> <span class="nf">emptyBoard</span><span class="p">();</span>
  <span class="nv">$raw</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$f</span><span class="p">);</span>
  <span class="nv">$j</span> <span class="o">=</span> <span class="nv">$raw</span> <span class="o">?</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$raw</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$j</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$j</span> <span class="o">:</span> <span class="nf">emptyBoard</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">saveBoard</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$b</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$d</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nv">$f</span> <span class="o">=</span> <span class="nf">pathOf</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
  <span class="nv">$d</span><span class="p">[</span><span class="s1">'updated'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
  <span class="nv">$h</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$f</span><span class="p">,</span> <span class="s1">'c+'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$h</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="no">LOCK_EX</span><span class="p">);</span>
    <span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$d</span><span class="p">,</span> <span class="no">JSON_PRETTY_PRINT</span> <span class="o">|</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">));</span>
    <span class="nb">fflush</span><span class="p">(</span><span class="nv">$h</span><span class="p">);</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="no">LOCK_UN</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$h</span><span class="p">);</span>
    <span class="o">@</span><span class="nb">chmod</span><span class="p">(</span><span class="nv">$f</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">emitJSON</span><span class="p">(</span><span class="nv">$x</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[]):</span> <span class="kt">never</span> <span class="p">{</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$headers</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="nb">header</span><span class="p">(</span><span class="s2">"</span><span class="nv">$k</span><span class="s2">: </span><span class="nv">$v</span><span class="s2">"</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/json; charset=utf-8'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Cache-Control: no-cache, must-revalidate'</span><span class="p">);</span>
  <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$x</span><span class="p">,</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">);</span>
  <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">notModified</span><span class="p">():</span> <span class="kt">never</span> <span class="p">{</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'HTTP/1.1 304 Not Modified'</span><span class="p">);</span>
  <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">htmlHeader</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Cache-Control: no-cache'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// Asset router (manifest, sw, icons, favicon)</span>
<span class="c1">/////////////////////////////</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'asset'</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$asset</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'asset'</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$asset</span> <span class="o">===</span> <span class="s1">'manifest'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/manifest+json; charset=utf-8'</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Cache-Control: public, max-age=3600'</span><span class="p">);</span>
    <span class="c1">// Minimal base64 1x1 PNG</span>
    <span class="nv">$icon1x1</span> <span class="o">=</span> <span class="s1">'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII='</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">([</span>
      <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'memor.ia.br — Todos'</span><span class="p">,</span>
      <span class="s1">'short_name'</span> <span class="o">=&gt;</span> <span class="s1">'memor'</span><span class="p">,</span>
      <span class="s1">'start_url'</span> <span class="o">=&gt;</span> <span class="s1">'/?b=public'</span><span class="p">,</span>
      <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="s1">'standalone'</span><span class="p">,</span>
      <span class="s1">'background_color'</span> <span class="o">=&gt;</span> <span class="s1">'#ffffff'</span><span class="p">,</span>
      <span class="s1">'theme_color'</span> <span class="o">=&gt;</span> <span class="s1">'#111111'</span><span class="p">,</span>
      <span class="s1">'icons'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">'src'</span> <span class="o">=&gt;</span> <span class="nv">$icon1x1</span><span class="p">,</span> <span class="s1">'sizes'</span> <span class="o">=&gt;</span> <span class="s1">'192x192'</span><span class="p">,</span> <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'image/png'</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">'src'</span> <span class="o">=&gt;</span> <span class="nv">$icon1x1</span><span class="p">,</span> <span class="s1">'sizes'</span> <span class="o">=&gt;</span> <span class="s1">'512x512'</span><span class="p">,</span> <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'image/png'</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">'src'</span> <span class="o">=&gt;</span> <span class="nv">$origin</span> <span class="mf">.</span> <span class="s1">'/?asset=favicon'</span><span class="p">,</span> <span class="s1">'sizes'</span> <span class="o">=&gt;</span> <span class="s1">'any'</span><span class="p">,</span> <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'image/svg+xml'</span><span class="p">,</span> <span class="s1">'purpose'</span> <span class="o">=&gt;</span> <span class="s1">'any maskable'</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="s1">'scope'</span> <span class="o">=&gt;</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="p">],</span> <span class="no">JSON_UNESCAPED_SLASHES</span> <span class="o">|</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$asset</span> <span class="o">===</span> <span class="s1">'sw'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/javascript; charset=utf-8'</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Cache-Control: public, max-age=3600'</span><span class="p">);</span>
    <span class="cp">?&gt;</span>
// Service Worker for memor.ia.br
const CACHE_NAME = 'memor-cache-v1.4';
const SHELL = [
  '/?b=public',
  '/?asset=manifest',
  '/?asset=favicon'
];

self.addEventListener('install', (e) =&gt; {
  e.waitUntil(caches.open(CACHE_NAME).then(c =&gt; c.addAll(SHELL)));
  self.skipWaiting();
});

self.addEventListener('activate', (e) =&gt; {
  e.waitUntil(
    caches.keys().then(keys =&gt; Promise.all(keys.map(k =&gt; (k!==CACHE_NAME ? caches.delete(k) : Promise.resolve()))))
  );
  self.clients.claim();
});

self.addEventListener('fetch', (e) =&gt; {
  const url = new URL(e.request.url);
  // API fetch for board -&gt; stale-while-revalidate
  if (url.searchParams.get('action') === 'fetch' <span class="err">&amp;&amp;</span> url.searchParams.get('b')) {
    e.respondWith((async () =&gt; {
      const cache = await caches.open(CACHE_NAME);
      const cached = await cache.match(e.request);
      const fetchPromise = fetch(e.request).then(res =&gt; {
        if (res <span class="err">&amp;&amp;</span> (res.status === 200 || res.status === 304)) {
          cache.put(e.request, res.clone());
        }
        return res;
      }).catch(() =&gt; cached);
      return cached || fetchPromise;
    })());
    return;
  }
  // HTML/other GET: network first; fallback to cache; simple offline page if none
  if (e.request.method === 'GET') {
    e.respondWith((async () =&gt; {
      try {
        const net = await fetch(e.request);
        const cache = await caches.open(CACHE_NAME);
        cache.put(e.request, net.clone());
        return net;
      } catch (err) {
        const cache = await caches.open(CACHE_NAME);
        const cached = await cache.match(e.request);
        return cached || new Response('<span class="cp">&lt;!doctype html&gt;</span><span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;&lt;title&gt;</span>Offline<span class="nt">&lt;/title&gt;&lt;h1&gt;</span>Offline<span class="nt">&lt;/h1&gt;&lt;p&gt;</span>The app is offline. Retry when back online.<span class="nt">&lt;/p&gt;</span>', { headers: {'Content-Type':'text/html; charset=utf-8'} });
      }
    })());
  }
});
    <span class="cp">&lt;?php</span>
    <span class="k">exit</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$asset</span> <span class="o">===</span> <span class="s1">'favicon'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: image/svg+xml; charset=utf-8'</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Cache-Control: public, max-age=86400'</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s1">'&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"&gt;&lt;rect fill="#111" width="64" height="64" rx="12"/&gt;&lt;path d="M48 20L27 41l-11-9" stroke="#fff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/&gt;&lt;/svg&gt;'</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'HTTP/1.1 404 Not Found'</span><span class="p">);</span>
  <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// API: Board fetch (GET) with ETag/Last-Modified</span>
<span class="c1">/////////////////////////////</span>

<span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$bParam</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'b'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$action</span> <span class="o">===</span> <span class="s1">'new'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$bid</span> <span class="o">=</span> <span class="nf">id</span><span class="p">();</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: '</span> <span class="mf">.</span> <span class="nv">$origin</span> <span class="mf">.</span> <span class="s1">'/?b='</span> <span class="mf">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$bid</span><span class="p">));</span>
  <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$action</span> <span class="o">===</span> <span class="s1">'fetch'</span> <span class="o">&amp;&amp;</span> <span class="nv">$bParam</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$b</span> <span class="o">=</span> <span class="nf">safeSlug</span><span class="p">(</span><span class="nv">$bParam</span><span class="p">);</span>
  <span class="nv">$f</span> <span class="o">=</span> <span class="nf">pathOf</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
  <span class="nv">$board</span> <span class="o">=</span> <span class="nf">loadBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
  <span class="nv">$raw</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$board</span><span class="p">,</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">);</span>
  <span class="nv">$etag</span> <span class="o">=</span> <span class="s1">'"'</span> <span class="mf">.</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$raw</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'"'</span><span class="p">;</span>
  <span class="nv">$lastModTs</span> <span class="o">=</span> <span class="nb">file_exists</span><span class="p">(</span><span class="nv">$f</span><span class="p">)</span> <span class="o">?</span> <span class="nb">filemtime</span><span class="p">(</span><span class="nv">$f</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$board</span><span class="p">[</span><span class="s1">'updated'</span><span class="p">];</span>
  <span class="nv">$lastMod</span> <span class="o">=</span> <span class="nb">gmdate</span><span class="p">(</span><span class="s1">'D, d M Y H:i:s'</span><span class="p">,</span> <span class="nv">$lastModTs</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">' GMT'</span><span class="p">;</span>

  <span class="nv">$inm</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_IF_NONE_MATCH'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nv">$ims</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_IF_MODIFIED_SINCE'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$inm</span> <span class="o">===</span> <span class="nv">$etag</span> <span class="o">||</span> <span class="nv">$ims</span> <span class="o">===</span> <span class="nv">$lastMod</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'ETag: '</span> <span class="mf">.</span> <span class="nv">$etag</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Last-Modified: '</span> <span class="mf">.</span> <span class="nv">$lastMod</span><span class="p">);</span>
    <span class="nf">notModified</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'ETag'</span> <span class="o">=&gt;</span> <span class="nv">$etag</span><span class="p">,</span>
    <span class="s1">'Last-Modified'</span> <span class="o">=&gt;</span> <span class="nv">$lastMod</span>
  <span class="p">]);</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// POST ops</span>
<span class="c1">/////////////////////////////</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$bParam</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$b</span> <span class="o">=</span> <span class="nf">safeSlug</span><span class="p">(</span><span class="nv">$bParam</span><span class="p">);</span>
  <span class="nv">$in</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">((</span><span class="n">string</span><span class="p">)</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">),</span> <span class="kc">true</span><span class="p">)</span> <span class="o">?:</span> <span class="p">[];</span>
  <span class="nv">$op</span> <span class="o">=</span> <span class="nv">$in</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nv">$board</span> <span class="o">=</span> <span class="nf">loadBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'add'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$t</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$t</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$t</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">MAX_TEXT_LEN</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
      <span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nf">id</span><span class="p">(),</span> <span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">,</span> <span class="s1">'done'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'ts'</span> <span class="o">=&gt;</span> <span class="nb">time</span><span class="p">()];</span>
      <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'toggle'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$idv</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">]</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">===</span> <span class="nv">$idv</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$t</span><span class="p">[</span><span class="s1">'done'</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="nv">$t</span><span class="p">[</span><span class="s1">'done'</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">unset</span><span class="p">(</span><span class="nv">$t</span><span class="p">);</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'edit'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$idv</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">);</span>
    <span class="nv">$txt</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">));</span>
    <span class="nv">$txt</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$txt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">MAX_TEXT_LEN</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">]</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">===</span> <span class="nv">$idv</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$t</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$txt</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">unset</span><span class="p">(</span><span class="nv">$t</span><span class="p">);</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'del'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$idv</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">);</span>
    <span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nb">array_filter</span><span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">],</span> <span class="k">fn</span><span class="p">(</span><span class="nv">$t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">!==</span> <span class="nv">$idv</span><span class="p">));</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'title'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ttl</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$ttl</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="nv">$ttl</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$ttl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">MAX_TITLE_LEN</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="nv">$board</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$ttl</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span> <span class="nv">$ttl</span> <span class="o">:</span> <span class="s1">'My Todo'</span><span class="p">;</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'clear_done'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nb">array_filter</span><span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">],</span> <span class="k">fn</span><span class="p">(</span><span class="nv">$t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">'done'</span><span class="p">])));</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// New: set all done/undone</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'set_all'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$done</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)(</span><span class="nv">$in</span><span class="p">[</span><span class="s1">'done'</span><span class="p">]</span> <span class="o">??</span> <span class="kc">false</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">]</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$t</span><span class="p">[</span><span class="s1">'done'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$done</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">unset</span><span class="p">(</span><span class="nv">$t</span><span class="p">);</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// New: clear all</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'clear_all'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// New: reorder tasks by id list</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">===</span> <span class="s1">'reorder'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$in</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span> <span class="o">??</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$order</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$idx</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$order</span> <span class="k">as</span> <span class="nv">$pos</span> <span class="o">=&gt;</span> <span class="nv">$tid</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$idx</span><span class="p">[(</span><span class="n">string</span><span class="p">)</span><span class="nv">$tid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="nv">$pos</span><span class="p">;</span> <span class="p">}</span>
      <span class="nb">usort</span><span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">],</span> <span class="k">function</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$idx</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ai</span> <span class="o">=</span> <span class="nv">$idx</span><span class="p">[</span><span class="nv">$a</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]]</span> <span class="o">??</span> <span class="kc">PHP_INT_MAX</span><span class="p">;</span>
        <span class="nv">$bi</span> <span class="o">=</span> <span class="nv">$idx</span><span class="p">[</span><span class="nv">$b</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]]</span> <span class="o">??</span> <span class="kc">PHP_INT_MAX</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$ai</span> <span class="o">&lt;=&gt;</span> <span class="nv">$bi</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nf">emitJSON</span><span class="p">(</span><span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nf">emitJSON</span><span class="p">([</span><span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="s1">'unknown op'</span><span class="p">]);</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// Quick add by URL (?add=Text) -&gt; add to board and redirect</span>
<span class="c1">/////////////////////////////</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'add'</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$b</span> <span class="o">=</span> <span class="nf">safeSlug</span><span class="p">(</span><span class="nv">$bParam</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span> <span class="nv">$bParam</span> <span class="o">:</span> <span class="s1">'public'</span><span class="p">);</span>
  <span class="nv">$txt</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'add'</span><span class="p">]);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$txt</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$txt</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$txt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">MAX_TEXT_LEN</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="nv">$board</span> <span class="o">=</span> <span class="nf">loadBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
    <span class="nv">$board</span><span class="p">[</span><span class="s1">'tasks'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nf">id</span><span class="p">(),</span> <span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nv">$txt</span><span class="p">,</span> <span class="s1">'done'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'ts'</span> <span class="o">=&gt;</span> <span class="nb">time</span><span class="p">()];</span>
    <span class="nf">saveBoard</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span> <span class="nv">$board</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: '</span> <span class="mf">.</span> <span class="nv">$origin</span> <span class="mf">.</span> <span class="s1">'/?b='</span> <span class="mf">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$b</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">303</span><span class="p">);</span>
  <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////</span>
<span class="c1">// HTML App</span>
<span class="c1">/////////////////////////////</span>

<span class="nv">$boardSlug</span> <span class="o">=</span> <span class="nf">safeSlug</span><span class="p">(</span><span class="nv">$bParam</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span> <span class="nv">$bParam</span> <span class="o">:</span> <span class="s1">'public'</span><span class="p">);</span>
<span class="nf">htmlHeader</span><span class="p">();</span>
<span class="cp">?&gt;</span>
<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"robots"</span> <span class="na">content=</span><span class="s">"noindex"</span><span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"manifest"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$origin</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">/?asset=manifest"</span><span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$origin</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">/?asset=favicon"</span> <span class="na">type=</span><span class="s">"image/svg+xml"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"theme-color"</span> <span class="na">content=</span><span class="s">"#111111"</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>memor.ia.br <span class="ni">&amp;mdash;</span> Todos<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;style&gt;</span>
  <span class="nd">:root</span> <span class="p">{</span> <span class="py">color-scheme</span><span class="p">:</span> <span class="n">light</span> <span class="n">dark</span><span class="p">;</span> <span class="py">--bg</span><span class="p">:</span><span class="m">#fff</span><span class="p">;</span> <span class="py">--fg</span><span class="p">:</span><span class="m">#111</span><span class="p">;</span> <span class="py">--muted</span><span class="p">:</span><span class="m">#777</span><span class="p">;</span> <span class="py">--border</span><span class="p">:</span><span class="m">#ddd</span><span class="p">;</span> <span class="py">--accent</span><span class="p">:</span><span class="m">#111</span><span class="p">;</span> <span class="py">--ok</span><span class="p">:</span><span class="m">#0a7f2e</span><span class="p">;</span> <span class="py">--warn</span><span class="p">:</span><span class="m">#a00</span><span class="p">;</span> <span class="py">--chip</span><span class="p">:</span><span class="m">#f1f1f1</span><span class="p">;</span> <span class="py">--chipA</span><span class="p">:</span><span class="m">#d1e9ff</span><span class="p">;</span> <span class="py">--focus</span><span class="p">:</span><span class="m">#5b9cff</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">prefers-color-scheme</span><span class="p">:</span> <span class="n">dark</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">:root</span> <span class="p">{</span> <span class="py">--bg</span><span class="p">:</span><span class="m">#0c0c0c</span><span class="p">;</span> <span class="py">--fg</span><span class="p">:</span><span class="m">#eee</span><span class="p">;</span> <span class="py">--muted</span><span class="p">:</span><span class="m">#aaa</span><span class="p">;</span> <span class="py">--border</span><span class="p">:</span><span class="m">#222</span><span class="p">;</span> <span class="py">--accent</span><span class="p">:</span><span class="m">#e5e5e5</span><span class="p">;</span> <span class="py">--ok</span><span class="p">:</span><span class="m">#4cc27f</span><span class="p">;</span> <span class="py">--warn</span><span class="p">:</span><span class="m">#ff736a</span><span class="p">;</span> <span class="py">--chip</span><span class="p">:</span><span class="m">#171717</span><span class="p">;</span> <span class="py">--chipA</span><span class="p">:</span><span class="m">#0f3050</span><span class="p">;</span> <span class="py">--focus</span><span class="p">:</span><span class="m">#6aa3ff</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="c">/* Prevent padding/border from causing overflow on small screens */</span>
  <span class="o">*,</span> <span class="o">*</span><span class="nd">::before</span><span class="o">,</span> <span class="o">*</span><span class="nd">::after</span> <span class="p">{</span> <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span> <span class="p">}</span>

  <span class="nt">html</span><span class="o">,</span><span class="nt">body</span><span class="p">{</span><span class="nl">height</span><span class="p">:</span><span class="m">100%</span><span class="p">}</span>
  <span class="nt">body</span><span class="p">{</span><span class="nl">margin</span><span class="p">:</span><span class="m">0</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--bg</span><span class="p">);</span><span class="nl">color</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--fg</span><span class="p">);</span><span class="nl">font</span><span class="p">:</span><span class="m">16px</span><span class="p">/</span><span class="m">1.5</span> <span class="n">system-ui</span><span class="p">,</span><span class="n">Segoe</span> <span class="n">UI</span><span class="p">,</span><span class="n">Roboto</span><span class="p">,</span><span class="n">Arial</span><span class="p">}</span>
  <span class="nc">.wrap</span><span class="p">{</span><span class="nl">max-width</span><span class="p">:</span><span class="m">920px</span><span class="p">;</span><span class="nl">margin</span><span class="p">:</span><span class="m">0</span> <span class="nb">auto</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">18px</span><span class="p">}</span>
  <span class="nc">.box</span><span class="p">{</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">);</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">12px</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">14px</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0.02</span><span class="p">)}</span>
  <span class="c">/* Allow items to wrap instead of overflowing horizontally */</span>
  <span class="nc">.row</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="n">flex</span><span class="p">;</span><span class="py">gap</span><span class="p">:</span><span class="m">.5rem</span><span class="p">;</span><span class="nl">align-items</span><span class="p">:</span><span class="nb">center</span><span class="p">;</span><span class="nl">flex-wrap</span><span class="p">:</span><span class="n">wrap</span><span class="p">}</span>
  <span class="c">/* Inputs are flex items that may shrink; ensure they can */</span>
  <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">text</span><span class="o">],</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">search</span><span class="o">]</span><span class="p">{</span>
    <span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">min-width</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="c">/* allow shrink within flex containers */</span>
    <span class="nl">padding</span><span class="p">:</span><span class="m">.65rem</span><span class="p">;</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">);</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">10px</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="nb">transparent</span><span class="p">;</span><span class="nl">color</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--fg</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nt">button</span><span class="p">{</span><span class="nl">padding</span><span class="p">:</span><span class="m">.6rem</span> <span class="m">.9rem</span><span class="p">;</span><span class="nl">border</span><span class="p">:</span><span class="m">0</span><span class="p">;</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">10px</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--accent</span><span class="p">);</span><span class="nl">color</span><span class="p">:</span><span class="m">#fff</span><span class="p">;</span><span class="nl">cursor</span><span class="p">:</span><span class="nb">pointer</span><span class="p">}</span>
  <span class="nt">button</span><span class="nc">.secondary</span><span class="p">{</span><span class="nl">background</span><span class="p">:</span><span class="nb">transparent</span><span class="p">;</span><span class="nl">color</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--fg</span><span class="p">);</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">)}</span>
  <span class="nt">button</span><span class="nc">.warn</span><span class="p">{</span><span class="nl">background</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--warn</span><span class="p">)}</span>
  <span class="nt">button</span><span class="nc">.ok</span><span class="p">{</span><span class="nl">background</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--ok</span><span class="p">)}</span>
  <span class="nt">ul</span><span class="p">{</span><span class="nl">list-style</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">0</span><span class="p">;</span><span class="nl">margin</span><span class="p">:</span><span class="m">12px</span> <span class="m">0</span><span class="p">}</span>
  <span class="c">/* Let task rows wrap controls/text on narrow screens */</span>
  <span class="nt">li</span><span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span><span class="n">flex</span><span class="p">;</span>
    <span class="nl">align-items</span><span class="p">:</span><span class="nb">center</span><span class="p">;</span>
    <span class="py">gap</span><span class="p">:</span><span class="m">.5rem</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span><span class="m">.45rem</span> <span class="m">.3rem</span><span class="p">;</span>
    <span class="nl">border-bottom</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">);</span>
    <span class="nl">flex-wrap</span><span class="p">:</span><span class="n">wrap</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">li</span><span class="nd">:focus</span><span class="p">{</span><span class="nl">outline</span><span class="p">:</span><span class="m">2px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--focus</span><span class="p">);</span><span class="nl">outline-offset</span><span class="p">:</span><span class="m">2px</span><span class="p">;</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">8px</span><span class="p">}</span>
  <span class="nt">li</span><span class="nc">.done</span> <span class="nc">.txt</span><span class="p">{</span><span class="nl">text-decoration</span><span class="p">:</span><span class="nb">line-through</span><span class="p">;</span><span class="nl">color</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--muted</span><span class="p">)}</span>
  <span class="nc">.txt</span><span class="p">{</span>
    <span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">min-width</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="c">/* avoid pushing buttons offscreen */</span>
    <span class="nl">outline</span><span class="p">:</span><span class="nb">none</span>
  <span class="p">}</span>
  <span class="nc">.txt</span><span class="nd">:focus</span><span class="p">{</span><span class="nl">background</span><span class="p">:</span><span class="n">rgba</span><span class="p">(</span><span class="m">127</span><span class="p">,</span><span class="m">127</span><span class="p">,</span><span class="m">127</span><span class="p">,</span><span class="m">.1</span><span class="p">);</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">4px</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">2px</span><span class="p">}</span>
  <span class="nc">.meta</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="n">flex</span><span class="p">;</span><span class="py">gap</span><span class="p">:</span><span class="m">8px</span><span class="p">;</span><span class="nl">align-items</span><span class="p">:</span><span class="nb">center</span><span class="p">;</span><span class="nl">flex-wrap</span><span class="p">:</span><span class="n">wrap</span><span class="p">;</span><span class="nl">margin-top</span><span class="p">:</span><span class="m">10px</span><span class="p">}</span>
  <span class="nc">.small</span><span class="p">{</span><span class="nl">font-size</span><span class="p">:</span><span class="m">.9rem</span><span class="p">;</span><span class="nl">color</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--muted</span><span class="p">)}</span>
  <span class="nc">.pill</span><span class="p">{</span><span class="nl">padding</span><span class="p">:</span><span class="m">.1rem</span> <span class="m">.5rem</span><span class="p">;</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">);</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">999px</span><span class="p">}</span>
  <span class="nc">.share</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="n">inline-flex</span><span class="p">;</span><span class="py">gap</span><span class="p">:</span><span class="m">.5rem</span><span class="p">;</span><span class="nl">align-items</span><span class="p">:</span><span class="nb">center</span><span class="p">}</span>
  <span class="nc">.offline</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">margin</span><span class="p">:</span><span class="m">12px</span> <span class="m">0</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">10px</span><span class="p">;</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">10px</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="m">#fffbcc</span><span class="p">;</span><span class="nl">color</span><span class="p">:</span><span class="m">#333</span><span class="p">;</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="m">#e0dca6</span><span class="p">}</span>
  <span class="nc">.offline.show</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="nb">block</span><span class="p">}</span>
  <span class="nc">.right</span><span class="p">{</span><span class="nl">margin-left</span><span class="p">:</span><span class="nb">auto</span><span class="p">}</span>
  <span class="nc">.kbd</span><span class="p">{</span><span class="nl">font-family</span><span class="p">:</span><span class="n">ui-monospace</span><span class="p">,</span> <span class="n">SFMono-Regular</span><span class="p">,</span> <span class="n">Menlo</span><span class="p">,</span> <span class="n">Consolas</span><span class="p">,</span> <span class="nb">monospace</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="n">rgba</span><span class="p">(</span><span class="m">127</span><span class="p">,</span><span class="m">127</span><span class="p">,</span><span class="m">127</span><span class="p">,</span><span class="m">.18</span><span class="p">);</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">);</span><span class="nl">border-bottom-color</span><span class="p">:</span><span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">.3</span><span class="p">);</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">6px</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">0</span> <span class="m">.3rem</span><span class="p">}</span>
  <span class="nc">.toolbar</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="n">flex</span><span class="p">;</span><span class="py">gap</span><span class="p">:</span><span class="m">.5rem</span><span class="p">;</span><span class="nl">flex-wrap</span><span class="p">:</span><span class="n">wrap</span><span class="p">;</span><span class="nl">align-items</span><span class="p">:</span><span class="nb">center</span><span class="p">;</span><span class="nl">margin-bottom</span><span class="p">:</span><span class="m">.6rem</span><span class="p">}</span>
  <span class="nc">.chips</span><span class="p">{</span><span class="nl">display</span><span class="p">:</span><span class="n">flex</span><span class="p">;</span><span class="py">gap</span><span class="p">:</span><span class="m">.4rem</span><span class="p">;</span><span class="nl">flex-wrap</span><span class="p">:</span><span class="n">wrap</span><span class="p">}</span>
  <span class="nc">.chip</span><span class="p">{</span><span class="nl">padding</span><span class="p">:</span><span class="m">.35rem</span> <span class="m">.6rem</span><span class="p">;</span><span class="nl">border-radius</span><span class="p">:</span><span class="m">999px</span><span class="p">;</span><span class="nl">border</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="n">var</span><span class="p">(</span><span class="n">--border</span><span class="p">);</span><span class="nl">background</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--chip</span><span class="p">);</span><span class="nl">cursor</span><span class="p">:</span><span class="nb">pointer</span><span class="p">}</span>
  <span class="nc">.chip.active</span><span class="p">{</span><span class="nl">background</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--chipA</span><span class="p">)}</span>
  <span class="nc">.drag</span><span class="p">{</span><span class="nl">cursor</span><span class="p">:</span><span class="n">grab</span><span class="p">;</span><span class="py">user-select</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">color</span><span class="p">:</span><span class="n">var</span><span class="p">(</span><span class="n">--muted</span><span class="p">);</span><span class="nl">padding</span><span class="p">:</span><span class="m">0</span> <span class="m">.4rem</span><span class="p">}</span>
  <span class="nc">.count</span><span class="p">{</span><span class="nl">margin-left</span><span class="p">:</span><span class="m">.4rem</span><span class="p">}</span>
  <span class="nc">.status</span><span class="p">{</span><span class="nl">min-height</span><span class="p">:</span><span class="m">1.4rem</span><span class="p">}</span>
  <span class="nc">.status</span> <span class="nt">button</span><span class="p">{</span><span class="nl">margin-left</span><span class="p">:</span><span class="m">.5rem</span><span class="p">}</span>
  <span class="nc">.sr</span><span class="p">{</span><span class="nl">position</span><span class="p">:</span><span class="nb">absolute</span><span class="p">;</span><span class="nl">left</span><span class="p">:</span><span class="m">-9999px</span><span class="p">;</span><span class="nl">top</span><span class="p">:</span><span class="nb">auto</span><span class="p">;</span><span class="nl">width</span><span class="p">:</span><span class="m">1px</span><span class="p">;</span><span class="nl">height</span><span class="p">:</span><span class="m">1px</span><span class="p">;</span><span class="nl">overflow</span><span class="p">:</span><span class="nb">hidden</span><span class="p">;}</span>

  <span class="c">/* Keep drag handle/checkbox/delete visible; text fills remaining space */</span>
  <span class="nt">li</span> <span class="o">&gt;</span> <span class="nc">.drag</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">0</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">}</span>
  <span class="nt">li</span> <span class="o">&gt;</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">checkbox</span><span class="o">]</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">0</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">}</span>
  <span class="nt">li</span> <span class="o">&gt;</span> <span class="nt">button</span><span class="o">[</span><span class="nt">aria-label</span><span class="o">=</span><span class="s1">"Delete task"</span><span class="o">]</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">0</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">}</span>

  <span class="c">/* Defensive text wrapping to avoid horizontal scroll from long tokens/URLs */</span>
  <span class="nc">.wrap</span><span class="o">,</span> <span class="nc">.box</span><span class="o">,</span> <span class="nc">.txt</span><span class="o">,</span> <span class="nf">#title</span><span class="o">,</span> <span class="nf">#newtodo</span><span class="o">,</span> <span class="nf">#search</span><span class="o">,</span> <span class="nf">#shareUrl</span> <span class="p">{</span>
    <span class="nl">overflow-wrap</span><span class="p">:</span><span class="n">anywhere</span><span class="p">;</span>
    <span class="nl">word-break</span><span class="p">:</span><span class="n">break-word</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c">/* --- Responsive layout --- */</span>
  <span class="c">/* Toolbar: allow the shortcuts block to wrap to its own line on small screens */</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">620px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">.wrap</span><span class="p">{</span><span class="nl">padding</span><span class="p">:</span><span class="m">12px</span><span class="p">}</span>
    <span class="nc">.toolbar</span> <span class="nc">.row</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
    <span class="nc">.toolbar</span> <span class="nc">.row.right</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">;</span> <span class="nl">order</span><span class="p">:</span><span class="m">2</span><span class="p">;</span> <span class="nl">font-size</span><span class="p">:</span><span class="m">.95rem</span><span class="p">}</span>
  <span class="p">}</span>

  <span class="c">/* Title + bulk actions row:
     - Title takes full width on narrow viewports
     - Buttons wrap to two columns, then single column on very narrow screens */</span>
  <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:first-of-type</span> <span class="o">&gt;</span> <span class="nf">#title</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">320px</span><span class="p">;</span> <span class="nl">min-width</span><span class="p">:</span><span class="m">0</span><span class="p">}</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">820px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:first-of-type</span> <span class="o">&gt;</span> <span class="nf">#title</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
  <span class="p">}</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">620px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:first-of-type</span> <span class="o">&gt;</span> <span class="nf">#title</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
    <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:first-of-type</span> <span class="o">&gt;</span> <span class="nt">button</span><span class="p">{</span>
      <span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="n">calc</span><span class="p">(</span><span class="m">50%</span> <span class="n">-</span> <span class="m">.5rem</span><span class="p">);</span>
      <span class="nl">min-width</span><span class="p">:</span><span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">420px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:first-of-type</span> <span class="o">&gt;</span> <span class="nt">button</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
  <span class="p">}</span>

  <span class="c">/* Add/search/filter row: allow clean wrapping */</span>
  <span class="nf">#newtodo</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">2</span> <span class="m">1</span> <span class="m">260px</span><span class="p">;</span> <span class="nl">min-width</span><span class="p">:</span><span class="m">0</span><span class="p">}</span>
  <span class="nf">#search</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">180px</span><span class="p">;</span> <span class="nl">min-width</span><span class="p">:</span><span class="m">0</span><span class="p">}</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">620px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:nth-of-type</span><span class="o">(</span><span class="err">2</span><span class="o">)</span> <span class="o">&gt;</span> <span class="nf">#newtodo</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
    <span class="nc">.box</span> <span class="o">&gt;</span> <span class="nc">.row</span><span class="nd">:nth-of-type</span><span class="o">(</span><span class="err">2</span><span class="o">)</span> <span class="o">&gt;</span> <span class="nf">#search</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
    <span class="nc">.chips</span><span class="p">{</span><span class="nl">flex</span><span class="p">:</span><span class="m">1</span> <span class="m">1</span> <span class="m">100%</span><span class="p">}</span>
    <span class="c">/* Override inline max-widths so fields can span full width on small screens */</span>
    <span class="nf">#slug</span><span class="o">,</span> <span class="nf">#search</span><span class="o">,</span> <span class="nf">#shareUrl</span> <span class="p">{</span> <span class="nl">max-width</span><span class="p">:</span><span class="m">100%</span> <span class="cp">!important</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="c">/* List items: small screens may move Delete to next line neatly */</span>
  <span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">420px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nt">li</span><span class="p">{</span><span class="py">row-gap</span><span class="p">:</span><span class="m">.35rem</span><span class="p">}</span>
    <span class="nt">li</span> <span class="o">&gt;</span> <span class="nt">button</span><span class="o">[</span><span class="nt">aria-label</span><span class="o">=</span><span class="s1">"Delete task"</span><span class="o">]</span><span class="p">{</span><span class="nl">margin-left</span><span class="p">:</span><span class="nb">auto</span><span class="p">}</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrap"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"toolbar"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span> <span class="na">style=</span><span class="s">"flex:1;gap:.5rem"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small pill"</span><span class="nt">&gt;</span>Board<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"slug"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$boardSlug</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">aria-label=</span><span class="s">"Board slug"</span> <span class="na">style=</span><span class="s">"max-width:240px"</span> <span class="na">list=</span><span class="s">"boards"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;datalist</span> <span class="na">id=</span><span class="s">"boards"</span><span class="nt">&gt;&lt;/datalist&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">id=</span><span class="s">"switch"</span> <span class="na">title=</span><span class="s">"Open board by slug"</span><span class="nt">&gt;</span>Open<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">id=</span><span class="s">"newBoard"</span> <span class="na">title=</span><span class="s">"Create a new random board"</span><span class="nt">&gt;</span>New<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row right"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small"</span><span class="nt">&gt;</span>Shortcuts: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"kbd"</span><span class="nt">&gt;</span>Enter<span class="nt">&lt;/span&gt;</span> add/edit, <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"kbd"</span><span class="nt">&gt;</span>Esc<span class="nt">&lt;/span&gt;</span> cancel, <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"kbd"</span><span class="nt">&gt;</span>Ctrl<span class="nt">&lt;/span&gt;</span>+<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"kbd"</span><span class="nt">&gt;</span>/<span class="nt">&lt;/span&gt;</span> focus<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"offline"</span> <span class="na">class=</span><span class="s">"offline"</span> <span class="na">role=</span><span class="s">"status"</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;</span>You are offline. Changes will queue and sync when back online.<span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span> <span class="na">aria-label=</span><span class="s">"Todo app"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span> <span class="na">style=</span><span class="s">"margin-bottom:.6rem"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"title"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"My Todo"</span> <span class="na">aria-label=</span><span class="s">"List title"</span> <span class="na">title=</span><span class="s">"Title (Enter to save, Esc to cancel)"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"saveTitle"</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">title=</span><span class="s">"Save title"</span><span class="nt">&gt;</span>Save title<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"toggleAll"</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">title=</span><span class="s">"Toggle all tasks"</span><span class="nt">&gt;</span>Complete all<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"clearDone"</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">title=</span><span class="s">"Remove completed tasks"</span><span class="nt">&gt;</span>Clear completed<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"clearAll"</span> <span class="na">class=</span><span class="s">"warn"</span> <span class="na">title=</span><span class="s">"Remove all tasks"</span><span class="nt">&gt;</span>Clear all<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span> <span class="na">style=</span><span class="s">"margin-bottom:.6rem"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"newtodo"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">placeholder=</span><span class="s">"Add a task"</span> <span class="na">autofocus</span> <span class="na">aria-label=</span><span class="s">"New task"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"add"</span><span class="nt">&gt;</span>Add<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"search"</span> <span class="na">type=</span><span class="s">"search"</span> <span class="na">placeholder=</span><span class="s">"Search"</span> <span class="na">aria-label=</span><span class="s">"Search tasks"</span> <span class="na">style=</span><span class="s">"max-width:240px"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"chips"</span> <span class="na">role=</span><span class="s">"tablist"</span> <span class="na">aria-label=</span><span class="s">"Filter tasks"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"chip active"</span> <span class="na">data-filter=</span><span class="s">"all"</span> <span class="na">role=</span><span class="s">"tab"</span> <span class="na">aria-selected=</span><span class="s">"true"</span><span class="nt">&gt;</span>All<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"chip"</span> <span class="na">data-filter=</span><span class="s">"active"</span> <span class="na">role=</span><span class="s">"tab"</span> <span class="na">aria-selected=</span><span class="s">"false"</span><span class="nt">&gt;</span>Active<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"chip"</span> <span class="na">data-filter=</span><span class="s">"done"</span> <span class="na">role=</span><span class="s">"tab"</span> <span class="na">aria-selected=</span><span class="s">"false"</span><span class="nt">&gt;</span>Completed<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"list"</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;&lt;/ul&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"meta"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small"</span><span class="nt">&gt;</span>Share this board URL:<span class="nt">&lt;/span&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"shareUrl"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">readonly</span> <span class="na">style=</span><span class="s">"max-width:380px"</span> <span class="na">aria-label=</span><span class="s">"Share URL"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">id=</span><span class="s">"copy"</span><span class="nt">&gt;</span>Copy<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small count"</span> <span class="na">id=</span><span class="s">"counts"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small right"</span> <span class="na">id=</span><span class="s">"updated"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"meta"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small"</span><span class="nt">&gt;</span>Share this board URL:<span class="nt">&lt;/span&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"shareUrl"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">readonly</span> <span class="na">style=</span><span class="s">"max-width:380px"</span> <span class="na">aria-label=</span><span class="s">"Share URL"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">id=</span><span class="s">"copy"</span><span class="nt">&gt;</span>Copy<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small count"</span> <span class="na">id=</span><span class="s">"counts"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small right"</span> <span class="na">id=</span><span class="s">"updated"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"meta"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"status small"</span> <span class="na">id=</span><span class="s">"status"</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"undo"</span> <span class="na">class=</span><span class="s">"secondary"</span> <span class="na">style=</span><span class="s">"display:none"</span><span class="nt">&gt;</span>Undo<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr"</span> <span class="na">id=</span><span class="s">"srmsg"</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="kd">const</span> <span class="nx">origin</span> <span class="o">=</span> <span class="cp">&lt;?=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$origin</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">bid</span> <span class="o">=</span> <span class="cp">&lt;?=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$boardSlug</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">s</span> <span class="o">=&gt;</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#list</span><span class="dl">'</span><span class="p">),</span> <span class="nx">input</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#newtodo</span><span class="dl">'</span><span class="p">),</span> <span class="nx">title</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#title</span><span class="dl">'</span><span class="p">),</span> <span class="nx">statusEl</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#status</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">offlineBanner</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#offline</span><span class="dl">'</span><span class="p">),</span> <span class="nx">slugInput</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#slug</span><span class="dl">'</span><span class="p">),</span> <span class="nx">shareUrl</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#shareUrl</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">countsEl</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#counts</span><span class="dl">'</span><span class="p">),</span> <span class="nx">updatedEl</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#updated</span><span class="dl">'</span><span class="p">),</span> <span class="nx">undoBtn</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#undo</span><span class="dl">'</span><span class="p">),</span> <span class="nx">srmsg</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#srmsg</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">chips</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">.chip</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">boardsDL</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#boards</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">boardETag</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">boardLastMod</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">isSyncing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">boardData</span> <span class="o">=</span> <span class="p">{</span><span class="na">title</span><span class="p">:</span><span class="dl">'</span><span class="s1">My Todo</span><span class="dl">'</span><span class="p">,</span> <span class="na">tasks</span><span class="p">:[],</span> <span class="na">created</span><span class="p">:</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span> <span class="na">updated</span><span class="p">:</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="o">|</span><span class="mi">0</span><span class="p">};</span>
<span class="kd">let</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">memor_filter</span><span class="dl">'</span><span class="p">)</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">all</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">searchQuery</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">memor_search</span><span class="dl">'</span><span class="p">)</span> <span class="o">||</span> <span class="dl">''</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">pendingEdit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// {id, orig}</span>
<span class="kd">let</span> <span class="nx">lastAction</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// for undo</span>
<span class="kd">let</span> <span class="nx">undoTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">outboxKey</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`memor_outbox_</span><span class="p">${</span><span class="nx">b</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">recentBoardsKey</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">memor_recent_boards_v1</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Register SW</span>
<span class="k">if </span><span class="p">(</span><span class="dl">'</span><span class="s1">serviceWorker</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="dl">'</span><span class="s1">/?asset=sw</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">scope</span><span class="p">:</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Online/offline indicators</span>
<span class="kd">function</span> <span class="nf">updateOnlineUI</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">onLine</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">offlineBanner</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="dl">'</span><span class="s1">show</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">offlineBanner</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">show</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">online</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nf">updateOnlineUI</span><span class="p">();</span> <span class="nf">flushOutbox</span><span class="p">();</span> <span class="nf">fetchBoard</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="p">});</span>
<span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">offline</span><span class="dl">'</span><span class="p">,</span> <span class="nx">updateOnlineUI</span><span class="p">);</span>
<span class="nf">updateOnlineUI</span><span class="p">();</span>

<span class="c1">// Copy/share URL setup</span>
<span class="kd">const</span> <span class="nx">boardURL</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">origin</span><span class="p">}</span><span class="s2">/?b=</span><span class="p">${</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">bid</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
<span class="nx">shareUrl</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">boardURL</span><span class="p">;</span>
<span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#copy</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span> <span class="k">await</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">clipboard</span><span class="p">.</span><span class="nf">writeText</span><span class="p">(</span><span class="nx">boardURL</span><span class="p">);</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Copied link</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1200</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Copy failed</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1500</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Helper: small status message</span>
<span class="kd">let</span> <span class="nx">flashTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nf">flash</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">persistMs</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">clearTimeout</span><span class="p">(</span><span class="nx">flashTimer</span><span class="p">);</span>
  <span class="nx">statusEl</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">persistMs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">flashTimer</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">statusEl</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">''</span><span class="p">,</span> <span class="nx">persistMs</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">srmsg</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Undo handling</span>
<span class="kd">function</span> <span class="nf">showUndo</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">lastAction</span> <span class="o">=</span> <span class="nx">action</span><span class="p">;</span> <span class="c1">// {type, payload}</span>
  <span class="nx">undoBtn</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">inline-block</span><span class="dl">'</span><span class="p">;</span>
  <span class="nf">clearTimeout</span><span class="p">(</span><span class="nx">undoTimer</span><span class="p">);</span>
  <span class="nx">undoTimer</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nf">hideUndo</span><span class="p">();</span> <span class="p">},</span> <span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">hideUndo</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">lastAction</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">undoBtn</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">undoBtn</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">lastAction</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">act</span> <span class="o">=</span> <span class="nx">lastAction</span><span class="p">;</span>
  <span class="nf">hideUndo</span><span class="p">();</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">act</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">del</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">act</span><span class="p">.</span><span class="nx">payload</span><span class="p">;</span>
    <span class="k">await</span> <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">add</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">text</span><span class="p">});</span>
    <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Undid delete</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">act</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">clear_done</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">t</span> <span class="k">of</span> <span class="nx">act</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">add</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">text</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Restored completed</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1200</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Render helpers</span>
<span class="kd">function</span> <span class="nf">fmtRelTime</span><span class="p">(</span><span class="nx">ts</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span> <span class="o">-</span> <span class="nx">ts</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="dl">'</span><span class="s1">just now</span><span class="dl">'</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">s</span><span class="p">}</span><span class="s2">s ago`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nx">s</span><span class="o">/</span><span class="mi">60</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">m</span><span class="p">}</span><span class="s2">m ago`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nx">m</span><span class="o">/</span><span class="mi">60</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">h</span><span class="p">}</span><span class="s2">h ago`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nx">h</span><span class="o">/</span><span class="mi">24</span><span class="p">);</span>
  <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">d</span><span class="p">}</span><span class="s2">d ago`</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">updateMeta</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">activeCount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">||</span> <span class="p">[]).</span><span class="nf">filter</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span><span class="p">;</span>
  <span class="nx">countsEl</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">total</span> <span class="p">?</span> <span class="s2">`</span><span class="p">${</span><span class="nx">activeCount</span><span class="p">}</span><span class="s2"> item</span><span class="p">${</span><span class="nx">activeCount</span><span class="o">!==</span><span class="mi">1</span><span class="p">?</span><span class="dl">'</span><span class="s1">s</span><span class="dl">'</span><span class="p">:</span><span class="dl">''</span><span class="p">}</span><span class="s2"> left • </span><span class="p">${</span><span class="nx">total</span><span class="p">}</span><span class="s2"> total`</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">No tasks</span><span class="dl">'</span><span class="p">;</span>
  <span class="nx">updatedEl</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">`Updated </span><span class="p">${</span><span class="nf">fmtRelTime</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">updated</span><span class="o">||</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="o">|</span><span class="mi">0</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#toggleAll</span><span class="dl">'</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">activeCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">Complete all</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">Uncheck all</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Filtering</span>
<span class="kd">function</span> <span class="nf">applyFilter</span><span class="p">(</span><span class="nx">tasks</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">slice</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">q</span> <span class="o">=</span> <span class="p">(</span><span class="nx">searchQuery</span><span class="o">||</span><span class="dl">''</span><span class="p">).</span><span class="nf">toLowerCase</span><span class="p">();</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">filter</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">active</span><span class="dl">'</span><span class="p">)</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">filter</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">done</span><span class="dl">'</span><span class="p">)</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">text</span><span class="o">||</span><span class="dl">''</span><span class="p">).</span><span class="nf">toLowerCase</span><span class="p">().</span><span class="nf">includes</span><span class="p">(</span><span class="nx">q</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">updateFilterUI</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">chips</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">ch</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">isActive</span> <span class="o">=</span> <span class="nx">ch</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-filter</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">filter</span><span class="p">;</span>
    <span class="nx">ch</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">toggle</span><span class="p">(</span><span class="dl">'</span><span class="s1">active</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isActive</span><span class="p">);</span>
    <span class="nx">ch</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">aria-selected</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isActive</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">false</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#search</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">searchQuery</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">reorderAllowed</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">filter</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">all</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">searchQuery</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Recent boards</span>
<span class="kd">function</span> <span class="nf">pushRecentBoard</span><span class="p">(</span><span class="nx">slug</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="nx">recentBoardsKey</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">raw</span> <span class="p">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="p">:</span> <span class="p">[];</span>
    <span class="nx">arr</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span> <span class="o">!==</span> <span class="nx">slug</span><span class="p">);</span>
    <span class="nx">arr</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="nx">slug</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nf">setItem</span><span class="p">(</span><span class="nx">recentBoardsKey</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">arr</span><span class="p">));</span>
    <span class="nf">renderBoardsList</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">renderBoardsList</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="nx">recentBoardsKey</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">raw</span> <span class="p">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="p">:</span> <span class="p">[];</span>
    <span class="nx">boardsDL</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="s2">`&lt;option value="</span><span class="p">${</span><span class="nx">s</span><span class="p">}</span><span class="s2">"&gt;&lt;/option&gt;`</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Render board</span>
<span class="kd">function</span> <span class="nf">render</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">boardData</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
  <span class="nx">title</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">My Todo</span><span class="dl">'</span><span class="p">;</span>
  <span class="nf">updateMeta</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
  <span class="nf">renderBoardsList</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">tasks</span> <span class="o">=</span> <span class="nf">applyFilter</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">||</span> <span class="p">[]);</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">allowDrag</span> <span class="o">=</span> <span class="nf">reorderAllowed</span><span class="p">();</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">allowDrag</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-drag-disabled</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-drag-disabled</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">tasks</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">li</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">li</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">li</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">tabindex</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="nx">li</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">done</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">li</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">li</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="nx">allowDrag</span><span class="p">;</span>
    <span class="nx">li</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span>
      <span class="s2">`&lt;span class="drag" title="</span><span class="p">${</span><span class="nx">allowDrag</span><span class="p">?</span><span class="dl">'</span><span class="s1">Drag to reorder</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">Reorder disabled while filtering/searching</span><span class="dl">'</span><span class="p">}</span><span class="s2">"&gt;⋮⋮&lt;/span&gt;
       &lt;input type="checkbox" </span><span class="p">${</span><span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">?</span><span class="dl">'</span><span class="s1">checked</span><span class="dl">'</span><span class="p">:</span><span class="dl">''</span><span class="p">}</span><span class="s2"> data-id="</span><span class="p">${</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">" aria-label="Mark task done"&gt;
       &lt;span class="txt" contenteditable="true" data-id="</span><span class="p">${</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">" spellcheck="false" role="textbox" aria-multiline="false"&gt;&lt;/span&gt;
       &lt;button class="secondary" data-del="</span><span class="p">${</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">" aria-label="Delete task"&gt;Delete&lt;/button&gt;`</span><span class="p">;</span>
    <span class="nx">li</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">.txt</span><span class="dl">'</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Drag events</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">allowDrag</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">li</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragstart</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nf">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragging</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">li</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragend</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragging</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">li</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragover</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">dragging</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">.dragging</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">dragging</span> <span class="o">||</span> <span class="nx">dragging</span> <span class="o">===</span> <span class="nx">li</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">li</span><span class="p">.</span><span class="nf">getBoundingClientRect</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">before</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">list</span><span class="p">.</span><span class="nf">insertBefore</span><span class="p">(</span><span class="nx">dragging</span><span class="p">,</span> <span class="nx">before</span> <span class="p">?</span> <span class="nx">li</span> <span class="p">:</span> <span class="nx">li</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">li</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">drop</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">li</span><span class="dl">'</span><span class="p">)).</span><span class="nf">map</span><span class="p">(</span><span class="nx">node</span> <span class="o">=&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">await</span> <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">reorder</span><span class="dl">'</span><span class="p">,</span> <span class="nx">order</span><span class="p">});</span>
        <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Reordered</span><span class="dl">'</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">list</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">li</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Fetch with ETag support</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">fetchBoard</span><span class="p">(</span><span class="nx">force</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`?action=fetch&amp;b=</span><span class="p">${</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">bid</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">boardETag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">force</span><span class="p">)</span> <span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">If-None-Match</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">boardETag</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">boardLastMod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">force</span><span class="p">)</span> <span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">If-Modified-Since</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">boardLastMod</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="nx">headers</span><span class="p">});</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">304</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Network error</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">r</span><span class="p">.</span><span class="nf">json</span><span class="p">();</span>
    <span class="nx">boardETag</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">ETag</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">boardLastMod</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">Last-Modified</span><span class="dl">'</span><span class="p">);</span>
    <span class="nf">render</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
    <span class="nf">pushRecentBoard</span><span class="p">(</span><span class="nx">bid</span><span class="p">);</span>
    <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Loaded</span><span class="dl">'</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Offline (cached view)</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1500</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Queue ops if offline/errors</span>
<span class="kd">function</span> <span class="nf">queueOp</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">k</span> <span class="o">=</span> <span class="nf">outboxKey</span><span class="p">(</span><span class="nx">bid</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">[]</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">arr</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nf">setItem</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">arr</span><span class="p">));</span>
  <span class="nx">offlineBanner</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">show</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Flush queued ops</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">flushOutbox</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">isSyncing</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">k</span> <span class="o">=</span> <span class="nf">outboxKey</span><span class="p">(</span><span class="nx">bid</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">[]</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="o">!</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">onLine</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="nx">isSyncing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">while </span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">onLine</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">await</span> <span class="nf">op</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="p">{</span><span class="na">silent</span><span class="p">:</span><span class="kc">true</span><span class="p">});</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nf">shift</span><span class="p">();</span>
      <span class="nx">localStorage</span><span class="p">.</span><span class="nf">setItem</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">arr</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offlineBanner</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="dl">'</span><span class="s1">show</span><span class="dl">'</span><span class="p">);</span>
      <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Synced</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
      <span class="nf">fetchBoard</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// keep queue for retry</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="nx">isSyncing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Perform operation</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">op</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">opts</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="s2">`?b=</span><span class="p">${</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">bid</span><span class="p">)}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">},</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
    <span class="p">});</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Bad response</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">r</span><span class="p">.</span><span class="nf">json</span><span class="p">();</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="nf">render</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">queueOp</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Queued (offline)</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1500</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Event handlers</span>
<span class="nb">document</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">DOMContentLoaded</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Initialize filter UI</span>
  <span class="nx">chips</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">ch</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ch</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">filter</span> <span class="o">=</span> <span class="nx">ch</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-filter</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">localStorage</span><span class="p">.</span><span class="nf">setItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">memor_filter</span><span class="dl">'</span><span class="p">,</span> <span class="nx">filter</span><span class="p">);</span>
      <span class="nf">updateFilterUI</span><span class="p">();</span>
      <span class="nf">render</span><span class="p">(</span><span class="nx">boardData</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#search</span><span class="dl">'</span><span class="p">).</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">searchQuery</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">trim</span><span class="p">();</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nf">setItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">memor_search</span><span class="dl">'</span><span class="p">,</span> <span class="nx">searchQuery</span><span class="p">);</span>
    <span class="nf">render</span><span class="p">(</span><span class="nx">boardData</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nf">updateFilterUI</span><span class="p">();</span>

  <span class="k">await</span> <span class="nf">fetchBoard</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="k">await</span> <span class="nf">flushOutbox</span><span class="p">();</span>

  <span class="c1">// Add new task</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#add</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">trim</span><span class="p">();</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">add</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">v</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="o">=</span><span class="dl">''</span><span class="p">;</span> <span class="nx">input</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Added</span><span class="dl">'</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">input</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Enter</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#add</span><span class="dl">'</span><span class="p">).</span><span class="nf">click</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Escape</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="o">=</span><span class="dl">''</span><span class="p">;</span> <span class="nx">input</span><span class="p">.</span><span class="nf">blur</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span> <span class="nx">input</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Title save/cancel</span>
  <span class="kd">let</span> <span class="nx">titleOrig</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
  <span class="nx">title</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">focus</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">titleOrig</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="p">});</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#saveTitle</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ttl</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">trim</span><span class="p">()</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">My Todo</span><span class="dl">'</span><span class="p">;</span>
    <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="nx">ttl</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Saved</span><span class="dl">'</span><span class="p">,</span> <span class="mi">900</span><span class="p">));</span>
  <span class="p">};</span>
  <span class="nx">title</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Enter</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#saveTitle</span><span class="dl">'</span><span class="p">).</span><span class="nf">click</span><span class="p">();</span> <span class="nx">title</span><span class="p">.</span><span class="nf">blur</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Escape</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span> <span class="nx">title</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">titleOrig</span><span class="p">;</span> <span class="nx">title</span><span class="p">.</span><span class="nf">blur</span><span class="p">();</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Canceled</span><span class="dl">'</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">title</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">blur</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#saveTitle</span><span class="dl">'</span><span class="p">).</span><span class="nf">click</span><span class="p">());</span>

  <span class="c1">// Bulk buttons</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#clearDone</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">cleared</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boardData</span><span class="p">.</span><span class="nx">tasks</span><span class="o">||</span><span class="p">[]).</span><span class="nf">filter</span><span class="p">(</span><span class="nx">t</span><span class="o">=&gt;</span><span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">cleared</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">No completed tasks</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1200</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
    <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">clear_done</span><span class="dl">'</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Cleared completed</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span> <span class="nf">showUndo</span><span class="p">({</span><span class="na">type</span><span class="p">:</span><span class="dl">'</span><span class="s1">clear_done</span><span class="dl">'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="nx">cleared</span><span class="p">});</span> <span class="p">});</span>
  <span class="p">};</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#clearAll</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boardData</span><span class="p">.</span><span class="nx">tasks</span><span class="o">||</span><span class="p">[]).</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">total</span><span class="p">)</span> <span class="p">{</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">No tasks to clear</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1200</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if </span><span class="p">(</span><span class="nf">confirm</span><span class="p">(</span><span class="s2">`Delete all </span><span class="p">${</span><span class="nx">total</span><span class="p">}</span><span class="s2"> tasks?`</span><span class="p">))</span> <span class="p">{</span>
      <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">clear_all</span><span class="dl">'</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">All cleared</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#toggleAll</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">anyActive</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boardData</span><span class="p">.</span><span class="nx">tasks</span><span class="o">||</span><span class="p">[]).</span><span class="nf">some</span><span class="p">(</span><span class="nx">t</span><span class="o">=&gt;!</span><span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span>
    <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">set_all</span><span class="dl">'</span><span class="p">,</span> <span class="na">done</span><span class="p">:</span> <span class="nx">anyActive</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="nf">flash</span><span class="p">(</span><span class="nx">anyActive</span><span class="p">?</span><span class="dl">'</span><span class="s1">Completed all</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">Unchecked all</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="c1">// Switch/open board by slug</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#switch</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">slugInput</span><span class="p">.</span><span class="nx">value</span><span class="o">||</span><span class="dl">''</span><span class="p">).</span><span class="nf">trim</span><span class="p">();</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">s</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">origin</span><span class="p">}</span><span class="s2">/?b=</span><span class="p">${</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">s</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#newBoard</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">origin</span><span class="p">}</span><span class="s2">/?action=new`</span><span class="p">;</span>

  <span class="c1">// Global keyboard</span>
  <span class="nb">document</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span> <span class="nx">input</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">n</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">altKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">!==</span> <span class="nx">input</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">!==</span> <span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">input</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// List interactions</span>
  <span class="nx">list</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-id</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">checkbox</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">toggle</span><span class="dl">'</span><span class="p">,</span> <span class="nx">id</span><span class="p">});</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">list</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-del</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boardData</span><span class="p">.</span><span class="nx">tasks</span><span class="o">||</span><span class="p">[]).</span><span class="nf">find</span><span class="p">(</span><span class="nx">x</span><span class="o">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">id</span><span class="o">===</span><span class="nx">id</span><span class="p">);</span>
      <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">del</span><span class="dl">'</span><span class="p">,</span> <span class="nx">id</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Deleted</span><span class="dl">'</span><span class="p">,</span> <span class="mi">900</span><span class="p">);</span> <span class="k">if </span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="nf">showUndo</span><span class="p">({</span><span class="na">type</span><span class="p">:</span><span class="dl">'</span><span class="s1">del</span><span class="dl">'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="nx">t</span><span class="p">});</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// List keyboard (item-level)</span>
  <span class="nx">list</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">li</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">closest</span><span class="p">(</span><span class="dl">'</span><span class="s1">li</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">li</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">// Per-item shortcuts when LI itself is focused</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">li</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span> <span class="kd">const</span> <span class="nx">cb</span> <span class="o">=</span> <span class="nx">li</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">input[type=checkbox]</span><span class="dl">'</span><span class="p">);</span> <span class="k">if </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">cb</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span> <span class="nx">cb</span><span class="p">.</span><span class="nf">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nc">Event</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">));</span> <span class="p">}</span> <span class="p">}</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Delete</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Backspace</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">li</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-del]</span><span class="dl">'</span><span class="p">)?.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-del</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boardData</span><span class="p">.</span><span class="nx">tasks</span><span class="o">||</span><span class="p">[]).</span><span class="nf">find</span><span class="p">(</span><span class="nx">x</span><span class="o">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">id</span><span class="o">===</span><span class="nx">id</span><span class="p">);</span>
          <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">del</span><span class="dl">'</span><span class="p">,</span> <span class="nx">id</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Deleted</span><span class="dl">'</span><span class="p">,</span> <span class="mi">900</span><span class="p">);</span> <span class="k">if </span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="nf">showUndo</span><span class="p">({</span><span class="na">type</span><span class="p">:</span><span class="dl">'</span><span class="s1">del</span><span class="dl">'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="nx">t</span><span class="p">});</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">e</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nx">li</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">.txt</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">txt</span><span class="p">)</span> <span class="nx">txt</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Contenteditable shortcuts</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">txt</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Enter</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">blur</span><span class="p">();</span> <span class="c1">// commit on blur</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Escape</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">pendingEdit</span> <span class="o">&amp;&amp;</span> <span class="nx">pendingEdit</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-id</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">pendingEdit</span><span class="p">.</span><span class="nx">orig</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">blur</span><span class="p">();</span>
        <span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Canceled</span><span class="dl">'</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Tab</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">els</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">.txt</span><span class="dl">'</span><span class="p">));</span>
        <span class="kd">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">els</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">els</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="p">?</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span><span class="p">)];</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">blur</span><span class="p">();</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="nx">next</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Inline edit lifecycle (commit-on-blur if changed)</span>
  <span class="nx">list</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">focusin</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">txt</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">pendingEdit</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-id</span><span class="dl">'</span><span class="p">),</span> <span class="na">orig</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">textContent</span> <span class="p">};</span>
      <span class="kd">const</span> <span class="nx">range</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createRange</span><span class="p">();</span>
      <span class="nx">range</span><span class="p">.</span><span class="nf">selectNodeContents</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
      <span class="nx">range</span><span class="p">.</span><span class="nf">collapse</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">getSelection</span><span class="p">();</span>
      <span class="nx">sel</span><span class="p">.</span><span class="nf">removeAllRanges</span><span class="p">();</span>
      <span class="nx">sel</span><span class="p">.</span><span class="nf">addRange</span><span class="p">(</span><span class="nx">range</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">list</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">blur</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">txt</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">data-id</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nf">trim</span><span class="p">();</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">pendingEdit</span> <span class="o">&amp;&amp;</span> <span class="nx">pendingEdit</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">text</span> <span class="o">!==</span> <span class="nx">pendingEdit</span><span class="p">.</span><span class="nx">orig</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">op</span><span class="p">({</span><span class="na">op</span><span class="p">:</span><span class="dl">'</span><span class="s1">edit</span><span class="dl">'</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">}).</span><span class="nf">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="nf">flash</span><span class="p">(</span><span class="dl">'</span><span class="s1">Saved</span><span class="dl">'</span><span class="p">,</span> <span class="mi">800</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">pendingEdit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Initialize UI state</span>
<span class="p">(</span><span class="kd">function</span> <span class="nf">initUI</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">updateFilterUI</span><span class="p">();</span>
<span class="p">})();</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="scratchpad" /></entry><entry><title type="html">Galaxy A34 custom ROM</title><link href="https://ib.bsb.br/galaxy-a34-custom-rom/" rel="alternate" type="text/html" title="Galaxy A34 custom ROM" /><published>2025-08-30T00:00:00+00:00</published><updated>2025-08-30T17:42:21+00:00</updated><id>https://ib.bsb.br/galaxy-a34-custom-rom</id><content type="html" xml:base="https://ib.bsb.br/galaxy-a34-custom-rom/"><![CDATA[<p>1) Device identification (from your screenshots)</p>
<ul>
  <li>Manufacturer: Samsung</li>
  <li>Model: Galaxy A34 5G</li>
  <li>Exact model number: SM‑A346M/DSN (Dual SIM; CSC ZTO indicates Brazil open market)</li>
  <li>Software shown: Android 15; One UI 7.0; Android security patch: 1 July 2025; Build/baseband series A346M…DYG1; Phone status: “Oficial” (bootloader not unlocked)</li>
  <li>Likely codename: a34x (confirm with: adb shell getprop ro.product.device and ro.product.vendor.device)</li>
  <li>SoC: MediaTek Dimensity 1080 (relevant for aftermarket support constraints)</li>
</ul>

<p>2) Core concepts and how they relate to custom ROMs</p>
<ul>
  <li>Bootloader unlocking: Removes OEM signature enforcement so unsigned images can boot. On Samsung, unlocking is official, wipes data, and permanently trips KNOX (0x1), disabling Samsung Wallet, Secure Folder, and some enterprise features.</li>
  <li>Recovery (stock vs custom): Stock recovery is limited. Custom recovery (e.g., TWRP) enables flashing images/ZIPs, Nandroid backups, and advanced wipes. Samsung devices use Download Mode + Odin/Heimdall for flashing; they do not have standard fastboot.</li>
  <li>Root (Magisk): Optional and independent from installing a ROM/GSI. Commonly done by patching the boot image. Root can help with app workarounds (DenyList) but may affect Play Integrity and security posture.</li>
  <li>AVB/dm‑verity (vbmeta): Verified Boot enforces integrity. Running a GSI often requires disabling verification (flashing a vbmeta with verification/verity disabled).</li>
  <li>Odin/Heimdall vs fastboot: Samsung requires Odin (Windows) or Heimdall (open-source, sometimes less reliable on newer devices). Standard fastboot commands are not available.</li>
</ul>

<p>3) Compatible custom OS options for SM‑A346M</p>
<ul>
  <li>Android-based GSIs (Treble, arm64-ab images):
• PixelOS / Pixel Experience GSI (Pixel-like UX with GMS)
• LineageOS GSI (AOSP-based with Lineage extras; GApps optional)
• PHH AOSP GSI (baseline reference GSI)
• Evolution X GSI (Pixel base with extensive customization)
Notes: Hardware support depends on Samsung’s vendor; common gaps include IMS/VoLTE/VoWiFi, advanced camera features, fingerprint behavior, NFC.</li>
  <li>Stock-based One UI “debloated”/modded ROMs (if available for A346x):
• Built from Samsung firmware; retain most hardware features; fewer UX changes; still require unlocking (KNOX 0x1).</li>
  <li>Linux-based mobile OS:
• Ubuntu Touch and postmarketOS: No known stable, daily-driver ports for Galaxy A34 5G as of commonly available project device lists. Treat any claims as experimental; expect missing telephony/camera/sensors.</li>
</ul>

<p>4) Comparative analysis (features/stability/usability/community)</p>
<ul>
  <li>PixelOS / Pixel Experience GSI
• Features/stability/performance: Pixel UX with integrated Google apps; often polished if vendor supports essentials; potential gaps in IMS/camera/UDFPS on Samsung MTK.
• Install/user-friendliness: Moderate; similar to other GSIs; out-of-box usability can be high if core hardware works.
• Development/community: Active projects; GSI tracks vary by maintainer; broad generic support, fewer device-specific fixes.</li>
  <li>LineageOS GSI
• Features/stability/performance: Clean AOSP+Lineage features; good performance; similar device-specific caveats.
• Install/user-friendliness: Moderate; GApps optional; privacy-friendly.
• Development/community: Strong lineage ecosystem; GSI builds are community-driven; support depends on maintainer.</li>
  <li>PHH AOSP GSI
• Features/stability/performance: Baseline GSI; often gets treble fixes early; performance good when hardware cooperates.
• Install/user-friendliness: Moderate; good for testing baseline compatibility.
• Development/community: Very active upstream; device-specific contributions vary.</li>
  <li>Evolution X GSI
• Features/stability/performance: Extensive customization atop Pixel base; may introduce additional complexity.
• Install/user-friendliness: Moderate; more toggles/settings in daily use.
• Development/community: Generally active; verify current GSI status for A34 specifically.</li>
  <li>Stock-based One UI debloated ROMs (A346x)
• Features/stability/performance: Highest chance of keeping camera quality, IMS, fingerprint reliability; performance similar/slightly better due to debloat.
• Install/user-friendliness: Often simpler via Odin; closest to stock daily experience.
• Development/community: Availability varies; fewer device-specific ROMs for Samsung MTK midrange vs Snapdragon flagships.</li>
</ul>

<p>5) General high-level installation procedure (Samsung-specific), including a concrete PixelOS GSI path
Preparation</p>
<ul>
  <li>Back up all data (unlocking wipes device).</li>
  <li>Battery ≥70%. Install Android Platform-Tools (adb), Samsung USB Driver, Odin (Windows) or Heimdall (Linux/macOS).</li>
  <li>Download full stock firmware for SM‑A346M with your CSC (e.g., ZTO) to allow recovery if needed.</li>
  <li>Enable Developer options; toggle OEM unlocking (may require network connection and time).</li>
</ul>

<p>Unlock bootloader (irreversible KNOX 0x1)</p>
<ul>
  <li>Power off. Enter Download Mode (hold Volume Up + Volume Down while connecting USB).</li>
  <li>Long-press Volume Up to unlock; confirm. Device wipes and reboots.</li>
  <li>Minimal setup; verify OEM unlocking shows unlocked.</li>
</ul>

<p>Low-risk test (if available): DSU Loader</p>
<ul>
  <li>Developer options → DSU Loader: temporarily boot a PixelOS/PHH GSI without permanent flashing. Test telephony, data, Wi‑Fi/BT, camera, fingerprint. Note: DSU availability may be limited by firmware.</li>
</ul>

<p>Concrete install: PixelOS GSI via TWRP (requires verified working TWRP for a34x)</p>
<ul>
  <li>Flash TWRP with Odin
• Download Mode → Odin: Options: check F. Reset Time; uncheck Auto Reboot.
• AP: select TWRP .tar for a34x → Start → PASS.
• Exit Download Mode (Vol Down + Power), then immediately boot to recovery (Vol Up + Power) to prevent stock recovery restore.</li>
  <li>In TWRP: prepare data
• Allow modifications → Wipe → Format Data (type yes) → Reboot → Recovery.</li>
  <li>Disable AVB/verity (vbmeta)
• On PC with avbtool:
    <ul>
      <li>avbtool make_vbmeta_image –output vbmeta_disabled.img –disable_verification –disable_verity</li>
      <li>tar -H ustar -cvf vbmeta_disabled.tar vbmeta_disabled.img (rename inside tar to vbmeta.img if needed by your Odin packaging)
• Reboot phone to Download Mode from TWRP → Odin AP: select vbmeta_disabled.tar → Start → PASS.
• Boot back to TWRP (timed key combo as above).</li>
    </ul>
  </li>
  <li>Flash PixelOS GSI
• Copy PixelOS system.img (arm64-ab) to phone (MTP or adb push).
• TWRP → Install → Install Image → select system.img → choose System Image → swipe to flash.
• (Optional) Wipe → Advanced Wipe → Dalvik/ART Cache and Cache.
• Reboot → System. First boot may take 10–15 minutes.</li>
  <li>Post-install checks
• Test calls/SMS, mobile data/APN, Wi‑Fi/BT/GPS, cameras, mic/speakers, UDFPS, NFC, sensors, IMS (VoLTE/VoWiFi), Play Integrity/DRM apps.</li>
  <li>Updates (dirty flash)
• Reboot to TWRP → Install Image → flash new PixelOS system.img to System Image → wipe Dalvik/Cache (optional) → reboot.</li>
  <li>Rollback to stock
• Download Mode → Odin: flash stock BL/AP/CP/CSC (use CSC to full-wipe if necessary) → Start → PASS → reboot. KNOX remains 0x1 permanently.</li>
</ul>

<p>If no verified TWRP exists for a34x</p>
<ul>
  <li>Do not proceed with full flashing. Use DSU to evaluate GSIs. Avoid manual super partition repacks unless following a trusted, device-specific guide; risk of hard brick is high.</li>
</ul>

<p>6) Significant risks</p>
<ul>
  <li>KNOX 0x1: Permanent; disables Samsung Wallet, Secure Folder, some enterprise features even after relocking.</li>
  <li>Warranty/service: Likely voided by unlocking/rooting.</li>
  <li>Bricking: Soft bricks recoverable via Odin; hard bricks (no Download Mode) may require hardware repair.</li>
  <li>Data loss: Unlocking and some flashes wipe data.</li>
  <li>Functionality regressions on GSIs: IMS/VoLTE/VoWiFi, advanced camera features, UDFPS, NFC, and DRM levels may degrade or fail.</li>
  <li>Security posture: Verified Boot guarantees weakened; Play Integrity may fail; some banking/streaming apps may not work.</li>
  <li>EFS/modem risk: Do not touch EFS/modem partitions; corruption can break IMEI/baseband.</li>
</ul>

<p>7) Device-specific resources (verify current status for A34 5G/SM‑A346x)</p>
<ul>
  <li>XDA Developers forums (search device-specific threads): https://forum.xda-developers.com/</li>
  <li>TWRP devices list (check if A34 5G is supported): https://twrp.me/Devices/</li>
  <li>PHH Treble docs/issues (GSI guidance): https://github.com/phhusson/treble_experimentations</li>
  <li>Android Platform-Tools (adb): https://developer.android.com/tools/releases/platform-tools</li>
  <li>Odin (Windows; obtain from reputable sources) and Samsung USB Driver (Samsung support portals)</li>
  <li>Heimdall (open-source flashing tool): https://github.com/Benjamin-Dobell/Heimdall</li>
  <li>Ubuntu Touch devices: https://devices.ubuntu-touch.io/</li>
  <li>postmarketOS devices: https://wiki.postmarketos.org/wiki/Devices</li>
  <li>Stock firmware (for recovery): use reputable firmware repositories for SM‑A346M with your CSC (e.g., ZTO)</li>
</ul>

<p>ABNT-style references</p>
<ul>
  <li>GOOGLE. Android Platform-Tools (adb). Available at: <a href="https://developer.android.com/tools/releases/platform-tools">https://developer.android.com/tools/releases/platform-tools</a>. Accessed on: 30 August 2025.</li>
  <li>TWRP. Team Win Recovery Project – Devices. Available at: <a href="https://twrp.me/Devices/">https://twrp.me/Devices/</a>. Accessed on: 30 August 2025.</li>
  <li>XDA DEVELOPERS. Forums. Available at: <a href="https://forum.xda-developers.com/">https://forum.xda-developers.com/</a>. Accessed on: 30 August 2025.</li>
  <li>PHHUSSON. Treble Experimentations. Available at: <a href="https://github.com/phhusson/treble_experimentations">https://github.com/phhusson/treble_experimentations</a>. Accessed on: 30 August 2025.</li>
  <li>HEIMDALL. Heimdall flashing tool. Available at: <a href="https://github.com/Benjamin-Dobell/Heimdall">https://github.com/Benjamin-Dobell/Heimdall</a>. Accessed on: 30 August 2025.</li>
  <li>UBPORTS. Ubuntu Touch devices. Available at: <a href="https://devices.ubuntu-touch.io/">https://devices.ubuntu-touch.io/</a>. Accessed on: 30 August 2025.</li>
  <li>POSTMARKETOS. Devices list. Available at: <a href="https://wiki.postmarketos.org/wiki/Devices">https://wiki.postmarketos.org/wiki/Devices</a>. Accessed on: 30 August 2025.</li>
</ul>

<p>8) Synthesis and recommendation (balancing Linux interest with stability)</p>
<ul>
  <li>If you prioritize stability and full hardware support: stay on stock One UI or consider a reputable stock-based debloated ROM for A346x (if available). Best chance to retain camera quality, IMS/VoLTE, fingerprint reliability, and DRM levels.</li>
  <li>If you want a different UX and accept trade-offs: trial PixelOS/Pixel Experience or LineageOS GSIs via DSU if available. If essential functions work, proceed with the TWRP-based PixelOS GSI installation flow above, including vbmeta disable. Expect potential IMS/camera/UDFPS quirks.</li>
  <li>Linux OS: For A34 5G, treat Ubuntu Touch/postmarketOS as experimental/unavailable for daily use; consider a secondary, well-supported device if mobile Linux is a primary goal.</li>
</ul>

<p>Critical precautions</p>
<ul>
  <li>Back up thoroughly; unlocking wipes data.</li>
  <li>Understand KNOX 0x1 is permanent.</li>
  <li>Keep full stock firmware for SM‑A346M (your CSC) ready for Odin recovery.</li>
  <li>Verify any recovery/ROM is explicitly for a34x/SM‑A346x; avoid cross-device images.</li>
  <li>Verify checksums; download only from original maintainer sources.</li>
  <li>Test essentials immediately after flashing; if critical features fail, roll back to stock.</li>
</ul>]]></content><author><name></name></author><category term="scratchpad" /></entry></feed>